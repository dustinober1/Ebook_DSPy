<svg viewBox="0 0 1000 500" xmlns="http://www.w3.org/2000/svg">
  <!-- Title -->
  <text x="500" y="35" font-size="22" font-weight="bold" text-anchor="middle" fill="#333">
    Pipeline Composition: Multi-Step Processing
  </text>

  <!-- Example: RAG Pipeline -->
  <text x="500" y="70" font-size="14" font-weight="bold" text-anchor="middle" fill="#555">
    Example: Retrieval-Augmented Generation (RAG) Pipeline
  </text>

  <!-- Step 1: Retrieval -->
  <g>
    <rect x="50" y="100" width="140" height="100" fill="#bbdefb" stroke="#1976d2" stroke-width="2" rx="5"/>
    <text x="120" y="130" font-size="12" font-weight="bold" text-anchor="middle" fill="#1565c0">
      1. Retrieve
    </text>
    <text x="120" y="155" font-size="10" text-anchor="middle" fill="#333">
      Search knowledge
    </text>
    <text x="120" y="175" font-size="10" text-anchor="middle" fill="#333">
      base for relevant
    </text>
    <text x="120" y="195" font-size="10" text-anchor="middle" fill="#333">
      documents
    </text>

    <!-- Input -->
    <text x="50" y="235" font-size="9" fill="#666">Query</text>
    <rect x="50" y="240" width="140" height="30" fill="#f5f5f5" stroke="#ccc" stroke-width="1" rx="2"/>
    <text x="120" y="260" font-size="9" text-anchor="middle" font-family="monospace">
      "How does X work?"
    </text>
  </g>

  <!-- Arrow 1 -->
  <g>
    <line x1="190" y1="150" x2="230" y2="150" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
    <text x="210" y="145" font-size="8" text-anchor="middle" fill="#666">documents</text>
  </g>

  <!-- Step 2: Rank -->
  <g>
    <rect x="230" y="100" width="140" height="100" fill="#c8e6c9" stroke="#388e3c" stroke-width="2" rx="5"/>
    <text x="300" y="130" font-size="12" font-weight="bold" text-anchor="middle" fill="#2e7d32">
      2. Rank
    </text>
    <text x="300" y="155" font-size="10" text-anchor="middle" fill="#333">
      Order by
    </text>
    <text x="300" y="175" font-size="10" text-anchor="middle" fill="#333">
      relevance
    </text>
    <text x="300" y="195" font-size="10" text-anchor="middle" fill="#333">
      score
    </text>

    <!-- Output/Input -->
    <text x="230" y="235" font-size="9" fill="#666">Top-K docs</text>
    <rect x="230" y="240" width="140" height="30" fill="#f5f5f5" stroke="#ccc" stroke-width="1" rx="2"/>
    <text x="300" y="260" font-size="8" text-anchor="middle" font-family="monospace">
      [doc1, doc2, ...]
    </text>
  </g>

  <!-- Arrow 2 -->
  <g>
    <line x1="370" y1="150" x2="410" y2="150" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
    <text x="390" y="145" font-size="8" text-anchor="middle" fill="#666">top docs</text>
  </g>

  <!-- Step 3: Generate -->
  <g>
    <rect x="410" y="100" width="140" height="100" fill="#ffe0b2" stroke="#f57c00" stroke-width="2" rx="5"/>
    <text x="480" y="130" font-size="12" font-weight="bold" text-anchor="middle" fill="#e65100">
      3. Generate
    </text>
    <text x="480" y="155" font-size="10" text-anchor="middle" fill="#333">
      Augment query
    </text>
    <text x="480" y="175" font-size="10" text-anchor="middle" fill="#333">
      with context
    </text>
    <text x="480" y="195" font-size="10" text-anchor="middle" fill="#333">
      and generate
    </text>

    <!-- Output -->
    <text x="410" y="235" font-size="9" fill="#666">Answer</text>
    <rect x="410" y="240" width="140" height="30" fill="#f5f5f5" stroke="#ccc" stroke-width="1" rx="2"/>
    <text x="480" y="255" font-size="8" text-anchor="middle" font-family="monospace">
      "X works by..."
    </text>
  </g>

  <!-- Arrow 3 -->
  <g>
    <line x1="550" y1="150" x2="590" y2="150" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
    <text x="570" y="145" font-size="8" text-anchor="middle" fill="#666">augmented</text>
  </g>

  <!-- Step 4: Validate -->
  <g>
    <rect x="590" y="100" width="140" height="100" fill="#f8bbd0" stroke="#c2185b" stroke-width="2" rx="5"/>
    <text x="660" y="130" font-size="12" font-weight="bold" text-anchor="middle" fill="#ad1457">
      4. Validate
    </text>
    <text x="660" y="155" font-size="10" text-anchor="middle" fill="#333">
      Check answer
    </text>
    <text x="660" y="175" font-size="10" text-anchor="middle" fill="#333">
      quality and
    </text>
    <text x="660" y="195" font-size="10" text-anchor="middle" fill="#333">
      correctness
    </text>

    <!-- Output -->
    <text x="590" y="235" font-size="9" fill="#666">Result</text>
    <rect x="590" y="240" width="140" height="30" fill="#f5f5f5" stroke="#ccc" stroke-width="1" rx="2"/>
    <text x="660" y="255" font-size="8" text-anchor="middle" font-family="monospace">
      Validated answer
    </text>
  </g>

  <!-- Arrow 4 -->
  <g>
    <line x1="730" y1="150" x2="770" y2="150" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
  </g>

  <!-- Final Output -->
  <g>
    <rect x="770" y="110" width="130" height="80" fill="#c5cae9" stroke="#3949ab" stroke-width="2" rx="5"/>
    <text x="835" y="140" font-size="12" font-weight="bold" text-anchor="middle" fill="#1a237e">
      Final Output
    </text>
    <text x="835" y="165" font-size="10" text-anchor="middle" fill="#333">
      Reliable answer
    </text>
  </g>

  <!-- DSPy Implementation -->
  <g>
    <rect x="50" y="320" width="850" height="150" fill="#f9f9f9" stroke="#ddd" stroke-width="1" rx="3"/>
    <text x="70" y="345" font-size="12" font-weight="bold" fill="#333">DSPy Implementation:</text>

    <text x="70" y="370" font-size="10" font-family="monospace" fill="#333">class RAGPipeline(dspy.Module):</text>
    <text x="70" y="388" font-size="10" font-family="monospace" fill="#333">  def __init__(self):</text>
    <text x="70" y="406" font-size="10" font-family="monospace" fill="#333">    super().__init__()</text>
    <text x="70" y="424" font-size="10" font-family="monospace" fill="#333">    self.retrieve = dspy.Retrieve()  # Vector search</text>
    <text x="70" y="442" font-size="10" font-family="monospace" fill="#333">    self.answer = dspy.ChainOfThought(GenerateAnswer)  # With reasoning</text>

    <text x="70" y="460" font-size="10" font-family="monospace" fill="#333">  def forward(self, query):</text>
    <text x="70" y="478" font-size="10" font-family="monospace" fill="#333">    context = self.retrieve(query).passages  # Step 1-2</text>
    <text x="500" y="478" font-size="10" font-family="monospace" fill="#333">return self.answer(context=context, query=query)  # Step 3-4</text>
  </g>

  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#333"/>
    </marker>
  </defs>
</svg>
