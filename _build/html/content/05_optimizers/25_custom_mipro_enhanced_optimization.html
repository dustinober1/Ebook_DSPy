
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>CustomMIPROv2: Enhanced Multi-Stage Prompt Optimization &#8212; DSPy: The Complete Guide</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=9c3e77be" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=1ae7504c"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'content/05_optimizers/25_custom_mipro_enhanced_optimization';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Automatic Prompt Optimization: When AI Outperforms Humans" href="26_automatic_prompt_optimization_research.html" />
    <link rel="prev" title="InPars+: Advanced Synthetic Data Generation for Information Retrieval" href="24_inpars_plus_synthetic_data_ir.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../00_frontmatter/00_preface.html">
  
  
  
  
  
  
    <p class="title logo__title">DSPy: The Complete Guide</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../00_frontmatter/01_how_to_use_this_book.html">How to Use This Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_frontmatter/02_prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_frontmatter/03_setup_instructions.html">Setup Instructions</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 1 - Fundamentals</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../01_fundamentals/00_chapter_intro.html">Chapter 1: DSPy Fundamentals</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../01_fundamentals/01_what_is_dspy.html">What is DSPy?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01_fundamentals/02_programming_vs_prompting.html">Programming vs. Prompting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01_fundamentals/03_installation_setup.html">Installation and Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01_fundamentals/04_first_dspy_program.html">Your First DSPy Program</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01_fundamentals/05_language_models.html">Language Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01_fundamentals/06_exercises.html">Chapter 1 Exercises</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 2 - Signatures</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../02_signatures/00_chapter_intro.html">Chapter 2: Signatures</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../02_signatures/01_understanding_signatures.html">Understanding Signatures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02_signatures/02_signature_syntax.html">Signature Syntax</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02_signatures/03_typed_signatures.html">Typed Signatures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02_signatures/04_advanced_signatures.html">Advanced Signatures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02_signatures/05_practical_examples.html">Practical Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02_signatures/06_exercises.html">Chapter 2 Exercises</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 3 - Modules</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../03_modules/00_chapter_intro.html">Chapter 3: Modules</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../03_modules/01_module_basics.html">Module Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03_modules/02_predict_module.html">The Predict Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03_modules/02a_typed_predictor.html">TypedPredictor: Type-Safe Language Model Wrappers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03_modules/03_chainofthought.html">Chain of Thought Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03_modules/04_react_agents.html">ReAct Agents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03_modules/05_custom_modules.html">Custom Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03_modules/06_composing_modules.html">Composing Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03_modules/07_exercises.html">Chapter 3 Exercises</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03_modules/08_assertions.html">Assertions Module</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 4 - Evaluation</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../04_evaluation/00_chapter_intro.html">Chapter 4: Evaluation</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/01_why_evaluation_matters.html">Why Evaluation Matters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/02_creating_datasets.html">Creating Datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/03_defining_metrics.html">Defining Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/04_evaluation_loops.html">Evaluation Loops</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/05_best_practices.html">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/06_exercises.html">Exercises</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/07_structured_prompting.html">Structured Prompting for Robust Evaluation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/08_llm_as_a_judge.html">LLM-as-a-Judge for Context-Sensitive Evaluation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/09_human_aligned_evaluation.html">Human-Aligned Evaluation: Capturing What Really Matters</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 5 - Optimizers</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="00_chapter_intro.html">Chapter 5: Optimizers &amp; Compilation</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="01_compilation_concept.html">The Compilation Concept in DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="02_bootstrapfewshot.html">BootstrapFewShot: Automatic Few-Shot Example Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="02a_copro.html">COPRO: Chain-of-Thought Prompt Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="03_mipro.html">MIPRO: Multi-step Instruction and Demonstration Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="04_knnfewshot.html">KNNFewShot: Similarity-Based Example Selection</a></li>
<li class="toctree-l2"><a class="reference internal" href="05_finetuning.html">Fine-Tuning Small Language Models in DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="06_choosing_optimizers.html">Choosing Optimizers: Decision Guide and Trade-offs</a></li>
<li class="toctree-l2"><a class="reference internal" href="07_constraint_driven_optimization.html">Constraint-Driven Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="07_exercises.html">Chapter 5 Exercises: Optimizers &amp; Compilation</a></li>
<li class="toctree-l2"><a class="reference internal" href="08_reflective_prompt_evolution.html">Reflective Prompt Evolution (RPE): Evolutionary Optimization Without Gradients</a></li>
<li class="toctree-l2"><a class="reference internal" href="09_copa_compiler_method.html">COPA: Compiler and Prompt Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="09a_copa_method.html">COPA: Combined Fine-Tuning and Prompt Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="10_joint_optimization.html">Joint Optimization: Fine-Tuning and Prompt Synergy</a></li>
<li class="toctree-l2"><a class="reference internal" href="11_monte_carlo_optimization.html">Monte Carlo Optimization in DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="12_bayesian_optimization.html">Bayesian Optimization for Prompt Tuning</a></li>
<li class="toctree-l2"><a class="reference internal" href="13_comprehensive_examples.html">Comprehensive Examples and Implementation Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="14_multistage_optimization_theory.html">Multi-stage Optimization Theory</a></li>
<li class="toctree-l2"><a class="reference internal" href="15_instruction_tuning_frameworks.html">Instruction Tuning Frameworks</a></li>
<li class="toctree-l2"><a class="reference internal" href="16_demonstration_optimization.html">Demonstration Optimization Strategies</a></li>
<li class="toctree-l2"><a class="reference internal" href="17_multistage_architectures.html">Multi-stage Program Architectures</a></li>
<li class="toctree-l2"><a class="reference internal" href="18_complex_pipeline_optimization.html">Optimization Strategies for Complex Pipelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="19_instruction_demonstration_interactions.html">Instruction and Demonstration Interaction Effects</a></li>
<li class="toctree-l2"><a class="reference internal" href="20_prompts_as_hyperparameters.html">Prompts as Auto-Optimized Hyperparameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="21_minimal_data_pipelines.html">Minimal Data Training Pipelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="22_gepa_genetic_pareto_optimization.html">GEPA: Genetic-Pareto Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="23_state_space_prompt_optimization.html">State-Space Search for Prompt Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="24_inpars_plus_synthetic_data_ir.html">InPars+: Advanced Synthetic Data Generation for Information Retrieval</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">CustomMIPROv2: Enhanced Multi-Stage Prompt Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="26_automatic_prompt_optimization_research.html">Automatic Prompt Optimization: When AI Outperforms Humans</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 6 - Real-World Applications</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../06_real_world_applications/00_chapter_intro.html">Chapter 6: Building Real-World Applications</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/01_rag_systems.html">RAG Systems: Building Intelligent Document Q&amp;A</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/02_multi_hop_search.html">Multi-hop Search: Complex Reasoning Across Documents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/03_classification_tasks.html">Classification Tasks: Building Robust Text Categorization Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/04_entity_extraction.html">Entity Extraction: Mining Structured Information from Text</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/05_intelligent_agents.html">Intelligent Agents: Building Autonomous Problem-Solving Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/06_code_generation.html">Code Generation: Building Automated Programming Assistants</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/07_exercises.html">Chapter 6 Exercises: Building Real-World Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/07a_perspective_driven_research.html">Perspective-Driven Research for Article Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/08_extreme_multilabel_classification.html">Extreme Multi-Label Classification: Scaling to Millions of Labels</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/08a_long_form_generation.html">Long-form Article Generation with DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/09_outline_generation.html">Outline Generation for Structured Article Writing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/11_extreme_few_shot_learning.html">Extreme Few-Shot Learning: Training with 10 Gold Labels</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/12_ir_model_training_scratch.html">IR Model Training from Scratch: Methodology and Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/13_lingvarbench_healthcare_synthetic_data.html">LingVarBench: Synthetic Healthcare Transcript Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/14_scientific_figure_caption_generation.html">Scientific Figure Caption Generation with DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/15_retrieval_augmented_guardrails.html">Retrieval-Augmented Guardrails for AI Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/16_graphrag_wikipedia_tidb_tutorial.html">GraphRAG from Wikipedia: Building with DSPy, OpenAI, and TiDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/17_framework_comparisons_dspy_ecosystem.html">Framework Comparisons in the DSPy Ecosystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/18_multi_agent_rag_systems.html">Multi-Agent RAG Systems with DSPy</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 7 - Advanced Topics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../07_advanced_topics/00_chapter_intro.html">Chapter 7: Advanced Topics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/01_adapters_tools.html">Adapters and Tools: Extending DSPy Capabilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/02_caching_performance.html">Caching and Performance: Building High-Performance DSPy Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/03_async_streaming.html">Async and Streaming: Building Real-Time DSPy Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/04_debugging_tracing.html">Debugging and Tracing: Mastering DSPy Application Diagnostics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/05_deployment_strategies.html">Deployment Strategies: Taking DSPy Applications to Production</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/06_exercises.html">Chapter 7 Exercises: Advanced Topics Mastery</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/07_self_refining_pipelines.html">Self-Refining Pipelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/08_declarative_compilation.html">Declarative Language Model Compilation Techniques</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 8 - Case Studies</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../08_case_studies/00_introduction.html">Chapter 8: Case Studies</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/01_enterprise_rag_system.html">Case Study 1: Building an Enterprise RAG System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/01a_healthcare_clinical_notes.html">Case Study 1: Clinical Notes Analysis with DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/02_customer_support_chatbot.html">Case Study 2: Developing a Customer Support Chatbot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/03_ai_code_assistant.html">Case Study 3: Creating an AI-Powered Code Assistant</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/04_automated_data_analysis.html">Case Study 4: Building an Automated Data Analysis Pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/05_exercises.html">Chapter 8 Exercises</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/05a_storm_writing_assistant.html">Case Study 5: STORM - AI-Powered Writing Assistant for Wikipedia-like Articles</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/06_assertion_driven_applications.html">Case Study: Assertion-Driven Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/07_databricks_jetblue_llm_optimization.html">Case Study 7: Databricks &amp; JetBlue LLM Pipeline Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/08_replit_code_repair_dspy.html">Case Study 8: Replit Code Repair with DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/09_databricks_dspy_platform_integration.html">Case Study 9: Databricks Platform Integration with DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/10_ddi_behavioral_simulation_automation.html">Case Study 10: DDI Behavioral Simulation Automation with DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/11_salomatic_medical_report_generation.html">Case Study 11: Salomatic Medical Report Generation with DSPy and Langtrace</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../09_appendices/00_introduction.html">Chapter 9: Appendices</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../09_appendices/01_api_reference_quick.html">API Reference Quick Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09_appendices/02_troubleshooting.html">Troubleshooting Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09_appendices/03_resources.html">Additional Resources</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09_appendices/04_glossary.html">Glossary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09_appendices/05_community_resources.html">Community Resources and Perspectives</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/content/05_optimizers/25_custom_mipro_enhanced_optimization.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>CustomMIPROv2: Enhanced Multi-Stage Prompt Optimization</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#key-enhancements">Key Enhancements</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#architecture">Architecture</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#two-stage-optimization-process">1. Two-Stage Optimization Process</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#routing-agent-optimization-example">2. Routing Agent Optimization Example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#prompt-evaluator-optimization">3. Prompt Evaluator Optimization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code-generation-optimization">4. Code Generation Optimization</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation-guide">Implementation Guide</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#basic-usage">1. Basic Usage</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-constraints-and-tips">2. Using Constraints and Tips</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-and-using-optimized-prompts">3. Extracting and Using Optimized Prompts</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#key-results-from-paper">Key Results from Paper</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#best-practices">Best Practices</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-features">Advanced Features</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#constraint-prioritization">1. Constraint Prioritization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#adaptive-trial-management">2. Adaptive Trial Management</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#limitations-and-considerations">Limitations and Considerations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">Conclusion</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="custommiprov2-enhanced-multi-stage-prompt-optimization">
<h1>CustomMIPROv2: Enhanced Multi-Stage Prompt Optimization<a class="headerlink" href="#custommiprov2-enhanced-multi-stage-prompt-optimization" title="Link to this heading">#</a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">#</a></h2>
<p><strong>CustomMIPROv2</strong> is an enhanced version of the MIPROv2 optimizer that addresses real-world production needs through a two-stage optimization process and explicit constraint handling. This optimizer was developed through extensive multi-use case studies and demonstrates significant improvements in complex tasks like routing agents, prompt evaluation, and code generation.</p>
</section>
<section id="key-enhancements">
<h2>Key Enhancements<a class="headerlink" href="#key-enhancements" title="Link to this heading">#</a></h2>
<ol class="arabic simple">
<li><p><strong>Two-Stage Instruction Generation</strong>: Separates constraint extraction from instruction generation for better focus</p></li>
<li><p><strong>Explicit Constraint Handling</strong>: Users can provide domain-specific constraints and optimization tips</p></li>
<li><p><strong>Mini-Batch Evaluation</strong>: Efficient evaluation using representative subsets</p></li>
<li><p><strong>Context-Aware Optimization</strong>: Better handling of long conversations and complex contexts</p></li>
<li><p><strong>Production-Ready Extraction</strong>: Optimized prompts designed for extraction from DSPy framework</p></li>
</ol>
</section>
<section id="architecture">
<h2>Architecture<a class="headerlink" href="#architecture" title="Link to this heading">#</a></h2>
<section id="two-stage-optimization-process">
<h3>1. Two-Stage Optimization Process<a class="headerlink" href="#two-stage-optimization-process" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">dspy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">OptimizationConstraint</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a constraint for prompt optimization.&quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">priority</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># HIGH, MEDIUM, LOW</span>
    <span class="n">examples</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CustomMIPROv2</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enhanced MIPROv2 optimizer with two-stage optimization.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">teacher_model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span>
                 <span class="n">student_model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">,</span>
                 <span class="n">num_trials</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
                 <span class="n">mini_batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
                 <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teacher_model</span> <span class="o">=</span> <span class="n">teacher_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">student_model</span> <span class="o">=</span> <span class="n">student_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_trials</span> <span class="o">=</span> <span class="n">num_trials</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mini_batch_size</span> <span class="o">=</span> <span class="n">mini_batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="n">temperature</span>

        <span class="c1"># Optimization stages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraint_extractor</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Analyze the provided task demonstrations and extract key constraints</span>
<span class="sd">            and edge cases that the optimized instruction should handle.</span>

<span class="sd">            Task Demonstrations:</span>
<span class="sd">            {demonstrations}</span>

<span class="sd">            Program Context:</span>
<span class="sd">            {program_context}</span>

<span class="sd">            Extract:</span>
<span class="sd">            1. Critical constraints (must-follow rules)</span>
<span class="sd">            2. Edge cases to consider</span>
<span class="sd">            3. Common failure patterns</span>
<span class="sd">            4. Important contextual factors</span>

<span class="sd">            Constraints and Edge Cases:&quot;&quot;&quot;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">instruction_generator</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">ChainOfThought</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Generate an optimized instruction based on constraints and examples.</span>

<span class="sd">            Task Description: {task_description}</span>
<span class="sd">            Constraints: {constraints}</span>
<span class="sd">            Edge Cases: {edge_cases}</span>
<span class="sd">            Tips/Guidance: {tips}</span>

<span class="sd">            Requirements:</span>
<span class="sd">            - Address all high-priority constraints</span>
<span class="sd">            - Handle identified edge cases</span>
<span class="sd">            - Follow provided tips when applicable</span>
<span class="sd">            - Keep instruction clear and concise</span>
<span class="sd">            - Maintain consistency with examples</span>

<span class="sd">            Optimized Instruction:&quot;&quot;&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">program</span><span class="p">:</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
                <span class="n">trainset</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">dspy</span><span class="o">.</span><span class="n">Example</span><span class="p">],</span>
                <span class="n">valset</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">dspy</span><span class="o">.</span><span class="n">Example</span><span class="p">],</span>
                <span class="n">metric</span><span class="p">:</span> <span class="nb">callable</span><span class="p">,</span>
                <span class="n">tips</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">constraints</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">OptimizationConstraint</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compile the program with enhanced optimization.&quot;&quot;&quot;</span>

        <span class="c1"># Store references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">program</span> <span class="o">=</span> <span class="n">program</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trainset</span> <span class="o">=</span> <span class="n">trainset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valset</span> <span class="o">=</span> <span class="n">valset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="n">metric</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tips</span> <span class="o">=</span> <span class="n">tips</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="n">constraints</span> <span class="ow">or</span> <span class="p">[]</span>

        <span class="c1"># Stage 1: Extract constraints from demonstrations</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stage 1: Extracting constraints and edge cases...&quot;</span><span class="p">)</span>
        <span class="n">extracted_constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_constraints_from_demos</span><span class="p">()</span>

        <span class="c1"># Combine user constraints with extracted ones</span>
        <span class="n">all_constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_constraints</span><span class="p">(</span><span class="n">extracted_constraints</span><span class="p">,</span> <span class="n">constraints</span><span class="p">)</span>

        <span class="c1"># Stage 2: Generate and evaluate optimized instructions</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stage 2: Generating optimized instructions...&quot;</span><span class="p">)</span>
        <span class="n">best_instruction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimize_instructions</span><span class="p">(</span><span class="n">all_constraints</span><span class="p">,</span> <span class="n">tips</span><span class="p">)</span>

        <span class="c1"># Create and return optimized program</span>
        <span class="n">optimized_program</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_optimized_program</span><span class="p">(</span><span class="n">best_instruction</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">optimized_program</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_constraints_from_demos</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract constraints from training demonstrations.&quot;&quot;&quot;</span>

        <span class="c1"># Sample demonstrations for analysis</span>
        <span class="n">demo_samples</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trainset</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trainset</span><span class="p">)))</span>

        <span class="c1"># Extract program context</span>
        <span class="n">program_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_program_structure</span><span class="p">()</span>

        <span class="c1"># Format demonstrations for analysis</span>
        <span class="n">demo_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
            <span class="sa">f</span><span class="s2">&quot;Input: </span><span class="si">{</span><span class="n">demo</span><span class="o">.</span><span class="n">inputs</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2">Output: </span><span class="si">{</span><span class="n">demo</span><span class="o">.</span><span class="n">outputs</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">demo</span> <span class="ow">in</span> <span class="n">demo_samples</span>
        <span class="p">])</span>

        <span class="c1"># Extract constraints</span>
        <span class="n">extraction_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraint_extractor</span><span class="p">(</span>
            <span class="n">demonstrations</span><span class="o">=</span><span class="n">demo_text</span><span class="p">,</span>
            <span class="n">program_context</span><span class="o">=</span><span class="n">program_context</span>
        <span class="p">)</span>

        <span class="c1"># Parse and structure the extraction</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_constraint_extraction</span><span class="p">(</span><span class="n">extraction_result</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">constraints</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_optimize_instructions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                             <span class="n">constraints</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
                             <span class="n">tips</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate and evaluate multiple instruction candidates.&quot;&quot;&quot;</span>

        <span class="c1"># Create mini-batches for evaluation</span>
        <span class="n">mini_batches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_mini_batches</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mini_batch_size</span><span class="p">)</span>

        <span class="n">best_instruction</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_score</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">for</span> <span class="n">trial</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_trials</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trial </span><span class="si">{</span><span class="n">trial</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_trials</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Generate instruction candidate</span>
            <span class="n">instruction_candidate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_instruction_candidate</span><span class="p">(</span>
                <span class="n">constraints</span><span class="p">,</span> <span class="n">tips</span><span class="p">,</span> <span class="n">trial</span>
            <span class="p">)</span>

            <span class="c1"># Evaluate on mini-batches</span>
            <span class="n">avg_score</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mini_batches</span><span class="p">):</span>
                <span class="c1"># Create temporary program with new instruction</span>
                <span class="n">temp_program</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_temp_program</span><span class="p">(</span><span class="n">instruction_candidate</span><span class="p">)</span>

                <span class="c1"># Evaluate on this batch</span>
                <span class="n">batch_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_on_batch</span><span class="p">(</span><span class="n">temp_program</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>
                <span class="n">avg_score</span> <span class="o">+=</span> <span class="n">batch_score</span>

            <span class="n">avg_score</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mini_batches</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Score: </span><span class="si">{</span><span class="n">avg_score</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Update best if improved</span>
            <span class="k">if</span> <span class="n">avg_score</span> <span class="o">&gt;</span> <span class="n">best_score</span><span class="p">:</span>
                <span class="n">best_score</span> <span class="o">=</span> <span class="n">avg_score</span>
                <span class="n">best_instruction</span> <span class="o">=</span> <span class="n">instruction_candidate</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  New best instruction found!&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Optimization complete. Best score: </span><span class="si">{</span><span class="n">best_score</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">best_instruction</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_instruction_candidate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                      <span class="n">constraints</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
                                      <span class="n">tips</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                                      <span class="n">trial</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a single instruction candidate.&quot;&quot;&quot;</span>

        <span class="c1"># Select random tips for variety</span>
        <span class="n">selected_tips</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
            <span class="n">tips</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Focus on clarity and conciseness&quot;</span><span class="p">],</span>
            <span class="nb">min</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tips</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Get random demonstration for reference</span>
        <span class="n">demo</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trainset</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>

        <span class="c1"># Generate instruction</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instruction_generator</span><span class="p">(</span>
            <span class="n">task_description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_task_description</span><span class="p">(),</span>
            <span class="n">constraints</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_format_constraints</span><span class="p">(</span><span class="n">constraints</span><span class="p">),</span>
            <span class="n">edge_cases</span><span class="o">=</span><span class="n">constraints</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;edge_cases&#39;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="n">tips</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">tip</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">tip</span> <span class="ow">in</span> <span class="n">selected_tips</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">optimized_instruction</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_evaluate_on_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">:</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">dspy</span><span class="o">.</span><span class="n">Example</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate program on a mini-batch.&quot;&quot;&quot;</span>

        <span class="n">total_score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">valid_examples</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Get prediction</span>
                <span class="n">prediction</span> <span class="o">=</span> <span class="n">program</span><span class="p">(</span><span class="o">**</span><span class="n">example</span><span class="o">.</span><span class="n">inputs</span><span class="p">())</span>

                <span class="c1"># Evaluate</span>
                <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">total_score</span> <span class="o">+=</span> <span class="n">score</span>
                <span class="n">valid_examples</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Error evaluating example: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

        <span class="k">return</span> <span class="n">total_score</span> <span class="o">/</span> <span class="n">valid_examples</span> <span class="k">if</span> <span class="n">valid_examples</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_optimized_program</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">best_instruction</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create the final optimized program.&quot;&quot;&quot;</span>

        <span class="c1"># Clone the original program</span>
        <span class="n">optimized_program</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clone_program</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">program</span><span class="p">)</span>

        <span class="c1"># Update all Predict modules with optimized instruction</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">optimized_program</span><span class="o">.</span><span class="n">named_modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">):</span>
                <span class="n">module</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">instruction</span><span class="o">=</span><span class="n">best_instruction</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">optimized_program</span>
</pre></div>
</div>
</section>
<section id="routing-agent-optimization-example">
<h3>2. Routing Agent Optimization Example<a class="headerlink" href="#routing-agent-optimization-example" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">RoutingAgentOptimizer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Example: Optimizing a routing agent using CustomMIPROv2.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Define the routing signature</span>
        <span class="k">class</span><span class="w"> </span><span class="nc">RouterSignature</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Signature</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Read the conversation and select the next role from roles_list</span>
<span class="sd">            to play. Only return the role.&quot;&quot;&quot;</span>
            <span class="n">conversation</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">InputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Current conversation history&quot;</span><span class="p">)</span>
            <span class="n">roles_list</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">InputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;List of available roles&quot;</span><span class="p">)</span>
            <span class="n">roles</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">InputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Role descriptions&quot;</span><span class="p">)</span>
            <span class="n">selected_role</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">OutputField</span><span class="p">(</span>
                <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Selected role from the list&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">signature</span> <span class="o">=</span> <span class="n">RouterSignature</span>

        <span class="c1"># Base program</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_program</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">)</span>

        <span class="c1"># Training data (conversations with correct role selections)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trainset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_routing_examples</span><span class="p">(</span><span class="s2">&quot;routing_train.json&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_routing_examples</span><span class="p">(</span><span class="s2">&quot;routing_val.json&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">optimize_routing_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Optimize the routing agent for better performance.&quot;&quot;&quot;</span>

        <span class="c1"># Define domain-specific constraints</span>
        <span class="n">routing_constraints</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">OptimizationConstraint</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;task_completion&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;If the last role didn&#39;t complete their task, they must be selected again&quot;</span><span class="p">,</span>
                <span class="n">priority</span><span class="o">=</span><span class="s2">&quot;HIGH&quot;</span>
            <span class="p">),</span>
            <span class="n">OptimizationConstraint</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;conversation_flow&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Consider the flow and tone when selecting roles&quot;</span><span class="p">,</span>
                <span class="n">priority</span><span class="o">=</span><span class="s2">&quot;MEDIUM&quot;</span>
            <span class="p">),</span>
            <span class="n">OptimizationConstraint</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;role_availability&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Only select from the provided roles list&quot;</span><span class="p">,</span>
                <span class="n">priority</span><span class="o">=</span><span class="s2">&quot;HIGH&quot;</span>
            <span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># Define optimization tips</span>
        <span class="n">optimization_tips</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;The model should be aware of conversation context and tone&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Consider the current state of task completion&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Match role selection to conversation needs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Maintain conversation coherence and flow&quot;</span>
        <span class="p">]</span>

        <span class="c1"># Define evaluation metric</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">routing_metric</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Evaluate routing accuracy.&quot;&quot;&quot;</span>
            <span class="n">expected_role</span> <span class="o">=</span> <span class="n">example</span><span class="o">.</span><span class="n">outputs</span><span class="p">()[</span><span class="s1">&#39;selected_role&#39;</span><span class="p">]</span>
            <span class="n">predicted_role</span> <span class="o">=</span> <span class="n">prediction</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;selected_role&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">predicted_role</span> <span class="o">==</span> <span class="n">expected_role</span> <span class="k">else</span> <span class="mf">0.0</span>

        <span class="c1"># Initialize CustomMIPROv2</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">CustomMIPROv2</span><span class="p">(</span>
            <span class="n">teacher_model</span><span class="o">=</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span>
            <span class="n">student_model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">,</span>
            <span class="n">num_trials</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
            <span class="n">mini_batch_size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
            <span class="n">temperature</span><span class="o">=</span><span class="mf">0.5</span>
        <span class="p">)</span>

        <span class="c1"># Compile optimized program</span>
        <span class="n">optimized_program</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
            <span class="n">program</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_program</span><span class="p">,</span>
            <span class="n">trainset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trainset</span><span class="p">,</span>
            <span class="n">valset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">valset</span><span class="p">,</span>
            <span class="n">metric</span><span class="o">=</span><span class="n">routing_metric</span><span class="p">,</span>
            <span class="n">tips</span><span class="o">=</span><span class="n">optimization_tips</span><span class="p">,</span>
            <span class="n">constraints</span><span class="o">=</span><span class="n">routing_constraints</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">optimized_program</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_routing_examples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">dspy</span><span class="o">.</span><span class="n">Example</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load routing examples from file.&quot;&quot;&quot;</span>
        <span class="c1"># Implementation depends on data format</span>
        <span class="n">examples</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Sample data structure</span>
        <span class="n">sample_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;conversation&quot;</span><span class="p">:</span> <span class="s2">&quot;User: I need help with the report</span><span class="se">\n</span><span class="s2">Admin: I&#39;ll help you with that&quot;</span><span class="p">,</span>
            <span class="s2">&quot;roles&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Human_Administrator&quot;</span><span class="p">,</span> <span class="s2">&quot;Project_Manager&quot;</span><span class="p">,</span> <span class="s2">&quot;Software_Engineer&quot;</span><span class="p">],</span>
            <span class="s2">&quot;selected_role&quot;</span><span class="p">:</span> <span class="s2">&quot;Human_Administrator&quot;</span>
        <span class="p">}</span>

        <span class="c1"># Convert to DSPy examples</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">load_json</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="n">example</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Example</span><span class="p">(</span>
                <span class="n">conversation</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;conversation&quot;</span><span class="p">],</span>
                <span class="n">roles_list</span><span class="o">=</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;roles&quot;</span><span class="p">]),</span>
                <span class="n">roles</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;roles&quot;</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">with_outputs</span><span class="p">(</span><span class="n">selected_role</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;selected_role&quot;</span><span class="p">])</span>
            <span class="n">examples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">example</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">examples</span>
</pre></div>
</div>
</section>
<section id="prompt-evaluator-optimization">
<h3>3. Prompt Evaluator Optimization<a class="headerlink" href="#prompt-evaluator-optimization" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">PromptEvaluatorOptimizer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Example: Optimizing a prompt evaluator for contradiction detection.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Define evaluation signature</span>
        <span class="k">class</span><span class="w"> </span><span class="nc">ContradictionSignature</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Signature</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Evaluate the prompt on a scale from 0.0 (high contradiction)</span>
<span class="sd">            to 1.0 (no contradiction) based on internal consistency.&quot;&quot;&quot;</span>
            <span class="n">prompt</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">InputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;The prompt to evaluate&quot;</span><span class="p">)</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">OutputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Score between 0.0 and 1.0&quot;</span><span class="p">)</span>
            <span class="n">explanation</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">OutputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Explanation of the score&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">signature</span> <span class="o">=</span> <span class="n">ContradictionSignature</span>

        <span class="c1"># Load contradiction detection dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trainset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_contradiction_examples</span><span class="p">(</span><span class="s2">&quot;contradictions_train.json&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_contradiction_examples</span><span class="p">(</span><span class="s2">&quot;contradictions_val.json&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">optimize_contradiction_detector</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Optimize contradiction detection with specific constraints.&quot;&quot;&quot;</span>

        <span class="c1"># Define contradiction-specific constraints</span>
        <span class="n">contradiction_constraints</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">OptimizationConstraint</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;format_contradiction&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Check if output format conflicts with instructions&quot;</span><span class="p">,</span>
                <span class="n">priority</span><span class="o">=</span><span class="s2">&quot;HIGH&quot;</span><span class="p">,</span>
                <span class="n">examples</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Instructions say &#39;no examples&#39; but examples are provided&quot;</span><span class="p">]</span>
            <span class="p">),</span>
            <span class="n">OptimizationConstraint</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;instruction_contradiction&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Check for conflicting instructions&quot;</span><span class="p">,</span>
                <span class="n">priority</span><span class="o">=</span><span class="s2">&quot;HIGH&quot;</span><span class="p">,</span>
                <span class="n">examples</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Do X AND Don&#39;t do X&quot;</span><span class="p">]</span>
            <span class="p">),</span>
            <span class="n">OptimizationConstraint</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;example_contradiction&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Check if examples don&#39;t follow instructions&quot;</span><span class="p">,</span>
                <span class="n">priority</span><span class="o">=</span><span class="s2">&quot;MEDIUM&quot;</span><span class="p">,</span>
                <span class="n">examples</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Example shows different format than instructed&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># Custom tip for contradiction detection</span>
        <span class="n">contradiction_tips</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;Carefully examine all instruction pairs for conflicts&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Verify that examples strictly follow the instructions&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Check for ambiguous or conflicting requirements&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Score 0.0 if ANY contradiction is found&quot;</span>
        <span class="p">]</span>

        <span class="c1"># Evaluation metric</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">contradiction_metric</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Evaluate contradiction detection accuracy.&quot;&quot;&quot;</span>
            <span class="n">predicted_score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">prediction</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;score&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
            <span class="n">expected_label</span> <span class="o">=</span> <span class="n">example</span><span class="o">.</span><span class="n">outputs</span><span class="p">()[</span><span class="s1">&#39;has_contradiction&#39;</span><span class="p">]</span>
            <span class="n">predicted_label</span> <span class="o">=</span> <span class="n">predicted_score</span> <span class="o">&lt;</span> <span class="mf">0.6</span>

            <span class="k">return</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">predicted_label</span> <span class="o">==</span> <span class="n">expected_label</span> <span class="k">else</span> <span class="mf">0.0</span>

        <span class="c1"># Initialize optimizer</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">CustomMIPROv2</span><span class="p">(</span>
            <span class="n">num_trials</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">mini_batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">temperature</span><span class="o">=</span><span class="mf">0.5</span>
        <span class="p">)</span>

        <span class="c1"># Optimize</span>
        <span class="n">optimized_detector</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
            <span class="n">program</span><span class="o">=</span><span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">),</span>
            <span class="n">trainset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trainset</span><span class="p">,</span>
            <span class="n">valset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">valset</span><span class="p">,</span>
            <span class="n">metric</span><span class="o">=</span><span class="n">contradiction_metric</span><span class="p">,</span>
            <span class="n">tips</span><span class="o">=</span><span class="n">contradiction_tips</span><span class="p">,</span>
            <span class="n">constraints</span><span class="o">=</span><span class="n">contradiction_constraints</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">optimized_detector</span>
</pre></div>
</div>
</section>
<section id="code-generation-optimization">
<h3>4. Code Generation Optimization<a class="headerlink" href="#code-generation-optimization" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CodeGenerationOptimizer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Example: Optimizing code generation with CustomMIPROv2.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Code generation signature</span>
        <span class="k">class</span><span class="w"> </span><span class="nc">CodeGenSignature</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Signature</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Generate pandas code to answer the user&#39;s question.&quot;&quot;&quot;</span>
            <span class="n">question</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">InputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;User&#39;s data analysis question&quot;</span><span class="p">)</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">InputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Available columns and sample values&quot;</span><span class="p">)</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">OutputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Generated pandas code&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">signature</span> <span class="o">=</span> <span class="n">CodeGenSignature</span>

        <span class="c1"># Load code generation dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trainset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_code_examples</span><span class="p">(</span><span class="s2">&quot;code_train.json&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_code_examples</span><span class="p">(</span><span class="s2">&quot;code_val.json&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">optimize_code_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Optimize code generation with quality constraints.&quot;&quot;&quot;</span>

        <span class="c1"># Code quality constraints</span>
        <span class="n">code_constraints</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">OptimizationConstraint</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;executable_code&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Generated code must be syntactically correct and executable&quot;</span><span class="p">,</span>
                <span class="n">priority</span><span class="o">=</span><span class="s2">&quot;HIGH&quot;</span>
            <span class="p">),</span>
            <span class="n">OptimizationConstraint</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;efficiency&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Code should be efficient and not overly complex&quot;</span><span class="p">,</span>
                <span class="n">priority</span><span class="o">=</span><span class="s2">&quot;MEDIUM&quot;</span>
            <span class="p">),</span>
            <span class="n">OptimizationConstraint</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;relevance&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Code must directly address the user&#39;s question&quot;</span><span class="p">,</span>
                <span class="n">priority</span><span class="o">=</span><span class="s2">&quot;HIGH&quot;</span>
            <span class="p">),</span>
            <span class="n">OptimizationConstraint</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;readability&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Include appropriate comments and clear structure&quot;</span><span class="p">,</span>
                <span class="n">priority</span><span class="o">=</span><span class="s2">&quot;LOW&quot;</span>
            <span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># Code generation tips</span>
        <span class="n">code_tips</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;Use pandas built-in methods when possible&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Handle potential errors or edge cases&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Keep code concise but complete&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Add minimal but helpful comments&quot;</span>
        <span class="p">]</span>

        <span class="c1"># LLM-as-a-Judge for code evaluation</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">code_quality_metric</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Evaluate generated code quality using LLM judge.&quot;&quot;&quot;</span>

            <span class="n">code</span> <span class="o">=</span> <span class="n">prediction</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">question</span> <span class="o">=</span> <span class="n">example</span><span class="o">.</span><span class="n">inputs</span><span class="p">()[</span><span class="s1">&#39;question&#39;</span><span class="p">]</span>

            <span class="c1"># Create judge prompt</span>
            <span class="n">judge</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">ChainOfThought</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Evaluate the generated code for the given question.</span>

<span class="sd">                Question: {question}</span>
<span class="sd">                Generated Code: {code}</span>

<span class="sd">                Evaluate on:</span>
<span class="sd">                1. Correctness (0-1): Does it solve the problem correctly?</span>
<span class="sd">                2. Efficiency (0-1): Is it reasonably efficient?</span>
<span class="sd">                3. Readability (0-1): Is it well-structured?</span>

<span class="sd">                Overall Score (0-1):&quot;&quot;&quot;</span>
            <span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">judge</span><span class="p">(</span><span class="n">question</span><span class="o">=</span><span class="n">question</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">)</span>
            <span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">overall_score</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s1">&#39;overall_score&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.5</span>

            <span class="k">return</span> <span class="n">score</span>

        <span class="c1"># Initialize optimizer</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">CustomMIPROv2</span><span class="p">(</span>
            <span class="n">num_trials</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
            <span class="n">mini_batch_size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
            <span class="n">temperature</span><span class="o">=</span><span class="mf">0.3</span>
        <span class="p">)</span>

        <span class="c1"># Optimize</span>
        <span class="n">optimized_generator</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
            <span class="n">program</span><span class="o">=</span><span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">),</span>
            <span class="n">trainset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trainset</span><span class="p">,</span>
            <span class="n">valset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">valset</span><span class="p">,</span>
            <span class="n">metric</span><span class="o">=</span><span class="n">code_quality_metric</span><span class="p">,</span>
            <span class="n">tips</span><span class="o">=</span><span class="n">code_tips</span><span class="p">,</span>
            <span class="n">constraints</span><span class="o">=</span><span class="n">code_constraints</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">optimized_generator</span>
</pre></div>
</div>
</section>
</section>
<section id="implementation-guide">
<h2>Implementation Guide<a class="headerlink" href="#implementation-guide" title="Link to this heading">#</a></h2>
<section id="basic-usage">
<h3>1. Basic Usage<a class="headerlink" href="#basic-usage" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define your DSPy program</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MyProgram</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predict</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span><span class="s2">&quot;question -&gt; answer&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">question</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">question</span><span class="o">=</span><span class="n">question</span><span class="p">)</span>

<span class="c1"># Create training and validation sets</span>
<span class="n">trainset</span> <span class="o">=</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="n">valset</span> <span class="o">=</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span>

<span class="c1"># Define evaluation metric</span>
<span class="k">def</span><span class="w"> </span><span class="nf">my_metric</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Your metric logic</span>
    <span class="k">return</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">prediction</span><span class="o">.</span><span class="n">answer</span> <span class="o">==</span> <span class="n">example</span><span class="o">.</span><span class="n">answer</span> <span class="k">else</span> <span class="mf">0.0</span>

<span class="c1"># Initialize CustomMIPROv2</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">CustomMIPROv2</span><span class="p">(</span>
    <span class="n">teacher_model</span><span class="o">=</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span>
    <span class="n">student_model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">,</span>
    <span class="n">num_trials</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">mini_batch_size</span><span class="o">=</span><span class="mi">15</span>
<span class="p">)</span>

<span class="c1"># Optimize</span>
<span class="n">optimized_program</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="n">program</span><span class="o">=</span><span class="n">MyProgram</span><span class="p">(),</span>
    <span class="n">trainset</span><span class="o">=</span><span class="n">trainset</span><span class="p">,</span>
    <span class="n">valset</span><span class="o">=</span><span class="n">valset</span><span class="p">,</span>
    <span class="n">metric</span><span class="o">=</span><span class="n">my_metric</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="using-constraints-and-tips">
<h3>2. Using Constraints and Tips<a class="headerlink" href="#using-constraints-and-tips" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define constraints</span>
<span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">OptimizationConstraint</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;safety&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Never provide harmful or unsafe content&quot;</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="s2">&quot;HIGH&quot;</span>
    <span class="p">),</span>
    <span class="n">OptimizationConstraint</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;clarity&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Use clear and unambiguous language&quot;</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="s2">&quot;MEDIUM&quot;</span>
    <span class="p">)</span>
<span class="p">]</span>

<span class="c1"># Define tips</span>
<span class="n">tips</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Consider safety implications before answering&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Provide structured responses when possible&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Acknowledge uncertainty when appropriate&quot;</span>
<span class="p">]</span>

<span class="c1"># Compile with constraints and tips</span>
<span class="n">optimized</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="n">program</span><span class="o">=</span><span class="n">MyProgram</span><span class="p">(),</span>
    <span class="n">trainset</span><span class="o">=</span><span class="n">trainset</span><span class="p">,</span>
    <span class="n">valset</span><span class="o">=</span><span class="n">valset</span><span class="p">,</span>
    <span class="n">metric</span><span class="o">=</span><span class="n">my_metric</span><span class="p">,</span>
    <span class="n">tips</span><span class="o">=</span><span class="n">tips</span><span class="p">,</span>
    <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="extracting-and-using-optimized-prompts">
<h3>3. Extracting and Using Optimized Prompts<a class="headerlink" href="#extracting-and-using-optimized-prompts" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the optimized instruction</span>
<span class="n">optimized_instruction</span> <span class="o">=</span> <span class="n">optimized_program</span><span class="o">.</span><span class="n">predict</span><span class="o">.</span><span class="n">instruction</span>

<span class="c1"># Use outside DSPy (with caution)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">use_optimized_prompt_elsewhere</span><span class="p">():</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">openai</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">openai</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">,</span>
        <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">optimized_instruction</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Your input here&quot;</span><span class="p">}</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>

<span class="c1"># Note: Performance may vary outside DSPy context</span>
</pre></div>
</div>
</section>
</section>
<section id="key-results-from-paper">
<h2>Key Results from Paper<a class="headerlink" href="#key-results-from-paper" title="Link to this heading">#</a></h2>
<ol class="arabic simple">
<li><p><strong>Routing Agent</strong>: Improved from 85.71% to 90.47% accuracy (5% absolute improvement)</p></li>
<li><p><strong>Prompt Evaluator</strong>: Improved from 46.2% to 76.9% accuracy (30% absolute improvement)</p></li>
<li><p><strong>Code Generation</strong>: Achieved 90% accuracy with optimized prompts</p></li>
<li><p><strong>Jailbreak Detection</strong>: Maintained perfect recall while improving precision</p></li>
<li><p><strong>Hallucination Detection</strong>: Up to 82% accuracy with optimized examples</p></li>
</ol>
</section>
<section id="best-practices">
<h2>Best Practices<a class="headerlink" href="#best-practices" title="Link to this heading">#</a></h2>
<ol class="arabic simple">
<li><p><strong>Clear Constraints</strong>: Define specific, actionable constraints with examples</p></li>
<li><p><strong>Domain-Specific Tips</strong>: Provide tips that are relevant to your task domain</p></li>
<li><p><strong>Appropriate Mini-Batch Size</strong>: Balance evaluation cost with accuracy</p></li>
<li><p><strong>Sufficient Trials</strong>: Use enough trials to explore the instruction space</p></li>
<li><p><strong>Metric Design</strong>: Ensure metrics capture important aspects of performance</p></li>
</ol>
</section>
<section id="advanced-features">
<h2>Advanced Features<a class="headerlink" href="#advanced-features" title="Link to this heading">#</a></h2>
<section id="constraint-prioritization">
<h3>1. Constraint Prioritization<a class="headerlink" href="#constraint-prioritization" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">PrioritizedCustomMIPROv2</span><span class="p">(</span><span class="n">CustomMIPROv2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enhanced version with constraint prioritization.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_format_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraints</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Format constraints with priority information.&quot;&quot;&quot;</span>

        <span class="n">formatted</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">constraints</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;high_priority&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">formatted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MUST: </span><span class="si">{</span><span class="n">constraint</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">constraints</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;medium_priority&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">formatted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SHOULD: </span><span class="si">{</span><span class="n">constraint</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">constraints</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;low_priority&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">formatted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;COULD: </span><span class="si">{</span><span class="n">constraint</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">formatted</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="adaptive-trial-management">
<h3>2. Adaptive Trial Management<a class="headerlink" href="#adaptive-trial-management" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AdaptiveCustomMIPROv2</span><span class="p">(</span><span class="n">CustomMIPROv2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Version with adaptive trial management.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">optimize_instructions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraints</span><span class="p">,</span> <span class="n">tips</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Optimize with early stopping based on improvement.&quot;&quot;&quot;</span>

        <span class="n">best_score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">no_improvement_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">max_no_improvement</span> <span class="o">=</span> <span class="mi">5</span>

        <span class="k">for</span> <span class="n">trial</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_trials</span><span class="p">):</span>
            <span class="c1"># Generate and evaluate candidate</span>
            <span class="n">candidate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_instruction_candidate</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="n">tips</span><span class="p">,</span> <span class="n">trial</span><span class="p">)</span>
            <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_candidate</span><span class="p">(</span><span class="n">candidate</span><span class="p">)</span>

            <span class="c1"># Check for improvement</span>
            <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">best_score</span><span class="p">:</span>
                <span class="n">best_score</span> <span class="o">=</span> <span class="n">score</span>
                <span class="n">best_instruction</span> <span class="o">=</span> <span class="n">candidate</span>
                <span class="n">no_improvement_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">no_improvement_count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Early stopping</span>
            <span class="k">if</span> <span class="n">no_improvement_count</span> <span class="o">&gt;=</span> <span class="n">max_no_improvement</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Early stopping at trial </span><span class="si">{</span><span class="n">trial</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">best_instruction</span>
</pre></div>
</div>
</section>
</section>
<section id="limitations-and-considerations">
<h2>Limitations and Considerations<a class="headerlink" href="#limitations-and-considerations" title="Link to this heading">#</a></h2>
<ol class="arabic simple">
<li><p><strong>Extraction Overhead</strong>: Two-stage process increases optimization time</p></li>
<li><p><strong>Constraint Quality</strong>: Poorly defined constraints can hurt performance</p></li>
<li><p><strong>Mini-Batch Representativeness</strong>: Small batches may not represent full validation set</p></li>
<li><p><strong>Context Transfer</strong>: Optimized prompts may perform differently outside DSPy</p></li>
<li><p><strong>Compute Cost</strong>: Multiple trials increase API costs</p></li>
</ol>
</section>
<section id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Link to this heading">#</a></h2>
<p>CustomMIPROv2 addresses practical challenges in prompt optimization for production systems. By separating constraint extraction from instruction generation and providing explicit control through constraints and tips, it enables more targeted and effective optimization. The framework demonstrates that systematic optimization can significantly improve performance across diverse tasks, from routing agents to code generation, making it a valuable tool for real-world DSPy applications.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./content/05_optimizers"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="24_inpars_plus_synthetic_data_ir.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">InPars+: Advanced Synthetic Data Generation for Information Retrieval</p>
      </div>
    </a>
    <a class="right-next"
       href="26_automatic_prompt_optimization_research.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Automatic Prompt Optimization: When AI Outperforms Humans</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#key-enhancements">Key Enhancements</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#architecture">Architecture</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#two-stage-optimization-process">1. Two-Stage Optimization Process</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#routing-agent-optimization-example">2. Routing Agent Optimization Example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#prompt-evaluator-optimization">3. Prompt Evaluator Optimization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#code-generation-optimization">4. Code Generation Optimization</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation-guide">Implementation Guide</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#basic-usage">1. Basic Usage</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-constraints-and-tips">2. Using Constraints and Tips</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-and-using-optimized-prompts">3. Extracting and Using Optimized Prompts</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#key-results-from-paper">Key Results from Paper</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#best-practices">Best Practices</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-features">Advanced Features</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#constraint-prioritization">1. Constraint Prioritization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#adaptive-trial-management">2. Adaptive Trial Management</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#limitations-and-considerations">Limitations and Considerations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">Conclusion</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Dustin Ober
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
       Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>