
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>COPA: Compiler and Prompt Optimization &#8212; DSPy: The Complete Guide</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=9c3e77be" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=1ae7504c"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'content/05_optimizers/09_copa_compiler_method';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="COPA: Combined Fine-Tuning and Prompt Optimization" href="09a_copa_method.html" />
    <link rel="prev" title="Reflective Prompt Evolution (RPE): Evolutionary Optimization Without Gradients" href="08_reflective_prompt_evolution.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../00_frontmatter/00_preface.html">
  
  
  
  
  
  
    <p class="title logo__title">DSPy: The Complete Guide</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../00_frontmatter/01_how_to_use_this_book.html">How to Use This Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_frontmatter/02_prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_frontmatter/03_setup_instructions.html">Setup Instructions</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 1 - Fundamentals</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../01_fundamentals/00_chapter_intro.html">Chapter 1: DSPy Fundamentals</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../01_fundamentals/01_what_is_dspy.html">What is DSPy?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01_fundamentals/02_programming_vs_prompting.html">Programming vs. Prompting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01_fundamentals/03_installation_setup.html">Installation and Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01_fundamentals/04_first_dspy_program.html">Your First DSPy Program</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01_fundamentals/05_language_models.html">Language Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01_fundamentals/06_exercises.html">Chapter 1 Exercises</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 2 - Signatures</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../02_signatures/00_chapter_intro.html">Chapter 2: Signatures</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../02_signatures/01_understanding_signatures.html">Understanding Signatures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02_signatures/02_signature_syntax.html">Signature Syntax</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02_signatures/03_typed_signatures.html">Typed Signatures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02_signatures/04_advanced_signatures.html">Advanced Signatures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02_signatures/05_practical_examples.html">Practical Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02_signatures/06_exercises.html">Chapter 2 Exercises</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 3 - Modules</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../03_modules/00_chapter_intro.html">Chapter 3: Modules</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../03_modules/01_module_basics.html">Module Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03_modules/02_predict_module.html">The Predict Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03_modules/02a_typed_predictor.html">TypedPredictor: Type-Safe Language Model Wrappers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03_modules/03_chainofthought.html">Chain of Thought Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03_modules/04_react_agents.html">ReAct Agents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03_modules/05_custom_modules.html">Custom Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03_modules/06_composing_modules.html">Composing Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03_modules/07_exercises.html">Chapter 3 Exercises</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03_modules/08_assertions.html">Assertions Module</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 4 - Evaluation</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../04_evaluation/00_chapter_intro.html">Chapter 4: Evaluation</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/01_why_evaluation_matters.html">Why Evaluation Matters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/02_creating_datasets.html">Creating Datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/03_defining_metrics.html">Defining Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/04_evaluation_loops.html">Evaluation Loops</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/05_best_practices.html">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/06_exercises.html">Exercises</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/07_structured_prompting.html">Structured Prompting for Robust Evaluation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/08_llm_as_a_judge.html">LLM-as-a-Judge for Context-Sensitive Evaluation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/09_human_aligned_evaluation.html">Human-Aligned Evaluation: Capturing What Really Matters</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 5 - Optimizers</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="00_chapter_intro.html">Chapter 5: Optimizers &amp; Compilation</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="01_compilation_concept.html">The Compilation Concept in DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="02_bootstrapfewshot.html">BootstrapFewShot: Automatic Few-Shot Example Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="02a_copro.html">COPRO: Chain-of-Thought Prompt Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="03_mipro.html">MIPRO: Multi-step Instruction and Demonstration Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="04_knnfewshot.html">KNNFewShot: Similarity-Based Example Selection</a></li>
<li class="toctree-l2"><a class="reference internal" href="05_finetuning.html">Fine-Tuning Small Language Models in DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="06_choosing_optimizers.html">Choosing Optimizers: Decision Guide and Trade-offs</a></li>
<li class="toctree-l2"><a class="reference internal" href="07_constraint_driven_optimization.html">Constraint-Driven Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="07_exercises.html">Chapter 5 Exercises: Optimizers &amp; Compilation</a></li>
<li class="toctree-l2"><a class="reference internal" href="08_reflective_prompt_evolution.html">Reflective Prompt Evolution (RPE): Evolutionary Optimization Without Gradients</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">COPA: Compiler and Prompt Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="09a_copa_method.html">COPA: Combined Fine-Tuning and Prompt Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="10_joint_optimization.html">Joint Optimization: Fine-Tuning and Prompt Synergy</a></li>
<li class="toctree-l2"><a class="reference internal" href="11_monte_carlo_optimization.html">Monte Carlo Optimization in DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="12_bayesian_optimization.html">Bayesian Optimization for Prompt Tuning</a></li>
<li class="toctree-l2"><a class="reference internal" href="13_comprehensive_examples.html">Comprehensive Examples and Implementation Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="14_multistage_optimization_theory.html">Multi-stage Optimization Theory</a></li>
<li class="toctree-l2"><a class="reference internal" href="15_instruction_tuning_frameworks.html">Instruction Tuning Frameworks</a></li>
<li class="toctree-l2"><a class="reference internal" href="16_demonstration_optimization.html">Demonstration Optimization Strategies</a></li>
<li class="toctree-l2"><a class="reference internal" href="17_multistage_architectures.html">Multi-stage Program Architectures</a></li>
<li class="toctree-l2"><a class="reference internal" href="18_complex_pipeline_optimization.html">Optimization Strategies for Complex Pipelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="19_instruction_demonstration_interactions.html">Instruction and Demonstration Interaction Effects</a></li>
<li class="toctree-l2"><a class="reference internal" href="20_prompts_as_hyperparameters.html">Prompts as Auto-Optimized Hyperparameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="21_minimal_data_pipelines.html">Minimal Data Training Pipelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="22_gepa_genetic_pareto_optimization.html">GEPA: Genetic-Pareto Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="23_state_space_prompt_optimization.html">State-Space Search for Prompt Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="24_inpars_plus_synthetic_data_ir.html">InPars+: Advanced Synthetic Data Generation for Information Retrieval</a></li>
<li class="toctree-l2"><a class="reference internal" href="25_custom_mipro_enhanced_optimization.html">CustomMIPROv2: Enhanced Multi-Stage Prompt Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="26_automatic_prompt_optimization_research.html">Automatic Prompt Optimization: When AI Outperforms Humans</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 6 - Real-World Applications</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../06_real_world_applications/00_chapter_intro.html">Chapter 6: Building Real-World Applications</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/01_rag_systems.html">RAG Systems: Building Intelligent Document Q&amp;A</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/02_multi_hop_search.html">Multi-hop Search: Complex Reasoning Across Documents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/03_classification_tasks.html">Classification Tasks: Building Robust Text Categorization Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/04_entity_extraction.html">Entity Extraction: Mining Structured Information from Text</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/05_intelligent_agents.html">Intelligent Agents: Building Autonomous Problem-Solving Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/06_code_generation.html">Code Generation: Building Automated Programming Assistants</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/07_exercises.html">Chapter 6 Exercises: Building Real-World Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/07a_perspective_driven_research.html">Perspective-Driven Research for Article Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/08_extreme_multilabel_classification.html">Extreme Multi-Label Classification: Scaling to Millions of Labels</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/08a_long_form_generation.html">Long-form Article Generation with DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/09_outline_generation.html">Outline Generation for Structured Article Writing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/11_extreme_few_shot_learning.html">Extreme Few-Shot Learning: Training with 10 Gold Labels</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/12_ir_model_training_scratch.html">IR Model Training from Scratch: Methodology and Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/13_lingvarbench_healthcare_synthetic_data.html">LingVarBench: Synthetic Healthcare Transcript Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/14_scientific_figure_caption_generation.html">Scientific Figure Caption Generation with DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/15_retrieval_augmented_guardrails.html">Retrieval-Augmented Guardrails for AI Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/16_graphrag_wikipedia_tidb_tutorial.html">GraphRAG from Wikipedia: Building with DSPy, OpenAI, and TiDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/17_framework_comparisons_dspy_ecosystem.html">Framework Comparisons in the DSPy Ecosystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/18_multi_agent_rag_systems.html">Multi-Agent RAG Systems with DSPy</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 7 - Advanced Topics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../07_advanced_topics/00_chapter_intro.html">Chapter 7: Advanced Topics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/01_adapters_tools.html">Adapters and Tools: Extending DSPy Capabilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/02_caching_performance.html">Caching and Performance: Building High-Performance DSPy Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/03_async_streaming.html">Async and Streaming: Building Real-Time DSPy Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/04_debugging_tracing.html">Debugging and Tracing: Mastering DSPy Application Diagnostics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/05_deployment_strategies.html">Deployment Strategies: Taking DSPy Applications to Production</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/06_exercises.html">Chapter 7 Exercises: Advanced Topics Mastery</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/07_self_refining_pipelines.html">Self-Refining Pipelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/08_declarative_compilation.html">Declarative Language Model Compilation Techniques</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 8 - Case Studies</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../08_case_studies/00_introduction.html">Chapter 8: Case Studies</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/01_enterprise_rag_system.html">Case Study 1: Building an Enterprise RAG System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/01a_healthcare_clinical_notes.html">Case Study 1: Clinical Notes Analysis with DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/02_customer_support_chatbot.html">Case Study 2: Developing a Customer Support Chatbot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/03_ai_code_assistant.html">Case Study 3: Creating an AI-Powered Code Assistant</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/04_automated_data_analysis.html">Case Study 4: Building an Automated Data Analysis Pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/05_exercises.html">Chapter 8 Exercises</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/05a_storm_writing_assistant.html">Case Study 5: STORM - AI-Powered Writing Assistant for Wikipedia-like Articles</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/06_assertion_driven_applications.html">Case Study: Assertion-Driven Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/07_databricks_jetblue_llm_optimization.html">Case Study 7: Databricks &amp; JetBlue LLM Pipeline Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/08_replit_code_repair_dspy.html">Case Study 8: Replit Code Repair with DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/09_databricks_dspy_platform_integration.html">Case Study 9: Databricks Platform Integration with DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/10_ddi_behavioral_simulation_automation.html">Case Study 10: DDI Behavioral Simulation Automation with DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/11_salomatic_medical_report_generation.html">Case Study 11: Salomatic Medical Report Generation with DSPy and Langtrace</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../09_appendices/00_introduction.html">Chapter 9: Appendices</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../09_appendices/01_api_reference_quick.html">API Reference Quick Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09_appendices/02_troubleshooting.html">Troubleshooting Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09_appendices/03_resources.html">Additional Resources</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09_appendices/04_glossary.html">Glossary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09_appendices/05_community_resources.html">Community Resources and Perspectives</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/content/05_optimizers/09_copa_compiler_method.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>COPA: Compiler and Prompt Optimization</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-objectives">Learning Objectives</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-copa-framework">The COPA Framework</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#core-principles">Core Principles</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-two-phase-optimization-process">The Two-Phase Optimization Process</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#phase-1-compilation-optimization">Phase 1: Compilation Optimization</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#phase-2-prompt-optimization">Phase 2: Prompt Optimization</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#detailed-implementation">Detailed Implementation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#compilation-phase">Compilation Phase</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#prompt-phase">Prompt Phase</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#knowledge-transfer-mechanism">Knowledge Transfer Mechanism</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-copa-features">Advanced COPA Features</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#adaptive-optimization-strategy">Adaptive Optimization Strategy</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multi-task-copa">Multi-Task COPA</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#practical-examples">Practical Examples</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-1-complex-question-answering">Example 1: Complex Question Answering</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-2-code-generation-with-constraints">Example 2: Code Generation with Constraints</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#performance-evaluation">Performance Evaluation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparative-analysis">Comparative Analysis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#optimization-trajectory-analysis">Optimization Trajectory Analysis</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#best-practices">Best Practices</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#when-to-use-copa">When to Use COPA</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration-guidelines">Configuration Guidelines</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#common-pitfalls-and-solutions">Common Pitfalls and Solutions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#key-takeaways">Key Takeaways</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="copa-compiler-and-prompt-optimization">
<h1>COPA: Compiler and Prompt Optimization<a class="headerlink" href="#copa-compiler-and-prompt-optimization" title="Link to this heading">#</a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<p>COPA (Compiler and Prompt Optimization) is an advanced optimization framework in DSPy that synergistically combines compilation techniques with prompt engineering to achieve superior performance. Unlike traditional optimization methods that focus on either parameter tuning or prompt refinement, COPA treats compilation and prompt optimization as two interconnected processes that work together to maximize model performance.</p>
<section id="learning-objectives">
<h3>Learning Objectives<a class="headerlink" href="#learning-objectives" title="Link to this heading">#</a></h3>
<p>By the end of this section, you will:</p>
<ul class="simple">
<li><p>Understand the COPA methodology and its theoretical foundations</p></li>
<li><p>Learn how to implement COPA in DSPy programs</p></li>
<li><p>Master the integration of compilation and prompt optimization</p></li>
<li><p>Apply COPA to complex multi-task scenarios</p></li>
<li><p>Evaluate and compare COPA performance against other optimizers</p></li>
</ul>
</section>
</section>
<section id="the-copa-framework">
<h2>The COPA Framework<a class="headerlink" href="#the-copa-framework" title="Link to this heading">#</a></h2>
<section id="core-principles">
<h3>Core Principles<a class="headerlink" href="#core-principles" title="Link to this heading">#</a></h3>
<p>COPA is built on three fundamental principles:</p>
<ol class="arabic simple">
<li><p><strong>Unified Optimization Space</strong>: Treats model parameters and prompts as a single optimization space</p></li>
<li><p><strong>Iterative Refinement</strong>: Alternates between compilation and prompt optimization</p></li>
<li><p><strong>Knowledge Transfer</strong>: Leverages insights from each phase to inform the other</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">COPAOptimizer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    COPA: Compiler and Prompt Optimization framework.</span>

<span class="sd">    This optimizer alternates between compilation (parameter optimization)</span>
<span class="sd">    and prompt engineering to achieve superior performance.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">compilation_optimizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">prompt_optimizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">max_iterations</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">convergence_threshold</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
        <span class="n">transfer_strategy</span><span class="o">=</span><span class="s2">&quot;knowledge_distillation&quot;</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compilation_optimizer</span> <span class="o">=</span> <span class="n">compilation_optimizer</span> <span class="ow">or</span> <span class="n">BootstrapFewShot</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prompt_optimizer</span> <span class="o">=</span> <span class="n">prompt_optimizer</span> <span class="ow">or</span> <span class="n">MIPROv2</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_iterations</span> <span class="o">=</span> <span class="n">max_iterations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convergence_threshold</span> <span class="o">=</span> <span class="n">convergence_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transfer_strategy</span> <span class="o">=</span> <span class="n">transfer_strategy</span>

        <span class="c1"># Track optimization history</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;iteration&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;prompt_updates&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;parameter_updates&quot;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>
</pre></div>
</div>
</section>
<section id="the-two-phase-optimization-process">
<h3>The Two-Phase Optimization Process<a class="headerlink" href="#the-two-phase-optimization-process" title="Link to this heading">#</a></h3>
<p>COPA operates in two alternating phases:</p>
<section id="phase-1-compilation-optimization">
<h4>Phase 1: Compilation Optimization<a class="headerlink" href="#phase-1-compilation-optimization" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Optimizes model parameters using gradient-based or gradient-free methods</p></li>
<li><p>Generates and refines few-shot examples</p></li>
<li><p>Adjusts module configurations</p></li>
</ul>
</section>
<section id="phase-2-prompt-optimization">
<h4>Phase 2: Prompt Optimization<a class="headerlink" href="#phase-2-prompt-optimization" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Refines instructions and demonstrations</p></li>
<li><p>Optimizes prompt structure and formatting</p></li>
<li><p>Applies prompt-level transformations</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">,</span> <span class="n">trainset</span><span class="p">,</span> <span class="n">valset</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Execute the COPA optimization process.</span>

<span class="sd">    Args:</span>
<span class="sd">        program: The DSPy program to optimize</span>
<span class="sd">        trainset: Training examples</span>
<span class="sd">        valset: Validation examples</span>
<span class="sd">        metric: Evaluation metric</span>

<span class="sd">    Returns:</span>
<span class="sd">        Optimized program and optimization history</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">best_metric</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">best_program</span> <span class="o">=</span> <span class="n">program</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_iterations</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== COPA Iteration </span><span class="si">{</span><span class="n">iteration</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> ===&quot;</span><span class="p">)</span>

        <span class="c1"># Phase 1: Compilation Optimization</span>
        <span class="k">if</span> <span class="n">iteration</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Phase 1: Compilation Optimization&quot;</span><span class="p">)</span>
            <span class="n">compiled_program</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compilation_phase</span><span class="p">(</span>
                <span class="n">program</span><span class="p">,</span> <span class="n">trainset</span><span class="p">,</span> <span class="n">valset</span><span class="p">,</span> <span class="n">metric</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Phase 2: Prompt Optimization</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Phase 2: Prompt Optimization&quot;</span><span class="p">)</span>
            <span class="n">compiled_program</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prompt_phase</span><span class="p">(</span>
                <span class="n">program</span><span class="p">,</span> <span class="n">trainset</span><span class="p">,</span> <span class="n">valset</span><span class="p">,</span> <span class="n">metric</span>
            <span class="p">)</span>

        <span class="c1"># Evaluate current performance</span>
        <span class="n">current_metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate</span><span class="p">(</span><span class="n">compiled_program</span><span class="p">,</span> <span class="n">valset</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current metric: </span><span class="si">{</span><span class="n">current_metric</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Update history</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;iteration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;metric&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_metric</span><span class="p">)</span>

        <span class="c1"># Check for improvement</span>
        <span class="k">if</span> <span class="n">current_metric</span> <span class="o">&gt;</span> <span class="n">best_metric</span><span class="p">:</span>
            <span class="n">best_metric</span> <span class="o">=</span> <span class="n">current_metric</span>
            <span class="n">best_program</span> <span class="o">=</span> <span class="n">compiled_program</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>

        <span class="c1"># Check for convergence</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_convergence</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converged after </span><span class="si">{</span><span class="n">iteration</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> iterations&quot;</span><span class="p">)</span>
            <span class="k">break</span>

        <span class="c1"># Knowledge transfer between phases</span>
        <span class="n">program</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_knowledge</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">compiled_program</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">best_program</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="detailed-implementation">
<h2>Detailed Implementation<a class="headerlink" href="#detailed-implementation" title="Link to this heading">#</a></h2>
<section id="compilation-phase">
<h3>Compilation Phase<a class="headerlink" href="#compilation-phase" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">_compilation_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">,</span> <span class="n">trainset</span><span class="p">,</span> <span class="n">valset</span><span class="p">,</span> <span class="n">metric</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the compilation optimization phase.&quot;&quot;&quot;</span>

    <span class="c1"># Enhanced BootstrapFewShot with COPA-specific features</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">COPABootstrapFewShot</span><span class="p">(</span><span class="n">BootstrapFewShot</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">copa_knowledge</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">,</span> <span class="n">trainset</span><span class="p">,</span> <span class="n">valset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="c1"># Use knowledge from previous prompt optimizations</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;copa_knowledge&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_apply_copa_knowledge</span><span class="p">(</span><span class="n">program</span><span class="p">)</span>

            <span class="c1"># Standard compilation with COPA enhancements</span>
            <span class="n">compiled</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">trainset</span><span class="p">,</span> <span class="n">valset</span><span class="p">)</span>

            <span class="c1"># Extract and store compilation insights</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extract_compilation_insights</span><span class="p">(</span><span class="n">compiled</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">compiled</span>

    <span class="c1"># Configure the compilation optimizer</span>
    <span class="n">compilation_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;max_bootstrapped_demos&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
        <span class="s2">&quot;max_labeled_demos&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
        <span class="s2">&quot;teacher_settings&quot;</span><span class="p">:</span> <span class="n">dspy</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">compose</span><span class="p">(</span>
            <span class="n">lm</span><span class="o">=</span><span class="n">dspy</span><span class="o">.</span><span class="n">OpenAI</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">0.3</span><span class="p">),</span>
            <span class="n">trace</span><span class="o">=</span><span class="p">[]</span>
        <span class="p">)</span>
    <span class="p">}</span>

    <span class="c1"># Create and run compilation optimizer</span>
    <span class="n">copa_bootstrap</span> <span class="o">=</span> <span class="n">COPABootstrapFewShot</span><span class="p">(</span><span class="o">**</span><span class="n">compilation_config</span><span class="p">)</span>
    <span class="n">compiled_program</span> <span class="o">=</span> <span class="n">copa_bootstrap</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">trainset</span><span class="p">,</span> <span class="n">valset</span><span class="p">)</span>

    <span class="c1"># Store compilation knowledge for next phase</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">compilation_knowledge</span> <span class="o">=</span> <span class="n">copa_bootstrap</span><span class="o">.</span><span class="n">copa_knowledge</span>

    <span class="k">return</span> <span class="n">compiled_program</span>
</pre></div>
</div>
</section>
<section id="prompt-phase">
<h3>Prompt Phase<a class="headerlink" href="#prompt-phase" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">_prompt_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">,</span> <span class="n">trainset</span><span class="p">,</span> <span class="n">valset</span><span class="p">,</span> <span class="n">metric</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the prompt optimization phase.&quot;&quot;&quot;</span>

    <span class="c1"># Enhanced MIPRO with COPA-specific features</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">COPAMIPRO</span><span class="p">(</span><span class="n">MIPRO</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compilation_insights</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">,</span> <span class="n">trainset</span><span class="p">,</span> <span class="n">valset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="c1"># Apply compilation insights</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;compilation_insights&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_apply_compilation_insights</span><span class="p">(</span><span class="n">program</span><span class="p">)</span>

            <span class="c1"># Enhanced prompt optimization</span>
            <span class="n">compiled</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">trainset</span><span class="p">,</span> <span class="n">valset</span><span class="p">)</span>

            <span class="c1"># Extract prompt-level insights</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extract_prompt_insights</span><span class="p">(</span><span class="n">compiled</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">compiled</span>

    <span class="c1"># Configure prompt optimizer</span>
    <span class="n">prompt_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;num_candidates&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s2">&quot;init_temperature&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="s2">&quot;verbose&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;auto&quot;</span><span class="p">:</span> <span class="s2">&quot;medium&quot;</span>  <span class="c1"># Balanced auto prompt optimization</span>
    <span class="p">}</span>

    <span class="c1"># Create and run prompt optimizer</span>
    <span class="n">copa_mipro</span> <span class="o">=</span> <span class="n">COPAMIPRO</span><span class="p">(</span><span class="o">**</span><span class="n">prompt_config</span><span class="p">)</span>
    <span class="n">copa_mipro</span><span class="o">.</span><span class="n">compilation_insights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compilation_knowledge</span>

    <span class="n">compiled_program</span> <span class="o">=</span> <span class="n">copa_mipro</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">trainset</span><span class="p">,</span> <span class="n">valset</span><span class="p">)</span>

    <span class="c1"># Store prompt knowledge for next phase</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">prompt_knowledge</span> <span class="o">=</span> <span class="n">copa_mipro</span><span class="o">.</span><span class="n">prompt_insights</span>

    <span class="k">return</span> <span class="n">compiled_program</span>
</pre></div>
</div>
</section>
<section id="knowledge-transfer-mechanism">
<h3>Knowledge Transfer Mechanism<a class="headerlink" href="#knowledge-transfer-mechanism" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">_transfer_knowledge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_program</span><span class="p">,</span> <span class="n">optimized_program</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transfer knowledge between optimization phases.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer_strategy</span> <span class="o">==</span> <span class="s2">&quot;knowledge_distillation&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_knowledge_distillation_transfer</span><span class="p">(</span><span class="n">current_program</span><span class="p">,</span> <span class="n">optimized_program</span><span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer_strategy</span> <span class="o">==</span> <span class="s2">&quot;parameter_sharing&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameter_sharing_transfer</span><span class="p">(</span><span class="n">current_program</span><span class="p">,</span> <span class="n">optimized_program</span><span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer_strategy</span> <span class="o">==</span> <span class="s2">&quot;ensemble&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensemble_transfer</span><span class="p">(</span><span class="n">current_program</span><span class="p">,</span> <span class="n">optimized_program</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">optimized_program</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_knowledge_distillation_transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">optimized</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transfer knowledge through distillation.&quot;&quot;&quot;</span>

    <span class="c1"># Extract successful patterns from optimized program</span>
    <span class="n">successful_patterns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_patterns</span><span class="p">(</span><span class="n">optimized</span><span class="p">)</span>

    <span class="c1"># Apply patterns to current program selectively</span>
    <span class="n">enhanced_program</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">successful_patterns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">module_name</span> <span class="ow">in</span> <span class="n">enhanced_program</span><span class="o">.</span><span class="n">named_predictors</span><span class="p">():</span>
            <span class="c1"># Apply pattern with adaptation</span>
            <span class="n">adapted_pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adapt_pattern</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">enhanced_program</span><span class="p">[</span><span class="n">module_name</span><span class="p">])</span>
            <span class="n">enhanced_program</span><span class="p">[</span><span class="n">module_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">adapted_pattern</span>

    <span class="k">return</span> <span class="n">enhanced_program</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_extract_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract successful patterns from an optimized program.&quot;&quot;&quot;</span>
    <span class="n">patterns</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">predictor</span> <span class="ow">in</span> <span class="n">program</span><span class="o">.</span><span class="n">named_predictors</span><span class="p">():</span>
        <span class="c1"># Extract prompt patterns</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="s1">&#39;demos&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">predictor</span><span class="o">.</span><span class="n">demos</span><span class="p">:</span>
            <span class="n">patterns</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;demo_structure&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_demo_structure</span><span class="p">(</span><span class="n">predictor</span><span class="o">.</span><span class="n">demos</span><span class="p">),</span>
                <span class="s2">&quot;instruction_style&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_instruction</span><span class="p">(</span><span class="n">predictor</span><span class="p">),</span>
                <span class="s2">&quot;parameter_values&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_parameters</span><span class="p">(</span><span class="n">predictor</span><span class="p">)</span>
            <span class="p">}</span>

    <span class="k">return</span> <span class="n">patterns</span>
</pre></div>
</div>
</section>
</section>
<section id="advanced-copa-features">
<h2>Advanced COPA Features<a class="headerlink" href="#advanced-copa-features" title="Link to this heading">#</a></h2>
<section id="adaptive-optimization-strategy">
<h3>Adaptive Optimization Strategy<a class="headerlink" href="#adaptive-optimization-strategy" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AdaptiveCOPA</span><span class="p">(</span><span class="n">COPAOptimizer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    COPA with adaptive strategy selection based on task characteristics.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_analyzer</span> <span class="o">=</span> <span class="n">TaskComplexityAnalyzer</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">,</span> <span class="n">trainset</span><span class="p">,</span> <span class="n">valset</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute adaptive COPA optimization.&quot;&quot;&quot;</span>

        <span class="c1"># Analyze task complexity</span>
        <span class="n">task_profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_analyzer</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="n">trainset</span><span class="p">,</span> <span class="n">valset</span><span class="p">)</span>

        <span class="c1"># Adapt optimization strategy based on task</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_adapt_strategy</span><span class="p">(</span><span class="n">task_profile</span><span class="p">)</span>

        <span class="c1"># Run optimization with adapted strategy</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">trainset</span><span class="p">,</span> <span class="n">valset</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_adapt_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_profile</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adapt optimization strategy based on task characteristics.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">task_profile</span><span class="p">[</span><span class="s2">&quot;complexity&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;high&quot;</span><span class="p">:</span>
            <span class="c1"># For complex tasks, use more compilation iterations</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_iterations</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compilation_optimizer</span> <span class="o">=</span> <span class="n">BootstrapFewShot</span><span class="p">(</span>
                <span class="n">max_bootstrapped_demos</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                <span class="n">max_labeled_demos</span><span class="o">=</span><span class="mi">32</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">task_profile</span><span class="p">[</span><span class="s2">&quot;complexity&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;low&quot;</span><span class="p">:</span>
            <span class="c1"># For simple tasks, focus on prompt optimization</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_iterations</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prompt_optimizer</span> <span class="o">=</span> <span class="n">MIPRO</span><span class="p">(</span>
                <span class="n">num_candidates</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                <span class="n">init_temperature</span><span class="o">=</span><span class="mf">1.5</span>
            <span class="p">)</span>

        <span class="c1"># Adapt based on data size</span>
        <span class="k">if</span> <span class="n">task_profile</span><span class="p">[</span><span class="s2">&quot;data_size&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="c1"># Small dataset: emphasize compilation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compilation_ratio</span> <span class="o">=</span> <span class="mf">0.7</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Large dataset: balanced approach</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compilation_ratio</span> <span class="o">=</span> <span class="mf">0.5</span>
</pre></div>
</div>
</section>
<section id="multi-task-copa">
<h3>Multi-Task COPA<a class="headerlink" href="#multi-task-copa" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MultiTaskCOPA</span><span class="p">(</span><span class="n">COPAOptimizer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    COPA for multi-task optimization with shared representations.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tasks</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="n">tasks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shared_knowledge</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">optimize_multi_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">programs</span><span class="p">,</span> <span class="n">trainsets</span><span class="p">,</span> <span class="n">valsets</span><span class="p">,</span> <span class="n">metrics</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Optimize multiple related tasks simultaneously.&quot;&quot;&quot;</span>

        <span class="n">optimized_programs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Initial knowledge sharing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_shared_knowledge</span><span class="p">(</span><span class="n">programs</span><span class="p">,</span> <span class="n">trainsets</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">task_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Optimizing task: </span><span class="si">{</span><span class="n">task_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Create task-specific optimizer with shared knowledge</span>
            <span class="n">task_optimizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_task_optimizer</span><span class="p">(</span><span class="n">task_name</span><span class="p">)</span>

            <span class="c1"># Optimize with shared knowledge</span>
            <span class="n">optimized_programs</span><span class="p">[</span><span class="n">task_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">task_optimizer</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span>
                <span class="n">programs</span><span class="p">[</span><span class="n">task_name</span><span class="p">],</span>
                <span class="n">trainsets</span><span class="p">[</span><span class="n">task_name</span><span class="p">],</span>
                <span class="n">valsets</span><span class="p">[</span><span class="n">task_name</span><span class="p">],</span>
                <span class="n">metrics</span><span class="p">[</span><span class="n">task_name</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="c1"># Update shared knowledge</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_shared_knowledge</span><span class="p">(</span>
                <span class="n">task_name</span><span class="p">,</span>
                <span class="n">optimized_programs</span><span class="p">[</span><span class="n">task_name</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">optimized_programs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_shared_knowledge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">programs</span><span class="p">,</span> <span class="n">trainsets</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize shared knowledge across tasks.&quot;&quot;&quot;</span>

        <span class="c1"># Analyze common patterns across tasks</span>
        <span class="n">common_patterns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_cross_task_patterns</span><span class="p">(</span><span class="n">programs</span><span class="p">,</span> <span class="n">trainsets</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shared_knowledge</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;common_patterns&quot;</span><span class="p">:</span> <span class="n">common_patterns</span><span class="p">,</span>
            <span class="s2">&quot;successful_prompts&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;parameter_ranges&quot;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="practical-examples">
<h2>Practical Examples<a class="headerlink" href="#practical-examples" title="Link to this heading">#</a></h2>
<section id="example-1-complex-question-answering">
<h3>Example 1: Complex Question Answering<a class="headerlink" href="#example-1-complex-question-answering" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define a complex QA signature</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ComplexQA</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Signature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Answer complex questions requiring multi-step reasoning.&quot;&quot;&quot;</span>

    <span class="n">context</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">InputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Relevant context passages&quot;</span><span class="p">)</span>
    <span class="n">question</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">InputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;The question to answer&quot;</span><span class="p">)</span>
    <span class="n">answer</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">OutputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Detailed answer with reasoning&quot;</span><span class="p">)</span>
    <span class="n">confidence</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">OutputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Confidence score (0-1)&quot;</span><span class="p">)</span>

<span class="c1"># Create a complex QA program</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ComplexQAProgram</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyze</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">ChainOfThought</span><span class="p">(</span><span class="n">AnalyzeQuestionSignature</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retrieve</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Retrieve</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">synthesize</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">ChainOfThought</span><span class="p">(</span><span class="n">SynthesizeAnswerSignature</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">ChainOfThought</span><span class="p">(</span><span class="n">VerifyAnswerSignature</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">question</span><span class="p">):</span>
        <span class="c1"># Analyze question complexity</span>
        <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="n">question</span><span class="o">=</span><span class="n">question</span><span class="p">)</span>

        <span class="c1"># Retrieve relevant context</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">question</span><span class="p">)</span><span class="o">.</span><span class="n">passages</span>

        <span class="c1"># Generate initial answer</span>
        <span class="n">initial_answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">synthesize</span><span class="p">(</span>
            <span class="n">question</span><span class="o">=</span><span class="n">question</span><span class="p">,</span>
            <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
            <span class="n">analysis</span><span class="o">=</span><span class="n">analysis</span><span class="o">.</span><span class="n">analysis</span>
        <span class="p">)</span>

        <span class="c1"># Verify and refine answer</span>
        <span class="n">final_answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span>
            <span class="n">question</span><span class="o">=</span><span class="n">question</span><span class="p">,</span>
            <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
            <span class="n">answer</span><span class="o">=</span><span class="n">initial_answer</span><span class="o">.</span><span class="n">answer</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Prediction</span><span class="p">(</span>
            <span class="n">answer</span><span class="o">=</span><span class="n">final_answer</span><span class="o">.</span><span class="n">refined_answer</span><span class="p">,</span>
            <span class="n">confidence</span><span class="o">=</span><span class="n">final_answer</span><span class="o">.</span><span class="n">confidence</span>
        <span class="p">)</span>

<span class="c1"># Apply COPA optimization</span>
<span class="k">def</span><span class="w"> </span><span class="nf">optimize_complex_qa</span><span class="p">():</span>
    <span class="c1"># Initialize program</span>
    <span class="n">qa_program</span> <span class="o">=</span> <span class="n">ComplexQAProgram</span><span class="p">()</span>

    <span class="c1"># Create COPA optimizer</span>
    <span class="n">copa_optimizer</span> <span class="o">=</span> <span class="n">COPAOptimizer</span><span class="p">(</span>
        <span class="n">max_iterations</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">transfer_strategy</span><span class="o">=</span><span class="s2">&quot;knowledge_distillation&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Load datasets</span>
    <span class="n">trainset</span> <span class="o">=</span> <span class="n">load_complex_qa_trainset</span><span class="p">()</span>
    <span class="n">valset</span> <span class="o">=</span> <span class="n">load_complex_qa_valset</span><span class="p">()</span>

    <span class="c1"># Define evaluation metric</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">complex_qa_metric</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Check answer correctness</span>
        <span class="n">answer_correct</span> <span class="o">=</span> <span class="n">evaluate_answer_correctness</span><span class="p">(</span>
            <span class="n">example</span><span class="o">.</span><span class="n">answer</span><span class="p">,</span> <span class="n">pred</span><span class="o">.</span><span class="n">answer</span>
        <span class="p">)</span>

        <span class="c1"># Check reasoning quality</span>
        <span class="n">reasoning_quality</span> <span class="o">=</span> <span class="n">evaluate_reasoning_quality</span><span class="p">(</span>
            <span class="n">example</span><span class="o">.</span><span class="n">reasoning_steps</span><span class="p">,</span> <span class="n">pred</span><span class="o">.</span><span class="n">trace</span>
        <span class="p">)</span>

        <span class="c1"># Consider confidence calibration</span>
        <span class="n">confidence_calibration</span> <span class="o">=</span> <span class="n">evaluate_confidence_calibration</span><span class="p">(</span>
            <span class="n">pred</span><span class="o">.</span><span class="n">confidence</span><span class="p">,</span> <span class="n">answer_correct</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">answer_correct</span> <span class="o">+</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="n">reasoning_quality</span> <span class="o">+</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">confidence_calibration</span>

    <span class="c1"># Optimize</span>
    <span class="n">optimized_program</span><span class="p">,</span> <span class="n">history</span> <span class="o">=</span> <span class="n">copa_optimizer</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span>
        <span class="n">qa_program</span><span class="p">,</span>
        <span class="n">trainset</span><span class="p">,</span>
        <span class="n">valset</span><span class="p">,</span>
        <span class="n">metric</span><span class="o">=</span><span class="n">complex_qa_metric</span>
    <span class="p">)</span>

    <span class="c1"># Visualize optimization progress</span>
    <span class="n">plot_copa_history</span><span class="p">(</span><span class="n">history</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">optimized_program</span>

<span class="c1"># Run optimization</span>
<span class="n">optimized_qa</span> <span class="o">=</span> <span class="n">optimize_complex_qa</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="example-2-code-generation-with-constraints">
<h3>Example 2: Code Generation with Constraints<a class="headerlink" href="#example-2-code-generation-with-constraints" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define code generation signature</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CodeGen</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Signature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate code that satisfies specific constraints.&quot;&quot;&quot;</span>

    <span class="n">requirements</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">InputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Functional requirements&quot;</span><span class="p">)</span>
    <span class="n">constraints</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">InputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Code constraints (style, performance, etc.)&quot;</span><span class="p">)</span>
    <span class="n">language</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">InputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Programming language&quot;</span><span class="p">)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">OutputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Generated code&quot;</span><span class="p">)</span>
    <span class="n">explanation</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">OutputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Explanation of the code&quot;</span><span class="p">)</span>

<span class="c1"># Code generation program</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CodeGenerator</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">design</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">ChainOfThought</span><span class="p">(</span><span class="n">DesignAlgorithmSignature</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">implement</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span><span class="n">ImplementCodeSignature</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">ChainOfThought</span><span class="p">(</span><span class="n">ValidateCodeSignature</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requirements</span><span class="p">,</span> <span class="n">constraints</span><span class="p">,</span> <span class="n">language</span><span class="p">):</span>
        <span class="c1"># Design approach</span>
        <span class="n">design</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">design</span><span class="p">(</span>
            <span class="n">requirements</span><span class="o">=</span><span class="n">requirements</span><span class="p">,</span>
            <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">,</span>
            <span class="n">language</span><span class="o">=</span><span class="n">language</span>
        <span class="p">)</span>

        <span class="c1"># Implement code</span>
        <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">implement</span><span class="p">(</span>
            <span class="n">design</span><span class="o">=</span><span class="n">design</span><span class="o">.</span><span class="n">algorithm_design</span><span class="p">,</span>
            <span class="n">language</span><span class="o">=</span><span class="n">language</span>
        <span class="p">)</span>

        <span class="c1"># Validate and fix if needed</span>
        <span class="n">validation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span>
            <span class="n">requirements</span><span class="o">=</span><span class="n">requirements</span><span class="p">,</span>
            <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">,</span>
            <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="o">.</span><span class="n">code</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Prediction</span><span class="p">(</span>
            <span class="n">code</span><span class="o">=</span><span class="n">validation</span><span class="o">.</span><span class="n">fixed_code</span> <span class="ow">or</span> <span class="n">code</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
            <span class="n">explanation</span><span class="o">=</span><span class="n">design</span><span class="o">.</span><span class="n">explanation</span>
        <span class="p">)</span>

<span class="c1"># COPA optimization for code generation</span>
<span class="k">def</span><span class="w"> </span><span class="nf">optimize_code_generator</span><span class="p">():</span>
    <span class="c1"># Initialize</span>
    <span class="n">code_gen</span> <span class="o">=</span> <span class="n">CodeGenerator</span><span class="p">()</span>

    <span class="c1"># Task-specific COPA configuration</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">CodeGenCOPA</span><span class="p">(</span><span class="n">COPAOptimizer</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
            <span class="c1"># Code generation specific optimizers</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compilation_optimizer</span> <span class="o">=</span> <span class="n">BootstrapFewShot</span><span class="p">(</span>
                <span class="n">max_bootstrapped_demos</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                <span class="n">max_labeled_demos</span><span class="o">=</span><span class="mi">24</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prompt_optimizer</span> <span class="o">=</span> <span class="n">MIPRO</span><span class="p">(</span>
                <span class="n">num_candidates</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                <span class="n">init_temperature</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                <span class="n">auto</span><span class="o">=</span><span class="s2">&quot;light&quot;</span>
            <span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">,</span> <span class="n">valset</span><span class="p">,</span> <span class="n">metric</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Enhanced evaluation for code generation.&quot;&quot;&quot;</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">valset</span><span class="p">:</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="n">program</span><span class="p">(</span><span class="o">**</span><span class="n">example</span><span class="o">.</span><span class="n">inputs</span><span class="p">())</span>

                <span class="c1"># Check functional correctness</span>
                <span class="n">functional_score</span> <span class="o">=</span> <span class="n">test_code_functionality</span><span class="p">(</span>
                    <span class="n">pred</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">example</span><span class="o">.</span><span class="n">test_cases</span>
                <span class="p">)</span>

                <span class="c1"># Check constraint satisfaction</span>
                <span class="n">constraint_score</span> <span class="o">=</span> <span class="n">check_constraints</span><span class="p">(</span>
                    <span class="n">pred</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">example</span><span class="o">.</span><span class="n">constraints</span>
                <span class="p">)</span>

                <span class="c1"># Check code quality</span>
                <span class="n">quality_score</span> <span class="o">=</span> <span class="n">evaluate_code_quality</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>

                <span class="c1"># Combined score</span>
                <span class="n">total_score</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="mf">0.5</span> <span class="o">*</span> <span class="n">functional_score</span> <span class="o">+</span>
                    <span class="mf">0.3</span> <span class="o">*</span> <span class="n">constraint_score</span> <span class="o">+</span>
                    <span class="mf">0.2</span> <span class="o">*</span> <span class="n">quality_score</span>
                <span class="p">)</span>
                <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total_score</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>

    <span class="c1"># Run optimization</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">CodeGenCOPA</span><span class="p">()</span>
    <span class="n">optimized_gen</span><span class="p">,</span> <span class="n">history</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span>
        <span class="n">code_gen</span><span class="p">,</span>
        <span class="n">load_codegen_trainset</span><span class="p">(),</span>
        <span class="n">load_codegen_valset</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">optimized_gen</span>
</pre></div>
</div>
</section>
</section>
<section id="performance-evaluation">
<h2>Performance Evaluation<a class="headerlink" href="#performance-evaluation" title="Link to this heading">#</a></h2>
<section id="comparative-analysis">
<h3>Comparative Analysis<a class="headerlink" href="#comparative-analysis" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">compare_optimizers</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">trainset</span><span class="p">,</span> <span class="n">valset</span><span class="p">,</span> <span class="n">metric</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compare COPA with other optimizers.&quot;&quot;&quot;</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Initialize base program</span>
    <span class="n">program</span> <span class="o">=</span> <span class="n">create_task_program</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

    <span class="c1"># Test COPA</span>
    <span class="n">copa</span> <span class="o">=</span> <span class="n">COPAOptimizer</span><span class="p">(</span><span class="n">max_iterations</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">copa_program</span><span class="p">,</span> <span class="n">copa_history</span> <span class="o">=</span> <span class="n">copa</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">trainset</span><span class="p">,</span> <span class="n">valset</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;COPA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">copa_program</span><span class="p">,</span> <span class="n">valset</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>

    <span class="c1"># Test BootstrapFewShot</span>
    <span class="n">bootstrap</span> <span class="o">=</span> <span class="n">BootstrapFewShot</span><span class="p">()</span>
    <span class="n">bootstrap_program</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">trainset</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;BootstrapFewShot&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">bootstrap_program</span><span class="p">,</span> <span class="n">valset</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>

    <span class="c1"># Test MIPRO</span>
    <span class="n">mipro</span> <span class="o">=</span> <span class="n">MIPRO</span><span class="p">(</span><span class="n">num_candidates</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">mipro_program</span> <span class="o">=</span> <span class="n">mipro</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">trainset</span><span class="p">,</span> <span class="n">valset</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;MIPRO&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">mipro_program</span><span class="p">,</span> <span class="n">valset</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>

    <span class="c1"># Test fine-tuning</span>
    <span class="k">if</span> <span class="n">task</span><span class="p">[</span><span class="s2">&quot;supports_finetuning&quot;</span><span class="p">]:</span>
        <span class="n">finetuned</span> <span class="o">=</span> <span class="n">finetune_program</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">trainset</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;Fine-tuning&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">finetuned</span><span class="p">,</span> <span class="n">valset</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>

    <span class="c1"># Visualize results</span>
    <span class="n">plot_comparison</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span>

<span class="c1"># Example comparison</span>
<span class="n">comparison_results</span> <span class="o">=</span> <span class="n">compare_optimizers</span><span class="p">(</span>
    <span class="n">task</span><span class="o">=</span><span class="s2">&quot;complex_qa&quot;</span><span class="p">,</span>
    <span class="n">trainset</span><span class="o">=</span><span class="n">qa_trainset</span><span class="p">,</span>
    <span class="n">valset</span><span class="o">=</span><span class="n">qa_valset</span><span class="p">,</span>
    <span class="n">metric</span><span class="o">=</span><span class="n">qa_metric</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Optimizer Performance Comparison:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">comparison_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">optimizer</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="optimization-trajectory-analysis">
<h3>Optimization Trajectory Analysis<a class="headerlink" href="#optimization-trajectory-analysis" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">analyze_optimization_trajectory</span><span class="p">(</span><span class="n">history</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Analyze the optimization trajectory of COPA.&quot;&quot;&quot;</span>

    <span class="n">iterations</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="s2">&quot;iteration&quot;</span><span class="p">]</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="s2">&quot;metric&quot;</span><span class="p">]</span>

    <span class="c1"># Calculate improvement rates</span>
    <span class="n">improvement_rates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">)):</span>
        <span class="n">rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">metrics</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">metrics</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">improvement_rates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span>

    <span class="c1"># Identify convergence point</span>
    <span class="n">convergence_point</span> <span class="o">=</span> <span class="n">find_convergence_point</span><span class="p">(</span><span class="n">improvement_rates</span><span class="p">)</span>

    <span class="c1"># Phase-wise analysis</span>
    <span class="n">compilation_phases</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">iterations</span> <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">prompt_phases</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">iterations</span> <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>

    <span class="n">compilation_improvements</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">metrics</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">metrics</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">compilation_phases</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="p">]</span>
    <span class="n">prompt_improvements</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">metrics</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">metrics</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">prompt_phases</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="p">]</span>

    <span class="c1"># Generate insights</span>
    <span class="n">insights</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;total_improvement&quot;</span><span class="p">:</span> <span class="n">metrics</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">metrics</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s2">&quot;average_improvement_per_iteration&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">improvement_rates</span><span class="p">),</span>
        <span class="s2">&quot;convergence_iteration&quot;</span><span class="p">:</span> <span class="n">convergence_point</span><span class="p">,</span>
        <span class="s2">&quot;compilation_effectiveness&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">compilation_improvements</span><span class="p">),</span>
        <span class="s2">&quot;prompt_effectiveness&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">prompt_improvements</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">insights</span>
</pre></div>
</div>
</section>
</section>
<section id="best-practices">
<h2>Best Practices<a class="headerlink" href="#best-practices" title="Link to this heading">#</a></h2>
<section id="when-to-use-copa">
<h3>When to Use COPA<a class="headerlink" href="#when-to-use-copa" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p><strong>Complex Tasks</strong>: Multi-step reasoning or tasks with multiple constraints</p></li>
<li><p><strong>Limited Data</strong>: When you have moderate-sized training sets</p></li>
<li><p><strong>Performance Critical</strong>: When you need maximum performance</p></li>
<li><p><strong>Heterogeneous Tasks</strong>: Tasks requiring both good prompts and good demonstrations</p></li>
</ol>
</section>
<section id="configuration-guidelines">
<h3>Configuration Guidelines<a class="headerlink" href="#configuration-guidelines" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># For small datasets (&lt; 100 examples)</span>
<span class="n">small_dataset_config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;max_iterations&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s2">&quot;compilation_ratio&quot;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span>  <span class="c1"># More emphasis on compilation</span>
    <span class="s2">&quot;transfer_strategy&quot;</span><span class="p">:</span> <span class="s2">&quot;knowledge_distillation&quot;</span>
<span class="p">}</span>

<span class="c1"># For medium datasets (100-1000 examples)</span>
<span class="n">medium_dataset_config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;max_iterations&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
    <span class="s2">&quot;compilation_ratio&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>  <span class="c1"># Balanced approach</span>
    <span class="s2">&quot;transfer_strategy&quot;</span><span class="p">:</span> <span class="s2">&quot;ensemble&quot;</span>
<span class="p">}</span>

<span class="c1"># For large datasets (&gt; 1000 examples)</span>
<span class="n">large_dataset_config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;max_iterations&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s2">&quot;compilation_ratio&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>  <span class="c1"># More emphasis on prompts</span>
    <span class="s2">&quot;transfer_strategy&quot;</span><span class="p">:</span> <span class="s2">&quot;parameter_sharing&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="common-pitfalls-and-solutions">
<h3>Common Pitfalls and Solutions<a class="headerlink" href="#common-pitfalls-and-solutions" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p><strong>Over-optimization</strong>: Stop early if performance plateaus</p></li>
<li><p><strong>Knowledge Confusion</strong>: Carefully manage knowledge transfer between phases</p></li>
<li><p><strong>Computational Cost</strong>: Use appropriate iteration limits</p></li>
<li><p><strong>Evaluation Bias</strong>: Use held-out test sets for final evaluation</p></li>
</ol>
</section>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Link to this heading">#</a></h2>
<p>COPA represents a significant advancement in optimization for language model programs. By treating compilation and prompt optimization as complementary processes, COPA achieves superior performance across a wide range of tasks. The frameworks flexibility allows it to adapt to different task characteristics and requirements, making it a powerful tool in the DSPy optimization toolkit.</p>
<section id="key-takeaways">
<h3>Key Takeaways<a class="headerlink" href="#key-takeaways" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>COPA synergistically combines compilation and prompt optimization</p></li>
<li><p>The two-phase approach allows for comprehensive optimization</p></li>
<li><p>Knowledge transfer between phases enhances overall performance</p></li>
<li><p>Adaptive strategies enable task-specific optimization</p></li>
<li><p>Multi-task extensions support shared representations</p></li>
</ol>
</section>
</section>
<section id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Link to this heading">#</a></h2>
<p>In the next section, well explore Monte Carlo optimization methods for DSPy, which provide stochastic approaches to navigate complex optimization spaces.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./content/05_optimizers"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="08_reflective_prompt_evolution.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Reflective Prompt Evolution (RPE): Evolutionary Optimization Without Gradients</p>
      </div>
    </a>
    <a class="right-next"
       href="09a_copa_method.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">COPA: Combined Fine-Tuning and Prompt Optimization</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-objectives">Learning Objectives</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-copa-framework">The COPA Framework</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#core-principles">Core Principles</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-two-phase-optimization-process">The Two-Phase Optimization Process</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#phase-1-compilation-optimization">Phase 1: Compilation Optimization</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#phase-2-prompt-optimization">Phase 2: Prompt Optimization</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#detailed-implementation">Detailed Implementation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#compilation-phase">Compilation Phase</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#prompt-phase">Prompt Phase</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#knowledge-transfer-mechanism">Knowledge Transfer Mechanism</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-copa-features">Advanced COPA Features</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#adaptive-optimization-strategy">Adaptive Optimization Strategy</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multi-task-copa">Multi-Task COPA</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#practical-examples">Practical Examples</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-1-complex-question-answering">Example 1: Complex Question Answering</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-2-code-generation-with-constraints">Example 2: Code Generation with Constraints</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#performance-evaluation">Performance Evaluation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparative-analysis">Comparative Analysis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#optimization-trajectory-analysis">Optimization Trajectory Analysis</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#best-practices">Best Practices</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#when-to-use-copa">When to Use COPA</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration-guidelines">Configuration Guidelines</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#common-pitfalls-and-solutions">Common Pitfalls and Solutions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#key-takeaways">Key Takeaways</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Dustin Ober
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
       Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>