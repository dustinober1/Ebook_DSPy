
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>LLM-as-a-Judge for Context-Sensitive Evaluation &#8212; DSPy: The Complete Guide</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=9c3e77be" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=1ae7504c"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'content/04_evaluation/08_llm_as_a_judge';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Human-Aligned Evaluation: Capturing What Really Matters" href="09_human_aligned_evaluation.html" />
    <link rel="prev" title="Structured Prompting for Robust Evaluation" href="07_structured_prompting.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../00_frontmatter/00_preface.html">
  
  
  
  
  
  
    <p class="title logo__title">DSPy: The Complete Guide</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../00_frontmatter/01_how_to_use_this_book.html">How to Use This Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_frontmatter/02_prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_frontmatter/03_setup_instructions.html">Setup Instructions</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 1 - Fundamentals</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../01_fundamentals/00_chapter_intro.html">Chapter 1: DSPy Fundamentals</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../01_fundamentals/01_what_is_dspy.html">What is DSPy?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01_fundamentals/02_programming_vs_prompting.html">Programming vs. Prompting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01_fundamentals/03_installation_setup.html">Installation and Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01_fundamentals/04_first_dspy_program.html">Your First DSPy Program</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01_fundamentals/05_language_models.html">Language Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01_fundamentals/06_exercises.html">Chapter 1 Exercises</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 2 - Signatures</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../02_signatures/00_chapter_intro.html">Chapter 2: Signatures</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../02_signatures/01_understanding_signatures.html">Understanding Signatures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02_signatures/02_signature_syntax.html">Signature Syntax</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02_signatures/03_typed_signatures.html">Typed Signatures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02_signatures/04_advanced_signatures.html">Advanced Signatures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02_signatures/05_practical_examples.html">Practical Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02_signatures/06_exercises.html">Chapter 2 Exercises</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 3 - Modules</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../03_modules/00_chapter_intro.html">Chapter 3: Modules</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../03_modules/01_module_basics.html">Module Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03_modules/02_predict_module.html">The Predict Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03_modules/02a_typed_predictor.html">TypedPredictor: Type-Safe Language Model Wrappers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03_modules/03_chainofthought.html">Chain of Thought Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03_modules/04_react_agents.html">ReAct Agents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03_modules/05_custom_modules.html">Custom Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03_modules/06_composing_modules.html">Composing Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03_modules/07_exercises.html">Chapter 3 Exercises</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03_modules/08_assertions.html">Assertions Module</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 4 - Evaluation</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="00_chapter_intro.html">Chapter 4: Evaluation</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="01_why_evaluation_matters.html">Why Evaluation Matters</a></li>
<li class="toctree-l2"><a class="reference internal" href="02_creating_datasets.html">Creating Datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="03_defining_metrics.html">Defining Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="04_evaluation_loops.html">Evaluation Loops</a></li>
<li class="toctree-l2"><a class="reference internal" href="05_best_practices.html">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="06_exercises.html">Exercises</a></li>
<li class="toctree-l2"><a class="reference internal" href="07_structured_prompting.html">Structured Prompting for Robust Evaluation</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">LLM-as-a-Judge for Context-Sensitive Evaluation</a></li>
<li class="toctree-l2"><a class="reference internal" href="09_human_aligned_evaluation.html">Human-Aligned Evaluation: Capturing What Really Matters</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 5 - Optimizers</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../05_optimizers/00_chapter_intro.html">Chapter 5: Optimizers &amp; Compilation</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/01_compilation_concept.html">The Compilation Concept in DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/02_bootstrapfewshot.html">BootstrapFewShot: Automatic Few-Shot Example Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/02a_copro.html">COPRO: Chain-of-Thought Prompt Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/03_mipro.html">MIPRO: Multi-step Instruction and Demonstration Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/04_knnfewshot.html">KNNFewShot: Similarity-Based Example Selection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/05_finetuning.html">Fine-Tuning Small Language Models in DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/06_choosing_optimizers.html">Choosing Optimizers: Decision Guide and Trade-offs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/07_constraint_driven_optimization.html">Constraint-Driven Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/07_exercises.html">Chapter 5 Exercises: Optimizers &amp; Compilation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/08_reflective_prompt_evolution.html">Reflective Prompt Evolution (RPE): Evolutionary Optimization Without Gradients</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/09_copa_compiler_method.html">COPA: Compiler and Prompt Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/09a_copa_method.html">COPA: Combined Fine-Tuning and Prompt Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/10_joint_optimization.html">Joint Optimization: Fine-Tuning and Prompt Synergy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/11_monte_carlo_optimization.html">Monte Carlo Optimization in DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/12_bayesian_optimization.html">Bayesian Optimization for Prompt Tuning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/13_comprehensive_examples.html">Comprehensive Examples and Implementation Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/14_multistage_optimization_theory.html">Multi-stage Optimization Theory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/15_instruction_tuning_frameworks.html">Instruction Tuning Frameworks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/16_demonstration_optimization.html">Demonstration Optimization Strategies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/17_multistage_architectures.html">Multi-stage Program Architectures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/18_complex_pipeline_optimization.html">Optimization Strategies for Complex Pipelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/19_instruction_demonstration_interactions.html">Instruction and Demonstration Interaction Effects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/20_prompts_as_hyperparameters.html">Prompts as Auto-Optimized Hyperparameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/21_minimal_data_pipelines.html">Minimal Data Training Pipelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/22_gepa_genetic_pareto_optimization.html">GEPA: Genetic-Pareto Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/23_state_space_prompt_optimization.html">State-Space Search for Prompt Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/24_inpars_plus_synthetic_data_ir.html">InPars+: Advanced Synthetic Data Generation for Information Retrieval</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/25_custom_mipro_enhanced_optimization.html">CustomMIPROv2: Enhanced Multi-Stage Prompt Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/26_automatic_prompt_optimization_research.html">Automatic Prompt Optimization: When AI Outperforms Humans</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 6 - Real-World Applications</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../06_real_world_applications/00_chapter_intro.html">Chapter 6: Building Real-World Applications</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/01_rag_systems.html">RAG Systems: Building Intelligent Document Q&amp;A</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/02_multi_hop_search.html">Multi-hop Search: Complex Reasoning Across Documents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/03_classification_tasks.html">Classification Tasks: Building Robust Text Categorization Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/04_entity_extraction.html">Entity Extraction: Mining Structured Information from Text</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/05_intelligent_agents.html">Intelligent Agents: Building Autonomous Problem-Solving Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/06_code_generation.html">Code Generation: Building Automated Programming Assistants</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/07_exercises.html">Chapter 6 Exercises: Building Real-World Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/07a_perspective_driven_research.html">Perspective-Driven Research for Article Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/08_extreme_multilabel_classification.html">Extreme Multi-Label Classification: Scaling to Millions of Labels</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/08a_long_form_generation.html">Long-form Article Generation with DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/09_outline_generation.html">Outline Generation for Structured Article Writing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/11_extreme_few_shot_learning.html">Extreme Few-Shot Learning: Training with 10 Gold Labels</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/12_ir_model_training_scratch.html">IR Model Training from Scratch: Methodology and Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/13_lingvarbench_healthcare_synthetic_data.html">LingVarBench: Synthetic Healthcare Transcript Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/14_scientific_figure_caption_generation.html">Scientific Figure Caption Generation with DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/15_retrieval_augmented_guardrails.html">Retrieval-Augmented Guardrails for AI Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/16_graphrag_wikipedia_tidb_tutorial.html">GraphRAG from Wikipedia: Building with DSPy, OpenAI, and TiDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/17_framework_comparisons_dspy_ecosystem.html">Framework Comparisons in the DSPy Ecosystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/18_multi_agent_rag_systems.html">Multi-Agent RAG Systems with DSPy</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 7 - Advanced Topics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../07_advanced_topics/00_chapter_intro.html">Chapter 7: Advanced Topics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/01_adapters_tools.html">Adapters and Tools: Extending DSPy Capabilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/02_caching_performance.html">Caching and Performance: Building High-Performance DSPy Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/03_async_streaming.html">Async and Streaming: Building Real-Time DSPy Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/04_debugging_tracing.html">Debugging and Tracing: Mastering DSPy Application Diagnostics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/05_deployment_strategies.html">Deployment Strategies: Taking DSPy Applications to Production</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/06_exercises.html">Chapter 7 Exercises: Advanced Topics Mastery</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/07_self_refining_pipelines.html">Self-Refining Pipelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/08_declarative_compilation.html">Declarative Language Model Compilation Techniques</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 8 - Case Studies</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../08_case_studies/00_introduction.html">Chapter 8: Case Studies</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/01_enterprise_rag_system.html">Case Study 1: Building an Enterprise RAG System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/01a_healthcare_clinical_notes.html">Case Study 1: Clinical Notes Analysis with DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/02_customer_support_chatbot.html">Case Study 2: Developing a Customer Support Chatbot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/03_ai_code_assistant.html">Case Study 3: Creating an AI-Powered Code Assistant</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/04_automated_data_analysis.html">Case Study 4: Building an Automated Data Analysis Pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/05_exercises.html">Chapter 8 Exercises</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/05a_storm_writing_assistant.html">Case Study 5: STORM - AI-Powered Writing Assistant for Wikipedia-like Articles</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/06_assertion_driven_applications.html">Case Study: Assertion-Driven Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/07_databricks_jetblue_llm_optimization.html">Case Study 7: Databricks &amp; JetBlue LLM Pipeline Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/08_replit_code_repair_dspy.html">Case Study 8: Replit Code Repair with DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/09_databricks_dspy_platform_integration.html">Case Study 9: Databricks Platform Integration with DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/10_ddi_behavioral_simulation_automation.html">Case Study 10: DDI Behavioral Simulation Automation with DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/11_salomatic_medical_report_generation.html">Case Study 11: Salomatic Medical Report Generation with DSPy and Langtrace</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../09_appendices/00_introduction.html">Chapter 9: Appendices</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../09_appendices/01_api_reference_quick.html">API Reference Quick Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09_appendices/02_troubleshooting.html">Troubleshooting Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09_appendices/03_resources.html">Additional Resources</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09_appendices/04_glossary.html">Glossary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09_appendices/05_community_resources.html">Community Resources and Perspectives</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/content/04_evaluation/08_llm_as_a_judge.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>LLM-as-a-Judge for Context-Sensitive Evaluation</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#when-to-use-llm-as-a-judge">When to Use LLM-as-a-Judge</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#domain-specific-impact-assessment">1. Domain-Specific Impact Assessment</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#nuanced-semantic-evaluation">2. Nuanced Semantic Evaluation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multi-dimensional-quality-assessment">3. Multi-Dimensional Quality Assessment</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation-framework">Implementation Framework</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#core-judge-architecture">1. Core Judge Architecture</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#clinical-impact-judge">2. Clinical Impact Judge</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#specialized-judges-for-different-domains">3. Specialized Judges for Different Domains</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#training-and-optimization">Training and Optimization</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-gepa-for-prompt-optimization">1. Using GEPA for Prompt Optimization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cost-sensitive-training">2. Cost-Sensitive Training</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#best-practices">Best Practices</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#prompt-design">1. Prompt Design</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#handling-bias">2. Handling Bias</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ensemble-of-judges">3. Ensemble of Judges</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#integration-with-dspy-evaluation">Integration with DSPy Evaluation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-metrics">1. Custom Metrics</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#progressive-evaluation">2. Progressive Evaluation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="llm-as-a-judge-for-context-sensitive-evaluation">
<h1>LLM-as-a-Judge for Context-Sensitive Evaluation<a class="headerlink" href="#llm-as-a-judge-for-context-sensitive-evaluation" title="Link to this heading">#</a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">#</a></h2>
<p><strong>LLM-as-a-Judge</strong> is a powerful evaluation paradigm that uses large language models to assess the quality and impact of model outputs. This approach is particularly valuable when traditional metrics fail to capture domain-specific nuances or real-world consequences.</p>
<p>This framework becomes essential in safety-critical domains like healthcare, where standard metrics such as Word Error Rate (WER) for Automatic Speech Recognition (ASR) correlate poorly with actual clinical risk. The approach demonstrates how LLMs can be trained to perform nuanced, context-aware evaluations that align with expert human judgment.</p>
</section>
<section id="when-to-use-llm-as-a-judge">
<h2>When to Use LLM-as-a-Judge<a class="headerlink" href="#when-to-use-llm-as-a-judge" title="Link to this heading">#</a></h2>
<section id="domain-specific-impact-assessment">
<h3>1. Domain-Specific Impact Assessment<a class="headerlink" href="#domain-specific-impact-assessment" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Standard metrics (WER, BLEU) fail to capture clinical meaning</span>
<span class="n">standard_metrics</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;wer&quot;</span><span class="p">:</span> <span class="mf">0.12</span><span class="p">,</span>  <span class="c1"># Low error rate</span>
    <span class="s2">&quot;bleu&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span>  <span class="c1"># High overlap</span>
    <span class="c1"># But missed critical negation: &quot;no chest pain&quot; â†’ &quot;chest pain&quot;</span>
<span class="p">}</span>

<span class="c1"># LLM-as-a-Judge captures actual impact</span>
<span class="n">clinical_judge</span> <span class="o">=</span> <span class="n">ClinicalImpactJudge</span><span class="p">()</span>
<span class="n">assessment</span> <span class="o">=</span> <span class="n">clinical_judge</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
    <span class="n">ground_truth</span><span class="o">=</span><span class="s2">&quot;Patient reports no chest pain or shortness of breath&quot;</span><span class="p">,</span>
    <span class="n">hypothesis</span><span class="o">=</span><span class="s2">&quot;Patient reports chest pain or shortness of breath&quot;</span>
<span class="p">)</span>
<span class="c1"># Result: SIGNIFICANT_CLINICAL_IMPACT (2/2)</span>
</pre></div>
</div>
</section>
<section id="nuanced-semantic-evaluation">
<h3>2. Nuanced Semantic Evaluation<a class="headerlink" href="#nuanced-semantic-evaluation" title="Link to this heading">#</a></h3>
<p>Traditional metrics struggle with:</p>
<ul class="simple">
<li><p>Context-dependent meaning</p></li>
<li><p>Domain-specific terminology</p></li>
<li><p>Weighted importance of different errors</p></li>
<li><p>Complex relationships between concepts</p></li>
</ul>
</section>
<section id="multi-dimensional-quality-assessment">
<h3>3. Multi-Dimensional Quality Assessment<a class="headerlink" href="#multi-dimensional-quality-assessment" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MultiDimensionalJudge</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Evaluates outputs across multiple quality dimensions.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">=</span> <span class="n">dimensions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">judge</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">ChainOfThought</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Evaluate the {output} against {ground_truth}.</span>

<span class="sd">            Consider these dimensions:</span>
<span class="sd">            {dimensions}</span>

<span class="sd">            For each dimension, provide:</span>
<span class="sd">            - Score (1-5)</span>
<span class="sd">            - Justification</span>
<span class="sd">            - Impact severity&quot;&quot;&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">evaluation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">judge</span><span class="p">(</span>
            <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">,</span>
            <span class="n">ground_truth</span><span class="o">=</span><span class="n">ground_truth</span><span class="p">,</span>
            <span class="n">dimensions</span><span class="o">=</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">evaluation</span>
</pre></div>
</div>
</section>
</section>
<section id="implementation-framework">
<h2>Implementation Framework<a class="headerlink" href="#implementation-framework" title="Link to this heading">#</a></h2>
<section id="core-judge-architecture">
<h3>1. Core Judge Architecture<a class="headerlink" href="#core-judge-architecture" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">dspy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>

<span class="k">class</span><span class="w"> </span><span class="nc">LLMJudge</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for LLM-as-a-Judge implementations.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">prompt_template</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">output_schema</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span>
                 <span class="n">max_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prompt_template</span> <span class="o">=</span> <span class="n">prompt_template</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_schema</span> <span class="o">=</span> <span class="n">output_schema</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_tokens</span> <span class="o">=</span> <span class="n">max_tokens</span>

        <span class="c1"># Initialize the judge with Chain of Thought for reasoning</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">judge</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">ChainOfThought</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prompt_template</span><span class="p">,</span>
            <span class="n">max_tokens</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_tokens</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">hypothesis</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate hypothesis against ground truth.&quot;&quot;&quot;</span>
        <span class="c1"># Format the prompt with inputs</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">ground_truth</span><span class="o">=</span><span class="n">ground_truth</span><span class="p">,</span>
            <span class="n">hypothesis</span><span class="o">=</span><span class="n">hypothesis</span><span class="p">,</span>
            <span class="o">**</span><span class="n">context</span>
        <span class="p">)</span>

        <span class="c1"># Get LLM evaluation</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">judge</span><span class="p">(</span>
            <span class="n">ground_truth</span><span class="o">=</span><span class="n">ground_truth</span><span class="p">,</span>
            <span class="n">hypothesis</span><span class="o">=</span><span class="n">hypothesis</span><span class="p">,</span>
            <span class="o">**</span><span class="n">context</span>
        <span class="p">)</span>

        <span class="c1"># Parse and validate output</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_output</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="s2">&quot;raw_output&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">),</span>
                <span class="s2">&quot;evaluation&quot;</span><span class="p">:</span> <span class="s2">&quot;PARSING_ERROR&quot;</span>
            <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parse_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_output</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse LLM output into structured format.&quot;&quot;&quot;</span>
        <span class="c1"># Implementation depends on output_schema</span>
        <span class="c1"># This is a generic implementation</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">raw_output</span><span class="p">,</span> <span class="s1">&#39;reasoning&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;reasoning&quot;</span><span class="p">:</span> <span class="n">raw_output</span><span class="o">.</span><span class="n">reasoning</span><span class="p">,</span>
                <span class="s2">&quot;evaluation&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">raw_output</span><span class="p">,</span> <span class="s1">&#39;evaluation&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">raw_output</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;raw_output&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">raw_output</span><span class="p">)}</span>
</pre></div>
</div>
</section>
<section id="clinical-impact-judge">
<h3>2. Clinical Impact Judge<a class="headerlink" href="#clinical-impact-judge" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ClinicalImpactJudge</span><span class="p">(</span><span class="n">LLMJudge</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Judge for assessing clinical impact of ASR errors.&quot;&quot;&quot;</span>

    <span class="c1"># Define impact levels</span>
    <span class="n">IMPACT_LEVELS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;No Clinical Impact&quot;</span><span class="p">,</span>
        <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;Minimal Clinical Impact&quot;</span><span class="p">,</span>
        <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;Significant Clinical Impact&quot;</span>
    <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">prompt_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        You are an expert medical analyst. Your task is to assess the clinical impact</span>
<span class="s2">        of errors in an AI-generated transcription of a medical conversation.</span>

<span class="s2">        You will be given:</span>
<span class="s2">        1. ground_truth_conversation: The accurate, human-verified transcript</span>
<span class="s2">        2. transcription_conversation: The machine-generated transcript with errors</span>

<span class="s2">        Core Principle: Determine if a clinician reading the transcription would</span>
<span class="s2">        make different medical decisions than if they read the ground truth.</span>

<span class="s2">        Provide:</span>
<span class="s2">        1. reasoning: Step-by-step analysis of differences</span>
<span class="s2">        2. clinical_impact: Single integer (0, 1, or 2)</span>

<span class="s2">        Impact Levels:</span>
<span class="s2">        - 0: No Clinical Impact (cosmetic errors only)</span>
<span class="s2">        - 1: Minimal Clinical Impact (non-critical ambiguities)</span>
<span class="s2">        - 2: Significant Clinical Impact (could affect diagnosis/treatment)</span>

<span class="s2">        Ground Truth: </span><span class="si">{ground_truth}</span>
<span class="s2">        Transcription: </span><span class="si">{hypothesis}</span>
<span class="s2">        Context: </span><span class="si">{context}</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">prompt_template</span><span class="o">=</span><span class="n">prompt_template</span><span class="p">,</span>
            <span class="n">output_schema</span><span class="o">=</span><span class="nb">dict</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">hypothesis</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate clinical impact with structured output.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
            <span class="n">ground_truth</span><span class="o">=</span><span class="n">ground_truth</span><span class="p">,</span>
            <span class="n">hypothesis</span><span class="o">=</span><span class="n">hypothesis</span><span class="p">,</span>
            <span class="n">context</span><span class="o">=</span><span class="n">context</span> <span class="ow">or</span> <span class="s2">&quot;No additional context&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Normalize the impact level</span>
        <span class="k">if</span> <span class="s1">&#39;clinical_impact&#39;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">impact</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;clinical_impact&#39;</span><span class="p">])</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;clinical_impact&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">impact</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;impact_label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IMPACT_LEVELS</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;clinical_impact&#39;</span><span class="p">]]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;clinical_impact&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;impact_label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;UNKNOWN&quot;</span>

        <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</section>
<section id="specialized-judges-for-different-domains">
<h3>3. Specialized Judges for Different Domains<a class="headerlink" href="#specialized-judges-for-different-domains" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CodeQualityJudge</span><span class="p">(</span><span class="n">LLMJudge</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Judge for evaluating code quality and correctness.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">prompt_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Evaluate the generated code against the reference implementation.</span>

<span class="s2">        Consider:</span>
<span class="s2">        - Correctness: Does it produce the right output?</span>
<span class="s2">        - Efficiency: Is it optimal in time/space complexity?</span>
<span class="s2">        - Readability: Is it clean and maintainable?</span>
<span class="s2">        - Edge Cases: Does it handle unusual inputs?</span>

<span class="s2">        Provide scores (1-5) for each dimension and overall assessment.</span>

<span class="s2">        Reference: </span><span class="si">{ground_truth}</span>
<span class="s2">        Generated: </span><span class="si">{hypothesis}</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">prompt_template</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CreativeWritingJudge</span><span class="p">(</span><span class="n">LLMJudge</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Judge for evaluating creative writing quality.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">prompt_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Evaluate the creative writing piece against criteria:</span>

<span class="s2">        - Creativity and originality</span>
<span class="s2">        - Engagement and flow</span>
<span class="s2">        - Character development (if applicable)</span>
<span class="s2">        - Plot coherence</span>
<span class="s2">        - Language quality</span>

<span class="s2">        Reference Piece: </span><span class="si">{ground_truth}</span>
<span class="s2">        Generated Piece: </span><span class="si">{hypothesis}</span>
<span class="s2">        Writing Style: </span><span class="si">{style}</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">prompt_template</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">FactualAccuracyJudge</span><span class="p">(</span><span class="n">LLMJudge</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Judge for checking factual accuracy in generated text.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">prompt_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Fact-check the generated text against verified information.</span>

<span class="s2">        For each factual claim:</span>
<span class="s2">        - Is it accurate?</span>
<span class="s2">        - Is it properly attributed?</span>
<span class="s2">        - Is any important context missing?</span>

<span class="s2">        Flag any hallucinations or misstatements.</span>

<span class="s2">        Verified Information: </span><span class="si">{ground_truth}</span>
<span class="s2">        Generated Text: </span><span class="si">{hypothesis}</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">prompt_template</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="training-and-optimization">
<h2>Training and Optimization<a class="headerlink" href="#training-and-optimization" title="Link to this heading">#</a></h2>
<section id="using-gepa-for-prompt-optimization">
<h3>1. Using GEPA for Prompt Optimization<a class="headerlink" href="#using-gepa-for-prompt-optimization" title="Link to this heading">#</a></h3>
<blockquote>
<div><p><strong>Note</strong>: <strong>GEPA</strong> stands for <em>Generative Evolutionary Prompt Adjustment</em>. It is an advanced optimizer technique covered in detail in <a class="reference internal" href="#../05-optimizers/00-chapter-intro.md"><span class="xref myst">Chapter 5: Optimizers</span></a>.</p>
</div></blockquote>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">gepa</span><span class="w"> </span><span class="kn">import</span> <span class="n">GEPAOptimizer</span>

<span class="k">class</span><span class="w"> </span><span class="nc">OptimizedJudge</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Train LLM judge using GEPA for prompt optimization.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_judge_class</span><span class="p">,</span> <span class="n">training_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_judge_class</span> <span class="o">=</span> <span class="n">base_judge_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_data</span> <span class="o">=</span> <span class="n">training_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimized_prompt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trained_judge</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">optimize_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_iterations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Optimize the judge&#39;s prompt using GEPA.&quot;&quot;&quot;</span>

        <span class="c1"># Initialize GEPA optimizer</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">GEPAOptimizer</span><span class="p">(</span>
            <span class="n">population_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">generations</span><span class="o">=</span><span class="n">num_iterations</span><span class="p">,</span>
            <span class="n">objectives</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;robustness&quot;</span><span class="p">],</span>
            <span class="n">reflection_model</span><span class="o">=</span><span class="s2">&quot;gpt-4&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Define initial prompt</span>
        <span class="n">initial_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_judge_class</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__doc__</span>

        <span class="c1"># Create evaluation function</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">evaluate_prompt</span><span class="p">(</span><span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
            <span class="c1"># Create temporary judge with new prompt</span>
            <span class="n">temp_judge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_judge_class</span><span class="p">()</span>
            <span class="n">temp_judge</span><span class="o">.</span><span class="n">prompt_template</span> <span class="o">=</span> <span class="n">prompt</span>

            <span class="c1"># Evaluate on training data</span>
            <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">training_data</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_data</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">temp_judge</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="o">**</span><span class="n">example</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;evaluation&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">example</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;expected&#39;</span><span class="p">):</span>
                    <span class="n">correct</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;accuracy&quot;</span><span class="p">:</span> <span class="n">correct</span> <span class="o">/</span> <span class="n">total</span><span class="p">,</span>
                <span class="s2">&quot;robustness&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_robustness</span><span class="p">(</span><span class="n">temp_judge</span><span class="p">)</span>
            <span class="p">}</span>

        <span class="c1"># Run optimization</span>
        <span class="n">best_prompt</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
            <span class="n">program</span><span class="o">=</span><span class="n">initial_prompt</span><span class="p">,</span>
            <span class="n">trainset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_data</span><span class="p">,</span>
            <span class="n">evalset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_data</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">optimized_prompt</span> <span class="o">=</span> <span class="n">best_prompt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trained_judge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_judge_class</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trained_judge</span><span class="o">.</span><span class="n">prompt_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimized_prompt</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_robustness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">judge</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate robustness across diverse examples.&quot;&quot;&quot;</span>
        <span class="c1"># Test on edge cases and variations</span>
        <span class="n">edge_cases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_edge_cases</span><span class="p">()</span>
        <span class="n">consistent_results</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">edge_cases</span><span class="p">:</span>
            <span class="n">result1</span> <span class="o">=</span> <span class="n">judge</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="o">**</span><span class="n">case</span><span class="p">)</span>
            <span class="c1"># Slight variation</span>
            <span class="n">case_variant</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_noise</span><span class="p">(</span><span class="n">case</span><span class="p">)</span>
            <span class="n">result2</span> <span class="o">=</span> <span class="n">judge</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="o">**</span><span class="n">case_variant</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results_consistent</span><span class="p">(</span><span class="n">result1</span><span class="p">,</span> <span class="n">result2</span><span class="p">):</span>
                <span class="n">consistent_results</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">consistent_results</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">edge_cases</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="cost-sensitive-training">
<h3>2. Cost-Sensitive Training<a class="headerlink" href="#cost-sensitive-training" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CostSensitiveTraining</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Train judge with cost-sensitive loss function.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cost_matrix</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="nb">float</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cost_matrix</span> <span class="o">=</span> <span class="n">cost_matrix</span>
        <span class="c1"># Example: cost_matrix[(true, pred)] = penalty</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
                       <span class="n">labels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate weighted loss based on cost matrix.&quot;&quot;&quot;</span>
        <span class="n">total_cost</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">for</span> <span class="n">pred</span><span class="p">,</span> <span class="n">true</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
            <span class="n">cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_matrix</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">true</span><span class="p">,</span> <span class="n">pred</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">cost</span>

        <span class="k">return</span> <span class="n">total_cost</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>

<span class="c1"># Example cost matrix for clinical impact</span>
<span class="n">clinical_cost_matrix</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="mf">1.2</span><span class="p">,</span>   <span class="c1"># Correctly identify no impact</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mf">0.3</span><span class="p">,</span>   <span class="c1"># Over-predict minimal impact</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span>  <span class="c1"># Over-predict significant impact</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="mf">0.3</span><span class="p">,</span>   <span class="c1"># Under-predict minimal impact</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mf">1.5</span><span class="p">,</span>   <span class="c1"># Correctly identify minimal impact</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="mf">0.5</span><span class="p">,</span>   <span class="c1"># Over-predict significant impact</span>
    <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="o">-</span><span class="mf">1.2</span><span class="p">,</span>  <span class="c1"># Miss significant impact (worst)</span>
    <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mf">0.4</span><span class="p">,</span>   <span class="c1"># Under-predict significance</span>
    <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="mf">1.5</span>    <span class="c1"># Correctly identify significant impact</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="best-practices">
<h2>Best Practices<a class="headerlink" href="#best-practices" title="Link to this heading">#</a></h2>
<section id="prompt-design">
<h3>1. Prompt Design<a class="headerlink" href="#prompt-design" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Good: Clear, structured prompts with explicit criteria</span>
<span class="n">GOOD_PROMPT_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">You are evaluating [task_type] outputs.</span>

<span class="s2">Evaluation Criteria:</span>
<span class="s2">1. [Criterion 1]: [Clear definition]</span>
<span class="s2">2. [Criterion 2]: [Clear definition]</span>
<span class="s2">3. [Criterion 3]: [Clear definition]</span>

<span class="s2">For each criterion:</span>
<span class="s2">- Provide a score (1-5)</span>
<span class="s2">- Give specific justification</span>
<span class="s2">- Note any concerns</span>

<span class="s2">Output Format:</span>
<span class="s2">{</span>
<span class="s2">  &quot;scores&quot;: {{</span>
<span class="s2">    &quot;criterion_1&quot;: score,</span>
<span class="s2">    &quot;criterion_2&quot;: score,</span>
<span class="s2">    &quot;criterion_3&quot;: score</span>
<span class="s2">  }},</span>
<span class="s2">  &quot;justifications&quot;: {{</span>
<span class="s2">    &quot;criterion_1&quot;: &quot;explanation&quot;,</span>
<span class="s2">    &quot;criterion_2&quot;: &quot;explanation&quot;,</span>
<span class="s2">    &quot;criterion_3&quot;: &quot;explanation&quot;</span>
<span class="s2">  }},</span>
<span class="s2">  &quot;overall_assessment&quot;: &quot;summary&quot;,</span>
<span class="s2">  &quot;confidence&quot;: 0.0-1.0</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># Bad: Vague, unstructured evaluation</span>
<span class="n">BAD_PROMPT_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Is this output good?</span>
<span class="s2">Output: </span><span class="si">{hypothesis}</span>
<span class="s2">Reference: </span><span class="si">{ground_truth}</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>
</div>
</section>
<section id="handling-bias">
<h3>2. Handling Bias<a class="headerlink" href="#handling-bias" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">UnbiasedJudge</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Judge with bias mitigation strategies.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_judge</span><span class="p">,</span> <span class="n">bias_detectors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">callable</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_judge</span> <span class="o">=</span> <span class="n">base_judge</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_detectors</span> <span class="o">=</span> <span class="n">bias_detectors</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Get initial evaluation</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_judge</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Check for various biases</span>
        <span class="k">for</span> <span class="n">detector</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_detectors</span><span class="p">:</span>
            <span class="n">bias_score</span> <span class="o">=</span> <span class="n">detector</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bias_score</span> <span class="o">&gt;</span> <span class="mf">0.7</span><span class="p">:</span>  <span class="c1"># High bias detected</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;bias_warning&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;High </span><span class="si">{</span><span class="n">detector</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> detected&quot;</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;bias_score&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bias_score</span>

        <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span><span class="w"> </span><span class="nf">length_bias_detector</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">hypothesis</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Detect bias towards longer/shorter outputs.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hypothesis</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.8</span>  <span class="c1"># Likely favoring longer outputs</span>
    <span class="k">return</span> <span class="mf">0.1</span>

<span class="k">def</span><span class="w"> </span><span class="nf">positivity_bias_detector</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">hypothesis</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Detect bias towards overly positive evaluations.&quot;&quot;&quot;</span>
    <span class="n">positive_words</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;excellent&quot;</span><span class="p">,</span> <span class="s2">&quot;perfect&quot;</span><span class="p">,</span> <span class="s2">&quot;outstanding&quot;</span><span class="p">]</span>
    <span class="n">count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">positive_words</span> <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.7</span>
    <span class="k">return</span> <span class="mf">0.1</span>
</pre></div>
</div>
</section>
<section id="ensemble-of-judges">
<h3>3. Ensemble of Judges<a class="headerlink" href="#ensemble-of-judges" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">JudgeEnsemble</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Combine multiple judges for more robust evaluation.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">judges</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">LLMJudge</span><span class="p">],</span> <span class="n">weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">judges</span> <span class="o">=</span> <span class="n">judges</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="ow">or</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">judges</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get evaluations from all judges and combine.&quot;&quot;&quot;</span>
        <span class="n">evaluations</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">judge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">judges</span><span class="p">:</span>
            <span class="n">eval_result</span> <span class="o">=</span> <span class="n">judge</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">evaluations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eval_result</span><span class="p">)</span>

        <span class="c1"># Combine results</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_evaluations</span><span class="p">(</span><span class="n">evaluations</span><span class="p">)</span>

        <span class="c1"># Calculate confidence based on agreement</span>
        <span class="n">combined</span><span class="p">[</span><span class="s2">&quot;agreement_score&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_agreement</span><span class="p">(</span><span class="n">evaluations</span><span class="p">)</span>
        <span class="n">combined</span><span class="p">[</span><span class="s2">&quot;individual_evaluations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">evaluations</span>

        <span class="k">return</span> <span class="n">combined</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_combine_evaluations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evaluations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Combine multiple evaluation results.&quot;&quot;&quot;</span>
        <span class="c1"># Simple averaging for numeric scores</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="s1">&#39;evaluation&#39;</span> <span class="ow">in</span> <span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">evaluations</span><span class="p">):</span>
            <span class="c1"># For classification tasks</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;evaluation&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">evaluations</span><span class="p">]</span>
            <span class="n">combined</span><span class="p">[</span><span class="s1">&#39;evaluation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">))</span>
            <span class="n">combined</span><span class="p">[</span><span class="s1">&#39;vote_distribution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">score</span><span class="p">:</span> <span class="n">scores</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="k">for</span> <span class="n">score</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="n">combined</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_agreement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evaluations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate how much judges agree with each other.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">evaluations</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.0</span>

        <span class="n">agreements</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_comparisons</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">evaluations</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">evaluations</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">evaluations</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;evaluation&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">evaluations</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;evaluation&#39;</span><span class="p">):</span>
                    <span class="n">agreements</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">total_comparisons</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">agreements</span> <span class="o">/</span> <span class="n">total_comparisons</span> <span class="k">if</span> <span class="n">total_comparisons</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
</pre></div>
</div>
</section>
</section>
<section id="integration-with-dspy-evaluation">
<h2>Integration with DSPy Evaluation<a class="headerlink" href="#integration-with-dspy-evaluation" title="Link to this heading">#</a></h2>
<section id="custom-metrics">
<h3>1. Custom Metrics<a class="headerlink" href="#custom-metrics" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">LLMJudgeMetric</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Metric</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;DSPy metric that uses LLM judge for evaluation.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">judge</span><span class="p">:</span> <span class="n">LLMJudge</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">judge</span> <span class="o">=</span> <span class="n">judge</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">example</span><span class="p">,</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate prediction using LLM judge.&quot;&quot;&quot;</span>
        <span class="c1"># Extract relevant fields from example and prediction</span>
        <span class="n">ground_truth</span> <span class="o">=</span> <span class="n">example</span><span class="o">.</span><span class="n">outputs</span><span class="p">()</span>
        <span class="n">hypothesis</span> <span class="o">=</span> <span class="n">prediction</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">prediction</span><span class="p">))</span>

        <span class="c1"># Add context if available</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">example</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;context&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Get judge evaluation</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">judge</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
            <span class="n">ground_truth</span><span class="o">=</span><span class="n">ground_truth</span><span class="p">,</span>
            <span class="n">hypothesis</span><span class="o">=</span><span class="n">hypothesis</span><span class="p">,</span>
            <span class="n">context</span><span class="o">=</span><span class="n">context</span>
        <span class="p">)</span>

        <span class="c1"># Convert to numeric score</span>
        <span class="k">if</span> <span class="s1">&#39;evaluation&#39;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;evaluation&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span>  <span class="c1"># Normalize to [0, 1]</span>

        <span class="c1"># Fallback to confidence score</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;confidence&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

<span class="c1"># Usage in DSPy evaluation</span>
<span class="n">clinical_metric</span> <span class="o">=</span> <span class="n">LLMJudgeMetric</span><span class="p">(</span><span class="n">ClinicalImpactJudge</span><span class="p">())</span>

<span class="n">evaluate</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Evaluate</span><span class="p">(</span>
    <span class="n">devset</span><span class="o">=</span><span class="n">test_set</span><span class="p">,</span>
    <span class="n">metric</span><span class="o">=</span><span class="n">clinical_metric</span><span class="p">,</span>
    <span class="n">num_threads</span><span class="o">=</span><span class="mi">1</span>  <span class="c1"># LLM judges may be expensive</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="progressive-evaluation">
<h3>2. Progressive Evaluation<a class="headerlink" href="#progressive-evaluation" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ProgressiveEvaluator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Multi-stage evaluation using different judges.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;quick_filter&quot;</span><span class="p">,</span> <span class="n">QuickFilterJudge</span><span class="p">()),</span>  <span class="c1"># Fast, cheap</span>
            <span class="p">(</span><span class="s2">&quot;detailed&quot;</span><span class="p">,</span> <span class="n">DetailedJudge</span><span class="p">()),</span>        <span class="c1"># Slower, thorough</span>
            <span class="p">(</span><span class="s2">&quot;expert&quot;</span><span class="p">,</span> <span class="n">ExpertJudge</span><span class="p">())</span>              <span class="c1"># Slowest, most accurate</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">examples</span><span class="p">,</span> <span class="n">predictions</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Progressively evaluate with increasing detail.&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">stage_name</span><span class="p">,</span> <span class="n">judge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stages</span><span class="p">:</span>
            <span class="n">stage_results</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">example</span><span class="p">,</span> <span class="n">pred</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">examples</span><span class="p">,</span> <span class="n">predictions</span><span class="p">):</span>
                <span class="c1"># Skip if already filtered out</span>
                <span class="k">if</span> <span class="n">stage_name</span> <span class="o">!=</span> <span class="s2">&quot;quick_filter&quot;</span> <span class="ow">and</span> \
                   <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;quick_filter&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">stage_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="n">result</span> <span class="o">=</span> <span class="n">judge</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
                    <span class="n">ground_truth</span><span class="o">=</span><span class="n">example</span><span class="o">.</span><span class="n">outputs</span><span class="p">(),</span>
                    <span class="n">hypothesis</span><span class="o">=</span><span class="n">pred</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">pred</span><span class="p">))</span>
                <span class="p">)</span>

                <span class="n">passed</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;evaluation&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">stage_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">passed</span><span class="p">)</span>

            <span class="n">results</span><span class="p">[</span><span class="n">stage_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">],</span>
                                           <span class="n">stage_results</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">results</span>
</pre></div>
</div>
</section>
</section>
<section id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Link to this heading">#</a></h2>
<ol class="arabic simple">
<li><p><strong>Implement Domain-Specific Judge</strong>: Create an LLM judge for evaluating responses in your specific domain (e.g., legal documents, scientific papers, customer service).</p></li>
<li><p><strong>Compare with Traditional Metrics</strong>: Evaluate a dataset using both traditional metrics (WER, BLEU) and an LLM judge. Compare the correlation with human judgments.</p></li>
<li><p><strong>Optimize with GEPA</strong>: Take a basic judge prompt and optimize it using GEPA on a small labeled dataset.</p></li>
<li><p><strong>Create Ensemble</strong>: Build an ensemble of judges with different specializations and evaluate their combined performance.</p></li>
<li><p><strong>Bias Analysis</strong>: Implement bias detection for your judge and analyze potential biases in evaluations.</p></li>
</ol>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./content/04_evaluation"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="07_structured_prompting.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Structured Prompting for Robust Evaluation</p>
      </div>
    </a>
    <a class="right-next"
       href="09_human_aligned_evaluation.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Human-Aligned Evaluation: Capturing What Really Matters</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#when-to-use-llm-as-a-judge">When to Use LLM-as-a-Judge</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#domain-specific-impact-assessment">1. Domain-Specific Impact Assessment</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#nuanced-semantic-evaluation">2. Nuanced Semantic Evaluation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multi-dimensional-quality-assessment">3. Multi-Dimensional Quality Assessment</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation-framework">Implementation Framework</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#core-judge-architecture">1. Core Judge Architecture</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#clinical-impact-judge">2. Clinical Impact Judge</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#specialized-judges-for-different-domains">3. Specialized Judges for Different Domains</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#training-and-optimization">Training and Optimization</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-gepa-for-prompt-optimization">1. Using GEPA for Prompt Optimization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cost-sensitive-training">2. Cost-Sensitive Training</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#best-practices">Best Practices</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#prompt-design">1. Prompt Design</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#handling-bias">2. Handling Bias</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ensemble-of-judges">3. Ensemble of Judges</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#integration-with-dspy-evaluation">Integration with DSPy Evaluation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-metrics">1. Custom Metrics</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#progressive-evaluation">2. Progressive Evaluation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Dustin Ober
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      Â© Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>