
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Assertions Module &#8212; DSPy: The Complete Guide</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=9c3e77be" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=1ae7504c"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'content/03_modules/08_assertions';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Chapter 4: Evaluation" href="../04_evaluation/00_chapter_intro.html" />
    <link rel="prev" title="Chapter 3 Exercises" href="07_exercises.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../00_frontmatter/00_preface.html">
  
  
  
  
  
  
    <p class="title logo__title">DSPy: The Complete Guide</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../00_frontmatter/01_how_to_use_this_book.html">How to Use This Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_frontmatter/02_prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_frontmatter/03_setup_instructions.html">Setup Instructions</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 1 - Fundamentals</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../01_fundamentals/00_chapter_intro.html">Chapter 1: DSPy Fundamentals</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../01_fundamentals/01_what_is_dspy.html">What is DSPy?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01_fundamentals/02_programming_vs_prompting.html">Programming vs. Prompting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01_fundamentals/03_installation_setup.html">Installation and Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01_fundamentals/04_first_dspy_program.html">Your First DSPy Program</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01_fundamentals/05_language_models.html">Language Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01_fundamentals/06_exercises.html">Chapter 1 Exercises</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 2 - Signatures</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../02_signatures/00_chapter_intro.html">Chapter 2: Signatures</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../02_signatures/01_understanding_signatures.html">Understanding Signatures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02_signatures/02_signature_syntax.html">Signature Syntax</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02_signatures/03_typed_signatures.html">Typed Signatures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02_signatures/04_advanced_signatures.html">Advanced Signatures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02_signatures/05_practical_examples.html">Practical Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02_signatures/06_exercises.html">Chapter 2 Exercises</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 3 - Modules</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="00_chapter_intro.html">Chapter 3: Modules</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="01_module_basics.html">Module Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="02_predict_module.html">The Predict Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="02a_typed_predictor.html">TypedPredictor: Type-Safe Language Model Wrappers</a></li>
<li class="toctree-l2"><a class="reference internal" href="03_chainofthought.html">Chain of Thought Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="04_react_agents.html">ReAct Agents</a></li>
<li class="toctree-l2"><a class="reference internal" href="05_custom_modules.html">Custom Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="06_composing_modules.html">Composing Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="07_exercises.html">Chapter 3 Exercises</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Assertions Module</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 4 - Evaluation</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../04_evaluation/00_chapter_intro.html">Chapter 4: Evaluation</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/01_why_evaluation_matters.html">Why Evaluation Matters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/02_creating_datasets.html">Creating Datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/03_defining_metrics.html">Defining Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/04_evaluation_loops.html">Evaluation Loops</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/05_best_practices.html">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/06_exercises.html">Exercises</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/07_structured_prompting.html">Structured Prompting for Robust Evaluation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/08_llm_as_a_judge.html">LLM-as-a-Judge for Context-Sensitive Evaluation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/09_human_aligned_evaluation.html">Human-Aligned Evaluation: Capturing What Really Matters</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 5 - Optimizers</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../05_optimizers/00_chapter_intro.html">Chapter 5: Optimizers &amp; Compilation</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/01_compilation_concept.html">The Compilation Concept in DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/02_bootstrapfewshot.html">BootstrapFewShot: Automatic Few-Shot Example Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/02a_copro.html">COPRO: Chain-of-Thought Prompt Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/03_mipro.html">MIPRO: Multi-step Instruction and Demonstration Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/04_knnfewshot.html">KNNFewShot: Similarity-Based Example Selection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/05_finetuning.html">Fine-Tuning Small Language Models in DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/06_choosing_optimizers.html">Choosing Optimizers: Decision Guide and Trade-offs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/07_constraint_driven_optimization.html">Constraint-Driven Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/07_exercises.html">Chapter 5 Exercises: Optimizers &amp; Compilation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/08_reflective_prompt_evolution.html">Reflective Prompt Evolution (RPE): Evolutionary Optimization Without Gradients</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/09_copa_compiler_method.html">COPA: Compiler and Prompt Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/09a_copa_method.html">COPA: Combined Fine-Tuning and Prompt Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/10_joint_optimization.html">Joint Optimization: Fine-Tuning and Prompt Synergy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/11_monte_carlo_optimization.html">Monte Carlo Optimization in DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/12_bayesian_optimization.html">Bayesian Optimization for Prompt Tuning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/13_comprehensive_examples.html">Comprehensive Examples and Implementation Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/14_multistage_optimization_theory.html">Multi-stage Optimization Theory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/15_instruction_tuning_frameworks.html">Instruction Tuning Frameworks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/16_demonstration_optimization.html">Demonstration Optimization Strategies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/17_multistage_architectures.html">Multi-stage Program Architectures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/18_complex_pipeline_optimization.html">Optimization Strategies for Complex Pipelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/19_instruction_demonstration_interactions.html">Instruction and Demonstration Interaction Effects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/20_prompts_as_hyperparameters.html">Prompts as Auto-Optimized Hyperparameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/21_minimal_data_pipelines.html">Minimal Data Training Pipelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/22_gepa_genetic_pareto_optimization.html">GEPA: Genetic-Pareto Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/23_state_space_prompt_optimization.html">State-Space Search for Prompt Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/24_inpars_plus_synthetic_data_ir.html">InPars+: Advanced Synthetic Data Generation for Information Retrieval</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/25_custom_mipro_enhanced_optimization.html">CustomMIPROv2: Enhanced Multi-Stage Prompt Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/26_automatic_prompt_optimization_research.html">Automatic Prompt Optimization: When AI Outperforms Humans</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 6 - Real-World Applications</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../06_real_world_applications/00_chapter_intro.html">Chapter 6: Building Real-World Applications</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/01_rag_systems.html">RAG Systems: Building Intelligent Document Q&amp;A</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/02_multi_hop_search.html">Multi-hop Search: Complex Reasoning Across Documents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/03_classification_tasks.html">Classification Tasks: Building Robust Text Categorization Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/04_entity_extraction.html">Entity Extraction: Mining Structured Information from Text</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/05_intelligent_agents.html">Intelligent Agents: Building Autonomous Problem-Solving Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/06_code_generation.html">Code Generation: Building Automated Programming Assistants</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/07_exercises.html">Chapter 6 Exercises: Building Real-World Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/07a_perspective_driven_research.html">Perspective-Driven Research for Article Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/08_extreme_multilabel_classification.html">Extreme Multi-Label Classification: Scaling to Millions of Labels</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/08a_long_form_generation.html">Long-form Article Generation with DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/09_outline_generation.html">Outline Generation for Structured Article Writing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/11_extreme_few_shot_learning.html">Extreme Few-Shot Learning: Training with 10 Gold Labels</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/12_ir_model_training_scratch.html">IR Model Training from Scratch: Methodology and Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/13_lingvarbench_healthcare_synthetic_data.html">LingVarBench: Synthetic Healthcare Transcript Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/14_scientific_figure_caption_generation.html">Scientific Figure Caption Generation with DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/15_retrieval_augmented_guardrails.html">Retrieval-Augmented Guardrails for AI Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/16_graphrag_wikipedia_tidb_tutorial.html">GraphRAG from Wikipedia: Building with DSPy, OpenAI, and TiDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/17_framework_comparisons_dspy_ecosystem.html">Framework Comparisons in the DSPy Ecosystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/18_multi_agent_rag_systems.html">Multi-Agent RAG Systems with DSPy</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 7 - Advanced Topics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../07_advanced_topics/00_chapter_intro.html">Chapter 7: Advanced Topics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/01_adapters_tools.html">Adapters and Tools: Extending DSPy Capabilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/02_caching_performance.html">Caching and Performance: Building High-Performance DSPy Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/03_async_streaming.html">Async and Streaming: Building Real-Time DSPy Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/04_debugging_tracing.html">Debugging and Tracing: Mastering DSPy Application Diagnostics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/05_deployment_strategies.html">Deployment Strategies: Taking DSPy Applications to Production</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/06_exercises.html">Chapter 7 Exercises: Advanced Topics Mastery</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/07_self_refining_pipelines.html">Self-Refining Pipelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/08_declarative_compilation.html">Declarative Language Model Compilation Techniques</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 8 - Case Studies</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../08_case_studies/00_introduction.html">Chapter 8: Case Studies</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/01_enterprise_rag_system.html">Case Study 1: Building an Enterprise RAG System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/01a_healthcare_clinical_notes.html">Case Study 1: Clinical Notes Analysis with DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/02_customer_support_chatbot.html">Case Study 2: Developing a Customer Support Chatbot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/03_ai_code_assistant.html">Case Study 3: Creating an AI-Powered Code Assistant</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/04_automated_data_analysis.html">Case Study 4: Building an Automated Data Analysis Pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/05_exercises.html">Chapter 8 Exercises</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/05a_storm_writing_assistant.html">Case Study 5: STORM - AI-Powered Writing Assistant for Wikipedia-like Articles</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/06_assertion_driven_applications.html">Case Study: Assertion-Driven Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/07_databricks_jetblue_llm_optimization.html">Case Study 7: Databricks &amp; JetBlue LLM Pipeline Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/08_replit_code_repair_dspy.html">Case Study 8: Replit Code Repair with DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/09_databricks_dspy_platform_integration.html">Case Study 9: Databricks Platform Integration with DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/10_ddi_behavioral_simulation_automation.html">Case Study 10: DDI Behavioral Simulation Automation with DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/11_salomatic_medical_report_generation.html">Case Study 11: Salomatic Medical Report Generation with DSPy and Langtrace</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../09_appendices/00_introduction.html">Chapter 9: Appendices</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../09_appendices/01_api_reference_quick.html">API Reference Quick Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09_appendices/02_troubleshooting.html">Troubleshooting Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09_appendices/03_resources.html">Additional Resources</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09_appendices/04_glossary.html">Glossary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09_appendices/05_community_resources.html">Community Resources and Perspectives</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/content/03_modules/08_assertions.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Assertions Module</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prerequisites">Prerequisites</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-objectives">Learning Objectives</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction-to-assertions">Introduction to Assertions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#why-assertions-matter">Why Assertions Matter</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#core-assertion-types">Core Assertion Types</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dspy-assert-hard-constraints">1. dspy.Assert - Hard Constraints</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dspy-suggest-soft-constraints">2. dspy.Suggest - Soft Constraints</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multiple-assertions">3. Multiple Assertions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#constraint-types">Constraint Types</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#format-constraints">1. Format Constraints</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#semantic-constraints">2. Semantic Constraints</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#consistency-constraints">3. Consistency Constraints</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-assertion-patterns">Advanced Assertion Patterns</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#self-refining-pipelines">1. Self-Refining Pipelines</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#contextual-assertions">2. Contextual Assertions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multi-output-assertions">3. Multi-Output Assertions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#integration-with-existing-modules">Integration with Existing Modules</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assertions-with-chainofthought">1. Assertions with ChainOfThought</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assertions-with-react">2. Assertions with ReAct</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-assertion-handlers">3. Custom Assertion Handlers</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#best-practices">Best Practices</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#design-effective-validators">1. Design Effective Validators</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#balance-strictness-and-flexibility">2. Balance Strictness and Flexibility</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#handle-edge-cases">3. Handle Edge Cases</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#performance-considerations">Performance Considerations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assertion-overhead">1. Assertion Overhead</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#caching-validation-results">2. Caching Validation Results</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#progressive-validation">3. Progressive Validation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#debugging-assertions">Debugging Assertions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#trace-inspection">1. Trace Inspection</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assertion-metrics">2. Assertion Metrics</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Advanced Assertion Patterns</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hierarchical-assertions">1. Hierarchical Assertions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#probabilistic-assertions">2. Probabilistic Assertions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#distributed-assertions">3. Distributed Assertions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-assertions">4. Learning Assertions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#key-takeaways">Key Takeaways</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#further-reading">Further Reading</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="assertions-module">
<h1>Assertions Module<a class="headerlink" href="#assertions-module" title="Link to this heading">#</a></h1>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>Previous Section</strong>: <a class="reference internal" href="#./06-composing-modules.md"><span class="xref myst">Composing Modules</span></a> - Understanding of module composition</p></li>
<li><p><strong>Chapter 2</strong>: Signatures - Strong familiarity with signature design</p></li>
<li><p><strong>Required Knowledge</strong>: Constraint validation, error handling patterns</p></li>
<li><p><strong>Difficulty Level</strong>: Advanced</p></li>
<li><p><strong>Estimated Reading Time</strong>: 60 minutes</p></li>
</ul>
</section>
<section id="learning-objectives">
<h2>Learning Objectives<a class="headerlink" href="#learning-objectives" title="Link to this heading">#</a></h2>
<p>By the end of this section, you will:</p>
<ul class="simple">
<li><p>Master the <code class="docutils literal notranslate"><span class="pre">dspy.Assert</span></code> and <code class="docutils literal notranslate"><span class="pre">dspy.Suggest</span></code> constraint system</p></li>
<li><p>Learn to implement runtime validation for AI outputs</p></li>
<li><p>Build self-refining pipelines with automatic error recovery</p></li>
<li><p>Understand the computational constraints framework</p></li>
<li><p>Design robust AI applications with guaranteed output quality</p></li>
</ul>
</section>
<section id="introduction-to-assertions">
<h2>Introduction to Assertions<a class="headerlink" href="#introduction-to-assertions" title="Link to this heading">#</a></h2>
<p>Assertions in DSPy provide a powerful mechanism for ensuring the quality and correctness of AI-generated outputs. They act as runtime validators that check if the modelâ€™s output meets specified constraints, and can automatically trigger refinement when constraints are violated.</p>
<section id="why-assertions-matter">
<h3>Why Assertions Matter<a class="headerlink" href="#why-assertions-matter" title="Link to this heading">#</a></h3>
<p><strong>Without Assertions:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Brittle - no validation</span>
<span class="n">qa</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span><span class="s2">&quot;question -&gt; answer&quot;</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">qa</span><span class="p">(</span><span class="n">question</span><span class="o">=</span><span class="s2">&quot;What is 2+2?&quot;</span><span class="p">)</span>
<span class="c1"># Model might return &quot;4&quot;, &quot;Four&quot;, &quot;The answer is 4&quot;, or even hallucinate</span>
</pre></div>
</div>
<p><strong>With Assertions:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Robust - guaranteed format and correctness</span>
<span class="n">qa</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span><span class="s2">&quot;question -&gt; answer&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">validate_numeric_answer</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Check if answer is a number</span>
    <span class="k">assert</span> <span class="n">pred</span><span class="o">.</span><span class="n">answer</span><span class="o">.</span><span class="n">isdigit</span><span class="p">(),</span> <span class="s2">&quot;Answer must be numeric&quot;</span>
    <span class="c1"># Check if it&#39;s actually correct</span>
    <span class="k">assert</span> <span class="nb">int</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">answer</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;Answer must be correct&quot;</span>
    <span class="k">return</span> <span class="kc">True</span>

<span class="c1"># Configure assertion</span>
<span class="n">qa</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Assert</span><span class="p">(</span>
    <span class="n">qa</span><span class="p">,</span>
    <span class="n">validation_fn</span><span class="o">=</span><span class="n">validate_numeric_answer</span><span class="p">,</span>
    <span class="n">max_attempts</span><span class="o">=</span><span class="mi">3</span>
<span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">qa</span><span class="p">(</span><span class="n">question</span><span class="o">=</span><span class="s2">&quot;What is 2+2?&quot;</span><span class="p">)</span>
<span class="c1"># Guaranteed: result.answer is &quot;4&quot;</span>
</pre></div>
</div>
</section>
</section>
<section id="core-assertion-types">
<h2>Core Assertion Types<a class="headerlink" href="#core-assertion-types" title="Link to this heading">#</a></h2>
<section id="dspy-assert-hard-constraints">
<h3>1. dspy.Assert - Hard Constraints<a class="headerlink" href="#dspy-assert-hard-constraints" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">dspy.Assert</span></code> enforces strict constraints that must be satisfied. If a constraint fails, the system automatically retries with refined instructions.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">dspy</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CodeGenerator</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Signature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate Python code for the given task.&quot;&quot;&quot;</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">InputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Programming task to implement&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">OutputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Valid Python code&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

<span class="c1"># Create the module</span>
<span class="n">coder</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">ChainOfThought</span><span class="p">(</span><span class="n">CodeGenerator</span><span class="p">)</span>

<span class="c1"># Define assertion function</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_syntax</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure generated code has valid Python syntax.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">compile</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="s1">&#39;&lt;string&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">SyntaxError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Provide helpful error message</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Syntax error in generated code: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Wrap with assertion</span>
<span class="n">safe_coder</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Assert</span><span class="p">(</span>
    <span class="n">coder</span><span class="p">,</span>
    <span class="n">validation_fn</span><span class="o">=</span><span class="n">validate_syntax</span><span class="p">,</span>
    <span class="n">max_attempts</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">backtrack</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># Try different approach on failure</span>
<span class="p">)</span>

<span class="c1"># Use it</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">safe_coder</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="s2">&quot;Create a function to calculate factorial&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>  <span class="c1"># Guaranteed to be syntactically valid</span>
</pre></div>
</div>
</section>
<section id="dspy-suggest-soft-constraints">
<h3>2. dspy.Suggest - Soft Constraints<a class="headerlink" href="#dspy-suggest-soft-constraints" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">dspy.Suggest</span></code> provides gentle guidance for improving outputs without strict enforcement.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">EssayWriter</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Signature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write an essay on the given topic.&quot;&quot;&quot;</span>
    <span class="n">topic</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">InputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Essay topic&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">essay</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">OutputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Well-written essay&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

<span class="n">writer</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span><span class="n">EssayWriter</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">suggest_improvements</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Suggest improvements for better essays.&quot;&quot;&quot;</span>
    <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">essay</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Essay should be at least 200 words&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">punc</span> <span class="ow">in</span> <span class="n">pred</span><span class="o">.</span><span class="n">essay</span> <span class="k">for</span> <span class="n">punc</span> <span class="ow">in</span> <span class="s1">&#39;.!?&#39;</span><span class="p">):</span>
        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Include proper punctuation&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">pred</span><span class="o">.</span><span class="n">essay</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isupper</span><span class="p">()])</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Start sentences with capital letters&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">suggestions</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Please improve: </span><span class="si">{</span><span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">suggestions</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">None</span>

<span class="c1"># Wrap with suggestions</span>
<span class="n">improved_writer</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Suggest</span><span class="p">(</span>
    <span class="n">writer</span><span class="p">,</span>
    <span class="n">validation_fn</span><span class="o">=</span><span class="n">suggest_improvements</span><span class="p">,</span>
    <span class="n">max_attempts</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">recovery_hint</span><span class="o">=</span><span class="s2">&quot;Focus on clarity, grammar, and completeness&quot;</span>
<span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">improved_writer</span><span class="p">(</span><span class="n">topic</span><span class="o">=</span><span class="s2">&quot;The importance of sleep&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="multiple-assertions">
<h3>3. Multiple Assertions<a class="headerlink" href="#multiple-assertions" title="Link to this heading">#</a></h3>
<p>Chain multiple assertions for comprehensive validation:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DataProcessor</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Signature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process and analyze data.&quot;&quot;&quot;</span>
    <span class="n">raw_data</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">InputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Raw input data&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">processed_data</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">OutputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processed output&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">insights</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">OutputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Key insights from data&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

<span class="n">processor</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span><span class="n">DataProcessor</span><span class="p">)</span>

<span class="c1"># Assertion 1: JSON format</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_json_format</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">processed_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Processed data must be valid JSON&quot;</span><span class="p">)</span>

<span class="c1"># Assertion 2: Required fields</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_required_fields</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">processed_data</span><span class="p">)</span>
    <span class="n">required</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span>
    <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">required</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing required fields: </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>

<span class="c1"># Assertion 3: Insights quality</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_insights</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">insights</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Insights must be detailed (min 50 characters)&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>

<span class="c1"># Chain all assertions</span>
<span class="n">robust_processor</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">with_assertions</span><span class="p">([</span>
    <span class="n">validate_json_format</span><span class="p">,</span>
    <span class="n">validate_required_fields</span><span class="p">,</span>
    <span class="n">validate_insights</span>
<span class="p">])</span>
</pre></div>
</div>
</section>
</section>
<section id="constraint-types">
<h2>Constraint Types<a class="headerlink" href="#constraint-types" title="Link to this heading">#</a></h2>
<section id="format-constraints">
<h3>1. Format Constraints<a class="headerlink" href="#format-constraints" title="Link to this heading">#</a></h3>
<p>Ensure outputs follow specific structural requirements:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">APIResponse</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Signature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate API responses.&quot;&quot;&quot;</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">InputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;API request details&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">OutputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;JSON API response&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">validate_api_response</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure valid API response format.&quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>

        <span class="c1"># Check required structure</span>
        <span class="k">assert</span> <span class="s1">&#39;status&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">,</span> <span class="s2">&quot;Missing &#39;status&#39; field&quot;</span>
        <span class="k">assert</span> <span class="s1">&#39;data&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">,</span> <span class="s2">&quot;Missing &#39;data&#39; field&quot;</span>

        <span class="c1"># Check status codes</span>
        <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">201</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">404</span><span class="p">,</span> <span class="mi">500</span><span class="p">],</span> \
               <span class="sa">f</span><span class="s2">&quot;Invalid status code: </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Check data types</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">),</span> <span class="s2">&quot;Status must be integer&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">)),</span> <span class="s2">&quot;Data must be object or array&quot;</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Response must be valid JSON&quot;</span><span class="p">)</span>

<span class="n">api_generator</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Assert</span><span class="p">(</span>
    <span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span><span class="n">APIResponse</span><span class="p">),</span>
    <span class="n">validation_fn</span><span class="o">=</span><span class="n">validate_api_response</span><span class="p">,</span>
    <span class="n">max_attempts</span><span class="o">=</span><span class="mi">3</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="semantic-constraints">
<h3>2. Semantic Constraints<a class="headerlink" href="#semantic-constraints" title="Link to this heading">#</a></h3>
<p>Validate the meaning and correctness of outputs:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MathTutor</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Signature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Solve math problems with explanations.&quot;&quot;&quot;</span>
    <span class="n">problem</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">InputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Math problem to solve&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">solution</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">OutputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Step-by-step solution&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">answer</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">OutputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Final numerical answer&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">validate_math_solution</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate mathematical correctness.&quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">math</span>

    <span class="c1"># Extract numerical answer</span>
    <span class="n">numbers</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;-?\d+\.?\d*&#39;</span><span class="p">,</span> <span class="n">pred</span><span class="o">.</span><span class="n">answer</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">numbers</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Answer must contain a number&quot;</span><span class="p">)</span>

    <span class="n">model_answer</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">numbers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Verify with actual calculation</span>
    <span class="k">if</span> <span class="s2">&quot;square root&quot;</span> <span class="ow">in</span> <span class="n">example</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;square root of (\d+)&#39;</span><span class="p">,</span> <span class="n">example</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">num</span><span class="p">:</span>
            <span class="n">correct</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">model_answer</span> <span class="o">-</span> <span class="n">correct</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Incorrect square root calculation&quot;</span><span class="p">)</span>

    <span class="c1"># Check if solution explains steps</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">solution</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Solution must show multiple steps&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">True</span>

<span class="n">math_tutor</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Assert</span><span class="p">(</span>
    <span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span><span class="n">MathTutor</span><span class="p">),</span>
    <span class="n">validation_fn</span><span class="o">=</span><span class="n">validate_math_solution</span><span class="p">,</span>
    <span class="n">max_attempts</span><span class="o">=</span><span class="mi">3</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="consistency-constraints">
<h3>3. Consistency Constraints<a class="headerlink" href="#consistency-constraints" title="Link to this heading">#</a></h3>
<p>Ensure consistency between multiple outputs:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">StoryGenerator</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Signature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a coherent story.&quot;&quot;&quot;</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">InputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Story prompt&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">OutputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Story title&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">OutputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Brief summary&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">OutputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Full story content&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">validate_story_consistency</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure story elements are consistent.&quot;&quot;&quot;</span>

    <span class="c1"># Title should reflect content</span>
    <span class="n">title_words</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
    <span class="n">content_words</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[:</span><span class="mi">50</span><span class="p">])</span>  <span class="c1"># First 50 words</span>
    <span class="n">overlap</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">title_words</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">content_words</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">overlap</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Title doesn&#39;t match story content&quot;</span><span class="p">)</span>

    <span class="c1"># Summary should match content</span>
    <span class="k">if</span> <span class="n">pred</span><span class="o">.</span><span class="n">summary</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pred</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
        <span class="c1"># Allow for paraphrasing by checking key concepts</span>
        <span class="n">summary_concepts</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">content_lower</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">concept</span> <span class="ow">in</span> <span class="n">summary_concepts</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">concept</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">concept</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">content_lower</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Summary mentions &#39;</span><span class="si">{</span><span class="n">concept</span><span class="si">}</span><span class="s2">&#39; not in story&quot;</span><span class="p">)</span>

    <span class="c1"># Check story length</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">content</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Story too short (minimum 500 characters)&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">True</span>

<span class="n">story_generator</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Assert</span><span class="p">(</span>
    <span class="n">dspy</span><span class="o">.</span><span class="n">ChainOfThought</span><span class="p">(</span><span class="n">StoryGenerator</span><span class="p">),</span>
    <span class="n">validation_fn</span><span class="o">=</span><span class="n">validate_story_consistency</span><span class="p">,</span>
    <span class="n">max_attempts</span><span class="o">=</span><span class="mi">2</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="advanced-assertion-patterns">
<h2>Advanced Assertion Patterns<a class="headerlink" href="#advanced-assertion-patterns" title="Link to this heading">#</a></h2>
<section id="self-refining-pipelines">
<h3>1. Self-Refining Pipelines<a class="headerlink" href="#self-refining-pipelines" title="Link to this heading">#</a></h3>
<p>Build pipelines that improve themselves based on assertion feedback:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SelfImprovingWriter</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A writer that improves its output based on quality metrics.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">ChainOfThought</span><span class="p">(</span><span class="s2">&quot;topic -&gt; draft&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">critic</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">ChainOfThought</span><span class="p">(</span><span class="s2">&quot;draft, criteria -&gt; critique&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">improver</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">ChainOfThought</span><span class="p">(</span><span class="s2">&quot;draft, critique -&gt; improved_draft&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topic</span><span class="p">):</span>
        <span class="c1"># Initial draft</span>
        <span class="n">draft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">topic</span><span class="o">=</span><span class="n">topic</span><span class="p">)</span>

        <span class="c1"># Quality criteria</span>
        <span class="n">criteria</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        1. Clarity: Is the writing clear and easy to understand?</span>
<span class="s2">        2. Completeness: Does it fully address the topic?</span>
<span class="s2">        3. Engagement: Is it interesting to read?</span>
<span class="s2">        4. Accuracy: Are all statements factual?</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="c1"># Critique the draft</span>
        <span class="n">critique</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">critic</span><span class="p">(</span><span class="n">draft</span><span class="o">=</span><span class="n">draft</span><span class="o">.</span><span class="n">draft</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">)</span>

        <span class="c1"># Improve based on critique</span>
        <span class="n">improved</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">improver</span><span class="p">(</span><span class="n">draft</span><span class="o">=</span><span class="n">draft</span><span class="o">.</span><span class="n">draft</span><span class="p">,</span> <span class="n">critique</span><span class="o">=</span><span class="n">critique</span><span class="o">.</span><span class="n">critique</span><span class="p">)</span>

        <span class="c1"># Assert quality</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">validate_quality</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">word_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">improved_draft</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
            <span class="k">assert</span> <span class="n">word_count</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;Draft too short&quot;</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">improved_draft</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;Add more paragraphs&quot;</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Apply assertion with self-refinement</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Assert</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">validation_fn</span><span class="o">=</span><span class="n">validate_quality</span><span class="p">,</span>
            <span class="n">max_attempts</span><span class="o">=</span><span class="mi">3</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Prediction</span><span class="p">(</span><span class="n">improved_draft</span><span class="o">=</span><span class="n">improved</span><span class="o">.</span><span class="n">improved_draft</span><span class="p">)</span>

<span class="c1"># Use the self-improving writer</span>
<span class="n">writer</span> <span class="o">=</span> <span class="n">SelfImprovingWriter</span><span class="p">()</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">writer</span><span class="p">(</span><span class="n">topic</span><span class="o">=</span><span class="s2">&quot;The benefits of renewable energy&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="contextual-assertions">
<h3>2. Contextual Assertions<a class="headerlink" href="#contextual-assertions" title="Link to this heading">#</a></h3>
<p>Adapt validation based on input context:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AdaptiveValidator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validates outputs based on input context.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rules</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;technical&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_technical</span><span class="p">,</span>
            <span class="s1">&#39;creative&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_creative</span><span class="p">,</span>
            <span class="s1">&#39;formal&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_formal</span><span class="p">,</span>
            <span class="s1">&#39;casual&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_casual</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_style</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine writing style from input.&quot;&quot;&quot;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">text</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;algorithm&#39;</span><span class="p">,</span> <span class="s1">&#39;technical&#39;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="s1">&#39;technical&#39;</span>
        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">text</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;story&#39;</span><span class="p">,</span> <span class="s1">&#39;poem&#39;</span><span class="p">,</span> <span class="s1">&#39;creative&#39;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="s1">&#39;creative&#39;</span>
        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">text</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;report&#39;</span><span class="p">,</span> <span class="s1">&#39;formal&#39;</span><span class="p">,</span> <span class="s1">&#39;business&#39;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="s1">&#39;formal&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;casual&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_technical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate technical content.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="s1">&#39;}&#39;</span> <span class="ow">in</span> <span class="n">pred</span><span class="o">.</span><span class="n">output</span> <span class="ow">or</span> <span class="s1">&#39;;&#39;</span> <span class="ow">in</span> <span class="n">pred</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> \
               <span class="s2">&quot;Technical content should include code examples&quot;</span>
        <span class="k">assert</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">pred</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                  <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;implementation&#39;</span><span class="p">,</span> <span class="s1">&#39;example&#39;</span><span class="p">,</span> <span class="s1">&#39;function&#39;</span><span class="p">]),</span> \
               <span class="s2">&quot;Include practical implementation details&quot;</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_creative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate creative content.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">output</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;Creative content should be substantial&quot;</span>
        <span class="n">sentences</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sentences</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;Include multiple sentences&quot;</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_formal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate formal content.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">pred</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                      <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;hey&#39;</span><span class="p">,</span> <span class="s1">&#39;guys&#39;</span><span class="p">,</span> <span class="s1">&#39;awesome&#39;</span><span class="p">]),</span> \
               <span class="s2">&quot;Avoid informal language in formal writing&quot;</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_casual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate casual content.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># No strict requirements</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Route to appropriate validator based on context.&quot;&quot;&quot;</span>
        <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_style</span><span class="p">(</span><span class="n">example</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>
        <span class="n">validator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">style</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_casual</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">validator</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

<span class="c1"># Use adaptive validation</span>
<span class="n">validator</span> <span class="o">=</span> <span class="n">AdaptiveValidator</span><span class="p">()</span>

<span class="n">adaptive_writer</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Assert</span><span class="p">(</span>
    <span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span><span class="s2">&quot;input -&gt; output&quot;</span><span class="p">),</span>
    <span class="n">validation_fn</span><span class="o">=</span><span class="n">validator</span><span class="o">.</span><span class="n">validate</span><span class="p">,</span>
    <span class="n">max_attempts</span><span class="o">=</span><span class="mi">2</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="multi-output-assertions">
<h3>3. Multi-Output Assertions<a class="headerlink" href="#multi-output-assertions" title="Link to this heading">#</a></h3>
<p>Validate relationships between multiple output fields:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MovieReview</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Signature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a comprehensive movie review.&quot;&quot;&quot;</span>
    <span class="n">movie</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">InputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Movie title&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">rating</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">OutputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Rating 1-10&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">OutputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Brief summary&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">detailed_review</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">OutputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Full review&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">validate_review_consistency</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure all parts of the review are consistent.&quot;&quot;&quot;</span>

    <span class="c1"># Rating must be in valid range</span>
    <span class="k">assert</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">pred</span><span class="o">.</span><span class="n">rating</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Rating </span><span class="si">{</span><span class="n">pred</span><span class="o">.</span><span class="n">rating</span><span class="si">}</span><span class="s2"> out of range&quot;</span>

    <span class="c1"># High ratings should have positive content</span>
    <span class="k">if</span> <span class="n">pred</span><span class="o">.</span><span class="n">rating</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">:</span>
        <span class="n">positive_words</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;excellent&#39;</span><span class="p">,</span> <span class="s1">&#39;amazing&#39;</span><span class="p">,</span> <span class="s1">&#39;brilliant&#39;</span><span class="p">,</span> <span class="s1">&#39;outstanding&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">pred</span><span class="o">.</span><span class="n">detailed_review</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                  <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">positive_words</span><span class="p">),</span> \
               <span class="s2">&quot;High rating should include positive language&quot;</span>

    <span class="c1"># Low ratings should include criticism</span>
    <span class="k">if</span> <span class="n">pred</span><span class="o">.</span><span class="n">rating</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">negative_words</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;disappointing&#39;</span><span class="p">,</span> <span class="s1">&#39;flawed&#39;</span><span class="p">,</span> <span class="s1">&#39;lacking&#39;</span><span class="p">,</span> <span class="s1">&#39;weak&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">pred</span><span class="o">.</span><span class="n">detailed_review</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                  <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">negative_words</span><span class="p">),</span> \
               <span class="s2">&quot;Low rating should include constructive criticism&quot;</span>

    <span class="c1"># Summary should reflect rating</span>
    <span class="k">if</span> <span class="n">pred</span><span class="o">.</span><span class="n">rating</span> <span class="o">&gt;=</span> <span class="mi">8</span> <span class="ow">and</span> <span class="s1">&#39;not&#39;</span> <span class="ow">in</span> <span class="n">pred</span><span class="o">.</span><span class="n">summary</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Summary conflicts with high rating&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pred</span><span class="o">.</span><span class="n">rating</span> <span class="o">&lt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;great&#39;</span> <span class="ow">in</span> <span class="n">pred</span><span class="o">.</span><span class="n">summary</span> <span class="ow">or</span> <span class="s1">&#39;excellent&#39;</span> <span class="ow">in</span> <span class="n">pred</span><span class="o">.</span><span class="n">summary</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Summary conflicts with low rating&quot;</span><span class="p">)</span>

    <span class="c1"># Detailed review must be longer than summary</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">detailed_review</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">summary</span><span class="p">),</span> \
           <span class="s2">&quot;Detailed review should be longer than summary&quot;</span>

    <span class="k">return</span> <span class="kc">True</span>

<span class="n">review_generator</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Assert</span><span class="p">(</span>
    <span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span><span class="n">MovieReview</span><span class="p">),</span>
    <span class="n">validation_fn</span><span class="o">=</span><span class="n">validate_review_consistency</span><span class="p">,</span>
    <span class="n">max_attempts</span><span class="o">=</span><span class="mi">3</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="integration-with-existing-modules">
<h2>Integration with Existing Modules<a class="headerlink" href="#integration-with-existing-modules" title="Link to this heading">#</a></h2>
<section id="assertions-with-chainofthought">
<h3>1. Assertions with ChainOfThought<a class="headerlink" href="#assertions-with-chainofthought" title="Link to this heading">#</a></h3>
<p>Add assertions to reasoning chains:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">LogicalReasoning</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Signature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Solve logic puzzles with step-by-step reasoning.&quot;&quot;&quot;</span>
    <span class="n">puzzle</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">InputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Logic puzzle&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">reasoning</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">OutputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Step-by-step logical reasoning&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">conclusion</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">OutputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Final conclusion&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">confidence</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">OutputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Confidence level (1-10)&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

<span class="n">reasoner</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">ChainOfThought</span><span class="p">(</span><span class="n">LogicalReasoning</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">validate_logical_reasoning</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure reasoning is logically sound.&quot;&quot;&quot;</span>

    <span class="c1"># Check for reasoning steps</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">reasoning</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;Include at least 3 reasoning steps&quot;</span>

    <span class="c1"># Look for logical connectors</span>
    <span class="n">connectors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;therefore&#39;</span><span class="p">,</span> <span class="s1">&#39;because&#39;</span><span class="p">,</span> <span class="s1">&#39;since&#39;</span><span class="p">,</span> <span class="s1">&#39;thus&#39;</span><span class="p">,</span> <span class="s1">&#39;hence&#39;</span><span class="p">]</span>
    <span class="n">has_logic</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">connector</span> <span class="ow">in</span> <span class="n">pred</span><span class="o">.</span><span class="n">reasoning</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                   <span class="k">for</span> <span class="n">connector</span> <span class="ow">in</span> <span class="n">connectors</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">has_logic</span><span class="p">,</span> <span class="s2">&quot;Use logical connectors in reasoning&quot;</span>

    <span class="c1"># Conclusion should follow from reasoning</span>
    <span class="k">if</span> <span class="n">pred</span><span class="o">.</span><span class="n">confidence</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">conclusion</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">,</span> \
               <span class="s2">&quot;High confidence conclusions should be well-justified&quot;</span>

    <span class="k">return</span> <span class="kc">True</span>

<span class="n">logical_reasoner</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Assert</span><span class="p">(</span>
    <span class="n">reasoner</span><span class="p">,</span>
    <span class="n">validation_fn</span><span class="o">=</span><span class="n">validate_logical_reasoning</span><span class="p">,</span>
    <span class="n">max_attempts</span><span class="o">=</span><span class="mi">3</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="assertions-with-react">
<h3>2. Assertions with ReAct<a class="headerlink" href="#assertions-with-react" title="Link to this heading">#</a></h3>
<p>Validate agent actions and observations:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ResearchAgent</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An agent that performs research with validated findings.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">react</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">ReAct</span><span class="p">(</span><span class="s2">&quot;query -&gt; findings&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">validate_research</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Validate research quality.&quot;&quot;&quot;</span>

            <span class="c1"># Must have taken some actions</span>
            <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="s1">&#39;tool_calls&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">trace</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Must use search tools for research&quot;</span><span class="p">)</span>

            <span class="c1"># Findings should be substantial</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">findings</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;Research findings too brief&quot;</span>

            <span class="c1"># Should include sources or evidence</span>
            <span class="n">evidence_words</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;according&#39;</span><span class="p">,</span> <span class="s1">&#39;research shows&#39;</span><span class="p">,</span> <span class="s1">&#39;study&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">]</span>
            <span class="n">has_evidence</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">pred</span><span class="o">.</span><span class="n">findings</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                             <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">evidence_words</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">has_evidence</span><span class="p">,</span> <span class="s2">&quot;Include evidence or sources in findings&quot;</span>

            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Apply assertion</span>
        <span class="n">validated_react</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Assert</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">react</span><span class="p">,</span>
            <span class="n">validation_fn</span><span class="o">=</span><span class="n">validate_research</span><span class="p">,</span>
            <span class="n">max_attempts</span><span class="o">=</span><span class="mi">3</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">validated_react</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>

<span class="c1"># Use the validated research agent</span>
<span class="n">researcher</span> <span class="o">=</span> <span class="n">ResearchAgent</span><span class="p">()</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">researcher</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="s2">&quot;Impact of AI on job markets&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="custom-assertion-handlers">
<h3>3. Custom Assertion Handlers<a class="headerlink" href="#custom-assertion-handlers" title="Link to this heading">#</a></h3>
<p>Create specialized assertion handlers for complex scenarios:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AssertionHandler</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom handler for complex assertion scenarios.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attempt_history</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_assertion_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assertion_type</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">,</span> <span class="n">attempt</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Custom logic for handling assertion failures.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attempt_history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;attempt&#39;</span><span class="p">:</span> <span class="n">attempt</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">assertion_type</span><span class="p">,</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="p">})</span>

        <span class="c1"># Different recovery strategies based on error type</span>
        <span class="k">if</span> <span class="s2">&quot;format&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">return</span> <span class="s2">&quot;Please ensure strict adherence to the required format.&quot;</span>
        <span class="k">elif</span> <span class="s2">&quot;length&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">return</span> <span class="s2">&quot;Make your response more detailed and comprehensive.&quot;</span>
        <span class="k">elif</span> <span class="s2">&quot;accuracy&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">return</span> <span class="s2">&quot;Double-check your facts and calculations.&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Review your response for completeness and accuracy.&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_recovery_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original_input</span><span class="p">,</span> <span class="n">failed_output</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a refined prompt for retry attempts.&quot;&quot;&quot;</span>
        <span class="n">recovery_instruction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_assertion_failure</span><span class="p">(</span>
            <span class="s2">&quot;validation&quot;</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attempt_history</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Original task: </span><span class="si">{</span><span class="n">original_input</span><span class="si">}</span>

<span class="s2">        Your previous attempt: </span><span class="si">{</span><span class="n">failed_output</span><span class="si">}</span>

<span class="s2">        Error: </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span>

<span class="s2">        </span><span class="si">{</span><span class="n">recovery_instruction</span><span class="si">}</span>

<span class="s2">        Please provide an improved response that addresses the issue.</span>
<span class="s2">        &quot;&quot;&quot;</span>

<span class="c1"># Use custom handler</span>
<span class="n">handler</span> <span class="o">=</span> <span class="n">AssertionHandler</span><span class="p">()</span>

<span class="n">custom_assert</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Assert</span><span class="p">(</span>
    <span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span><span class="s2">&quot;task -&gt; result&quot;</span><span class="p">),</span>
    <span class="n">validation_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">ex</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">tr</span><span class="p">:</span> <span class="n">validate_output</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">tr</span><span class="p">),</span>
    <span class="n">max_attempts</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">error_handler</span><span class="o">=</span><span class="n">handler</span><span class="o">.</span><span class="n">handle_assertion_failure</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="best-practices">
<h2>Best Practices<a class="headerlink" href="#best-practices" title="Link to this heading">#</a></h2>
<section id="design-effective-validators">
<h3>1. Design Effective Validators<a class="headerlink" href="#design-effective-validators" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Good: Specific and actionable error messages</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_email</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">pred</span><span class="o">.</span><span class="n">email</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">pred</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="s2">&#39; is not a valid email. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Must follow format: user@domain.com&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>

<span class="c1"># Bad: Generic errors</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_email_bad</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;@&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pred</span><span class="o">.</span><span class="n">email</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Invalid email&quot;</span><span class="p">)</span>  <span class="c1"># Not helpful</span>
    <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
</section>
<section id="balance-strictness-and-flexibility">
<h3>2. Balance Strictness and Flexibility<a class="headerlink" href="#balance-strictness-and-flexibility" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use suggestions for preferences, assertions for requirements</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_content</span><span class="p">(</span><span class="n">topic</span><span class="p">):</span>
    <span class="c1"># Hard requirement: must have title</span>
    <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">),</span> <span class="s2">&quot;Content must have a title&quot;</span>

    <span class="c1"># Soft suggestion: prefer subheadings (not mandatory)</span>
    <span class="n">suggest_add_subheadings</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="handle-edge-cases">
<h3>3. Handle Edge Cases<a class="headerlink" href="#handle-edge-cases" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">robust_validator</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Main validation logic</span>
        <span class="n">validate_main_logic</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Required field missing from output&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Output has incorrect type or format&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="performance-considerations">
<h2>Performance Considerations<a class="headerlink" href="#performance-considerations" title="Link to this heading">#</a></h2>
<section id="assertion-overhead">
<h3>1. Assertion Overhead<a class="headerlink" href="#assertion-overhead" title="Link to this heading">#</a></h3>
<p>Each assertion adds computational overhead. Use judiciously:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Good: Critical assertions</span>
<span class="n">validate_safety</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">safety_module</span><span class="p">,</span> <span class="n">validate_safety_constraints</span><span class="p">)</span>

<span class="c1"># Consider: Performance-critical paths might use lighter validation</span>
<span class="n">quick_validate</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">ex</span><span class="p">,</span> <span class="n">pred</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">output</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span>  <span class="c1"># Simple check</span>
</pre></div>
</div>
</section>
<section id="caching-validation-results">
<h3>2. Caching Validation Results<a class="headerlink" href="#caching-validation-results" title="Link to this heading">#</a></h3>
<p>Cache expensive validation operations:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">lru_cache</span>

<span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">cached_syntax_check</span><span class="p">(</span><span class="n">code_hash</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cache syntax validation for identical code.&quot;&quot;&quot;</span>
    <span class="c1"># Check syntax...</span>
    <span class="k">pass</span>
</pre></div>
</div>
</section>
<section id="progressive-validation">
<h3>3. Progressive Validation<a class="headerlink" href="#progressive-validation" title="Link to this heading">#</a></h3>
<p>Validate in order of cost:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">progressive_validate</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Fast checks first</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">output</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Empty output&quot;</span>

    <span class="c1"># Medium checks</span>
    <span class="k">assert</span> <span class="n">pred</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Need multiple paragraphs&quot;</span>

    <span class="c1"># Expensive checks last</span>
    <span class="n">validate_semantics</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>  <span class="c1"># Slow operation</span>
    <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
</section>
</section>
<section id="debugging-assertions">
<h2>Debugging Assertions<a class="headerlink" href="#debugging-assertions" title="Link to this heading">#</a></h2>
<section id="trace-inspection">
<h3>1. Trace Inspection<a class="headerlink" href="#trace-inspection" title="Link to this heading">#</a></h3>
<p>Examine assertion failures for debugging:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">debug_assertion</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Debug assertion with detailed information.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input: </span><span class="si">{</span><span class="n">example</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output: </span><span class="si">{</span><span class="n">pred</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trace: </span><span class="si">{</span><span class="n">trace</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Perform validation</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">actual_validation</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Validation failed!&quot;</span><span class="p">)</span>
        <span class="c1"># Analyze why...</span>

    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</section>
<section id="assertion-metrics">
<h3>2. Assertion Metrics<a class="headerlink" href="#assertion-metrics" title="Link to this heading">#</a></h3>
<p>Track assertion performance:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AssertionMetrics</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;total_attempts&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;failures&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;retries&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;success_rate&#39;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">record_attempt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">success</span><span class="p">,</span> <span class="n">retries</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_attempts&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;failures&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;retries&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">retries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;success_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_attempts&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;failures&#39;</span><span class="p">])</span> <span class="o">/</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_attempts&#39;</span><span class="p">]</span>
        <span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="id1">
<h2>Advanced Assertion Patterns<a class="headerlink" href="#id1" title="Link to this heading">#</a></h2>
<section id="hierarchical-assertions">
<h3>1. Hierarchical Assertions<a class="headerlink" href="#hierarchical-assertions" title="Link to this heading">#</a></h3>
<p>Multi-level validation with cascading constraints:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">Generic</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>

<span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">HierarchicalAssertion</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for hierarchical assertion systems.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child</span><span class="p">:</span> <span class="s1">&#39;HierarchicalAssertion&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add child assertion.&quot;&quot;&quot;</span>
        <span class="n">child</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">child</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_hierarchy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate entire hierarchy.&quot;&quot;&quot;</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Validate current level</span>
        <span class="n">local_valid</span><span class="p">,</span> <span class="n">local_errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">local_valid</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">local_errors</span><span class="p">])</span>

        <span class="c1"># Validate children if current level passes</span>
        <span class="k">if</span> <span class="n">local_valid</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">child_valid</span><span class="p">,</span> <span class="n">child_errors</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">validate_hierarchy</span><span class="p">(</span>
                    <span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">child_valid</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">child_errors</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">errors</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate at this level.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

<span class="c1"># Example: Document validation hierarchy</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DocumentAssertion</span><span class="p">(</span><span class="n">HierarchicalAssertion</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Top-level document validation.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;document&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Add child assertions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">StructureAssertion</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">ContentAssertion</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">FormatAssertion</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate document-level constraints.&quot;&quot;&quot;</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Basic document checks</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;Missing content field&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">content</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Document too short (minimum 100 characters)&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">content</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Document too long (maximum 10000 characters)&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">errors</span>

<span class="k">class</span><span class="w"> </span><span class="nc">StructureAssertion</span><span class="p">(</span><span class="n">HierarchicalAssertion</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate document structure.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;structure&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate structural elements.&quot;&quot;&quot;</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">content</span>

        <span class="c1"># Check for sections</span>
        <span class="k">if</span> <span class="s1">&#39;#&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">content</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Document missing section headers&quot;</span><span class="p">)</span>

        <span class="c1"># Check for paragraphs</span>
        <span class="n">paragraphs</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">paragraphs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Document needs at least 3 paragraphs&quot;</span><span class="p">)</span>

        <span class="c1"># Check for flow</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_logical_flow</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Document lacks logical flow&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">errors</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">has_logical_flow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if content has logical flow.&quot;&quot;&quot;</span>
        <span class="c1"># Simple heuristic: look for transition words</span>
        <span class="n">transitions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;however&#39;</span><span class="p">,</span> <span class="s1">&#39;therefore&#39;</span><span class="p">,</span> <span class="s1">&#39;furthermore&#39;</span><span class="p">,</span> <span class="s1">&#39;consequently&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">transitions</span><span class="p">)</span>

<span class="c1"># Use hierarchical assertions</span>
<span class="n">doc_validator</span> <span class="o">=</span> <span class="n">DocumentAssertion</span><span class="p">()</span>

<span class="c1"># Wrap with hierarchical validation</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DocumentGenerator</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generator</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span><span class="s2">&quot;topic -&gt; content&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hierarchical_validator</span> <span class="o">=</span> <span class="n">doc_validator</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topic</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">(</span><span class="n">topic</span><span class="o">=</span><span class="n">topic</span><span class="p">)</span>

        <span class="c1"># Validate hierarchy</span>
        <span class="n">is_valid</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hierarchical_validator</span><span class="o">.</span><span class="n">validate_hierarchy</span><span class="p">(</span>
            <span class="n">example</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pred</span><span class="o">=</span><span class="n">result</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid</span><span class="p">:</span>
            <span class="c1"># Refine based on hierarchical feedback</span>
            <span class="n">refined_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refine_hierarchically</span><span class="p">(</span>
                <span class="n">result</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hierarchical_validator</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">refined_result</span>

        <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</section>
<section id="probabilistic-assertions">
<h3>2. Probabilistic Assertions<a class="headerlink" href="#probabilistic-assertions" title="Link to this heading">#</a></h3>
<p>Assertions with confidence-based validation:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ProbabilisticAssertion</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Assertions with probabilistic validation.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">confidence_threshold</span><span class="o">=</span><span class="mf">0.95</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">confidence_threshold</span> <span class="o">=</span> <span class="n">confidence_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_history</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_with_confidence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate with confidence scoring.&quot;&quot;&quot;</span>
        <span class="c1"># Calculate confidence score</span>
        <span class="n">confidence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_confidence</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

        <span class="c1"># Determine if passes threshold</span>
        <span class="n">passes</span> <span class="o">=</span> <span class="n">confidence</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">confidence_threshold</span>

        <span class="c1"># Generate explanation</span>
        <span class="n">explanation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_explanation</span><span class="p">(</span><span class="n">confidence</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span>

        <span class="c1"># Record for learning</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="n">confidence</span><span class="p">,</span>
            <span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="n">passes</span><span class="p">,</span>
            <span class="s1">&#39;explanation&#39;</span><span class="p">:</span> <span class="n">explanation</span>
        <span class="p">})</span>

        <span class="k">return</span> <span class="n">passes</span><span class="p">,</span> <span class="n">confidence</span><span class="p">,</span> <span class="n">explanation</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_confidence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate confidence score for validation.&quot;&quot;&quot;</span>
        <span class="n">confidence_factors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Factor 1: Structural consistency</span>
        <span class="n">struct_confidence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_structural_consistency</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
        <span class="n">confidence_factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">struct_confidence</span><span class="p">)</span>

        <span class="c1"># Factor 2: Semantic coherence</span>
        <span class="n">semantic_confidence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_semantic_coherence</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
        <span class="n">confidence_factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">semantic_confidence</span><span class="p">)</span>

        <span class="c1"># Factor 3: Historical performance</span>
        <span class="n">history_confidence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_historical_confidence</span><span class="p">()</span>
        <span class="n">confidence_factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">history_confidence</span><span class="p">)</span>

        <span class="c1"># Combine factors (weighted average)</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]</span>  <span class="c1"># Adjust as needed</span>
        <span class="n">confidence</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">c</span> <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">confidence_factors</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">confidence</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_structural_consistency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check structural consistency of output.&quot;&quot;&quot;</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># Check required fields</span>
        <span class="n">required_fields</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="s1">&#39;_required_fields&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">required_fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
                <span class="n">score</span> <span class="o">+=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">required_fields</span><span class="p">)</span>

        <span class="c1"># Check field consistency</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="s1">&#39;answer&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">):</span>
            <span class="c1"># Higher confidence should correlate with longer answers</span>
            <span class="k">if</span> <span class="n">pred</span><span class="o">.</span><span class="n">confidence</span> <span class="o">&gt;</span> <span class="mf">0.8</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">answer</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">*=</span> <span class="mf">0.5</span>  <span class="c1"># Penalize inconsistency</span>

        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_semantic_coherence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check semantic coherence using NLP techniques.&quot;&quot;&quot;</span>
        <span class="c1"># Simplified coherence check</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="s1">&#39;answer&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="n">answer</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">answer</span>

        <span class="c1"># Check for repeated phrases</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">answer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">unique_words</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>
        <span class="n">repetition_ratio</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_words</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="k">if</span> <span class="n">words</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="c1"># Check sentence structure</span>
        <span class="n">sentences</span> <span class="o">=</span> <span class="n">answer</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">avg_sentence_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sentences</span> <span class="k">if</span> <span class="n">s</span><span class="p">])</span>

        <span class="c1"># Combine factors</span>
        <span class="n">coherence_score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">coherence_score</span> <span class="o">+=</span> <span class="n">repetition_ratio</span> <span class="o">*</span> <span class="mf">0.4</span>
        <span class="n">coherence_score</span> <span class="o">+=</span> <span class="nb">min</span><span class="p">(</span><span class="n">avg_sentence_length</span> <span class="o">/</span> <span class="mi">15</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.3</span>
        <span class="n">coherence_score</span> <span class="o">+=</span> <span class="mf">0.3</span> <span class="k">if</span> <span class="mi">5</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sentences</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">10</span> <span class="k">else</span> <span class="mf">0.1</span>

        <span class="k">return</span> <span class="n">coherence_score</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_historical_confidence</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate confidence based on historical performance.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_history</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.5</span>  <span class="c1"># Neutral for no history</span>

        <span class="c1"># Recent performance more important</span>
        <span class="n">recent_history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_history</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]</span>
        <span class="n">success_rate</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">recent_history</span> <span class="k">if</span> <span class="n">h</span><span class="p">[</span><span class="s1">&#39;passed&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_history</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">success_rate</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AdaptiveThreshold</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adaptive confidence threshold based on context.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_threshold</span><span class="o">=</span><span class="mf">0.95</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_threshold</span> <span class="o">=</span> <span class="n">initial_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context_adjustments</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">performance_feedback</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get adjusted threshold for context.&quot;&quot;&quot;</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_threshold</span>

        <span class="c1"># Adjust based on context</span>
        <span class="n">context_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_context_key</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">context_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_adjustments</span><span class="p">:</span>
            <span class="n">threshold</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_adjustments</span><span class="p">[</span><span class="n">context_key</span><span class="p">]</span>

        <span class="c1"># Adjust based on recent performance</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">performance_feedback</span><span class="p">:</span>
            <span class="n">recent_performance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">performance_feedback</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:])</span>
            <span class="k">if</span> <span class="n">recent_performance</span> <span class="o">&lt;</span> <span class="mf">0.8</span><span class="p">:</span>
                <span class="n">threshold</span> <span class="o">*=</span> <span class="mf">0.9</span>  <span class="c1"># Lower threshold if struggling</span>
            <span class="k">elif</span> <span class="n">recent_performance</span> <span class="o">&gt;</span> <span class="mf">0.95</span><span class="p">:</span>
                <span class="n">threshold</span> <span class="o">*=</span> <span class="mf">1.1</span>  <span class="c1"># Raise threshold if doing well</span>

        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="mf">0.99</span><span class="p">)</span>  <span class="c1"># Keep within bounds</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_adjustment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">adjustment</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update context adjustment based on feedback.&quot;&quot;&quot;</span>
        <span class="n">context_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_context_key</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context_adjustments</span><span class="p">[</span><span class="n">context_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">adjustment</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_context_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate key for context lookup.&quot;&quot;&quot;</span>
        <span class="c1"># Simplified context key generation</span>
        <span class="n">key_parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;domain&#39;</span> <span class="ow">in</span> <span class="n">context</span><span class="p">:</span>
            <span class="n">key_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;domain&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;complexity&#39;</span> <span class="ow">in</span> <span class="n">context</span><span class="p">:</span>
            <span class="n">key_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;complexity_</span><span class="si">{</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;complexity&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">key_parts</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;default&quot;</span>

<span class="c1"># Usage with probabilistic assertions</span>
<span class="n">probabilistic_assert</span> <span class="o">=</span> <span class="n">ProbabilisticAssertion</span><span class="p">(</span><span class="n">confidence_threshold</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="n">adaptive_threshold</span> <span class="o">=</span> <span class="n">AdaptiveThreshold</span><span class="p">()</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ProbabilisticValidator</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_module</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_module</span> <span class="o">=</span> <span class="n">base_module</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prob_assert</span> <span class="o">=</span> <span class="n">probabilistic_assert</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_threshold</span> <span class="o">=</span> <span class="n">adaptive_threshold</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Get context</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;domain&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;domain&#39;</span><span class="p">,</span> <span class="s1">&#39;general&#39;</span><span class="p">),</span>
            <span class="s1">&#39;complexity&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;complexity&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="c1"># Get adaptive threshold</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_threshold</span><span class="o">.</span><span class="n">get_threshold</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

        <span class="c1"># Generate result</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_module</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Validate with confidence</span>
        <span class="n">passes</span><span class="p">,</span> <span class="n">confidence</span><span class="p">,</span> <span class="n">explanation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prob_assert</span><span class="o">.</span><span class="n">validate_with_confidence</span><span class="p">(</span>
            <span class="n">example</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pred</span><span class="o">=</span><span class="n">result</span>
        <span class="p">)</span>

        <span class="c1"># Check against adaptive threshold</span>
        <span class="k">if</span> <span class="n">confidence</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="c1"># Provide feedback for learning</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_threshold</span><span class="o">.</span><span class="n">update_adjustment</span><span class="p">(</span>
                <span class="n">context</span><span class="p">,</span>
                <span class="n">threshold</span> <span class="o">/</span> <span class="n">confidence</span>  <span class="c1"># Adjustment factor</span>
            <span class="p">)</span>

            <span class="c1"># Try to improve</span>
            <span class="n">improved</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">improve_result</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">explanation</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">improved</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">improved</span>

        <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</section>
<section id="distributed-assertions">
<h3>3. Distributed Assertions<a class="headerlink" href="#distributed-assertions" title="Link to this heading">#</a></h3>
<p>Assertions across multiple model calls:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DistributedAssertionSystem</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Manages assertions across distributed model calls.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assertion_nodes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;AssertionNode&#39;</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertion_nodes</span> <span class="o">=</span> <span class="n">assertion_nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">communication_bus</span> <span class="o">=</span> <span class="n">AssertionCommunicationBus</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span> <span class="o">=</span> <span class="n">AssertionCoordinator</span><span class="p">(</span><span class="n">assertion_nodes</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_distributed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Coordinate distributed validation.&quot;&quot;&quot;</span>
        <span class="c1"># Create validation plan</span>
        <span class="n">plan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">create_validation_plan</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>

        <span class="c1"># Execute in parallel where possible</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_validation_plan</span><span class="p">(</span><span class="n">plan</span><span class="p">)</span>

        <span class="c1"># Aggregate results</span>
        <span class="n">aggregated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">aggregate_results</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

        <span class="c1"># Resolve conflicts</span>
        <span class="n">resolved</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">resolve_conflicts</span><span class="p">(</span><span class="n">aggregated</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">resolved</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">execute_validation_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plan</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute validation plan with parallel execution.&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Identify parallelizable tasks</span>
        <span class="n">parallel_tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sequential_tasks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">plan</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;parallelizable&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">parallel_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">task_id</span><span class="p">,</span> <span class="n">task</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sequential_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">task_id</span><span class="p">,</span> <span class="n">task</span><span class="p">))</span>

        <span class="c1"># Execute parallel tasks</span>
        <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="n">future_to_task</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">execute_task</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span> <span class="n">task_id</span>
                <span class="k">for</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">parallel_tasks</span>
            <span class="p">}</span>

            <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">future_to_task</span><span class="p">):</span>
                <span class="n">task_id</span> <span class="o">=</span> <span class="n">future_to_task</span><span class="p">[</span><span class="n">future</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

        <span class="c1"># Execute sequential tasks</span>
        <span class="k">for</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">sequential_tasks</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AssertionNode</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Individual assertion node in distributed system.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">assertions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">dspy</span><span class="o">.</span><span class="n">Assert</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span> <span class="o">=</span> <span class="n">node_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertions</span> <span class="o">=</span> <span class="n">assertions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_cache</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate with local assertions.&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;node_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span><span class="p">,</span>
            <span class="s1">&#39;validations&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;overall_status&#39;</span><span class="p">:</span> <span class="s1">&#39;passed&#39;</span><span class="p">,</span>
            <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;validation_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assertions</span><span class="p">),</span>
                <span class="s1">&#39;execution_time&#39;</span><span class="p">:</span> <span class="mi">0</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">assertion</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertions</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Check cache first</span>
                <span class="n">cache_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cache_key</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">assertion</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_cache</span><span class="p">:</span>
                    <span class="n">validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Execute assertion</span>
                    <span class="n">validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_assertion</span><span class="p">(</span>
                        <span class="n">assertion</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">context</span>
                    <span class="p">)</span>
                    <span class="c1"># Cache result</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">local_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">validation_result</span>

                <span class="n">results</span><span class="p">[</span><span class="s1">&#39;validations&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;assertion_id&#39;</span><span class="p">:</span> <span class="nb">id</span><span class="p">(</span><span class="n">assertion</span><span class="p">),</span>
                    <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">validation_result</span><span class="p">,</span>
                    <span class="s1">&#39;cached&#39;</span><span class="p">:</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_cache</span>
                <span class="p">})</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">validation_result</span><span class="p">[</span><span class="s1">&#39;passed&#39;</span><span class="p">]:</span>
                    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;failed&#39;</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="s1">&#39;validations&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;assertion_id&#39;</span><span class="p">:</span> <span class="nb">id</span><span class="p">(</span><span class="n">assertion</span><span class="p">),</span>
                    <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="kc">False</span>
                <span class="p">})</span>
                <span class="n">results</span><span class="p">[</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;error&#39;</span>

        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="s1">&#39;execution_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

        <span class="k">return</span> <span class="n">results</span>

<span class="c1"># Example: Multi-modal validation system</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MultiModalValidationSystem</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validates outputs across different modalities.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Create assertion nodes for each modality</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text_node</span> <span class="o">=</span> <span class="n">AssertionNode</span><span class="p">(</span>
            <span class="s1">&#39;text_validation&#39;</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="n">dspy</span><span class="o">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">validate_text_coherence</span><span class="p">),</span>
                <span class="n">dspy</span><span class="o">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">validate_text_quality</span><span class="p">),</span>
                <span class="n">dspy</span><span class="o">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">validate_text_length</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">image_node</span> <span class="o">=</span> <span class="n">AssertionNode</span><span class="p">(</span>
            <span class="s1">&#39;image_validation&#39;</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="n">dspy</span><span class="o">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">validate_image_quality</span><span class="p">),</span>
                <span class="n">dspy</span><span class="o">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">validate_image_content</span><span class="p">),</span>
                <span class="n">dspy</span><span class="o">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">validate_image_style</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">multimodal_node</span> <span class="o">=</span> <span class="n">AssertionNode</span><span class="p">(</span>
            <span class="s1">&#39;multimodal_validation&#39;</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="n">dspy</span><span class="o">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">validate_text_image_consistency</span><span class="p">),</span>
                <span class="n">dspy</span><span class="o">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">validate_modality_balance</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Create distributed system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distributed_system</span> <span class="o">=</span> <span class="n">DistributedAssertionSystem</span><span class="p">({</span>
            <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_node</span><span class="p">,</span>
            <span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_node</span><span class="p">,</span>
            <span class="s1">&#39;multimodal&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">multimodal_node</span>
        <span class="p">})</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_multimodal_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate multimodal output.&quot;&quot;&quot;</span>
        <span class="c1"># Prepare inputs for each node</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;text_data&#39;</span><span class="p">:</span> <span class="n">output</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)},</span>
            <span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;image_data&#39;</span><span class="p">:</span> <span class="n">output</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)},</span>
            <span class="s1">&#39;multimodal&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;text_data&#39;</span><span class="p">:</span> <span class="n">output</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="s1">&#39;image_data&#39;</span><span class="p">:</span> <span class="n">output</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1"># Execute distributed validation</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distributed_system</span><span class="o">.</span><span class="n">validate_distributed</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>

        <span class="c1"># Generate comprehensive report</span>
        <span class="n">report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_validation_report</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">report</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_validation_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate comprehensive validation report.&quot;&quot;&quot;</span>
        <span class="n">report</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;overall_status&#39;</span><span class="p">:</span> <span class="s1">&#39;passed&#39;</span><span class="p">,</span>
            <span class="s1">&#39;modality_results&#39;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s1">&#39;cross_modality_issues&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;recommendations&#39;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>

        <span class="c1"># Process individual modality results</span>
        <span class="k">for</span> <span class="n">modality</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">report</span><span class="p">[</span><span class="s1">&#39;modality_results&#39;</span><span class="p">][</span><span class="n">modality</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span>
                <span class="p">}</span>
                <span class="n">report</span><span class="p">[</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;failed&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">report</span><span class="p">[</span><span class="s1">&#39;modality_results&#39;</span><span class="p">][</span><span class="n">modality</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;overall_status&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;validations_passed&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span>
                        <span class="mi">1</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;validations&#39;</span><span class="p">,</span> <span class="p">[])</span>
                        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;passed&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                    <span class="p">),</span>
                    <span class="s1">&#39;total_validations&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;validations&#39;</span><span class="p">,</span> <span class="p">[])),</span>
                    <span class="s1">&#39;execution_time&#39;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;execution_time&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;overall_status&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;passed&#39;</span><span class="p">:</span>
                    <span class="n">report</span><span class="p">[</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;failed&#39;</span>

        <span class="c1"># Cross-modality analysis</span>
        <span class="k">if</span> <span class="s1">&#39;text&#39;</span> <span class="ow">in</span> <span class="n">results</span> <span class="ow">and</span> <span class="s1">&#39;image&#39;</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">text_issues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_issues</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">])</span>
            <span class="n">image_issues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_issues</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">])</span>

            <span class="c1"># Find related issues</span>
            <span class="k">for</span> <span class="n">text_issue</span> <span class="ow">in</span> <span class="n">text_issues</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">image_issue</span> <span class="ow">in</span> <span class="n">image_issues</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">are_related_issues</span><span class="p">(</span><span class="n">text_issue</span><span class="p">,</span> <span class="n">image_issue</span><span class="p">):</span>
                        <span class="n">report</span><span class="p">[</span><span class="s1">&#39;cross_modality_issues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;related&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;text_issue&#39;</span><span class="p">:</span> <span class="n">text_issue</span><span class="p">,</span>
                            <span class="s1">&#39;image_issue&#39;</span><span class="p">:</span> <span class="n">image_issue</span><span class="p">,</span>
                            <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span>
                        <span class="p">})</span>

        <span class="c1"># Generate recommendations</span>
        <span class="n">report</span><span class="p">[</span><span class="s1">&#39;recommendations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_recommendations</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">report</span>

<span class="c1"># Usage</span>
<span class="n">multimodal_validator</span> <span class="o">=</span> <span class="n">MultiModalValidationSystem</span><span class="p">()</span>

<span class="c1"># Validate multimodal output</span>
<span class="n">output</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;A beautiful sunset over the mountains&#39;</span><span class="p">,</span>
    <span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="n">generated_image</span>
<span class="p">}</span>

<span class="n">validation_report</span> <span class="o">=</span> <span class="n">multimodal_validator</span><span class="o">.</span><span class="n">validate_multimodal_output</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overall status: </span><span class="si">{</span><span class="n">validation_report</span><span class="p">[</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="learning-assertions">
<h3>4. Learning Assertions<a class="headerlink" href="#learning-assertions" title="Link to this heading">#</a></h3>
<p>Assertions that improve over time:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">joblib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="k">class</span><span class="w"> </span><span class="nc">LearningAssertion</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Assertions that learn from validation history.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assertion_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertion_name</span> <span class="o">=</span> <span class="n">assertion_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span> <span class="o">=</span> <span class="n">model_path</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;models/</span><span class="si">{</span><span class="n">assertion_name</span><span class="si">}</span><span class="s2">_model.pkl&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_or_create_model</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_extractor</span> <span class="o">=</span> <span class="n">AssertionFeatureExtractor</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_or_create_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load existing model or create new one.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_with_learning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate using learned patterns.&quot;&quot;&quot;</span>
        <span class="c1"># Extract features</span>
        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_extractor</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

        <span class="c1"># Predict validation outcome</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">([</span><span class="n">features</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">confidence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">([</span><span class="n">features</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="c1"># Get feature importance</span>
        <span class="n">feature_importance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_feature_importance</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">prediction</span><span class="p">),</span>
            <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">confidence</span><span class="p">),</span>
            <span class="s1">&#39;feature_importance&#39;</span><span class="p">:</span> <span class="n">feature_importance</span><span class="p">,</span>
            <span class="s1">&#39;learned&#39;</span><span class="p">:</span> <span class="kc">True</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">learn_from_feedback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">actual_outcome</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Learn from actual validation outcomes.&quot;&quot;&quot;</span>
        <span class="c1"># Extract features</span>
        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_extractor</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

        <span class="c1"># Add to training data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;features&#39;</span><span class="p">:</span> <span class="n">features</span><span class="p">,</span>
            <span class="s1">&#39;outcome&#39;</span><span class="p">:</span> <span class="n">actual_outcome</span>
        <span class="p">})</span>

        <span class="c1"># Retrain if enough data</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">training_data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">retrain_model</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">retrain_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrain the assertion model.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_data</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Prepare training data</span>
        <span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_data</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;outcome&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_data</span><span class="p">]</span>

        <span class="c1"># Retrain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="c1"># Save model</span>
        <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">)</span>

        <span class="c1"># Clear training data to save memory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_feature_importance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get importance of each feature for this prediction.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;feature_importances_&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="n">feature_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_extractor</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">()</span>
        <span class="n">importances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">feature_importances_</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">imp</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">imp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">feature_names</span><span class="p">,</span> <span class="n">importances</span><span class="p">)</span>
        <span class="p">}</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AssertionFeatureExtractor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extracts features for learning assertions.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_cache</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">extract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract comprehensive features.&quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Text features</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="s1">&#39;answer&#39;</span><span class="p">):</span>
            <span class="n">text_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_text_features</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">answer</span><span class="p">)</span>
            <span class="n">features</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="sa">f</span><span class="s2">&quot;text_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">text_features</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>

        <span class="c1"># Structural features</span>
        <span class="n">struct_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_structural_features</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
        <span class="n">features</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="sa">f</span><span class="s2">&quot;struct_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">struct_features</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>

        <span class="c1"># Context features</span>
        <span class="k">if</span> <span class="n">example</span><span class="p">:</span>
            <span class="n">context_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_context_features</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span>
            <span class="n">features</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="sa">f</span><span class="s2">&quot;context_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">context_features</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>

        <span class="c1"># Trace features</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="n">trace_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_trace_features</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
            <span class="n">features</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="sa">f</span><span class="s2">&quot;trace_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">trace_features</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>

        <span class="k">return</span> <span class="n">features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">extract_text_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract text-based features.&quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Basic statistics</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">sentences</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">paragraphs</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;word_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;sentence_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sentences</span><span class="p">)</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;paragraph_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">paragraphs</span><span class="p">)</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;avg_word_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">words</span><span class="p">])</span> <span class="k">if</span> <span class="n">words</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;avg_sentence_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sentences</span> <span class="k">if</span> <span class="n">s</span><span class="p">])</span> <span class="k">if</span> <span class="n">sentences</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="c1"># Vocabulary diversity</span>
        <span class="n">unique_words</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;vocab_diversity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_words</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="k">if</span> <span class="n">words</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="c1"># Punctuation patterns</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;exclamation_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;!&#39;</span><span class="p">)</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;question_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;comma_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

        <span class="c1"># Readability approximation</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;readability_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_readability</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">extract_structural_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract structural features.&quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Field presence</span>
        <span class="n">all_fields</span> <span class="o">=</span> <span class="nb">dir</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;field_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_fields</span><span class="p">)</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;has_confidence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">)</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;has_reasoning&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="s1">&#39;reasoning&#39;</span><span class="p">)</span>

        <span class="c1"># Field consistency</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="s1">&#39;answer&#39;</span><span class="p">):</span>
            <span class="c1"># High confidence with short answer might be suspicious</span>
            <span class="k">if</span> <span class="n">pred</span><span class="o">.</span><span class="n">confidence</span> <span class="o">&gt;</span> <span class="mf">0.9</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">answer</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">features</span><span class="p">[</span><span class="s1">&#39;confidence_consistency&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">features</span><span class="p">[</span><span class="s1">&#39;confidence_consistency&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_readability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Simple readability score.&quot;&quot;&quot;</span>
        <span class="c1"># Simplified Flesch Reading Ease</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">sentences</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">words</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">sentences</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="n">avg_sentence_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">sentences</span><span class="p">)</span>
        <span class="n">avg_syllables</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">count_syllables</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">words</span><span class="p">])</span>

        <span class="n">readability</span> <span class="o">=</span> <span class="mf">206.835</span> <span class="o">-</span> <span class="mf">1.015</span> <span class="o">*</span> <span class="n">avg_sentence_length</span> <span class="o">-</span> <span class="mf">84.6</span> <span class="o">*</span> <span class="n">avg_syllables</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">readability</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">count_syllables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Approximate syllable count.&quot;&quot;&quot;</span>
        <span class="n">vowels</span> <span class="o">=</span> <span class="s2">&quot;aeiouy&quot;</span>
        <span class="n">word</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">syllables</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">prev_was_vowel</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">word</span><span class="p">:</span>
            <span class="n">is_vowel</span> <span class="o">=</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">vowels</span>
            <span class="k">if</span> <span class="n">is_vowel</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">prev_was_vowel</span><span class="p">:</span>
                <span class="n">syllables</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">prev_was_vowel</span> <span class="o">=</span> <span class="n">is_vowel</span>

        <span class="c1"># Adjust for silent e</span>
        <span class="k">if</span> <span class="n">word</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">syllables</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">syllables</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">syllables</span><span class="p">)</span>

<span class="c1"># Usage with learning assertions</span>
<span class="n">learning_assertion</span> <span class="o">=</span> <span class="n">LearningAssertion</span><span class="p">(</span><span class="s2">&quot;answer_quality&quot;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AdaptiveQA</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qa</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">ChainOfThought</span><span class="p">(</span><span class="s2">&quot;question -&gt; answer&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learning_assertion</span> <span class="o">=</span> <span class="n">learning_assertion</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">question</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qa</span><span class="p">(</span><span class="n">question</span><span class="o">=</span><span class="n">question</span><span class="p">)</span>

        <span class="c1"># Validate with learning</span>
        <span class="n">validation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_assertion</span><span class="o">.</span><span class="n">validate_with_learning</span><span class="p">(</span>
            <span class="n">example</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;question&#39;</span><span class="p">:</span> <span class="n">question</span><span class="p">},</span>
            <span class="n">pred</span><span class="o">=</span><span class="n">result</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">validation</span><span class="p">[</span><span class="s1">&#39;passed&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">validation</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>
            <span class="c1"># High confidence failure - likely an error</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation failed with high confidence: </span><span class="si">{</span><span class="n">validation</span><span class="p">[</span><span class="s1">&#39;feature_importance&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Learn from this</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">learning_assertion</span><span class="o">.</span><span class="n">learn_from_feedback</span><span class="p">(</span>
                <span class="n">example</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;question&#39;</span><span class="p">:</span> <span class="n">question</span><span class="p">},</span>
                <span class="n">pred</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
                <span class="n">actual_outcome</span><span class="o">=</span><span class="kc">False</span>  <span class="c1"># Failed</span>
            <span class="p">)</span>

            <span class="c1"># Try again</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qa</span><span class="p">(</span><span class="n">question</span><span class="o">=</span><span class="n">question</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

<span class="c1"># Later, with human feedback</span>
<span class="c1"># learning_assertion.learn_from_feedback(</span>
<span class="c1">#     example=example,</span>
<span class="c1">#     pred=prediction,</span>
<span class="c1">#     actual_outcome=True  # Human confirmed it was good</span>
<span class="c1"># )</span>
</pre></div>
</div>
</section>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Link to this heading">#</a></h2>
<p>DSPy Assertions provide:</p>
<ul class="simple">
<li><p><strong>Runtime validation</strong> of model outputs</p></li>
<li><p><strong>Automatic refinement</strong> when constraints fail</p></li>
<li><p><strong>Flexible constraint types</strong> - hard and soft constraints</p></li>
<li><p><strong>Self-improving systems</strong> through iterative refinement</p></li>
<li><p><strong>Production reliability</strong> through guaranteed output quality</p></li>
<li><p><strong>Hierarchical validation</strong> for complex requirements</p></li>
<li><p><strong>Probabilistic assertions</strong> with confidence-based decisions</p></li>
<li><p><strong>Distributed assertions</strong> across multiple model calls</p></li>
<li><p><strong>Learning assertions</strong> that improve from experience</p></li>
</ul>
<section id="key-takeaways">
<h3>Key Takeaways<a class="headerlink" href="#key-takeaways" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p><strong>Use Assert for requirements</strong> - Critical constraints that must pass</p></li>
<li><p><strong>Use Suggest for preferences</strong> - Guidance for improving quality</p></li>
<li><p><strong>Write clear error messages</strong> - Help the model understand failures</p></li>
<li><p><strong>Balance validation cost</strong> - Consider performance implications</p></li>
<li><p><strong>Compose multiple assertions</strong> - Build comprehensive validation</p></li>
</ol>
</section>
</section>
<section id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="#../07-advanced-topics/07-self-refining-pipelines.md"><span class="xref myst">Self-Refining Pipelines</span></a> - Learn advanced patterns</p></li>
<li><p><a class="reference internal" href="#../05-optimizers/07-constraint-driven-optimization.md"><span class="xref myst">Constraint-Driven Optimization</span></a> - Optimize with constraints</p></li>
<li><p><a class="reference internal" href="#../08-case-studies/06-assertion-driven-applications.md"><span class="xref myst">Assertion-Driven Applications</span></a> - Real-world examples</p></li>
<li><p><a class="reference internal" href="#./07-exercises.md"><span class="xref myst">Exercises</span></a> - Practice assertion techniques</p></li>
</ul>
</section>
<section id="further-reading">
<h2>Further Reading<a class="headerlink" href="#further-reading" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://dspy-docs.vercel.app/docs/deep-dive/assertions">DSPy Documentation: Assertions</a></p></li>
<li><p><a class="reference external" href="https://en.wikipedia.org/wiki/Constraint_programming">Constraint Programming</a> - Theoretical foundation</p></li>
<li><p><a class="reference external" href="https://en.wikipedia.org/wiki/Runtime_verification">Runtime Verification</a> - Validation techniques</p></li>
</ul>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./content/03_modules"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="07_exercises.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Chapter 3 Exercises</p>
      </div>
    </a>
    <a class="right-next"
       href="../04_evaluation/00_chapter_intro.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Chapter 4: Evaluation</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prerequisites">Prerequisites</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-objectives">Learning Objectives</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction-to-assertions">Introduction to Assertions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#why-assertions-matter">Why Assertions Matter</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#core-assertion-types">Core Assertion Types</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dspy-assert-hard-constraints">1. dspy.Assert - Hard Constraints</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dspy-suggest-soft-constraints">2. dspy.Suggest - Soft Constraints</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multiple-assertions">3. Multiple Assertions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#constraint-types">Constraint Types</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#format-constraints">1. Format Constraints</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#semantic-constraints">2. Semantic Constraints</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#consistency-constraints">3. Consistency Constraints</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-assertion-patterns">Advanced Assertion Patterns</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#self-refining-pipelines">1. Self-Refining Pipelines</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#contextual-assertions">2. Contextual Assertions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multi-output-assertions">3. Multi-Output Assertions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#integration-with-existing-modules">Integration with Existing Modules</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assertions-with-chainofthought">1. Assertions with ChainOfThought</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assertions-with-react">2. Assertions with ReAct</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-assertion-handlers">3. Custom Assertion Handlers</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#best-practices">Best Practices</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#design-effective-validators">1. Design Effective Validators</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#balance-strictness-and-flexibility">2. Balance Strictness and Flexibility</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#handle-edge-cases">3. Handle Edge Cases</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#performance-considerations">Performance Considerations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assertion-overhead">1. Assertion Overhead</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#caching-validation-results">2. Caching Validation Results</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#progressive-validation">3. Progressive Validation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#debugging-assertions">Debugging Assertions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#trace-inspection">1. Trace Inspection</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assertion-metrics">2. Assertion Metrics</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Advanced Assertion Patterns</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hierarchical-assertions">1. Hierarchical Assertions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#probabilistic-assertions">2. Probabilistic Assertions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#distributed-assertions">3. Distributed Assertions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-assertions">4. Learning Assertions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#key-takeaways">Key Takeaways</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#further-reading">Further Reading</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Dustin Ober
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      Â© Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>