
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Composing Modules &#8212; DSPy: The Complete Guide</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=9c3e77be" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=1ae7504c"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'content/03_modules/06_composing_modules';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Chapter 3 Exercises" href="07_exercises.html" />
    <link rel="prev" title="Custom Modules" href="05_custom_modules.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../00_frontmatter/00_preface.html">
  
  
  
  
  
  
    <p class="title logo__title">DSPy: The Complete Guide</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../00_frontmatter/01_how_to_use_this_book.html">How to Use This Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_frontmatter/02_prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_frontmatter/03_setup_instructions.html">Setup Instructions</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 1 - Fundamentals</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../01_fundamentals/00_chapter_intro.html">Chapter 1: DSPy Fundamentals</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../01_fundamentals/01_what_is_dspy.html">What is DSPy?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01_fundamentals/02_programming_vs_prompting.html">Programming vs. Prompting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01_fundamentals/03_installation_setup.html">Installation and Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01_fundamentals/04_first_dspy_program.html">Your First DSPy Program</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01_fundamentals/05_language_models.html">Language Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01_fundamentals/06_exercises.html">Chapter 1 Exercises</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 2 - Signatures</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../02_signatures/00_chapter_intro.html">Chapter 2: Signatures</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../02_signatures/01_understanding_signatures.html">Understanding Signatures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02_signatures/02_signature_syntax.html">Signature Syntax</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02_signatures/03_typed_signatures.html">Typed Signatures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02_signatures/04_advanced_signatures.html">Advanced Signatures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02_signatures/05_practical_examples.html">Practical Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02_signatures/06_exercises.html">Chapter 2 Exercises</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 3 - Modules</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="00_chapter_intro.html">Chapter 3: Modules</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="01_module_basics.html">Module Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="02_predict_module.html">The Predict Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="02a_typed_predictor.html">TypedPredictor: Type-Safe Language Model Wrappers</a></li>
<li class="toctree-l2"><a class="reference internal" href="03_chainofthought.html">Chain of Thought Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="04_react_agents.html">ReAct Agents</a></li>
<li class="toctree-l2"><a class="reference internal" href="05_custom_modules.html">Custom Modules</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Composing Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="07_exercises.html">Chapter 3 Exercises</a></li>
<li class="toctree-l2"><a class="reference internal" href="08_assertions.html">Assertions Module</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 4 - Evaluation</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../04_evaluation/00_chapter_intro.html">Chapter 4: Evaluation</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/01_why_evaluation_matters.html">Why Evaluation Matters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/02_creating_datasets.html">Creating Datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/03_defining_metrics.html">Defining Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/04_evaluation_loops.html">Evaluation Loops</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/05_best_practices.html">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/06_exercises.html">Exercises</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/07_structured_prompting.html">Structured Prompting for Robust Evaluation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/08_llm_as_a_judge.html">LLM-as-a-Judge for Context-Sensitive Evaluation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04_evaluation/09_human_aligned_evaluation.html">Human-Aligned Evaluation: Capturing What Really Matters</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 5 - Optimizers</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../05_optimizers/00_chapter_intro.html">Chapter 5: Optimizers &amp; Compilation</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/01_compilation_concept.html">The Compilation Concept in DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/02_bootstrapfewshot.html">BootstrapFewShot: Automatic Few-Shot Example Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/02a_copro.html">COPRO: Chain-of-Thought Prompt Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/03_mipro.html">MIPRO: Multi-step Instruction and Demonstration Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/04_knnfewshot.html">KNNFewShot: Similarity-Based Example Selection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/05_finetuning.html">Fine-Tuning Small Language Models in DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/06_choosing_optimizers.html">Choosing Optimizers: Decision Guide and Trade-offs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/07_constraint_driven_optimization.html">Constraint-Driven Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/07_exercises.html">Chapter 5 Exercises: Optimizers &amp; Compilation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/08_reflective_prompt_evolution.html">Reflective Prompt Evolution (RPE): Evolutionary Optimization Without Gradients</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/09_copa_compiler_method.html">COPA: Compiler and Prompt Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/09a_copa_method.html">COPA: Combined Fine-Tuning and Prompt Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/10_joint_optimization.html">Joint Optimization: Fine-Tuning and Prompt Synergy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/11_monte_carlo_optimization.html">Monte Carlo Optimization in DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/12_bayesian_optimization.html">Bayesian Optimization for Prompt Tuning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/13_comprehensive_examples.html">Comprehensive Examples and Implementation Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/14_multistage_optimization_theory.html">Multi-stage Optimization Theory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/15_instruction_tuning_frameworks.html">Instruction Tuning Frameworks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/16_demonstration_optimization.html">Demonstration Optimization Strategies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/17_multistage_architectures.html">Multi-stage Program Architectures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/18_complex_pipeline_optimization.html">Optimization Strategies for Complex Pipelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/19_instruction_demonstration_interactions.html">Instruction and Demonstration Interaction Effects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/20_prompts_as_hyperparameters.html">Prompts as Auto-Optimized Hyperparameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/21_minimal_data_pipelines.html">Minimal Data Training Pipelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/22_gepa_genetic_pareto_optimization.html">GEPA: Genetic-Pareto Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/23_state_space_prompt_optimization.html">State-Space Search for Prompt Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/24_inpars_plus_synthetic_data_ir.html">InPars+: Advanced Synthetic Data Generation for Information Retrieval</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/25_custom_mipro_enhanced_optimization.html">CustomMIPROv2: Enhanced Multi-Stage Prompt Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_optimizers/26_automatic_prompt_optimization_research.html">Automatic Prompt Optimization: When AI Outperforms Humans</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 6 - Real-World Applications</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../06_real_world_applications/00_chapter_intro.html">Chapter 6: Building Real-World Applications</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/01_rag_systems.html">RAG Systems: Building Intelligent Document Q&amp;A</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/02_multi_hop_search.html">Multi-hop Search: Complex Reasoning Across Documents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/03_classification_tasks.html">Classification Tasks: Building Robust Text Categorization Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/04_entity_extraction.html">Entity Extraction: Mining Structured Information from Text</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/05_intelligent_agents.html">Intelligent Agents: Building Autonomous Problem-Solving Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/06_code_generation.html">Code Generation: Building Automated Programming Assistants</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/07_exercises.html">Chapter 6 Exercises: Building Real-World Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/07a_perspective_driven_research.html">Perspective-Driven Research for Article Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/08_extreme_multilabel_classification.html">Extreme Multi-Label Classification: Scaling to Millions of Labels</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/08a_long_form_generation.html">Long-form Article Generation with DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/09_outline_generation.html">Outline Generation for Structured Article Writing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/11_extreme_few_shot_learning.html">Extreme Few-Shot Learning: Training with 10 Gold Labels</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/12_ir_model_training_scratch.html">IR Model Training from Scratch: Methodology and Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/13_lingvarbench_healthcare_synthetic_data.html">LingVarBench: Synthetic Healthcare Transcript Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/14_scientific_figure_caption_generation.html">Scientific Figure Caption Generation with DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/15_retrieval_augmented_guardrails.html">Retrieval-Augmented Guardrails for AI Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/16_graphrag_wikipedia_tidb_tutorial.html">GraphRAG from Wikipedia: Building with DSPy, OpenAI, and TiDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/17_framework_comparisons_dspy_ecosystem.html">Framework Comparisons in the DSPy Ecosystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_real_world_applications/18_multi_agent_rag_systems.html">Multi-Agent RAG Systems with DSPy</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 7 - Advanced Topics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../07_advanced_topics/00_chapter_intro.html">Chapter 7: Advanced Topics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/01_adapters_tools.html">Adapters and Tools: Extending DSPy Capabilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/02_caching_performance.html">Caching and Performance: Building High-Performance DSPy Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/03_async_streaming.html">Async and Streaming: Building Real-Time DSPy Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/04_debugging_tracing.html">Debugging and Tracing: Mastering DSPy Application Diagnostics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/05_deployment_strategies.html">Deployment Strategies: Taking DSPy Applications to Production</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/06_exercises.html">Chapter 7 Exercises: Advanced Topics Mastery</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/07_self_refining_pipelines.html">Self-Refining Pipelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_advanced_topics/08_declarative_compilation.html">Declarative Language Model Compilation Techniques</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part 8 - Case Studies</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../08_case_studies/00_introduction.html">Chapter 8: Case Studies</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/01_enterprise_rag_system.html">Case Study 1: Building an Enterprise RAG System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/01a_healthcare_clinical_notes.html">Case Study 1: Clinical Notes Analysis with DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/02_customer_support_chatbot.html">Case Study 2: Developing a Customer Support Chatbot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/03_ai_code_assistant.html">Case Study 3: Creating an AI-Powered Code Assistant</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/04_automated_data_analysis.html">Case Study 4: Building an Automated Data Analysis Pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/05_exercises.html">Chapter 8 Exercises</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/05a_storm_writing_assistant.html">Case Study 5: STORM - AI-Powered Writing Assistant for Wikipedia-like Articles</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/06_assertion_driven_applications.html">Case Study: Assertion-Driven Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/07_databricks_jetblue_llm_optimization.html">Case Study 7: Databricks &amp; JetBlue LLM Pipeline Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/08_replit_code_repair_dspy.html">Case Study 8: Replit Code Repair with DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/09_databricks_dspy_platform_integration.html">Case Study 9: Databricks Platform Integration with DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/10_ddi_behavioral_simulation_automation.html">Case Study 10: DDI Behavioral Simulation Automation with DSPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_case_studies/11_salomatic_medical_report_generation.html">Case Study 11: Salomatic Medical Report Generation with DSPy and Langtrace</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../09_appendices/00_introduction.html">Chapter 9: Appendices</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../09_appendices/01_api_reference_quick.html">API Reference Quick Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09_appendices/02_troubleshooting.html">Troubleshooting Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09_appendices/03_resources.html">Additional Resources</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09_appendices/04_glossary.html">Glossary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09_appendices/05_community_resources.html">Community Resources and Perspectives</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/content/03_modules/06_composing_modules.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Composing Modules</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prerequisites">Prerequisites</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-objectives">Learning Objectives</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction-to-module-composition">Introduction to Module Composition</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#composition-patterns">Composition Patterns</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sequential-composition">Sequential Composition</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#basic-pipeline-pattern">Basic Pipeline Pattern</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-pipeline-with-error-handling">Advanced Pipeline with Error Handling</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#parallel-composition">Parallel Composition</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parallel-module-execution">Parallel Module Execution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#specialized-parallel-patterns">Specialized Parallel Patterns</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#ensemble-classifier">Ensemble Classifier</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conditional-composition">Conditional Composition</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#router-module">Router Module</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#adaptive-module">Adaptive Module</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#hierarchical-composition">Hierarchical Composition</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multi-level-analysis-system">Multi-Level Analysis System</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#feedback-loop-composition">Feedback Loop Composition</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#iterative-refinement-module">Iterative Refinement Module</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#performance-optimization">Performance Optimization</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lazy-evaluation">Lazy Evaluation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#batch-processing">Batch Processing</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#best-practices">Best Practices</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#design-for-testability">1. Design for Testability</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#handle-failure-gracefully">2. Handle Failure Gracefully</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#use-type-hints">3. Use Type Hints</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-composition-patterns">Advanced Composition Patterns</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#section-by-section-writing-pattern">Section-by-Section Writing Pattern</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#key-takeaways">Key Takeaways</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#further-reading">Further Reading</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="composing-modules">
<h1>Composing Modules<a class="headerlink" href="#composing-modules" title="Link to this heading">#</a></h1>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>Previous Sections</strong>: <a class="reference internal" href="#./05-custom-modules.md"><span class="xref myst">Custom Modules</span></a> - Understanding of module creation</p></li>
<li><p><strong>Chapter 2</strong>: Signatures - Mastery of signature design</p></li>
<li><p><strong>Required Knowledge</strong>: Understanding of software design patterns</p></li>
<li><p><strong>Difficulty Level</strong>: Advanced</p></li>
<li><p><strong>Estimated Reading Time</strong>: 40 minutes</p></li>
</ul>
</section>
<section id="learning-objectives">
<h2>Learning Objectives<a class="headerlink" href="#learning-objectives" title="Link to this heading">#</a></h2>
<p>By the end of this section, you will:</p>
<ul class="simple">
<li><p>Master patterns for composing multiple DSPy modules</p></li>
<li><p>Learn to build complex workflows from simple components</p></li>
<li><p>Understand pipeline, chain, and parallel composition patterns</p></li>
<li><p>Discover how to optimize module composition for performance</p></li>
<li><p>Build sophisticated multi-module systems</p></li>
</ul>
</section>
<section id="introduction-to-module-composition">
<h2>Introduction to Module Composition<a class="headerlink" href="#introduction-to-module-composition" title="Link to this heading">#</a></h2>
<p>Module composition is the art of combining multiple DSPy modules to create powerful, specialized systems. Just as functions can be composed to form complex programs, DSPy modules can be composed to create sophisticated LLM applications.</p>
<section id="composition-patterns">
<h3>Composition Patterns<a class="headerlink" href="#composition-patterns" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p><strong>Sequential/Pipeline Composition</strong> - Pass output of one module to next</p></li>
<li><p><strong>Parallel Composition</strong> - Run multiple modules simultaneously</p></li>
<li><p><strong>Conditional Composition</strong> - Choose module based on conditions</p></li>
<li><p><strong>Hierarchical Composition</strong> - Nested modules for complex logic</p></li>
<li><p><strong>Feedback Loops</strong> - Modules that iteratively refine outputs</p></li>
</ol>
</section>
</section>
<section id="sequential-composition">
<h2>Sequential Composition<a class="headerlink" href="#sequential-composition" title="Link to this heading">#</a></h2>
<section id="basic-pipeline-pattern">
<h3>Basic Pipeline Pattern<a class="headerlink" href="#basic-pipeline-pattern" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">dspy</span>

<span class="c1"># Define individual modules</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TextCleaner</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signature</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Signature</span><span class="p">(</span><span class="s2">&quot;raw_text -&gt; cleaned_text&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_text</span><span class="p">):</span>
        <span class="c1"># Simple cleaning logic</span>
        <span class="n">cleaned</span> <span class="o">=</span> <span class="n">raw_text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Prediction</span><span class="p">(</span><span class="n">cleaned_text</span><span class="o">=</span><span class="n">cleaned</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TextAnalyzer</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span>
            <span class="s2">&quot;cleaned_text -&gt; sentiment, key_topics, entities&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cleaned_text</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="p">(</span><span class="n">cleaned_text</span><span class="o">=</span><span class="n">cleaned_text</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ReportGenerator</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generator</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span>
            <span class="s2">&quot;sentiment, key_topics, entities -&gt; report&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sentiment</span><span class="p">,</span> <span class="n">key_topics</span><span class="p">,</span> <span class="n">entities</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">(</span>
            <span class="n">sentiment</span><span class="o">=</span><span class="n">sentiment</span><span class="p">,</span>
            <span class="n">key_topics</span><span class="o">=</span><span class="n">key_topics</span><span class="p">,</span>
            <span class="n">entities</span><span class="o">=</span><span class="n">entities</span>
        <span class="p">)</span>

<span class="c1"># Compose into a pipeline</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TextAnalysisPipeline</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pipeline that combines text cleaning, analysis, and reporting.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleaner</span> <span class="o">=</span> <span class="n">TextCleaner</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span> <span class="o">=</span> <span class="n">TextAnalyzer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generator</span> <span class="o">=</span> <span class="n">ReportGenerator</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_text</span><span class="p">):</span>
        <span class="c1"># Step 1: Clean text</span>
        <span class="n">cleaned_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaner</span><span class="p">(</span><span class="n">raw_text</span><span class="o">=</span><span class="n">raw_text</span><span class="p">)</span>
        <span class="n">cleaned_text</span> <span class="o">=</span> <span class="n">cleaned_result</span><span class="o">.</span><span class="n">cleaned_text</span>

        <span class="c1"># Step 2: Analyze text</span>
        <span class="n">analysis_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="p">(</span><span class="n">cleaned_text</span><span class="o">=</span><span class="n">cleaned_text</span><span class="p">)</span>

        <span class="c1"># Step 3: Generate report</span>
        <span class="n">report_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">(</span>
            <span class="n">sentiment</span><span class="o">=</span><span class="n">analysis_result</span><span class="o">.</span><span class="n">sentiment</span><span class="p">,</span>
            <span class="n">key_topics</span><span class="o">=</span><span class="n">analysis_result</span><span class="o">.</span><span class="n">key_topics</span><span class="p">,</span>
            <span class="n">entities</span><span class="o">=</span><span class="n">analysis_result</span><span class="o">.</span><span class="n">entities</span>
        <span class="p">)</span>

        <span class="c1"># Combine all results</span>
        <span class="k">return</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Prediction</span><span class="p">(</span>
            <span class="n">cleaned_text</span><span class="o">=</span><span class="n">cleaned_text</span><span class="p">,</span>
            <span class="n">sentiment</span><span class="o">=</span><span class="n">analysis_result</span><span class="o">.</span><span class="n">sentiment</span><span class="p">,</span>
            <span class="n">key_topics</span><span class="o">=</span><span class="n">analysis_result</span><span class="o">.</span><span class="n">key_topics</span><span class="p">,</span>
            <span class="n">entities</span><span class="o">=</span><span class="n">analysis_result</span><span class="o">.</span><span class="n">entities</span><span class="p">,</span>
            <span class="n">report</span><span class="o">=</span><span class="n">report_result</span><span class="o">.</span><span class="n">report</span>
        <span class="p">)</span>

<span class="c1"># Use the pipeline</span>
<span class="n">pipeline</span> <span class="o">=</span> <span class="n">TextAnalysisPipeline</span><span class="p">()</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">(</span><span class="n">raw_text</span><span class="o">=</span><span class="s2">&quot;  This is an AMAZING product! I love how it works perfectly.  &quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Report: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">report</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="advanced-pipeline-with-error-handling">
<h3>Advanced Pipeline with Error Handling<a class="headerlink" href="#advanced-pipeline-with-error-handling" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">RobustPipeline</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pipeline with error handling and fallbacks.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modules</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">],</span> <span class="n">fallbacks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize pipeline with modules and fallbacks.</span>

<span class="sd">        Args:</span>
<span class="sd">            modules: List of modules in execution order</span>
<span class="sd">            fallbacks: Dictionary mapping module index to fallback module</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modules</span> <span class="o">=</span> <span class="n">modules</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fallbacks</span> <span class="o">=</span> <span class="n">fallbacks</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module_outputs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute pipeline with error handling.&quot;&quot;&quot;</span>
        <span class="n">current_input</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">module</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Execute module</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">module</span><span class="p">(</span><span class="o">**</span><span class="n">current_input</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">module_outputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>

                <span class="c1"># Extract outputs for next module</span>
                <span class="n">current_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_outputs</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Module </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Try fallback if available</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallbacks</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using fallback for module </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">fallback_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallbacks</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="o">**</span><span class="n">current_input</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">module_outputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fallback_result</span>
                    <span class="n">current_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_outputs</span><span class="p">(</span><span class="n">fallback_result</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Skip this module</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No fallback for module </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, skipping&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

        <span class="k">return</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Prediction</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">module_outputs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">extract_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Prediction</span><span class="p">,</span> <span class="n">module_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract outputs from module result for next module.&quot;&quot;&quot;</span>
        <span class="c1"># Get module signature</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">module_index</span><span class="p">],</span> <span class="s1">&#39;signature&#39;</span><span class="p">):</span>
            <span class="n">output_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">module_index</span><span class="p">]</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">output_fields</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">output_fields</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Fallback: return all attributes</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)}</span>
</pre></div>
</div>
</section>
</section>
<section id="parallel-composition">
<h2>Parallel Composition<a class="headerlink" href="#parallel-composition" title="Link to this heading">#</a></h2>
<section id="parallel-module-execution">
<h3>Parallel Module Execution<a class="headerlink" href="#parallel-module-execution" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ParallelProcessor</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute multiple modules in parallel.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modules</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">],</span> <span class="n">combine_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;merge&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize parallel processor.</span>

<span class="sd">        Args:</span>
<span class="sd">            modules: List of modules to execute in parallel</span>
<span class="sd">            combine_mode: How to combine outputs (&quot;merge&quot;, &quot;vote&quot;, &quot;select&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modules</span> <span class="o">=</span> <span class="n">modules</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combine_mode</span> <span class="o">=</span> <span class="n">combine_mode</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute all modules in parallel.&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># Execute modules in parallel</span>
        <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">))</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">module</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">):</span>
                <span class="n">future</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">future</span><span class="p">))</span>

            <span class="c1"># Collect results</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;module_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Module </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;module_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

        <span class="c1"># Combine results based on mode</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_results</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

        <span class="c1"># Add metadata</span>
        <span class="n">combined</span><span class="p">[</span><span class="s1">&#39;parallel_metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;execution_time&#39;</span><span class="p">:</span> <span class="n">execution_time</span><span class="p">,</span>
            <span class="s1">&#39;modules_run&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">),</span>
            <span class="s1">&#39;successful_modules&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Prediction</span><span class="p">(</span><span class="o">**</span><span class="n">combined</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">combine_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Combine results from multiple modules.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_mode</span> <span class="o">==</span> <span class="s2">&quot;merge&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_results</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_mode</span> <span class="o">==</span> <span class="s2">&quot;vote&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vote_results</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_mode</span> <span class="o">==</span> <span class="s2">&quot;select&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_best_result</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;combined_results&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">merge_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Merge all results into one dictionary.&quot;&quot;&quot;</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span>
                        <span class="n">merged</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">merged</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">vote_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Vote on categorical outputs.&quot;&quot;&quot;</span>
        <span class="n">votes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s1">&#39;prediction&#39;</span><span class="p">):</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">prediction</span>
                <span class="k">if</span> <span class="n">pred</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">votes</span><span class="p">:</span>
                    <span class="n">votes</span><span class="p">[</span><span class="n">pred</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">votes</span><span class="p">[</span><span class="n">pred</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Find most common prediction</span>
        <span class="k">if</span> <span class="n">votes</span><span class="p">:</span>
            <span class="n">winning_pred</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">votes</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">votes</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;prediction&quot;</span><span class="p">:</span> <span class="n">winning_pred</span><span class="p">,</span>
                <span class="s2">&quot;vote_counts&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">votes</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">votes</span><span class="p">[</span><span class="n">winning_pred</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">votes</span><span class="p">)</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;prediction&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;vote_counts&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">select_best_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Select the best result based on confidence scores.&quot;&quot;&quot;</span>
        <span class="n">best_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_confidence</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">confidence</span> <span class="o">&gt;</span> <span class="n">best_confidence</span><span class="p">:</span>
                    <span class="n">best_result</span> <span class="o">=</span> <span class="n">result</span>
                    <span class="n">best_confidence</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">confidence</span>

        <span class="k">if</span> <span class="n">best_result</span><span class="p">:</span>
            <span class="n">best_result</span><span class="p">[</span><span class="s2">&quot;selected_from&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">r</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">best_result</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No valid results found&quot;</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="specialized-parallel-patterns">
<h3>Specialized Parallel Patterns<a class="headerlink" href="#specialized-parallel-patterns" title="Link to this heading">#</a></h3>
<section id="ensemble-classifier">
<h4>Ensemble Classifier<a class="headerlink" href="#ensemble-classifier" title="Link to this heading">#</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">EnsembleClassifier</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensemble of classifiers that vote on predictions.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classifier_configs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize ensemble with multiple classifier configurations.</span>

<span class="sd">        Args:</span>
<span class="sd">            classifier_configs: List of configs for individual classifiers</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifiers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">classifier_configs</span><span class="p">:</span>
            <span class="c1"># Create classifier</span>
            <span class="n">signature</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Signature</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;signature&#39;</span><span class="p">])</span>
            <span class="n">classifier</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span><span class="n">signature</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;params&#39;</span><span class="p">,</span> <span class="p">{}))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">classifiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">classifier</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Prediction</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get ensemble prediction.&quot;&quot;&quot;</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">confidences</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Get predictions from all classifiers</span>
        <span class="k">for</span> <span class="n">classifier</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifiers</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">classifier</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">)</span>
            <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">prediction</span><span class="p">)</span>
            <span class="n">confidences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>

        <span class="c1"># Weighted voting</span>
        <span class="n">weighted_votes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">pred</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">confidences</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">):</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">conf</span> <span class="o">*</span> <span class="n">weight</span>
            <span class="k">if</span> <span class="n">pred</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">weighted_votes</span><span class="p">:</span>
                <span class="n">weighted_votes</span><span class="p">[</span><span class="n">pred</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">weighted_votes</span><span class="p">[</span><span class="n">pred</span><span class="p">]</span> <span class="o">+=</span> <span class="n">score</span>

        <span class="c1"># Find winner</span>
        <span class="n">winner</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">weighted_votes</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">weighted_votes</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
        <span class="n">total_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weighted_votes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">confidence</span> <span class="o">=</span> <span class="n">weighted_votes</span><span class="p">[</span><span class="n">winner</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_score</span> <span class="k">if</span> <span class="n">total_score</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.5</span>

        <span class="k">return</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Prediction</span><span class="p">(</span>
            <span class="n">prediction</span><span class="o">=</span><span class="n">winner</span><span class="p">,</span>
            <span class="n">confidence</span><span class="o">=</span><span class="n">confidence</span><span class="p">,</span>
            <span class="n">all_predictions</span><span class="o">=</span><span class="n">predictions</span><span class="p">,</span>
            <span class="n">vote_breakdown</span><span class="o">=</span><span class="n">weighted_votes</span>
        <span class="p">)</span>

<span class="c1"># Use ensemble classifier</span>
<span class="n">ensemble</span> <span class="o">=</span> <span class="n">EnsembleClassifier</span><span class="p">([</span>
    <span class="p">{</span>
        <span class="s1">&#39;signature&#39;</span><span class="p">:</span> <span class="s1">&#39;text -&gt; prediction, confidence&#39;</span><span class="p">,</span>
        <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;temperature&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
        <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="mf">2.0</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s1">&#39;signature&#39;</span><span class="p">:</span> <span class="s1">&#39;text -&gt; prediction, confidence&#39;</span><span class="p">,</span>
        <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;temperature&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">},</span>
        <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="mf">1.5</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s1">&#39;signature&#39;</span><span class="p">:</span> <span class="s1">&#39;text -&gt; prediction, confidence&#39;</span><span class="p">,</span>
        <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;temperature&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
        <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="mf">1.0</span>
    <span class="p">}</span>
<span class="p">])</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">ensemble</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;This product is absolutely fantastic!&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ensemble prediction: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">prediction</span><span class="si">}</span><span class="s2"> (confidence: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">confidence</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="conditional-composition">
<h2>Conditional Composition<a class="headerlink" href="#conditional-composition" title="Link to this heading">#</a></h2>
<section id="router-module">
<h3>Router Module<a class="headerlink" href="#router-module" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Router</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Route inputs to different modules based on conditions.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">],</span> <span class="n">default_route</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize router.</span>

<span class="sd">        Args:</span>
<span class="sd">            routes: Dictionary mapping route names to modules</span>
<span class="sd">            default_route: Default route if no condition matches</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routes</span> <span class="o">=</span> <span class="n">routes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_route</span> <span class="o">=</span> <span class="n">default_route</span> <span class="ow">or</span> <span class="nb">list</span><span class="p">(</span><span class="n">routes</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Route to appropriate module based on input conditions.&quot;&quot;&quot;</span>
        <span class="c1"># Determine route</span>
        <span class="n">route_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">determine_route</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Get module</span>
        <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">route_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">routes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">default_route</span><span class="p">])</span>

        <span class="c1"># Execute module</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">module</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Add routing information</span>
        <span class="n">result</span><span class="o">.</span><span class="n">route_used</span> <span class="o">=</span> <span class="n">route_name</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">determine_route</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine which route to use based on inputs.&quot;&quot;&quot;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="c1"># Simple routing logic</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">text</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">,</span> <span class="s1">&#39;purchase&#39;</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="s1">&#39;commerce&#39;</span>
        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">text</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">,</span> <span class="s1">&#39;support&#39;</span><span class="p">,</span> <span class="s1">&#39;issue&#39;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="s1">&#39;support&#39;</span>
        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">text</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;what&#39;</span><span class="p">,</span> <span class="s1">&#39;how&#39;</span><span class="p">,</span> <span class="s1">&#39;why&#39;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="s1">&#39;question&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_route</span>

<span class="c1"># Create routing system</span>
<span class="n">router</span> <span class="o">=</span> <span class="n">Router</span><span class="p">(</span>
    <span class="n">routes</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;commerce&#39;</span><span class="p">:</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span><span class="s2">&quot;text -&gt; category, intent&quot;</span><span class="p">),</span>
        <span class="s1">&#39;support&#39;</span><span class="p">:</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span><span class="s2">&quot;text -&gt; issue_type, priority&quot;</span><span class="p">),</span>
        <span class="s1">&#39;question&#39;</span><span class="p">:</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span><span class="s2">&quot;text -&gt; answer&quot;</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="n">default_route</span><span class="o">=</span><span class="s1">&#39;general&#39;</span>
<span class="p">)</span>

<span class="c1"># Test routing</span>
<span class="n">result1</span> <span class="o">=</span> <span class="n">router</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;I want to buy your product&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Route: </span><span class="si">{</span><span class="n">result1</span><span class="o">.</span><span class="n">route_used</span><span class="si">}</span><span class="s2">, Category: </span><span class="si">{</span><span class="n">result1</span><span class="o">.</span><span class="n">category</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">result2</span> <span class="o">=</span> <span class="n">router</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;How does this work?&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Route: </span><span class="si">{</span><span class="n">result2</span><span class="o">.</span><span class="n">route_used</span><span class="si">}</span><span class="s2">, Answer: </span><span class="si">{</span><span class="n">result2</span><span class="o">.</span><span class="n">answer</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="adaptive-module">
<h3>Adaptive Module<a class="headerlink" href="#adaptive-module" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AdaptiveModule</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Module that adapts its behavior based on input complexity.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simple_module</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span><span class="s2">&quot;query -&gt; answer&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">complex_module</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">ChainOfThought</span><span class="p">(</span><span class="s2">&quot;query -&gt; reasoning, answer&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Prediction</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Choose module based on query complexity.&quot;&quot;&quot;</span>
        <span class="n">complexity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assess_complexity</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">complexity</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="c1"># Use simple module for easy queries</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simple_module</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">processing_type</span> <span class="o">=</span> <span class="s2">&quot;simple&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use reasoning module for complex queries</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">complex_module</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">processing_type</span> <span class="o">=</span> <span class="s2">&quot;complex&quot;</span>

        <span class="n">result</span><span class="o">.</span><span class="n">complexity_score</span> <span class="o">=</span> <span class="n">complexity</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">assess_complexity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assess query complexity (0-1).&quot;&quot;&quot;</span>
        <span class="c1"># Simple heuristic</span>
        <span class="n">complexity_indicators</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">/</span> <span class="mi">20</span><span class="p">,</span>  <span class="c1"># Word count</span>
            <span class="nb">len</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">query</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">isupper</span><span class="p">()])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="p">),</span>  <span class="c1"># Capitals</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">query</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;!&#39;</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>  <span class="c1"># Punctuation</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">complexity_indicators</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>

<span class="c1"># Use adaptive module</span>
<span class="n">adaptive</span> <span class="o">=</span> <span class="n">AdaptiveModule</span><span class="p">()</span>

<span class="n">simple_result</span> <span class="o">=</span> <span class="n">adaptive</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="s2">&quot;What time is it?&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Type: </span><span class="si">{</span><span class="n">simple_result</span><span class="o">.</span><span class="n">processing_type</span><span class="si">}</span><span class="s2">, Answer: </span><span class="si">{</span><span class="n">simple_result</span><span class="o">.</span><span class="n">answer</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">complex_result</span> <span class="o">=</span> <span class="n">adaptive</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="s2">&quot;Explain the economic implications of inflation on small businesses&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Type: </span><span class="si">{</span><span class="n">complex_result</span><span class="o">.</span><span class="n">processing_type</span><span class="si">}</span><span class="s2">, Confidence: </span><span class="si">{</span><span class="n">complex_result</span><span class="o">.</span><span class="n">complexity_score</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="hierarchical-composition">
<h2>Hierarchical Composition<a class="headerlink" href="#hierarchical-composition" title="Link to this heading">#</a></h2>
<section id="multi-level-analysis-system">
<h3>Multi-Level Analysis System<a class="headerlink" href="#multi-level-analysis-system" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DocumentAnalyzer</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Multi-level document analysis system.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Level 1: Initial analysis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level1</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span><span class="s2">&quot;document -&gt; summary, key_points&quot;</span><span class="p">)</span>

        <span class="c1"># Level 2: Deep analysis based on Level 1 results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level2_classifier</span> <span class="o">=</span> <span class="n">Router</span><span class="p">(</span>
            <span class="n">routes</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;factual&#39;</span><span class="p">:</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span><span class="s2">&quot;document, summary -&gt; factual_analysis&quot;</span><span class="p">),</span>
                <span class="s1">&#39;opinion&#39;</span><span class="p">:</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span><span class="s2">&quot;document, summary -&gt; opinion_analysis&quot;</span><span class="p">),</span>
                <span class="s1">&#39;mixed&#39;</span><span class="p">:</span> <span class="n">dspy</span><span class="o">.</span><span class="n">ChainOfThought</span><span class="p">(</span><span class="s2">&quot;document, summary -&gt; detailed_analysis&quot;</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># Level 3: Specialized analysis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level3_modules</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;technical&#39;</span><span class="p">:</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span><span class="s2">&quot;document, detailed_analysis -&gt; technical_insights&quot;</span><span class="p">),</span>
            <span class="s1">&#39;legal&#39;</span><span class="p">:</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span><span class="s2">&quot;document, detailed_analysis -&gt; legal_considerations&quot;</span><span class="p">),</span>
            <span class="s1">&#39;business&#39;</span><span class="p">:</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span><span class="s2">&quot;document, detailed_analysis -&gt; business_impact&quot;</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">document_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Prediction</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform multi-level analysis.&quot;&quot;&quot;</span>
        <span class="c1"># Level 1: Basic analysis</span>
        <span class="n">level1_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level1</span><span class="p">(</span><span class="n">document</span><span class="o">=</span><span class="n">document</span><span class="p">)</span>

        <span class="c1"># Level 2: Determine document type and analyze</span>
        <span class="n">doc_type</span> <span class="o">=</span> <span class="n">document_type</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">classify_document</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>
        <span class="n">level2_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level2_classifier</span><span class="p">(</span>
            <span class="n">document</span><span class="o">=</span><span class="n">document</span><span class="p">,</span>
            <span class="n">summary</span><span class="o">=</span><span class="n">level1_result</span><span class="o">.</span><span class="n">summary</span>
        <span class="p">)</span>

        <span class="c1"># Level 3: Specialized analysis if available</span>
        <span class="n">level3_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">doc_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">level3_modules</span><span class="p">:</span>
            <span class="n">level3_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level3_modules</span><span class="p">[</span><span class="n">doc_type</span><span class="p">](</span>
                <span class="n">document</span><span class="o">=</span><span class="n">document</span><span class="p">,</span>
                <span class="n">detailed_analysis</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">level2_result</span><span class="p">,</span> <span class="n">level2_result</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Combine all results</span>
        <span class="n">final_result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;summary&#39;</span><span class="p">:</span> <span class="n">level1_result</span><span class="o">.</span><span class="n">summary</span><span class="p">,</span>
            <span class="s1">&#39;key_points&#39;</span><span class="p">:</span> <span class="n">level1_result</span><span class="o">.</span><span class="n">key_points</span><span class="p">,</span>
            <span class="s1">&#39;document_type&#39;</span><span class="p">:</span> <span class="n">doc_type</span><span class="p">,</span>
            <span class="s1">&#39;level2_analysis&#39;</span><span class="p">:</span> <span class="n">level2_result</span><span class="p">,</span>
            <span class="s1">&#39;level3_analysis&#39;</span><span class="p">:</span> <span class="n">level3_result</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Prediction</span><span class="p">(</span><span class="o">**</span><span class="n">final_result</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">classify_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Classify document type.&quot;&quot;&quot;</span>
        <span class="n">text_lower</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">indicators</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;technical&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;algorithm&#39;</span><span class="p">,</span> <span class="s1">&#39;implementation&#39;</span><span class="p">,</span> <span class="s1">&#39;programming&#39;</span><span class="p">],</span>
            <span class="s1">&#39;legal&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;contract&#39;</span><span class="p">,</span> <span class="s1">&#39;agreement&#39;</span><span class="p">,</span> <span class="s1">&#39;liability&#39;</span><span class="p">,</span> <span class="s1">&#39;jurisdiction&#39;</span><span class="p">],</span>
            <span class="s1">&#39;business&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;revenue&#39;</span><span class="p">,</span> <span class="s1">&#39;profit&#39;</span><span class="p">,</span> <span class="s1">&#39;market&#39;</span><span class="p">,</span> <span class="s1">&#39;strategy&#39;</span><span class="p">]</span>
        <span class="p">}</span>

        <span class="n">scores</span> <span class="o">=</span> <span class="p">{</span><span class="n">doc_type</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">indicators</span> <span class="k">if</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">text_lower</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">doc_type</span><span class="p">,</span> <span class="n">indicators</span> <span class="ow">in</span> <span class="n">indicators</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">scores</span><span class="o">.</span><span class="n">get</span><span class="p">)</span> <span class="k">if</span> <span class="n">scores</span> <span class="k">else</span> <span class="s1">&#39;general&#39;</span>

<span class="c1"># Use hierarchical analyzer</span>
<span class="n">analyzer</span> <span class="o">=</span> <span class="n">DocumentAnalyzer</span><span class="p">()</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">analyzer</span><span class="p">(</span>
    <span class="n">document</span><span class="o">=</span><span class="s2">&quot;The code implements a sorting algorithm using Python. It includes error handling and unit tests. &quot;</span>
            <span class="s2">&quot;The implementation is covered by an MIT license.&quot;</span><span class="p">,</span>
    <span class="n">document_type</span><span class="o">=</span><span class="s2">&quot;technical&quot;</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Summary: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">summary</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Document Type: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">document_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="feedback-loop-composition">
<h2>Feedback Loop Composition<a class="headerlink" href="#feedback-loop-composition" title="Link to this heading">#</a></h2>
<section id="iterative-refinement-module">
<h3>Iterative Refinement Module<a class="headerlink" href="#iterative-refinement-module" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">IterativeRefiner</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Module that iteratively refines outputs.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_module</span><span class="p">,</span> <span class="n">refinement_module</span><span class="p">,</span> <span class="n">max_iterations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize iterative refiner.</span>

<span class="sd">        Args:</span>
<span class="sd">            base_module: Module to generate initial output</span>
<span class="sd">            refinement_module: Module to refine outputs</span>
<span class="sd">            max_iterations: Maximum number of refinement iterations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_module</span> <span class="o">=</span> <span class="n">base_module</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refinement_module</span> <span class="o">=</span> <span class="n">refinement_module</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_iterations</span> <span class="o">=</span> <span class="n">max_iterations</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate and iteratively refine output.&quot;&quot;&quot;</span>
        <span class="c1"># Generate initial output</span>
        <span class="n">current_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_module</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Iteratively refine</span>
        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_iterations</span><span class="p">):</span>
            <span class="c1"># Check if refinement is needed</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_satisfactory</span><span class="p">(</span><span class="n">current_output</span><span class="p">):</span>
                <span class="k">break</span>

            <span class="c1"># Refine current output</span>
            <span class="n">refinement_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_refinement_prompt</span><span class="p">(</span>
                <span class="n">current_output</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>

            <span class="n">refined</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refinement_module</span><span class="p">(</span>
                <span class="n">original</span><span class="o">=</span><span class="n">current_output</span><span class="p">,</span>
                <span class="n">refinement_prompt</span><span class="o">=</span><span class="n">refinement_prompt</span><span class="p">,</span>
                <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="p">)</span>

            <span class="c1"># Update output</span>
            <span class="n">current_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_outputs</span><span class="p">(</span><span class="n">current_output</span><span class="p">,</span> <span class="n">refined</span><span class="p">)</span>

        <span class="c1"># Add iteration info</span>
        <span class="n">current_output</span><span class="o">.</span><span class="n">iterations</span> <span class="o">=</span> <span class="n">iteration</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">current_output</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_satisfactory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Prediction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if output meets quality criteria.&quot;&quot;&quot;</span>
        <span class="c1"># Check confidence if available</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">confidence</span> <span class="o">&gt;=</span> <span class="mf">0.9</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_refinement_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Prediction</span><span class="p">,</span> <span class="n">iteration</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create prompt for refinement.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">iteration</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Please refine this output to be more detailed and comprehensive.&quot;</span>
        <span class="k">elif</span> <span class="n">iteration</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Please improve clarity and add more examples.&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Please review and polish the output for final delivery.&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">merge_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original</span><span class="p">:</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Prediction</span><span class="p">,</span> <span class="n">refined</span><span class="p">:</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Prediction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Prediction</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Merge original and refined outputs.&quot;&quot;&quot;</span>
        <span class="c1"># Use refined output but keep metadata from original</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="n">refined</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">):</span>
            <span class="n">merged</span><span class="p">[</span><span class="s1">&#39;original_confidence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">original</span><span class="o">.</span><span class="n">confidence</span>
        <span class="k">return</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Prediction</span><span class="p">(</span><span class="o">**</span><span class="n">merged</span><span class="p">)</span>

<span class="c1"># Create iterative refiner</span>
<span class="n">base</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span><span class="s2">&quot;prompt -&gt; response&quot;</span><span class="p">)</span>
<span class="n">refiner</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">ChainOfThought</span><span class="p">(</span><span class="s2">&quot;original, refinement_prompt -&gt; refined_response&quot;</span><span class="p">)</span>

<span class="n">iterative_module</span> <span class="o">=</span> <span class="n">IterativeRefiner</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">refiner</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">iterative_module</span><span class="p">(</span>
    <span class="n">prompt</span><span class="o">=</span><span class="s2">&quot;Explain quantum computing&quot;</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final response after </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">iterations</span><span class="si">}</span><span class="s2"> iterations&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="performance-optimization">
<h2>Performance Optimization<a class="headerlink" href="#performance-optimization" title="Link to this heading">#</a></h2>
<section id="lazy-evaluation">
<h3>Lazy Evaluation<a class="headerlink" href="#lazy-evaluation" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">LazyComposer</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Composer that lazily evaluates modules only when needed.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modules</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">]):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modules</span> <span class="o">=</span> <span class="n">modules</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_results_cache</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">required_outputs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute only modules needed for required outputs.&quot;&quot;&quot;</span>
        <span class="c1"># Map outputs to modules</span>
        <span class="n">output_to_module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_outputs_to_modules</span><span class="p">(</span><span class="n">required_outputs</span><span class="p">)</span>

        <span class="c1"># Execute required modules</span>
        <span class="n">executed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">module_name</span> <span class="ow">in</span> <span class="n">output_to_module</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">module_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">executed</span><span class="p">:</span>
                <span class="n">module</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_name</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">module</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_results_cache</span><span class="p">[</span><span class="n">module_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
                <span class="n">executed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>

        <span class="c1"># Return only required outputs</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_required_outputs</span><span class="p">(</span><span class="n">required_outputs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">map_outputs_to_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">required_outputs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Map required outputs to module names.&quot;&quot;&quot;</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;summary&#39;</span><span class="p">:</span> <span class="s1">&#39;summarizer&#39;</span><span class="p">,</span>
            <span class="s1">&#39;sentiment&#39;</span><span class="p">:</span> <span class="s1">&#39;sentiment_analyzer&#39;</span><span class="p">,</span>
            <span class="s1">&#39;topics&#39;</span><span class="p">:</span> <span class="s1">&#39;topic_extractor&#39;</span><span class="p">,</span>
            <span class="s1">&#39;entities&#39;</span><span class="p">:</span> <span class="s1">&#39;entity_recognizer&#39;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="p">{</span><span class="n">output</span><span class="p">:</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s1">&#39;default_module&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">required_outputs</span>
                <span class="k">if</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="batch-processing">
<h3>Batch Processing<a class="headerlink" href="#batch-processing" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">BatchProcessor</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process multiple inputs efficiently in batches.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">:</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">module</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">dspy</span><span class="o">.</span><span class="n">Prediction</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process inputs in batches.&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">]</span>

            <span class="c1"># Process batch</span>
            <span class="n">batch_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">batch_results</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">dspy</span><span class="o">.</span><span class="n">Prediction</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process a single batch.&quot;&quot;&quot;</span>
        <span class="c1"># This could be optimized to use parallel processing</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">(</span><span class="o">**</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
</pre></div>
</div>
</section>
</section>
<section id="best-practices">
<h2>Best Practices<a class="headerlink" href="#best-practices" title="Link to this heading">#</a></h2>
<section id="design-for-testability">
<h3>1. Design for Testability<a class="headerlink" href="#design-for-testability" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TestableComposer</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Composer designed for easy testing.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># Use dependency injection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_module1</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_module2</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_module1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Factory method for module1 (can be overridden in tests).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span><span class="s2">&quot;text -&gt; analysis&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_module2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Factory method for module2 (can be overridden in tests).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span><span class="s2">&quot;analysis -&gt; report&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># Intermediate results can be inspected</span>
        <span class="n">intermediate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module1</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">)</span>
        <span class="n">final</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module2</span><span class="p">(</span><span class="n">analysis</span><span class="o">=</span><span class="n">intermediate</span><span class="o">.</span><span class="n">analysis</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">final</span>
</pre></div>
</div>
</section>
<section id="handle-failure-gracefully">
<h3>2. Handle Failure Gracefully<a class="headerlink" href="#handle-failure-gracefully" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ResilientComposer</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Composer that handles module failures.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modules</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">]):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modules</span> <span class="o">=</span> <span class="n">modules</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fallback_modules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_fallbacks</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">module</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">module</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                 <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_needs_input</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">k</span><span class="p">)})</span>
                <span class="n">results</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;module_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Module </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallback_modules</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fallback_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallback_modules</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                        <span class="n">results</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;module_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_fallback&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fallback_result</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">fallback_error</span><span class="p">:</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Module </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> fallback failed: </span><span class="si">{</span><span class="n">fallback_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Prediction</span><span class="p">(</span><span class="n">results</span><span class="o">=</span><span class="n">results</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="use-type-hints">
<h3>3. Use Type Hints<a class="headerlink" href="#use-type-hints" title="Link to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dspy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span><span class="p">,</span> <span class="n">Prediction</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TypedComposer</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Composer with full type annotations.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocessor</span><span class="p">:</span> <span class="n">Module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_preprocessor</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="p">:</span> <span class="n">Module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_analyzer</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_preprocessor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Module</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span><span class="s2">&quot;raw_text -&gt; processed_text&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_analyzer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Module</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span><span class="s2">&quot;processed_text -&gt; analysis, confidence&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Prediction</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process text with type safety.&quot;&quot;&quot;</span>
        <span class="c1"># Preprocess</span>
        <span class="n">pre_result</span><span class="p">:</span> <span class="n">Prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocessor</span><span class="p">(</span><span class="n">raw_text</span><span class="o">=</span><span class="n">raw_text</span><span class="p">)</span>

        <span class="c1"># Analyze</span>
        <span class="n">analysis_result</span><span class="p">:</span> <span class="n">Prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="p">(</span>
            <span class="n">processed_text</span><span class="o">=</span><span class="n">pre_result</span><span class="o">.</span><span class="n">processed_text</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">Prediction</span><span class="p">(</span>
            <span class="n">processed_text</span><span class="o">=</span><span class="n">pre_result</span><span class="o">.</span><span class="n">processed_text</span><span class="p">,</span>
            <span class="n">analysis</span><span class="o">=</span><span class="n">analysis_result</span><span class="o">.</span><span class="n">analysis</span><span class="p">,</span>
            <span class="n">confidence</span><span class="o">=</span><span class="n">analysis_result</span><span class="o">.</span><span class="n">confidence</span>
        <span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Link to this heading">#</a></h2>
<p>Module composition enables:</p>
<ul class="simple">
<li><p><strong>Complex workflows</strong> from simple modules</p></li>
<li><p><strong>Flexible architectures</strong> that adapt to needs</p></li>
<li><p><strong>Optimized execution</strong> through parallel and lazy evaluation</p></li>
<li><p><strong>Error resilience</strong> with fallbacks and retries</p></li>
<li><p><strong>Testable and maintainable</strong> code structures</p></li>
</ul>
</section>
<section id="advanced-composition-patterns">
<h2>Advanced Composition Patterns<a class="headerlink" href="#advanced-composition-patterns" title="Link to this heading">#</a></h2>
<section id="section-by-section-writing-pattern">
<h3>Section-by-Section Writing Pattern<a class="headerlink" href="#section-by-section-writing-pattern" title="Link to this heading">#</a></h3>
<p>The section-by-section writing pattern is essential for generating long-form content like articles, reports, or documentation. This pattern maintains context and coherence while generating content piece by piece.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SectionBySectionWriter</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Writes long-form content section by section with context management.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section_generator</span><span class="p">:</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">max_context_sections</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize section-by-section writer.</span>

<span class="sd">        Args:</span>
<span class="sd">            section_generator: Module that generates individual sections</span>
<span class="sd">            max_context_sections: Number of previous sections to keep in context</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">section_generator</span> <span class="o">=</span> <span class="n">section_generator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_context_sections</span> <span class="o">=</span> <span class="n">max_context_sections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generated_sections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">section_context</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outline</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate content section by section following an outline.</span>

<span class="sd">        Args:</span>
<span class="sd">            outline: Structured outline with section information</span>
<span class="sd">            topic: Overall topic for context</span>
<span class="sd">            **kwargs: Additional parameters for content generation</span>

<span class="sd">        Returns:</span>
<span class="sd">            Complete generated content with metadata</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generated_sections</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Generate each section in order</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">section_info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">outline</span><span class="p">):</span>
            <span class="c1"># Get context from previous sections</span>
            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_section_context</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="c1"># Generate current section</span>
            <span class="n">section_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_section</span><span class="p">(</span>
                <span class="n">section_info</span><span class="o">=</span><span class="n">section_info</span><span class="p">,</span>
                <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
                <span class="n">topic</span><span class="o">=</span><span class="n">topic</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>

            <span class="c1"># Store generated section</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generated_sections</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">section_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Section </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">),</span>
                <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">section_content</span><span class="p">,</span>
                <span class="s1">&#39;word_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">section_content</span><span class="o">.</span><span class="n">split</span><span class="p">()),</span>
                <span class="s1">&#39;section_number&#39;</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="p">})</span>

        <span class="c1"># Combine all sections</span>
        <span class="n">full_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_sections</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Prediction</span><span class="p">(</span>
            <span class="n">content</span><span class="o">=</span><span class="n">full_content</span><span class="p">,</span>
            <span class="n">sections</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">generated_sections</span><span class="p">,</span>
            <span class="n">total_word_count</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;word_count&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">generated_sections</span><span class="p">),</span>
            <span class="n">total_sections</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generated_sections</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_section_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_section_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get context from recent sections.&quot;&quot;&quot;</span>
        <span class="n">context_sections</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Include previous sections within context window</span>
        <span class="n">start_index</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">current_section_index</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_context_sections</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_index</span><span class="p">,</span> <span class="n">current_section_index</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generated_sections</span><span class="p">):</span>
                <span class="n">section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generated_sections</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">context_sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Section </span><span class="si">{</span><span class="n">section</span><span class="p">[</span><span class="s1">&#39;section_number&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">section</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Content: </span><span class="si">{</span><span class="n">section</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">][:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span>  <span class="c1"># First 200 chars</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context_sections</span><span class="p">)</span> <span class="k">if</span> <span class="n">context_sections</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                         <span class="n">section_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
                         <span class="n">context</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a single section with appropriate context.&quot;&quot;&quot;</span>
        <span class="c1"># Prepare section-specific prompt</span>
        <span class="n">section_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_section_prompt</span><span class="p">(</span>
            <span class="n">section_info</span><span class="o">=</span><span class="n">section_info</span><span class="p">,</span>
            <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
            <span class="n">topic</span><span class="o">=</span><span class="n">topic</span>
        <span class="p">)</span>

        <span class="c1"># Generate section content</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">section_generator</span><span class="p">(</span>
            <span class="n">section_prompt</span><span class="o">=</span><span class="n">section_prompt</span><span class="p">,</span>
            <span class="n">word_limit</span><span class="o">=</span><span class="n">section_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;word_count&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">content</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_section_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                              <span class="n">section_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
                              <span class="n">context</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                              <span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a comprehensive prompt for section generation.&quot;&quot;&quot;</span>
        <span class="n">prompt_parts</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;Topic: </span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Section Title: </span><span class="si">{</span><span class="n">section_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Untitled Section&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Section Purpose: </span><span class="si">{</span><span class="n">section_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;purpose&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Explain this aspect of the topic&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="n">context</span><span class="p">:</span>
            <span class="n">prompt_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Previous Sections Context:</span><span class="se">\n</span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Ensure your section flows naturally from the previous content.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">section_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;keywords&#39;</span><span class="p">):</span>
            <span class="n">prompt_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Keywords to include: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">section_info</span><span class="p">[</span><span class="s1">&#39;keywords&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">section_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;perspective&#39;</span><span class="p">):</span>
            <span class="n">prompt_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Write from this perspective: </span><span class="si">{</span><span class="n">section_info</span><span class="p">[</span><span class="s1">&#39;perspective&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prompt_parts</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_combine_sections</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Combine all sections into a coherent document.&quot;&quot;&quot;</span>
        <span class="n">document_parts</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">generated_sections</span><span class="p">:</span>
            <span class="c1"># Add section title</span>
            <span class="n">document_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## </span><span class="si">{</span><span class="n">section</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Add section content</span>
            <span class="n">document_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">section</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">])</span>

            <span class="c1"># Add transition</span>
            <span class="k">if</span> <span class="n">section</span><span class="p">[</span><span class="s1">&#39;section_number&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generated_sections</span><span class="p">):</span>
                <span class="n">next_section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generated_sections</span><span class="p">[</span><span class="n">section</span><span class="p">[</span><span class="s1">&#39;section_number&#39;</span><span class="p">]]</span>
                <span class="n">transition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_transition</span><span class="p">(</span>
                    <span class="n">current_section</span><span class="o">=</span><span class="n">section</span><span class="p">,</span>
                    <span class="n">next_section</span><span class="o">=</span><span class="n">next_section</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">transition</span><span class="p">:</span>
                    <span class="n">document_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">transition</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">document_parts</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_transition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_section</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">next_section</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a smooth transition between sections.&quot;&quot;&quot;</span>
        <span class="n">transition_generator</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span>
            <span class="s2">&quot;current_section, next_section -&gt; transition_text&quot;</span>
        <span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">transition_generator</span><span class="p">(</span>
            <span class="n">current_section</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">current_section</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">current_section</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">100</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">next_section</span><span class="o">=</span><span class="n">next_section</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">transition_text</span>


<span class="c1"># Example: Using the Section-by-Section Writer</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ArticleSectionGenerator</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Specialized module for generating article sections.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_section</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">ChainOfThought</span><span class="p">(</span>
            <span class="s2">&quot;section_prompt, word_limit -&gt; content&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">word_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Prediction</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate content for a single section.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_section</span><span class="p">(</span>
            <span class="n">section_prompt</span><span class="o">=</span><span class="n">section_prompt</span><span class="p">,</span>
            <span class="n">word_limit</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">word_limit</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Ensure content meets word limit</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">content</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">word_limit</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">:</span>  <span class="c1"># Allow 20% overflow</span>
            <span class="n">content</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">words</span><span class="p">[:</span><span class="n">word_limit</span><span class="p">])</span>
            <span class="n">content</span> <span class="o">+=</span> <span class="s2">&quot;...&quot;</span>  <span class="c1"># Indicate truncation</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">word_limit</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">:</span>  <span class="c1"># Require at least 80%</span>
            <span class="c1"># Expand content if too short</span>
            <span class="n">expander</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Predict</span><span class="p">(</span>
                <span class="s2">&quot;content, target_length -&gt; expanded_content&quot;</span>
            <span class="p">)</span>
            <span class="n">expanded</span> <span class="o">=</span> <span class="n">expander</span><span class="p">(</span>
                <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
                <span class="n">target_length</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">word_limit</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">expanded</span><span class="o">.</span><span class="n">expanded_content</span>

        <span class="k">return</span> <span class="n">dspy</span><span class="o">.</span><span class="n">Prediction</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">)</span>


<span class="c1"># Example usage</span>
<span class="n">outline</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Introduction&#39;</span><span class="p">,</span>
        <span class="s1">&#39;purpose&#39;</span><span class="p">:</span> <span class="s1">&#39;Introduce the topic and outline the article&#39;</span><span class="p">,</span>
        <span class="s1">&#39;word_count&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
        <span class="s1">&#39;keywords&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;overview&#39;</span><span class="p">,</span> <span class="s1">&#39;introduction&#39;</span><span class="p">,</span> <span class="s1">&#39;scope&#39;</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Background&#39;</span><span class="p">,</span>
        <span class="s1">&#39;purpose&#39;</span><span class="p">:</span> <span class="s1">&#39;Provide necessary background information&#39;</span><span class="p">,</span>
        <span class="s1">&#39;word_count&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
        <span class="s1">&#39;keywords&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;history&#39;</span><span class="p">,</span> <span class="s1">&#39;context&#39;</span><span class="p">,</span> <span class="s1">&#39;foundation&#39;</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Main Analysis&#39;</span><span class="p">,</span>
        <span class="s1">&#39;purpose&#39;</span><span class="p">:</span> <span class="s1">&#39;Present detailed analysis and findings&#39;</span><span class="p">,</span>
        <span class="s1">&#39;word_count&#39;</span><span class="p">:</span> <span class="mi">800</span><span class="p">,</span>
        <span class="s1">&#39;perspective&#39;</span><span class="p">:</span> <span class="s1">&#39;analytical&#39;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Conclusion&#39;</span><span class="p">,</span>
        <span class="s1">&#39;purpose&#39;</span><span class="p">:</span> <span class="s1">&#39;Summarize key points and provide future outlook&#39;</span><span class="p">,</span>
        <span class="s1">&#39;word_count&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
        <span class="s1">&#39;keywords&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">,</span> <span class="s1">&#39;conclusion&#39;</span><span class="p">,</span> <span class="s1">&#39;future&#39;</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">]</span>

<span class="c1"># Create and use the writer</span>
<span class="n">section_gen</span> <span class="o">=</span> <span class="n">ArticleSectionGenerator</span><span class="p">()</span>
<span class="n">writer</span> <span class="o">=</span> <span class="n">SectionBySectionWriter</span><span class="p">(</span><span class="n">section_gen</span><span class="p">,</span> <span class="n">max_context_sections</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">writer</span><span class="p">(</span>
    <span class="n">outline</span><span class="o">=</span><span class="n">outline</span><span class="p">,</span>
    <span class="n">topic</span><span class="o">=</span><span class="s2">&quot;The Impact of AI on Education&quot;</span><span class="p">,</span>
    <span class="n">writing_style</span><span class="o">=</span><span class="s2">&quot;academic&quot;</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">total_sections</span><span class="si">}</span><span class="s2"> sections&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total word count: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">total_word_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">First section preview:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">sections</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;content&#39;</span><span class="p">][:</span><span class="mi">200</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This pattern is particularly useful for:</p>
<ul class="simple">
<li><p><strong>Long-form article generation</strong> where maintaining coherence is crucial</p></li>
<li><p><strong>Documentation writing</strong> with structured sections</p></li>
<li><p><strong>Report generation</strong> following specific formats</p></li>
<li><p><strong>Educational content</strong> with progressive concept building</p></li>
<li><p><strong>Research synthesis</strong> combining findings from multiple sources</p></li>
</ul>
</section>
<section id="key-takeaways">
<h3>Key Takeaways<a class="headerlink" href="#key-takeaways" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p><strong>Start simple</strong> - Compose basic modules first</p></li>
<li><p><strong>Use patterns</strong> - Follow established composition patterns</p></li>
<li><p><strong>Handle failures</strong> - Build resilient systems</p></li>
<li><p><strong>Optimize wisely</strong> - Use parallel and batch processing</p></li>
<li><p><strong>Document composition</strong> - Make architectural decisions clear</p></li>
</ol>
</section>
</section>
<section id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="#./07-exercises.md"><span class="xref myst">Module Exercises</span></a> - Practice composition techniques</p></li>
<li><p><a class="reference internal" href="#../examples/chapter03/"><span class="xref myst">Practical Examples</span></a> - See composition in action</p></li>
<li><p><a class="reference internal" href="#../07-advanced-topics.md"><span class="xref myst">Advanced Topics</span></a> - Explore advanced patterns</p></li>
<li><p><a class="reference internal" href="#../06-real-world-applications/"><span class="xref myst">Real-World Applications</span></a> - Apply to real problems</p></li>
</ul>
</section>
<section id="further-reading">
<h2>Further Reading<a class="headerlink" href="#further-reading" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://refactoring.guru/">Design Patterns</a> - General design patterns</p></li>
<li><p><a class="reference external" href="https://github.com/stanfordnlp/dspy">DSPy GitHub</a> - Module implementation details</p></li>
<li><p><a class="reference internal" href="#../09-appendices/performance.md"><span class="xref myst">Performance Guide</span></a> - Optimization techniques</p></li>
</ul>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./content/03_modules"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="05_custom_modules.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Custom Modules</p>
      </div>
    </a>
    <a class="right-next"
       href="07_exercises.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Chapter 3 Exercises</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prerequisites">Prerequisites</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-objectives">Learning Objectives</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction-to-module-composition">Introduction to Module Composition</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#composition-patterns">Composition Patterns</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sequential-composition">Sequential Composition</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#basic-pipeline-pattern">Basic Pipeline Pattern</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-pipeline-with-error-handling">Advanced Pipeline with Error Handling</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#parallel-composition">Parallel Composition</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parallel-module-execution">Parallel Module Execution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#specialized-parallel-patterns">Specialized Parallel Patterns</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#ensemble-classifier">Ensemble Classifier</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conditional-composition">Conditional Composition</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#router-module">Router Module</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#adaptive-module">Adaptive Module</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#hierarchical-composition">Hierarchical Composition</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multi-level-analysis-system">Multi-Level Analysis System</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#feedback-loop-composition">Feedback Loop Composition</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#iterative-refinement-module">Iterative Refinement Module</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#performance-optimization">Performance Optimization</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lazy-evaluation">Lazy Evaluation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#batch-processing">Batch Processing</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#best-practices">Best Practices</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#design-for-testability">1. Design for Testability</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#handle-failure-gracefully">2. Handle Failure Gracefully</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#use-type-hints">3. Use Type Hints</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-composition-patterns">Advanced Composition Patterns</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#section-by-section-writing-pattern">Section-by-Section Writing Pattern</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#key-takeaways">Key Takeaways</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#further-reading">Further Reading</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Dustin Ober
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
       Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>