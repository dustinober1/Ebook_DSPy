<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solutions | Chapter 5 | DSPy: The Comprehensive Guide</title>
    <meta name="description"
        content="Complete solutions for Chapter 5 DSPy optimizer exercises with detailed explanations.">
    <link rel="stylesheet" href="../../assets/css/style.css?v=2">
    <link rel="stylesheet" href="../../assets/css/chapter.css?v=8">
    <link rel="stylesheet" href="../../assets/css/content.css?v=2">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
</head>

<body class="chapter-page">
    <header>
        <div class="logo">
            <a href="../../index.html">
                <img src="../../src/assets/logos/logo.png" alt="DSPy Ebook Logo">
                <span>DSPy Ebook</span>
            </a>
        </div>
        <nav>
            <ul>
                <li><a href="../../index.html">Home</a></li>
                <li><a href="../../index.html#chapters">Chapters</a></li>
                <li><a href="https://github.com/dustinober1/Ebook_DSPy" target="_blank">GitHub</a></li>
            </ul>
        </nav>
    </header>

    <div class="chapter-layout">
                <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Chapter 5</h2>
                <span class="sidebar-subtitle">Optimizers</span>
            </div>
            <nav class="sidebar-nav">
                <ul class="section-list" id="section-list">
                    <li class="section-item" data-section="intro">
                        <a href="index.html">
                            <span class="section-number">1</span>
                            <span class="section-title">Chapter Overview</span>
                        </a>
                    </li>
                    <li class="section-item" data-section="compilation-concept">
                        <a href="compilation-concept.html">
                            <span class="section-number">2</span>
                            <span class="section-title">Compilation Concept</span>
                        </a>
                    </li>
                    <li class="section-item" data-section="bootstrap-fewshot">
                        <a href="bootstrap-fewshot.html">
                            <span class="section-number">3</span>
                            <span class="section-title">BootstrapFewShot</span>
                        </a>
                    </li>
                    <li class="section-item" data-section="copro">
                        <a href="copro.html">
                            <span class="section-number">4</span>
                            <span class="section-title">COPRO</span>
                        </a>
                    </li>
                    <li class="section-item" data-section="mipro">
                        <a href="mipro.html">
                            <span class="section-number">5</span>
                            <span class="section-title">MiPRO</span>
                        </a>
                    </li>
                    <li class="section-item" data-section="knn-fewshot">
                        <a href="knn-fewshot.html">
                            <span class="section-number">6</span>
                            <span class="section-title">KnnFewShot</span>
                        </a>
                    </li>
                    <li class="section-item" data-section="finetuning">
                        <a href="finetuning.html">
                            <span class="section-number">7</span>
                            <span class="section-title">Fine-tuning</span>
                        </a>
                    </li>
                    <li class="section-item" data-section="choosing-optimizers">
                        <a href="choosing-optimizers.html">
                            <span class="section-number">8</span>
                            <span class="section-title">Choosing Optimizers</span>
                        </a>
                    </li>
                    <li class="section-item" data-section="constraint-driven-optimization">
                        <a href="constraint-driven-optimization.html">
                            <span class="section-number">9</span>
                            <span class="section-title">Constraint-Driven Optimization</span>
                        </a>
                    </li>
                    <li class="section-item" data-section="reflective-prompt-evolution">
                        <a href="reflective-prompt-evolution.html">
                            <span class="section-number">10</span>
                            <span class="section-title">Reflective Prompt Evolution</span>
                        </a>
                    </li>
                    <li class="section-item" data-section="copa-compiler-method">
                        <a href="copa-compiler-method.html">
                            <span class="section-number">11</span>
                            <span class="section-title">CoPA Compiler Method</span>
                        </a>
                    </li>
                    <li class="section-item" data-section="copa-method">
                        <a href="copa-method.html">
                            <span class="section-number">12</span>
                            <span class="section-title">CoPA Method</span>
                        </a>
                    </li>
                    <li class="section-item" data-section="joint-optimization">
                        <a href="joint-optimization.html">
                            <span class="section-number">13</span>
                            <span class="section-title">Joint Optimization</span>
                        </a>
                    </li>
                    <li class="section-item" data-section="monte-carlo-optimization">
                        <a href="monte-carlo-optimization.html">
                            <span class="section-number">14</span>
                            <span class="section-title">Monte Carlo Optimization</span>
                        </a>
                    </li>
                    <li class="section-item" data-section="bayesian-optimization">
                        <a href="bayesian-optimization.html">
                            <span class="section-number">15</span>
                            <span class="section-title">Bayesian Optimization</span>
                        </a>
                    </li>
                    <li class="section-item" data-section="comprehensive-examples">
                        <a href="comprehensive-examples.html">
                            <span class="section-number">16</span>
                            <span class="section-title">Comprehensive Examples</span>
                        </a>
                    </li>
                    <li class="section-item" data-section="multistage-optimization-theory">
                        <a href="multistage-optimization-theory.html">
                            <span class="section-number">17</span>
                            <span class="section-title">Multistage Optimization Theory</span>
                        </a>
                    </li>
                    <li class="section-item" data-section="instruction-tuning-frameworks">
                        <a href="instruction-tuning-frameworks.html">
                            <span class="section-number">18</span>
                            <span class="section-title">Instruction Tuning Frameworks</span>
                        </a>
                    </li>
                    <li class="section-item" data-section="demonstration-optimization">
                        <a href="demonstration-optimization.html">
                            <span class="section-number">19</span>
                            <span class="section-title">Demonstration Optimization</span>
                        </a>
                    </li>
                    <li class="section-item" data-section="multistage-architectures">
                        <a href="multistage-architectures.html">
                            <span class="section-number">20</span>
                            <span class="section-title">Multistage Architectures</span>
                        </a>
                    </li>
                    <li class="section-item" data-section="complex-pipeline-optimization">
                        <a href="complex-pipeline-optimization.html">
                            <span class="section-number">21</span>
                            <span class="section-title">Complex Pipeline Optimization</span>
                        </a>
                    </li>
                    <li class="section-item" data-section="instruction-demonstration-interactions">
                        <a href="instruction-demonstration-interactions.html">
                            <span class="section-number">22</span>
                            <span class="section-title">Instruction-Demonstration Interactions</span>
                        </a>
                    </li>
                    <li class="section-item" data-section="exercises">
                        <a href="exercises.html">
                            <span class="section-number">23</span>
                            <span class="section-title">Exercises</span>
                        </a>
                    </li>
                    <li class="section-item active" data-section="solutions">
                        <a href="solutions.html">
                            <span class="section-number">24</span>
                            <span class="section-title">Solutions</span>
                        </a>
                    </li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <a href="../chapter-06/index.html" class="next-chapter-btn">
                    Next: Chapter 06 ‚Üí
                </a>
            </div>
        </aside>

        <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle Sidebar">
            <span></span>
            <span></span>
            <span></span>
        </button>

        <main class="chapter-content">
            <div class="reading-progress" id="reading-progress">
                <div class="progress-bar"></div>
            </div>

            <section class="chapter-hero">
                <div class="chapter-hero-content is-visible fade-in-up">
                    <span class="chapter-label">Chapter 5 ¬∑ Section 8</span>
                    <h1 class="chapter-title">Solutions</h1>
                    <p class="chapter-description">Complete solutions with detailed explanations.</p>
                    <div class="chapter-meta">
                        <span class="meta-item">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            5 Solutions
                        </span>
                    </div>
                </div>
            </section>

            <div class="content-wrapper">
                <article class="content-article" id="content-article">
                    <section class="content-section is-visible" id="solutions" data-section="solutions">
                        <div class="markdown-content" id="solutions-content">

                            <!-- Solution 1 -->
                            <div class="content-block solution-block">
                                <div class="exercise-header">
                                    <span class="exercise-number">Solution 1</span>
                                    <span class="difficulty beginner">‚≠ê Beginner</span>
                                </div>
                                <h3>Basic BootstrapFewShot Optimization</h3>

                                <div class="command-box">
                                    <pre><code class="language-python">import dspy
from dspy.teleprompt import BootstrapFewShot
import os
from dotenv import load_dotenv

# Load environment variables
load_dotenv()

# Configure DSPy
lm = dspy.LM("openai/gpt-4o-mini", api_key=os.getenv("OPENAI_API_KEY"))
dspy.configure(lm=lm)

class BasicQA(dspy.Module):
    def __init__(self):
        super().__init__()
        self.generate_answer = dspy.Predict("question -> answer")
    
    def forward(self, question):
        return self.generate_answer(question=question)

# Define exact match metric
def exact_match(example, pred, trace=None):
    """Check if prediction matches expected answer."""
    return example.answer.lower().strip() == pred.answer.lower().strip()

# Training data
trainset = [
    dspy.Example(question="What is 2+2?", answer="4").with_inputs("question"),
    dspy.Example(question="Capital of France?", answer="Paris").with_inputs("question"),
    dspy.Example(question="Who wrote Romeo and Juliet?", answer="Shakespeare").with_inputs("question"),
    dspy.Example(question="What is H2O?", answer="Water").with_inputs("question"),
    dspy.Example(question="How many continents?", answer="7").with_inputs("question"),
]

# Test data
testset = [
    dspy.Example(question="What is 3+3?", answer="6").with_inputs("question"),
    dspy.Example(question="Capital of Spain?", answer="Madrid").with_inputs("question"),
]

def bootstrap_optimize(program, trainset, max_demos=4):
    """Optimize the program using BootstrapFewShot."""
    optimizer = BootstrapFewShot(
        metric=exact_match,
        max_bootstrapped_demos=max_demos,
        max_labeled_demos=2
    )
    return optimizer.compile(program, trainset=trainset)

def evaluate(program, testset):
    """Evaluate program on test set."""
    correct = 0
    for example in testset:
        try:
            pred = program(question=example.question)
            if exact_match(example, pred):
                correct += 1
        except Exception as e:
            print(f"Error: {e}")
    return correct / len(testset) if testset else 0

# Run optimization
baseline = BasicQA()
optimized = bootstrap_optimize(BasicQA(), trainset, max_demos=4)

# Evaluate
baseline_score = evaluate(baseline, testset)
optimized_score = evaluate(optimized, testset)

print(f"Baseline accuracy: {baseline_score:.2%}")
print(f"Optimized accuracy: {optimized_score:.2%}")
print(f"Improvement: {optimized_score - baseline_score:+.2%}")</code></pre>
                                </div>

                                <div class="chapter-sections-list">
                                    <div class="chapter-section-item">
                                        <span class="section-icon">üí°</span>
                                        <div class="section-content">
                                            <h4>Key Concepts</h4>
                                            <p>The metric function receives <code>example</code> (ground truth) and
                                                <code>pred</code> (prediction). Normalize strings with
                                                <code>.lower().strip()</code> for robust matching.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Solution 2 -->
                            <div class="content-block solution-block">
                                <div class="exercise-header">
                                    <span class="exercise-number">Solution 2</span>
                                    <span class="difficulty intermediate">‚≠ê‚≠ê Intermediate</span>
                                </div>
                                <h3>KNNFewShot for Context-Aware Selection</h3>

                                <div class="command-box">
                                    <pre><code class="language-python">import dspy
from dspy.teleprompt import KNNFewShot
import os
from dotenv import load_dotenv

load_dotenv()
lm = dspy.LM("openai/gpt-4o-mini", api_key=os.getenv("OPENAI_API_KEY"))
dspy.configure(lm=lm)

class TopicClassifier(dspy.Module):
    def __init__(self):
        super().__init__()
        self.classify = dspy.Predict("text -> topic")
    
    def forward(self, text):
        return self.classify(text=text)

# Training data with diverse topics
trainset = [
    dspy.Example(text="Stock price increased after earnings", topic="finance").with_inputs("text"),
    dspy.Example(text="New study reveals vaccine effectiveness", topic="healthcare").with_inputs("text"),
    dspy.Example(text="Court ruled in favor of plaintiff", topic="legal").with_inputs("text"),
    dspy.Example(text="Quarterback threw touchdown pass", topic="sports").with_inputs("text"),
    dspy.Example(text="New iPhone features improved camera", topic="technology").with_inputs("text"),
    dspy.Example(text="Merger approved by shareholders", topic="finance").with_inputs("text"),
    dspy.Example(text="Patient recovered after surgery", topic="healthcare").with_inputs("text"),
    dspy.Example(text="Jury reached guilty verdict", topic="legal").with_inputs("text"),
]

# Test data
testset = [
    dspy.Example(text="Bitcoin price surged today", topic="finance").with_inputs("text"),
    dspy.Example(text="The team won the championship", topic="sports").with_inputs("text"),
]

def topic_match(example, pred, trace=None):
    """Check if predicted topic matches expected."""
    return example.topic.lower().strip() == pred.topic.lower().strip()

def create_knn_optimizer(k=3):
    """Create KNNFewShot optimizer."""
    return KNNFewShot(
        k=k,
        trainset=trainset
    )

def evaluate_classifier(classifier, testset):
    """Evaluate classifier accuracy."""
    correct = 0
    for example in testset:
        try:
            pred = classifier(text=example.text)
            if topic_match(example, pred):
                correct += 1
                print(f"‚úì '{example.text[:40]}...' -> {pred.topic}")
            else:
                print(f"‚úó '{example.text[:40]}...' -> {pred.topic} (expected: {example.topic})")
        except Exception as e:
            print(f"Error: {e}")
    return correct / len(testset) if testset else 0

# Create and compile
optimizer = create_knn_optimizer(k=3)
compiled = optimizer.compile(TopicClassifier(), trainset=trainset)

# Evaluate
print("=== KNNFewShot Results ===")
accuracy = evaluate_classifier(compiled, testset)
print(f"\nAccuracy: {accuracy:.2%}")</code></pre>
                                </div>

                                <div class="chapter-sections-list">
                                    <div class="chapter-section-item">
                                        <span class="section-icon">üí°</span>
                                        <div class="section-content">
                                            <h4>Key Concepts</h4>
                                            <p>KNNFewShot selects the k most similar examples for each query. For
                                                finance questions, it selects finance examples‚Äîmaking the prompts more
                                                relevant!</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Solution 3 -->
                            <div class="content-block solution-block">
                                <div class="exercise-header">
                                    <span class="exercise-number">Solution 3</span>
                                    <span class="difficulty intermediate">‚≠ê‚≠ê Intermediate</span>
                                </div>
                                <h3>MIPRO for Complex Reasoning</h3>

                                <div class="command-box">
                                    <pre><code class="language-python">import dspy
from dspy.teleprompt import MIPRO
import re
import os
from dotenv import load_dotenv

load_dotenv()
lm = dspy.LM("openai/gpt-4o-mini", api_key=os.getenv("OPENAI_API_KEY"))
dspy.configure(lm=lm)

class MathSolver(dspy.Module):
    def __init__(self):
        super().__init__()
        self.solve = dspy.ChainOfThought("problem -> answer")
    
    def forward(self, problem):
        result = self.solve(problem=problem)
        return dspy.Prediction(
            steps=result.rationale,
            answer=result.answer
        )

# Training data
trainset = [
    dspy.Example(
        problem="A rope is 12m long. Cut into 3 equal pieces. Length of each?",
        answer="4 meters"
    ).with_inputs("problem"),
    dspy.Example(
        problem="Train travels 60km in 1 hour. How far in 3 hours?",
        answer="180 km"
    ).with_inputs("problem"),
    dspy.Example(
        problem="Box has 8 rows of 5 apples each. Total apples?",
        answer="40 apples"
    ).with_inputs("problem"),
]

# Test data
testset = [
    dspy.Example(
        problem="John saves $200 per month. How much in 6 months?",
        answer="$1,200"
    ).with_inputs("problem"),
]

def extract_number(text):
    """Extract numerical value from text."""
    numbers = re.findall(r'[\d,]+(?:\.\d+)?', str(text))
    if numbers:
        return float(numbers[-1].replace(',', ''))
    return None

def math_metric(example, pred, trace=None):
    """Metric that compares numerical answers."""
    pred_num = extract_number(pred.answer)
    true_num = extract_number(example.answer)
    
    if pred_num is None or true_num is None:
        # Fall back to string comparison
        return example.answer.lower() in pred.answer.lower()
    
    # Allow small numerical tolerance
    return abs(pred_num - true_num) < 0.01

def mipro_optimize(program, trainset, num_candidates=10):
    """Optimize using MIPRO."""
    optimizer = MIPRO(
        metric=math_metric,
        num_candidates=num_candidates,
        init_temperature=0.7,
        verbose=True
    )
    return optimizer.compile(
        program,
        trainset=trainset,
        num_trials=3,
        max_bootstrapped_demos=4
    )

# Optimize
print("=== MIPRO Optimization ===")
optimized = mipro_optimize(MathSolver(), trainset)

# Test
print("\n=== Testing ===")
for example in testset:
    result = optimized(problem=example.problem)
    print(f"Problem: {example.problem}")
    print(f"Reasoning: {result.steps}")
    print(f"Answer: {result.answer}")
    print(f"Expected: {example.answer}")
    print(f"Correct: {math_metric(example, result)}")</code></pre>
                                </div>

                                <div class="chapter-sections-list">
                                    <div class="chapter-section-item">
                                        <span class="section-icon">üí°</span>
                                        <div class="section-content">
                                            <h4>Key Concepts</h4>
                                            <p>MIPRO optimizes both instructions and demonstrations. The
                                                <code>extract_number</code> helper enables robust numerical comparison
                                                even when formats differ.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Solution 4 -->
                            <div class="content-block solution-block">
                                <div class="exercise-header">
                                    <span class="exercise-number">Solution 4</span>
                                    <span class="difficulty advanced">‚≠ê‚≠ê‚≠ê Advanced</span>
                                </div>
                                <h3>Optimizer Comparison Benchmark</h3>

                                <div class="command-box">
                                    <pre><code class="language-python">import dspy
from dspy.teleprompt import BootstrapFewShot, KNNFewShot, MIPRO
import time
import os
from dotenv import load_dotenv

load_dotenv()
lm = dspy.LM("openai/gpt-4o-mini", api_key=os.getenv("OPENAI_API_KEY"))
dspy.configure(lm=lm)

class SentimentAnalyzer(dspy.Module):
    def __init__(self):
        super().__init__()
        self.analyze = dspy.Predict("text -> sentiment")
    
    def forward(self, text):
        return self.analyze(text=text)

trainset = [
    dspy.Example(text="I love this product!", sentiment="positive").with_inputs("text"),
    dspy.Example(text="Terrible quality.", sentiment="negative").with_inputs("text"),
    dspy.Example(text="Works as expected.", sentiment="neutral").with_inputs("text"),
    dspy.Example(text="Outstanding service!", sentiment="positive").with_inputs("text"),
    dspy.Example(text="Would not recommend.", sentiment="negative").with_inputs("text"),
    dspy.Example(text="It's okay I guess.", sentiment="neutral").with_inputs("text"),
]

testset = [
    dspy.Example(text="Best purchase ever!", sentiment="positive").with_inputs("text"),
    dspy.Example(text="Complete waste of money.", sentiment="negative").with_inputs("text"),
    dspy.Example(text="Does the job.", sentiment="neutral").with_inputs("text"),
]

def sentiment_match(example, pred, trace=None):
    return example.sentiment.lower() == pred.sentiment.lower()

def evaluate(program, testset):
    correct = sum(1 for ex in testset 
                  if sentiment_match(ex, program(text=ex.text)))
    return correct / len(testset)

def benchmark_optimizers(program_class, trainset, testset):
    """Compare multiple optimizers."""
    results = {}
    
    # Baseline
    print("Testing Baseline...")
    baseline = program_class()
    results["Baseline"] = {
        "accuracy": evaluate(baseline, testset),
        "time": 0
    }
    
    # BootstrapFewShot
    print("Testing BootstrapFewShot...")
    start = time.time()
    optimizer = BootstrapFewShot(metric=sentiment_match, max_bootstrapped_demos=4)
    compiled = optimizer.compile(program_class(), trainset=trainset)
    results["BootstrapFewShot"] = {
        "accuracy": evaluate(compiled, testset),
        "time": time.time() - start
    }
    
    # KNNFewShot
    print("Testing KNNFewShot...")
    start = time.time()
    optimizer = KNNFewShot(k=3, trainset=trainset)
    compiled = optimizer.compile(program_class(), trainset=trainset)
    results["KNNFewShot"] = {
        "accuracy": evaluate(compiled, testset),
        "time": time.time() - start
    }
    
    # MIPRO
    print("Testing MIPRO...")
    start = time.time()
    optimizer = MIPRO(metric=sentiment_match, auto="light")
    compiled = optimizer.compile(program_class(), trainset=trainset, num_trials=2)
    results["MIPRO"] = {
        "accuracy": evaluate(compiled, testset),
        "time": time.time() - start
    }
    
    return results

def print_comparison(results):
    """Print comparison report."""
    print("\n" + "=" * 50)
    print("OPTIMIZER COMPARISON REPORT")
    print("=" * 50)
    
    baseline_acc = results["Baseline"]["accuracy"]
    
    for name, data in results.items():
        print(f"\n{name}:")
        print(f"  Accuracy: {data['accuracy']:.1%}")
        print(f"  Time: {data['time']:.1f}s")
        if name != "Baseline":
            improvement = data['accuracy'] - baseline_acc
            print(f"  Improvement: {improvement:+.1%}")
    
    # Best performance
    best = max(results.items(), key=lambda x: x[1]['accuracy'])
    print(f"\nüèÜ Best Performance: {best[0]}")

# Run benchmark
results = benchmark_optimizers(SentimentAnalyzer, trainset, testset)
print_comparison(results)</code></pre>
                                </div>

                                <div class="chapter-sections-list">
                                    <div class="chapter-section-item">
                                        <span class="section-icon">üí°</span>
                                        <div class="section-content">
                                            <h4>Key Concepts</h4>
                                            <p>This benchmark tracks both accuracy and compilation time. Note how MIPRO
                                                takes longer but often achieves the best results.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Solution 5 -->
                            <div class="content-block solution-block">
                                <div class="exercise-header">
                                    <span class="exercise-number">Solution 5</span>
                                    <span class="difficulty advanced">‚≠ê‚≠ê‚≠ê Advanced</span>
                                </div>
                                <h3>Progressive Optimization Pipeline</h3>

                                <div class="command-box">
                                    <pre><code class="language-python">import dspy
from dspy.teleprompt import BootstrapFewShot, KNNFewShot, MIPRO
import time
import os
from dotenv import load_dotenv

load_dotenv()
lm = dspy.LM("openai/gpt-4o-mini", api_key=os.getenv("OPENAI_API_KEY"))
dspy.configure(lm=lm)

def evaluate(program, valset, metric):
    """Evaluate program on validation set."""
    correct = sum(1 for ex in valset if metric(ex, program(**ex.inputs())))
    return correct / len(valset)

def progressive_optimize(program_class, trainset, valset, metric, target_accuracy=0.85):
    """
    Progressively optimize until target accuracy is reached.
    """
    stages = [
        {
            "name": "BootstrapFewShot",
            "optimizer": BootstrapFewShot(metric=metric, max_bootstrapped_demos=4),
            "config": {}
        },
        {
            "name": "KNNFewShot",
            "optimizer": KNNFewShot(k=3, trainset=trainset),
            "config": {}
        },
        {
            "name": "MIPRO",
            "optimizer": MIPRO(metric=metric, auto="medium"),
            "config": {"num_trials": 3}
        }
    ]
    
    results = []
    best_program = None
    best_accuracy = 0
    
    # Baseline
    baseline = program_class()
    baseline_acc = evaluate(baseline, valset, metric)
    results.append({
        "stage": "Baseline",
        "accuracy": baseline_acc,
        "time": 0
    })
    print(f"Baseline: {baseline_acc:.1%}")
    
    for stage in stages:
        print(f"\nTrying {stage['name']}...")
        start = time.time()
        
        try:
            compiled = stage['optimizer'].compile(
                program_class(),
                trainset=trainset,
                **stage['config']
            )
            
            accuracy = evaluate(compiled, valset, metric)
            elapsed = time.time() - start
            
            results.append({
                "stage": stage['name'],
                "accuracy": accuracy,
                "time": elapsed
            })
            
            print(f"  Accuracy: {accuracy:.1%} (took {elapsed:.1f}s)")
            
            if accuracy > best_accuracy:
                best_accuracy = accuracy
                best_program = compiled
                print(f"  ‚úì New best!")
            
            # Early stopping if target reached
            if accuracy >= target_accuracy:
                print(f"\nüéØ Target accuracy {target_accuracy:.1%} reached!")
                break
                
        except Exception as e:
            print(f"  Error: {e}")
    
    return best_program, results

def analyze_optimization_roi(results):
    """Analyze return on investment."""
    print("\n" + "=" * 50)
    print("ROI ANALYSIS")
    print("=" * 50)
    
    baseline_acc = results[0]['accuracy']
    
    for i, result in enumerate(results[1:], 1):
        gain = result['accuracy'] - baseline_acc
        time_spent = result['time']
        
        if time_spent > 0:
            roi = gain / (time_spent / 60)  # Gain per minute
            print(f"\n{result['stage']}:")
            print(f"  Accuracy gain: {gain:+.1%}")
            print(f"  Time spent: {time_spent:.1f}s")
            print(f"  ROI: {roi:.2%} per minute")

# Example usage
class SimpleQA(dspy.Module):
    def __init__(self):
        super().__init__()
        self.answer = dspy.Predict("question -> answer")
    
    def forward(self, question):
        return self.answer(question=question)

trainset = [
    dspy.Example(question="What is 2+2?", answer="4").with_inputs("question"),
    dspy.Example(question="Capital of France?", answer="Paris").with_inputs("question"),
    # ... more examples
]

valset = [
    dspy.Example(question="What is 5+5?", answer="10").with_inputs("question"),
]

def metric(ex, pred, trace=None):
    return ex.answer.lower() in pred.answer.lower()

# Run progressive optimization
best, results = progressive_optimize(
    SimpleQA, trainset, valset, metric, target_accuracy=0.80
)

# Analyze ROI
analyze_optimization_roi(results)

print("\n‚úÖ Optimization complete!")</code></pre>
                                </div>

                                <div class="chapter-sections-list">
                                    <div class="chapter-section-item">
                                        <span class="section-icon">üí°</span>
                                        <div class="section-content">
                                            <h4>Key Concepts</h4>
                                            <p>Progressive optimization stops early when target is reached‚Äîsaving time.
                                                ROI analysis helps identify which optimizer gives best "bang for buck."
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Continue to Next Chapter -->
                            <div class="content-block">
                                <div class="tip-box">
                                    <span class="tip-icon">üéâ</span>
                                    <p><strong>Congratulations!</strong> You've completed Chapter 5: Optimizers &
                                        Compilation. You now understand how to automatically optimize DSPy programs for
                                        maximum performance!</p>
                                </div>

                                <div class="continue-btn-container">
                                    <a href="../chapter-06/index.html" class="continue-btn next-chapter-main-btn">
                                        <span>Start Chapter 6: Real-World Applications</span>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M5 12h14M12 5l7 7-7 7" />
                                        </svg>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </section>
                </article>
            </div>
        </main>
    </div>

    <footer>
        <p>&copy; 2025 DSPy Ebook. All rights reserved.</p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="../../assets/js/main.js?v=1"></script>
    <script src="../../assets/js/chapter_v2.js" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (window.initChapter) {
                window.initChapter({});
            }
            setTimeout(() => {
                if (window.Prism) window.Prism.highlightAll();
            }, 100);
        });
    </script>
</body>

</html>