<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Building RAG Pipelines | Chapter 5 | DSPy: The Comprehensive Guide</title>
    <meta name="description" content="Learn to build complete RAG pipelines in DSPy - from retrieval to generation.">
    <link rel="stylesheet" href="../../assets/css/style.css?v=2">
    <link rel="stylesheet" href="../../assets/css/chapter.css?v=8">
    <link rel="stylesheet" href="../../assets/css/content.css?v=2">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
</head>

<body class="chapter-page">
    <header>
        <div class="logo">
            <a href="../../index.html">
                <img src="../../src/assets/logos/logo.png" alt="DSPy Ebook Logo">
                <span>DSPy Ebook</span>
            </a>
        </div>
        <nav>
            <ul>
                <li><a href="../../index.html">Home</a></li>
                <li><a href="../../index.html#chapters">Chapters</a></li>
                <li><a href="https://github.com/dustinober1/Ebook_DSPy" target="_blank">GitHub</a></li>
            </ul>
        </nav>
    </header>

    <div class="chapter-layout">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Chapter 5</h2>
                <span class="sidebar-subtitle">Retrieval</span>
            </div>
            <nav class="sidebar-nav">
                <ul class="section-list" id="section-list">
                    <li class="section-item viewed" data-section="intro">
                        <a href="index.html">
                            <span class="section-number">1</span>
                            <span class="section-title">Chapter Overview</span>
                        </a>
                    </li>
                    <li class="section-item viewed" data-section="what-is-rag">
                        <a href="what-is-rag.html">
                            <span class="section-number">2</span>
                            <span class="section-title">What is RAG?</span>
                        </a>
                    </li>
                    <li class="section-item viewed" data-section="retrievers">
                        <a href="retrievers.html">
                            <span class="section-number">3</span>
                            <span class="section-title">Retriever Modules</span>
                        </a>
                    </li>
                    <li class="section-item active" data-section="rag-pipelines">
                        <a href="rag-pipelines.html">
                            <span class="section-number">4</span>
                            <span class="section-title">Building RAG Pipelines</span>
                        </a>
                    </li>
                    <li class="section-item" data-section="advanced-rag">
                        <a href="advanced-rag.html">
                            <span class="section-number">5</span>
                            <span class="section-title">Advanced RAG Patterns</span>
                        </a>
                    </li>
                    <li class="section-item" data-section="exercises">
                        <a href="exercises.html">
                            <span class="section-number">6</span>
                            <span class="section-title">Exercises</span>
                        </a>
                    </li>
                    <li class="section-item" data-section="solutions">
                        <a href="solutions.html">
                            <span class="section-number">7</span>
                            <span class="section-title">Solutions</span>
                        </a>
                    </li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <a href="../chapter-06/index.html" class="next-chapter-btn">
                    Next: Chapter 06 ‚Üí
                </a>
            </div>
        </aside>

        <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle Sidebar">
            <span></span>
            <span></span>
            <span></span>
        </button>

        <main class="chapter-content">
            <div class="reading-progress" id="reading-progress">
                <div class="progress-bar"></div>
            </div>

            <section class="chapter-hero">
                <div class="chapter-hero-content is-visible fade-in-up">
                    <span class="chapter-label">Chapter 5 ¬∑ Section 4</span>
                    <h1 class="chapter-title">Building RAG Pipelines</h1>
                    <p class="chapter-description">Compose retrieval and generation into complete, production-ready
                        applications.</p>
                    <div class="chapter-meta">
                        <span class="meta-item">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            ~20 min read
                        </span>
                    </div>
                </div>
            </section>

            <div class="content-wrapper">
                <article class="content-article" id="content-article">
                    <section class="content-section is-visible" id="rag-pipelines" data-section="rag-pipelines">
                        <div class="markdown-content" id="rag-pipelines-content">

                            <!-- Basic RAG Module -->
                            <div class="content-block">
                                <h2>üèóÔ∏è Basic RAG Module</h2>

                                <p>Let's build a complete RAG pipeline as a DSPy module:</p>

                                <div class="command-box">
                                    <pre><code class="language-python">import dspy
from dotenv import load_dotenv

load_dotenv()

# Configure LM
lm = dspy.LM("openai/gpt-4o-mini")
dspy.configure(lm=lm)

# Signature for RAG generation
class GenerateAnswer(dspy.Signature):
    """Answer the question based on the provided context."""
    context: str = dspy.InputField(desc="Relevant passages from documents")
    question: str = dspy.InputField()
    answer: str = dspy.OutputField(desc="A detailed answer based on the context")

# RAG Module
class RAG(dspy.Module):
    def __init__(self, retriever, k=3):
        self.retriever = retriever
        self.k = k
        self.generate = dspy.ChainOfThought(GenerateAnswer)
    
    def forward(self, question):
        # Step 1: Retrieve relevant documents
        docs = self.retriever(question, k=self.k)
        
        # Step 2: Format context
        context = "\n\n".join(docs)
        
        # Step 3: Generate answer
        result = self.generate(context=context, question=question)
        
        return dspy.Prediction(
            context=context,
            answer=result.answer,
            reasoning=result.rationale
        )</code></pre>
                                </div>
                            </div>

                            <!-- Complete Working Example -->
                            <div class="content-block">
                                <h2>üíª Complete Working Example</h2>

                                <p>Here's a full example with an in-memory retriever:</p>

                                <div class="command-box">
                                    <pre><code class="language-python">import dspy
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity
import numpy as np
from dotenv import load_dotenv

load_dotenv()

# Configure LM
lm = dspy.LM("openai/gpt-4o-mini")
dspy.configure(lm=lm)

# Simple retriever
class SimpleRetriever:
    def __init__(self, documents: list):
        self.documents = documents
        self.vectorizer = TfidfVectorizer()
        self.doc_vectors = self.vectorizer.fit_transform(documents)
    
    def __call__(self, query: str, k: int = 3) -> list:
        query_vector = self.vectorizer.transform([query])
        similarities = cosine_similarity(query_vector, self.doc_vectors)[0]
        top_indices = np.argsort(similarities)[::-1][:k]
        return [self.documents[i] for i in top_indices]

# RAG Signature
class GenerateAnswer(dspy.Signature):
    """Answer the question based on the provided context."""
    context: str = dspy.InputField()
    question: str = dspy.InputField()
    answer: str = dspy.OutputField()

# RAG Module
class RAG(dspy.Module):
    def __init__(self, retriever, k=3):
        self.retriever = retriever
        self.k = k
        self.generate = dspy.ChainOfThought(GenerateAnswer)
    
    def forward(self, question):
        docs = self.retriever(question, k=self.k)
        context = "\n\n".join(docs)
        result = self.generate(context=context, question=question)
        return dspy.Prediction(
            context=context,
            answer=result.answer
        )

# Knowledge base
knowledge_base = [
    "DSPy is a framework developed at Stanford for programming language models. It treats LM calls as optimizable modules rather than static prompts.",
    "In DSPy, a Signature defines the input and output fields for a task. Signatures can be inline strings or Python classes.",
    "DSPy modules like Predict and ChainOfThought execute signatures and can be composed into pipelines.",
    "The BootstrapFewShot optimizer finds successful examples and uses them as demonstrations in prompts.",
    "MIPRO is an advanced optimizer that improves both instructions and examples simultaneously.",
    "RAG (Retrieval-Augmented Generation) combines retrieval with generation to ground answers in real data.",
    "Vector databases like ChromaDB store embeddings for fast similarity search.",
    "Embeddings are dense vector representations that capture semantic meaning of text.",
]

# Create RAG system
retriever = SimpleRetriever(knowledge_base)
rag = RAG(retriever, k=3)

# Test it
questions = [
    "What is DSPy?",
    "How does BootstrapFewShot work?",
    "What is RAG?",
]

print("=== RAG Q&A System ===\n")

for q in questions:
    result = rag(question=q)
    print(f"Q: {q}")
    print(f"A: {result.answer}")
    print(f"\nRetrieved context:\n{result.context[:200]}...")
    print("-" * 60)</code></pre>
                                </div>
                            </div>

                            <!-- RAG with Citations -->
                            <div class="content-block">
                                <h2>üìö RAG with Citations</h2>

                                <p>Add source citations to your RAG outputs:</p>

                                <div class="command-box">
                                    <pre><code class="language-python">class GenerateWithCitations(dspy.Signature):
    """Answer the question and cite which sources you used."""
    context: str = dspy.InputField(desc="Numbered passages [1], [2], etc.")
    question: str = dspy.InputField()
    answer: str = dspy.OutputField(desc="Answer with citation numbers like [1], [2]")
    sources_used: str = dspy.OutputField(desc="List of source numbers used")

class RAGWithCitations(dspy.Module):
    def __init__(self, retriever, k=3):
        self.retriever = retriever
        self.k = k
        self.generate = dspy.ChainOfThought(GenerateWithCitations)
    
    def forward(self, question):
        # Retrieve
        docs = self.retriever(question, k=self.k)
        
        # Number the sources
        numbered_context = "\n\n".join([
            f"[{i+1}] {doc}" 
            for i, doc in enumerate(docs)
        ])
        
        # Generate with citations
        result = self.generate(
            context=numbered_context, 
            question=question
        )
        
        return dspy.Prediction(
            answer=result.answer,
            sources_used=result.sources_used,
            context=numbered_context,
            raw_docs=docs
        )

# Usage
rag_with_citations = RAGWithCitations(retriever, k=3)
result = rag_with_citations(question="What optimizers does DSPy have?")

print(f"Answer: {result.answer}")
print(f"Sources used: {result.sources_used}")</code></pre>
                                </div>
                            </div>

                            <!-- RAG with Query Rewriting -->
                            <div class="content-block">
                                <h2>üîÑ RAG with Query Rewriting</h2>

                                <p>Improve retrieval by rewriting the user query:</p>

                                <div class="command-box">
                                    <pre><code class="language-python">class RewriteQuery(dspy.Signature):
    """Rewrite the question to be more specific for document retrieval."""
    original_question: str = dspy.InputField()
    rewritten_query: str = dspy.OutputField(
        desc="A search-optimized version of the question"
    )

class RAGWithQueryRewriting(dspy.Module):
    def __init__(self, retriever, k=3):
        self.retriever = retriever
        self.k = k
        self.rewrite = dspy.Predict(RewriteQuery)
        self.generate = dspy.ChainOfThought(GenerateAnswer)
    
    def forward(self, question):
        # Step 1: Rewrite query for better retrieval
        rewritten = self.rewrite(original_question=question)
        search_query = rewritten.rewritten_query
        
        # Step 2: Retrieve with improved query
        docs = self.retriever(search_query, k=self.k)
        context = "\n\n".join(docs)
        
        # Step 3: Generate answer
        result = self.generate(context=context, question=question)
        
        return dspy.Prediction(
            original_question=question,
            search_query=search_query,
            context=context,
            answer=result.answer
        )

# Example
advanced_rag = RAGWithQueryRewriting(retriever, k=3)
result = advanced_rag(question="How do I make my prompts better?")

print(f"Original: {result.original_question}")
print(f"Search query: {result.search_query}")
print(f"Answer: {result.answer}")</code></pre>
                                </div>
                            </div>

                            <!-- Optimizing RAG -->
                            <div class="content-block">
                                <h2>üéØ Optimizing RAG Pipelines</h2>

                                <p>RAG modules can be optimized just like any other DSPy module:</p>

                                <div class="command-box">
                                    <pre><code class="language-python"># Create training data
trainset = [
    dspy.Example(
        question="What is DSPy?",
        answer="DSPy is a framework for programming language models developed at Stanford."
    ).with_inputs("question"),
    dspy.Example(
        question="What does BootstrapFewShot do?",
        answer="BootstrapFewShot finds successful examples and uses them as demonstrations."
    ).with_inputs("question"),
    # ... more examples
]

# Define metric
def rag_metric(example, pred, trace=None):
    # Check if answer contains key information
    # (In practice, use more sophisticated evaluation)
    return example.answer.lower() in pred.answer.lower()

# Create optimizer
optimizer = dspy.BootstrapFewShot(
    metric=rag_metric,
    max_bootstrapped_demos=3
)

# Compile
rag = RAG(retriever, k=3)
optimized_rag = optimizer.compile(rag, trainset=trainset)

# Save for production
optimized_rag.save("optimized_rag.json")</code></pre>
                                </div>

                                <div class="tip-box">
                                    <span class="tip-icon">üí°</span>
                                    <p><strong>Key insight:</strong> Optimization can improve both the retrieval
                                        query formulation and the generation quality!</p>
                                </div>
                            </div>

                            <!-- Pipeline Architecture -->
                            <div class="content-block">
                                <h2>üìê Pipeline Architecture Patterns</h2>

                                <div class="chapter-sections-list">
                                    <div class="chapter-section-item">
                                        <span class="section-icon">1Ô∏è‚É£</span>
                                        <div class="section-content">
                                            <h4>Simple RAG</h4>
                                            <p>Query ‚Üí Retrieve ‚Üí Generate. Fast, works for simple questions.</p>
                                        </div>
                                    </div>
                                    <div class="chapter-section-item">
                                        <span class="section-icon">2Ô∏è‚É£</span>
                                        <div class="section-content">
                                            <h4>Query Rewrite RAG</h4>
                                            <p>Query ‚Üí Rewrite ‚Üí Retrieve ‚Üí Generate. Better retrieval quality.</p>
                                        </div>
                                    </div>
                                    <div class="chapter-section-item">
                                        <span class="section-icon">3Ô∏è‚É£</span>
                                        <div class="section-content">
                                            <h4>RAG with Reranking</h4>
                                            <p>Query ‚Üí Retrieve (many) ‚Üí Rerank (top k) ‚Üí Generate. Higher precision.
                                            </p>
                                        </div>
                                    </div>
                                    <div class="chapter-section-item">
                                        <span class="section-icon">4Ô∏è‚É£</span>
                                        <div class="section-content">
                                            <h4>Iterative RAG</h4>
                                            <p>Query ‚Üí Retrieve ‚Üí Generate ‚Üí Check ‚Üí (Retrieve more if needed). For
                                                complex questions.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Key Takeaways -->
                            <div class="content-block summary-block">
                                <h2>üìù Key Takeaways</h2>

                                <div class="chapter-sections-list no-icons">
                                    <div class="chapter-section-item">
                                        <div class="section-content">
                                            <p><strong>RAG modules</strong> combine retrieval + generation as
                                                dspy.Module</p>
                                        </div>
                                    </div>
                                    <div class="chapter-section-item">
                                        <div class="section-content">
                                            <p><strong>Add citations</strong> by numbering passages in context</p>
                                        </div>
                                    </div>
                                    <div class="chapter-section-item">
                                        <div class="section-content">
                                            <p><strong>Query rewriting</strong> improves retrieval quality</p>
                                        </div>
                                    </div>
                                    <div class="chapter-section-item">
                                        <div class="section-content">
                                            <p><strong>RAG can be optimized</strong> with BootstrapFewShot like any
                                                module</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Continue -->
                            <div class="content-block">
                                <div class="continue-btn-container">
                                    <a href="advanced-rag.html" class="continue-btn">
                                        <span>Continue to Advanced RAG Patterns</span>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M5 12h14M12 5l7 7-7 7" />
                                        </svg>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </section>
                </article>
            </div>
        </main>
    </div>

    <footer>
        <p>&copy; 2025 DSPy Ebook. All rights reserved.</p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="../../assets/js/main.js?v=1"></script>
    <script src="../../assets/js/chapter_v2.js" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (window.initChapter) {
                window.initChapter({});
            }
            setTimeout(() => {
                if (window.Prism) window.Prism.highlightAll();
            }, 100);
        });
    </script>
</body>

</html>