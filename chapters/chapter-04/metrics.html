<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metrics & Evaluation | Chapter 4 | DSPy: The Comprehensive Guide</title>
    <meta name="description"
        content="Learn to create effective metrics for DSPy optimization - the foundation of all improvement.">
    <link rel="stylesheet" href="../../assets/css/style.css?v=2">
    <link rel="stylesheet" href="../../assets/css/chapter.css?v=8">
    <link rel="stylesheet" href="../../assets/css/content.css?v=2">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
</head>

<body class="chapter-page">
    <header>
        <div class="logo">
            <a href="../../index.html">
                <img src="../../src/assets/logos/logo.png" alt="DSPy Ebook Logo">
                <span>DSPy Ebook</span>
            </a>
        </div>
        <nav>
            <ul>
                <li><a href="../../index.html">Home</a></li>
                <li><a href="../../index.html#chapters">Chapters</a></li>
                <li><a href="https://github.com/dustinober1/Ebook_DSPy" target="_blank">GitHub</a></li>
            </ul>
        </nav>
    </header>

    <div class="chapter-layout">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Chapter 4</h2>
                <span class="sidebar-subtitle">Optimizers</span>
            </div>
            <nav class="sidebar-nav">
                <ul class="section-list" id="section-list">
                    <li class="section-item viewed" data-section="intro">
                        <a href="index.html">
                            <span class="section-number">1</span>
                            <span class="section-title">Chapter Overview</span>
                        </a>
                    </li>
                    <li class="section-item viewed" data-section="why-optimize">
                        <a href="why-optimize.html">
                            <span class="section-number">2</span>
                            <span class="section-title">Why Optimize?</span>
                        </a>
                    </li>
                    <li class="section-item active" data-section="metrics">
                        <a href="metrics.html">
                            <span class="section-number">3</span>
                            <span class="section-title">Metrics & Evaluation</span>
                        </a>
                    </li>
                    <li class="section-item" data-section="bootstrap-fewshot">
                        <a href="bootstrap-fewshot.html">
                            <span class="section-number">4</span>
                            <span class="section-title">BootstrapFewShot</span>
                        </a>
                    </li>
                    <li class="section-item" data-section="advanced-optimizers">
                        <a href="advanced-optimizers.html">
                            <span class="section-number">5</span>
                            <span class="section-title">Advanced Optimizers</span>
                        </a>
                    </li>
                    <li class="section-item" data-section="exercises">
                        <a href="exercises.html">
                            <span class="section-number">6</span>
                            <span class="section-title">Exercises</span>
                        </a>
                    </li>
                    <li class="section-item" data-section="solutions">
                        <a href="solutions.html">
                            <span class="section-number">7</span>
                            <span class="section-title">Solutions</span>
                        </a>
                    </li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <a href="../chapter-05/index.html" class="next-chapter-btn">
                    Next: Chapter 05 ‚Üí
                </a>
            </div>
        </aside>

        <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle Sidebar">
            <span></span>
            <span></span>
            <span></span>
        </button>

        <main class="chapter-content">
            <div class="reading-progress" id="reading-progress">
                <div class="progress-bar"></div>
            </div>

            <section class="chapter-hero">
                <div class="chapter-hero-content is-visible fade-in-up">
                    <span class="chapter-label">Chapter 4 ¬∑ Section 3</span>
                    <h1 class="chapter-title">Metrics & Evaluation</h1>
                    <p class="chapter-description">Good metrics are the foundation of effective optimization. Learn to
                        measure what matters.</p>
                    <div class="chapter-meta">
                        <span class="meta-item">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            ~15 min read
                        </span>
                    </div>
                </div>
            </section>

            <div class="content-wrapper">
                <article class="content-article" id="content-article">
                    <section class="content-section is-visible" id="metrics" data-section="metrics">
                        <div class="markdown-content" id="metrics-content">

                            <!-- What is a Metric -->
                            <div class="content-block">
                                <h2>üìä What is a Metric?</h2>

                                <p>A <strong>metric</strong> is a function that scores how well your program performed
                                    on a single example:</p>

                                <div class="command-box">
                                    <pre><code class="language-python">def metric(example, prediction, trace=None):
    """
    Args:
        example: The input example with expected output(s)
        prediction: What your module actually produced
        trace: Optional debugging information (used by some optimizers)
    
    Returns:
        A score (bool, int, or float)
    """
    # Compare prediction to expected
    return prediction.answer == example.answer</code></pre>
                                </div>

                                <div class="tip-box">
                                    <span class="tip-icon">üí°</span>
                                    <p><strong>Key insight:</strong> Your metric defines what "success" means. The
                                        optimizer will maximize whatever you measure!</p>
                                </div>
                            </div>

                            <!-- Metric Types -->
                            <div class="content-block">
                                <h2>üéØ Types of Metrics</h2>

                                <h3>Binary Metrics (True/False)</h3>
                                <p>The simplest form‚Äîeither correct or not:</p>

                                <div class="command-box">
                                    <pre><code class="language-python"># Exact match
def exact_match(example, pred, trace=None):
    return pred.answer.strip().lower() == example.answer.strip().lower()

# Contains the answer
def contains_answer(example, pred, trace=None):
    return example.answer.lower() in pred.answer.lower()</code></pre>
                                </div>

                                <h3>Numeric Metrics (0.0 - 1.0)</h3>
                                <p>More nuanced scoring:</p>

                                <div class="command-box">
                                    <pre><code class="language-python"># Partial credit for word overlap
def word_overlap(example, pred, trace=None):
    expected_words = set(example.answer.lower().split())
    pred_words = set(pred.answer.lower().split())
    
    if not expected_words:
        return 0.0
    
    overlap = expected_words & pred_words
    return len(overlap) / len(expected_words)

# F1 score for multiple outputs
def f1_score(example, pred, trace=None):
    expected = set(example.entities)
    predicted = set(pred.entities)
    
    if not predicted:
        return 0.0
    
    precision = len(expected & predicted) / len(predicted)
    recall = len(expected & predicted) / len(expected) if expected else 0
    
    if precision + recall == 0:
        return 0.0
    
    return 2 * (precision * recall) / (precision + recall)</code></pre>
                                </div>
                            </div>

                            <!-- LM-as-Judge -->
                            <div class="content-block">
                                <h2>ü§ñ Using an LM as Judge</h2>

                                <p>For complex outputs where simple comparison doesn't work, use another LM to
                                    evaluate:</p>

                                <div class="command-box">
                                    <pre><code class="language-python">import dspy

class AssessSummary(dspy.Signature):
    """Assess if the summary captures the key points of the original text."""
    original_text: str = dspy.InputField()
    summary: str = dspy.InputField()
    score: float = dspy.OutputField(desc="Score from 0.0 to 1.0")
    reasoning: str = dspy.OutputField()

# Create the judge
judge = dspy.ChainOfThought(AssessSummary)

def summary_quality(example, pred, trace=None):
    """Use an LM to assess summary quality."""
    assessment = judge(
        original_text=example.text,
        summary=pred.summary
    )
    return float(assessment.score)</code></pre>
                                </div>

                                <div class="tip-box warning">
                                    <span class="tip-icon">‚ö†Ô∏è</span>
                                    <p><strong>Cost warning:</strong> LM-as-judge metrics are powerful but expensive.
                                        Each evaluation requires an LM call. Consider using a smaller/cheaper model for
                                        judging.</p>
                                </div>
                            </div>

                            <!-- Creating Training Data -->
                            <div class="content-block">
                                <h2>üìö Creating Training Data</h2>

                                <p>Optimizers need examples to learn from. Here's how to create them:</p>

                                <div class="command-box">
                                    <pre><code class="language-python">import dspy

# Create individual examples
example1 = dspy.Example(
    question="What is the capital of France?",
    answer="Paris"
)

# Mark which fields are inputs vs. labels
example1 = example1.with_inputs("question")
# Now example1.question is input, example1.answer is the expected output

# Create a training set
trainset = [
    dspy.Example(
        question="What is 2 + 2?",
        answer="4"
    ).with_inputs("question"),
    
    dspy.Example(
        question="Who wrote Romeo and Juliet?",
        answer="William Shakespeare"
    ).with_inputs("question"),
    
    dspy.Example(
        question="What is the chemical symbol for water?",
        answer="H2O"
    ).with_inputs("question"),
]</code></pre>
                                </div>

                                <h3>Loading from a Dataset</h3>

                                <div class="command-box">
                                    <pre><code class="language-python">import json

def load_dataset(filepath):
    """Load examples from a JSON file."""
    with open(filepath) as f:
        data = json.load(f)
    
    examples = []
    for item in data:
        example = dspy.Example(
            context=item["context"],
            question=item["question"],
            answer=item["answer"]
        ).with_inputs("context", "question")
        examples.append(example)
    
    return examples

trainset = load_dataset("training_data.json")</code></pre>
                                </div>
                            </div>

                            <!-- Train/Dev Split -->
                            <div class="content-block">
                                <h2>üìä Train/Dev/Test Split</h2>

                                <p>Always separate your data:</p>

                                <div class="command-box">
                                    <pre><code class="language-python">import random

def split_dataset(examples, train_ratio=0.7, dev_ratio=0.15):
    """Split examples into train/dev/test sets."""
    random.shuffle(examples)
    
    n = len(examples)
    train_end = int(n * train_ratio)
    dev_end = int(n * (train_ratio + dev_ratio))
    
    return {
        "train": examples[:train_end],
        "dev": examples[train_end:dev_end],
        "test": examples[dev_end:]
    }

# Split your data
splits = split_dataset(all_examples)
trainset = splits["train"]  # Use for optimization
devset = splits["dev"]      # Use for hyperparameter tuning
testset = splits["test"]    # Use for final evaluation only!</code></pre>
                                </div>

                                <div class="chapter-sections-list">
                                    <div class="chapter-section-item">
                                        <span class="section-icon">üìà</span>
                                        <div class="section-content">
                                            <h4>Training Set</h4>
                                            <p>Used by the optimizer to find demonstrations and tune prompts.</p>
                                        </div>
                                    </div>
                                    <div class="chapter-section-item">
                                        <span class="section-icon">üîß</span>
                                        <div class="section-content">
                                            <h4>Dev Set</h4>
                                            <p>Used to compare different optimizers or configurations.</p>
                                        </div>
                                    </div>
                                    <div class="chapter-section-item">
                                        <span class="section-icon">‚úÖ</span>
                                        <div class="section-content">
                                            <h4>Test Set</h4>
                                            <p>Only used once at the end to get final, unbiased performance numbers.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Evaluation Function -->
                            <div class="content-block">
                                <h2>üìã The Evaluate Helper</h2>

                                <p>DSPy provides an <code>Evaluate</code> class for systematic evaluation:</p>

                                <div class="command-box">
                                    <pre><code class="language-python">from dspy.evaluate import Evaluate

# Create evaluator
evaluator = Evaluate(
    devset=devset,
    metric=exact_match,
    num_threads=4,         # Parallel evaluation
    display_progress=True,
    display_table=5        # Show 5 example results
)

# Evaluate your module
score = evaluator(my_module)
print(f"Accuracy: {score:.2%}")

# Compare before and after optimization
baseline_score = evaluator(original_module)
optimized_score = evaluator(optimized_module)

print(f"Baseline: {baseline_score:.2%}")
print(f"Optimized: {optimized_score:.2%}")
print(f"Improvement: {optimized_score - baseline_score:.2%}")</code></pre>
                                </div>
                            </div>

                            <!-- Common Metric Patterns -->
                            <div class="content-block">
                                <h2>üîß Common Metric Patterns</h2>

                                <h3>Classification</h3>
                                <div class="command-box">
                                    <pre><code class="language-python">def classification_metric(example, pred, trace=None):
    # Normalize both to lower case and strip whitespace
    expected = example.label.strip().lower()
    predicted = pred.label.strip().lower()
    return expected == predicted</code></pre>
                                </div>

                                <h3>Multi-label Classification</h3>
                                <div class="command-box">
                                    <pre><code class="language-python">def multilabel_metric(example, pred, trace=None):
    expected = set(example.labels)
    predicted = set(pred.labels)
    
    # Jaccard similarity
    intersection = len(expected & predicted)
    union = len(expected | predicted)
    
    return intersection / union if union > 0 else 0.0</code></pre>
                                </div>

                                <h3>Generation with Multiple Valid Answers</h3>
                                <div class="command-box">
                                    <pre><code class="language-python">def generation_metric(example, pred, trace=None):
    # Check if prediction matches any valid answer
    valid_answers = example.valid_answers  # List of acceptable answers
    predicted = pred.answer.strip().lower()
    
    return any(
        valid.strip().lower() == predicted 
        for valid in valid_answers
    )</code></pre>
                                </div>

                                <h3>Combined Metrics</h3>
                                <div class="command-box">
                                    <pre><code class="language-python">def combined_metric(example, pred, trace=None):
    # Check correctness
    is_correct = pred.answer.lower() == example.answer.lower()
    
    # Check conciseness (penalize overly long responses)
    length_factor = min(1.0, 100 / len(pred.answer)) if pred.answer else 0
    
    # Combine (weighted)
    return 0.8 * is_correct + 0.2 * length_factor</code></pre>
                                </div>
                            </div>

                            <!-- Key Takeaways -->
                            <div class="content-block summary-block">
                                <h2>üìù Key Takeaways</h2>

                                <div class="chapter-sections-list no-icons">
                                    <div class="chapter-section-item">
                                        <div class="section-content">
                                            <p><strong>Metrics define success</strong> ‚Äî the optimizer maximizes your
                                                metric.</p>
                                        </div>
                                    </div>
                                    <div class="chapter-section-item">
                                        <div class="section-content">
                                            <p><strong>Use dspy.Example</strong> with <code>.with_inputs()</code> to
                                                create training data.</p>
                                        </div>
                                    </div>
                                    <div class="chapter-section-item">
                                        <div class="section-content">
                                            <p><strong>Split your data</strong> into train/dev/test sets.</p>
                                        </div>
                                    </div>
                                    <div class="chapter-section-item">
                                        <div class="section-content">
                                            <p><strong>LM-as-judge</strong> works for complex evaluations but costs
                                                more.</p>
                                        </div>
                                    </div>
                                    <div class="chapter-section-item">
                                        <div class="section-content">
                                            <p><strong>Use Evaluate</strong> for systematic performance measurement.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Continue -->
                            <div class="content-block">
                                <div class="continue-btn-container">
                                    <a href="bootstrap-fewshot.html" class="continue-btn">
                                        <span>Continue to BootstrapFewShot</span>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M5 12h14M12 5l7 7-7 7" />
                                        </svg>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </section>
                </article>
            </div>
        </main>
    </div>

    <footer>
        <p>&copy; 2025 DSPy Ebook. All rights reserved.</p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="../../assets/js/main.js?v=1"></script>
    <script src="../../assets/js/chapter_v2.js" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (window.initChapter) {
                window.initChapter({});
            }
            setTimeout(() => {
                if (window.Prism) window.Prism.highlightAll();
            }, 100);
        });
    </script>
</body>

</html>