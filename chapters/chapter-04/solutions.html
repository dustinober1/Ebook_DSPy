<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solutions | Chapter 4 | DSPy: The Comprehensive Guide</title>
    <meta name="description" content="Complete solutions and explanations for Chapter 4 evaluation exercises.">
    <link rel="stylesheet" href="../../assets/css/style.css?v=2">
    <link rel="stylesheet" href="../../assets/css/chapter.css?v=8">
    <link rel="stylesheet" href="../../assets/css/content.css?v=2">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
</head>

<body class="chapter-page">
    <!-- Skip Link for Accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <header>
        <div class="logo">
            <a href="../../index.html">
                <img src="../../src/assets/logos/logo.png" alt="DSPy Ebook Logo">
                <span>DSPy Ebook</span>
            </a>
        </div>
        <nav>
            <ul>
                <li><a href="../../index.html">Home</a></li>
                <li><a href="../../index.html#chapters">Chapters</a></li>
                <li><a href="https://github.com/dustinober1/Ebook_DSPy" target="_blank">GitHub</a></li>
            </ul>
        </nav>
    </header>

    <div class="chapter-layout">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Chapter 4</h2>
                <span class="sidebar-subtitle">Evaluation</span>
            </div>
            <nav class="sidebar-nav">
                <ul class="section-list" id="section-list">
                    <li class="section-item viewed" data-section="intro">
                        <a href="index.html">
                            <span class="section-number">1</span>
                            <span class="section-title">Chapter Overview</span>
                        </a>
                    </li>
                    <li class="section-item viewed" data-section="why-eval">
                        <a href="why-evaluation-matters.html">
                            <span class="section-number">2</span>
                            <span class="section-title">Why Evaluation Matters</span>
                        </a>
                    </li>
                    <li class="section-item viewed" data-section="datasets">
                        <a href="creating-datasets.html">
                            <span class="section-number">3</span>
                            <span class="section-title">Creating Datasets</span>
                        </a>
                    </li>
                    <li class="section-item viewed" data-section="metrics">
                        <a href="defining-metrics.html">
                            <span class="section-number">4</span>
                            <span class="section-title">Defining Metrics</span>
                        </a>
                    </li>
                    <li class="section-item viewed" data-section="loops">
                        <a href="evaluation-loops.html">
                            <span class="section-number">5</span>
                            <span class="section-title">Evaluation Loops</span>
                        </a>
                    </li>
                    <li class="section-item viewed" data-section="best-practices">
                        <a href="best-practices.html">
                            <span class="section-number">6</span>
                            <span class="section-title">Best Practices</span>
                        </a>
                    </li>
                    <li class="section-item viewed" data-section="exercises">
                        <a href="exercises.html">
                            <span class="section-number">7</span>
                            <span class="section-title">Exercises</span>
                        </a>
                    </li>
                    <li class="section-item viewed" data-section="structured-prompting">
                        <a href="structured-prompting.html">
                            <span class="section-number">8</span>
                            <span class="section-title">Structured Prompting</span>
                        </a>
                    </li>
                    <li class="section-item viewed" data-section="llm-as-judge">
                        <a href="llm-as-a-judge.html">
                            <span class="section-number">9</span>
                            <span class="section-title">LLM-as-a-Judge</span>
                        </a>
                    </li>
                    <li class="section-item viewed" data-section="human-aligned">
                        <a href="human-aligned-evaluation.html">
                            <span class="section-number">10</span>
                            <span class="section-title">Human-Aligned Eval</span>
                        </a>
                    </li>
                    <li class="section-item active" data-section="solutions">
                        <a href="solutions.html">
                            <span class="section-number">11</span>
                            <span class="section-title">Solutions</span>
                        </a>
                    </li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <a href="../chapter-05/index.html" class="next-chapter-btn">
                    Next: Chapter 05 ‚Üí
                </a>
            </div>
        </aside>

        <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle Sidebar">
            <span></span>
            <span></span>
            <span></span>
        </button>

        <main class="chapter-content" id="main-content">
            <div class="reading-progress" id="reading-progress">
                <div class="progress-bar"></div>
            </div>

            <section class="chapter-hero">
                <div class="chapter-hero-content is-visible fade-in-up">
                    <span class="chapter-label">Chapter 4 ¬∑ Section 11</span>
                    <h1 class="chapter-title">Solutions</h1>
                    <p class="chapter-description">Detailed implementations for the evaluation exercises.</p>
                </div>
            </section>

            <div class="content-wrapper">
                <article class="content-article" id="content-article">
                    <section class="content-section is-visible" id="solutions" data-section="solutions">
                        <div class="markdown-content" id="solutions-content">
                            <div class="content-block">
                                <h2>Exercise 1: Creating a Quality Dataset</h2>
                                <p>This solution demonstrates how to create a balanced, diverse dataset with edge cases
                                    and proper splitting.</p>

                                <div class="command-box">
                                    <pre><code class="language-python">import dspy
import random

def create_sentiment_dataset():
    examples = []
    
    # 1. POSITIVE EXAMPLES (10+)
    positive_texts = [
        "This product is amazing! Best purchase ever!",
        "Absolutely love the quality.",
        "Great customer service, very helpful.",
        "Fast shipping and item as described.",
        "Exceeded my expectations entirely.",
        "I would recommend this to everyone.",
        "Fantastic value for the money.",
        "Works perfectly out of the box.",
        "Simple to use and effective.",
        "Five stars, no complaints!"
    ]
    for text in positive_texts:
        examples.append(dspy.Example(text=text, sentiment="positive", confidence=0.9).with_inputs("text"))

    # 2. NEGATIVE EXAMPLES (10+)
    negative_texts = [
        "Terrible quality, broke immediately.",
        "Waste of money, do not buy.",
        "Customer service was rude and unhelpful.",
        "Shipping took forever and arrived damaged.",
        "Completely different from the description.",
        "Not worth the price tag.",
        "Stopped working after one day.",
        "Frustrating to set up.",
        "Poor design choices everywhere.",
        "I want a refund."
    ]
    for text in negative_texts:
        examples.append(dspy.Example(text=text, sentiment="negative", confidence=0.9).with_inputs("text"))

    # 3. NEUTRAL EXAMPLES (5+)
    neutral_texts = [
        "It's okay, nothing special.",
        "Average product for the price.",
        "Does the job, but has flaws.",
        "Delivered on time.",
        "It is what it is."
    ]
    for text in neutral_texts:
        examples.append(dspy.Example(text=text, sentiment="neutral", confidence=0.5).with_inputs("text"))

    # 4. EDGE CASESS (5+)
    edge_cases = [
        ("Great, another broken item.", "negative", 0.8), # Sarcasm
        ("Food was good, service was bad.", "neutral", 0.6), # Mixed
        ("Is this worth it?", "neutral", 0.3), # Question
        ("meh", "neutral", 0.4), # Short
        ("LOVE IT!!! üòç", "positive", 0.95), # Emoji/formatting
    ]
    for text, sent, conf in edge_cases:
        examples.append(dspy.Example(text=text, sentiment=sent, confidence=conf).with_inputs("text"))

    # 5. SHUFFLE
    random.seed(42)
    random.shuffle(examples)

    # 6. SPLIT (60/20/20)
    n = len(examples)
    train_end = int(n * 0.6)
    dev_end = int(n * 0.8)

    trainset = examples[:train_end]
    devset = examples[train_end:dev_end]
    testset = examples[dev_end:]

    return trainset, devset, testset</code></pre>
                                </div>
                            </div>

                            <div class="content-block">
                                <h2>Exercise 2: Designing a Custom Metric</h2>
                                <p>This metric implements weighted sub-scores and handles the trace parameter for
                                    optimization.</p>

                                <div class="command-box">
                                    <pre><code class="language-python">def qa_quality_metric(example, pred, trace=None):
    # 1. Correctness (40%)
    # Simple inclusion check (could use semantic comparison in production)
    expected = example.answer.lower()
    actual = pred.answer.lower()
    correctness = 1.0 if expected in actual else 0.0

    # 2. Completeness (30%)
    # Check if key concepts from answer are present
    key_terms = expected.split()
    found_terms = sum(1 for term in key_terms if term in actual)
    completeness = found_terms / len(key_terms) if key_terms else 1.0

    # 3. Conciseness (20%)
    # Ideal length between 10 and 100 words
    word_count = len(actual.split())
    if 10 <= word_count <= 100:
        conciseness = 1.0
    elif word_count < 5 or word_count > 200:
        conciseness = 0.0
    else:
        conciseness = 0.5

    # 4. Format (10%)
    # Check for basic punctuation
    format_score = 1.0 if actual.strip().endswith(('.', '!', '?')) else 0.0

    # Weighted Sum
    final_score = (
        0.4 * correctness + 
        0.3 * completeness + 
        0.2 * conciseness + 
        0.1 * format_score
    )

    # Trace Handling
    if trace is not None:
        # Optimization Goal: High quality (>0.7)
        return final_score >= 0.7
        
    return final_score</code></pre>
                                </div>
                            </div>

                            <div class="content-block">
                                <h2>Exercise 3: Systematic Evaluation</h2>
                                <p>A comprehensive evaluation function that provides actionable insights.</p>

                                <div class="command-box">
                                    <pre><code class="language-python">def comprehensive_evaluation(module, devset, metric):
    results = {
        'total_score': 0.0,
        'count': 0,
        'scores': [],
        'errors': [],
        'best_examples': [],
        'worst_examples': []
    }
    
    detailed_results = []

    for idx, example in enumerate(devset):
        try:
            # Predict
            pred = module(**example.inputs())
            
            # Score
            score = metric(example, pred)
            
            # Store
            results['total_score'] += score
            results['count'] += 1
            results['scores'].append(score)
            
            detailed_results.append({
                'example': example, 
                'pred': pred, 
                'score': score
            })

            # Error Analysis Categories
            if score < 0.5:
                error_type = "low_quality"
                if len(pred.answer) == 0:
                    error_type = "empty_response"
                results['errors'].append({
                    'index': idx,
                    'type': error_type,
                    'input': example.question,
                    'expected': example.answer,
                    'actual': pred.answer
                })

        except Exception as e:
            results['errors'].append({
                'index': idx,
                'type': 'exception',
                'message': str(e)
            })

    # Averages
    if results['count'] > 0:
        results['average_score'] = results['total_score'] / results['count']
    
    # Sort for best/worst
    sorted_res = sorted(detailed_results, key=lambda x: x['score'], reverse=True)
    results['best_examples'] = sorted_res[:3]
    results['worst_examples'] = sorted_res[-3:]

    return results</code></pre>
                                </div>
                            </div>

                            <div class="content-block">
                                <div class="continue-btn-container">
                                    <a href="../chapter-05/index.html" class="continue-btn">
                                        <span>Next: Chapter 5 - Optimizers</span>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M5 12h14M12 5l7 7-7 7" />
                                        </svg>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </section>
                </article>
            </div>
        </main>
    </div>

    <footer>
        <p>&copy; 2025 DSPy Ebook. All rights reserved.</p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="../../assets/js/main.js?v=1"></script>
    <script src="../../assets/js/chapter_v2.js" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (window.initChapter) {
                window.initChapter({});
            }
            setTimeout(() => {
                if (window.Prism) window.Prism.highlightAll();
            }, 100);
        });
    </script>
</body>

</html>