<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creating Custom Modules | Chapter 3 | DSPy: The Comprehensive Guide</title>
    <meta name="description"
        content="Learn to create custom DSPy modules by subclassing dspy.Module - build powerful, reusable components for your LM applications.">
    <link rel="stylesheet" href="../../assets/css/style.css?v=2">
    <link rel="stylesheet" href="../../assets/css/chapter.css?v=8">
    <link rel="stylesheet" href="../../assets/css/content.css?v=2">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
</head>

<body class="chapter-page">
    <header>
        <div class="logo">
            <a href="../../index.html">
                <img src="../../src/assets/logos/logo.png" alt="DSPy Ebook Logo">
                <span>DSPy Ebook</span>
            </a>
        </div>
        <nav>
            <ul>
                <li><a href="../../index.html">Home</a></li>
                <li><a href="../../index.html#chapters">Chapters</a></li>
                <li><a href="https://github.com/dustinober1/Ebook_DSPy" target="_blank">GitHub</a></li>
            </ul>
        </nav>
    </header>

    <div class="chapter-layout">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Chapter 3</h2>
                <span class="sidebar-subtitle">Modules</span>
            </div>
            <nav class="sidebar-nav">
                <ul class="section-list" id="section-list">
                    <li class="section-item viewed" data-section="intro">
                        <a href="index.html">
                            <span class="section-number">1</span>
                            <span class="section-title">Chapter Overview</span>
                        </a>
                    </li>
                    <li class="section-item viewed" data-section="what-are-modules">
                        <a href="what-are-modules.html">
                            <span class="section-number">2</span>
                            <span class="section-title">What Are Modules?</span>
                        </a>
                    </li>
                    <li class="section-item viewed" data-section="built-in-modules">
                        <a href="built-in-modules.html">
                            <span class="section-number">3</span>
                            <span class="section-title">Built-in Modules</span>
                        </a>
                    </li>
                    <li class="section-item active" data-section="custom-modules">
                        <a href="custom-modules.html">
                            <span class="section-number">4</span>
                            <span class="section-title">Creating Custom Modules</span>
                        </a>
                    </li>
                    <li class="section-item" data-section="module-composition">
                        <a href="module-composition.html">
                            <span class="section-number">5</span>
                            <span class="section-title">Module Composition</span>
                        </a>
                    </li>
                    <li class="section-item" data-section="exercises">
                        <a href="exercises.html">
                            <span class="section-number">6</span>
                            <span class="section-title">Exercises</span>
                        </a>
                    </li>
                    <li class="section-item" data-section="solutions">
                        <a href="solutions.html">
                            <span class="section-number">7</span>
                            <span class="section-title">Solutions</span>
                        </a>
                    </li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <a href="../chapter-04/index.html" class="next-chapter-btn">
                    Next: Chapter 04 ‚Üí
                </a>
            </div>
        </aside>

        <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle Sidebar">
            <span></span>
            <span></span>
            <span></span>
        </button>

        <main class="chapter-content">
            <div class="reading-progress" id="reading-progress">
                <div class="progress-bar"></div>
            </div>

            <section class="chapter-hero">
                <div class="chapter-hero-content is-visible fade-in-up">
                    <span class="chapter-label">Chapter 3 ¬∑ Section 4</span>
                    <h1 class="chapter-title">Creating Custom Modules</h1>
                    <p class="chapter-description">Build your own modules by subclassing dspy.Module‚Äîthe key to
                        creating powerful, reusable LM components.</p>
                    <div class="chapter-meta">
                        <span class="meta-item">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            ~15 min read
                        </span>
                    </div>
                </div>
            </section>

            <div class="content-wrapper">
                <article class="content-article" id="content-article">
                    <section class="content-section is-visible" id="custom-modules" data-section="custom-modules">
                        <div class="markdown-content" id="custom-modules-content">

                            <!-- Why Custom Modules -->
                            <div class="content-block">
                                <h2>üèóÔ∏è Why Create Custom Modules?</h2>

                                <p>While built-in modules are powerful, custom modules let you:</p>

                                <div class="chapter-sections-list">
                                    <div class="chapter-section-item">
                                        <span class="section-icon">üîó</span>
                                        <div class="section-content">
                                            <h4>Chain Multiple Steps</h4>
                                            <p>Combine multiple LM calls with custom logic between them.</p>
                                        </div>
                                    </div>
                                    <div class="chapter-section-item">
                                        <span class="section-icon">üîÑ</span>
                                        <div class="section-content">
                                            <h4>Add Control Flow</h4>
                                            <p>Include if/else, loops, and error handling around LM calls.</p>
                                        </div>
                                    </div>
                                    <div class="chapter-section-item">
                                        <span class="section-icon">üì¶</span>
                                        <div class="section-content">
                                            <h4>Encapsulate Complexity</h4>
                                            <p>Hide implementation details behind a clean interface.</p>
                                        </div>
                                    </div>
                                    <div class="chapter-section-item">
                                        <span class="section-icon">‚ôªÔ∏è</span>
                                        <div class="section-content">
                                            <h4>Enable Reuse</h4>
                                            <p>Create modules you can use across different projects.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Basic Structure -->
                            <div class="content-block">
                                <h2>üìê Basic Module Structure</h2>

                                <p>Every custom module follows this pattern:</p>

                                <div class="command-box">
                                    <pre><code class="language-python">import dspy

class MyModule(dspy.Module):
    def __init__(self):
        super().__init__()
        # Initialize sub-modules here
        self.step1 = dspy.Predict(SomeSignature)
        self.step2 = dspy.ChainOfThought(AnotherSignature)
    
    def forward(self, **inputs):
        # Define the execution logic
        result1 = self.step1(**inputs)
        result2 = self.step2(data=result1.output)
        return result2</code></pre>
                                </div>

                                <div class="chapter-sections-list">
                                    <div class="chapter-section-item">
                                        <span class="section-icon">1Ô∏è‚É£</span>
                                        <div class="section-content">
                                            <h4>Inherit from dspy.Module</h4>
                                            <p>This enables DSPy's parameter tracking and optimization.</p>
                                        </div>
                                    </div>
                                    <div class="chapter-section-item">
                                        <span class="section-icon">2Ô∏è‚É£</span>
                                        <div class="section-content">
                                            <h4>Define __init__</h4>
                                            <p>Create all sub-modules as instance attributes. Call
                                                <code>super().__init__()</code>.
                                            </p>
                                        </div>
                                    </div>
                                    <div class="chapter-section-item">
                                        <span class="section-icon">3Ô∏è‚É£</span>
                                        <div class="section-content">
                                            <h4>Define forward</h4>
                                            <p>Implement the execution logic. This is called when you invoke the
                                                module.</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="tip-box">
                                    <span class="tip-icon">üí°</span>
                                    <p><strong>Important:</strong> When you call <code>my_module(inputs)</code>, it
                                        actually calls <code>my_module.forward(inputs)</code>. This is similar to
                                        PyTorch!</p>
                                </div>
                            </div>

                            <!-- Simple Example -->
                            <div class="content-block">
                                <h2>üí° Simple Example: Multi-Step QA</h2>

                                <p>Let's create a module that first researches a topic, then answers a question:</p>

                                <div class="command-box">
                                    <pre><code class="language-python">import dspy

# Define the signatures
class GenerateSearchQuery(dspy.Signature):
    """Generate a search query to find information for answering the question."""
    question: str = dspy.InputField()
    search_query: str = dspy.OutputField()

class AnswerWithContext(dspy.Signature):
    """Answer the question using the provided context."""
    context: str = dspy.InputField()
    question: str = dspy.InputField()
    answer: str = dspy.OutputField()

# Create the custom module
class ResearchQA(dspy.Module):
    def __init__(self):
        super().__init__()
        self.generate_query = dspy.Predict(GenerateSearchQuery)
        self.answer = dspy.ChainOfThought(AnswerWithContext)
    
    def forward(self, question: str, knowledge_base: str):
        # Step 1: Generate a search query
        query_result = self.generate_query(question=question)
        
        # Step 2: Simulate searching (in real app, would search knowledge_base)
        # For demo, we just use the knowledge_base directly
        context = knowledge_base
        
        # Step 3: Answer with context
        answer_result = self.answer(
            context=context,
            question=question
        )
        
        return dspy.Prediction(
            search_query=query_result.search_query,
            answer=answer_result.answer,
            rationale=answer_result.rationale
        )

# Usage
qa = ResearchQA()
result = qa(
    question="What are the benefits of DSPy?",
    knowledge_base="DSPy is a framework that makes LM programming more reliable and maintainable..."
)
print(result.answer)</code></pre>
                                </div>
                            </div>

                            <!-- dspy.Prediction -->
                            <div class="content-block">
                                <h2>üì¶ Returning Results with dspy.Prediction</h2>

                                <p>Use <code>dspy.Prediction</code> to return structured results from your modules:</p>

                                <div class="command-box">
                                    <pre><code class="language-python">class AnalysisPipeline(dspy.Module):
    def __init__(self):
        super().__init__()
        self.summarize = dspy.Predict(Summarize)
        self.analyze = dspy.ChainOfThought(Analyze)
    
    def forward(self, document: str):
        summary = self.summarize(text=document)
        analysis = self.analyze(text=document)
        
        # Return multiple outputs in a Prediction
        return dspy.Prediction(
            summary=summary.summary,
            analysis=analysis.conclusion,
            confidence=analysis.confidence,
            # You can add computed values too
            word_count=len(document.split())
        )

# Access all fields
result = pipeline(document="...")
print(result.summary)
print(result.analysis)
print(result.confidence)
print(result.word_count)</code></pre>
                                </div>
                            </div>

                            <!-- Adding Control Flow -->
                            <div class="content-block">
                                <h2>üîÑ Adding Control Flow</h2>

                                <p>Custom modules can include any Python logic:</p>

                                <div class="command-box">
                                    <pre><code class="language-python">class SmartClassifier(dspy.Module):
    def __init__(self):
        super().__init__()
        self.quick_classify = dspy.Predict(QuickClassify)
        self.deep_analyze = dspy.ChainOfThought(DeepAnalyze)
    
    def forward(self, text: str, use_deep_analysis: bool = False):
        # Conditional logic
        if use_deep_analysis or len(text) > 1000:
            result = self.deep_analyze(text=text)
            return dspy.Prediction(
                category=result.category,
                confidence=result.confidence,
                reasoning=result.rationale,
                method="deep"
            )
        else:
            result = self.quick_classify(text=text)
            return dspy.Prediction(
                category=result.category,
                confidence=0.8,  # Default confidence for quick
                reasoning="Quick classification",
                method="quick"
            )</code></pre>
                                </div>

                                <h3>Loops and Iteration</h3>

                                <div class="command-box">
                                    <pre><code class="language-python">class BatchProcessor(dspy.Module):
    def __init__(self):
        super().__init__()
        self.process_item = dspy.Predict(ProcessItem)
    
    def forward(self, items: list[str]):
        results = []
        
        # Process each item
        for item in items:
            result = self.process_item(item=item)
            results.append(result.output)
        
        return dspy.Prediction(
            results=results,
            count=len(results)
        )</code></pre>
                                </div>
                            </div>

                            <!-- Error Handling -->
                            <div class="content-block">
                                <h2>‚ö†Ô∏è Error Handling</h2>

                                <p>Handle failures gracefully in your modules:</p>

                                <div class="command-box">
                                    <pre><code class="language-python">class RobustTranslator(dspy.Module):
    def __init__(self):
        super().__init__()
        self.translate = dspy.Predict(Translate)
        self.fallback = dspy.Predict(SimpleTranslate)
    
    def forward(self, text: str, target_language: str):
        try:
            # Try primary translation
            result = self.translate(
                text=text,
                target_language=target_language
            )
            
            # Validate the result
            if not result.translation or len(result.translation) < 2:
                raise ValueError("Translation too short")
            
            return dspy.Prediction(
                translation=result.translation,
                status="success"
            )
            
        except Exception as e:
            # Fall back to simpler approach
            fallback_result = self.fallback(
                text=text,
                language=target_language
            )
            
            return dspy.Prediction(
                translation=fallback_result.translation,
                status="fallback",
                error=str(e)
            )</code></pre>
                                </div>
                            </div>

                            <!-- Practical Example -->
                            <div class="content-block">
                                <h2>üîß Practical Example: Content Pipeline</h2>

                                <p>A complete content generation pipeline:</p>

                                <div class="command-box">
                                    <pre><code class="language-python">import dspy
from typing import Literal

# Signatures
class GenerateOutline(dspy.Signature):
    """Generate a structured outline for a blog post."""
    topic: str = dspy.InputField()
    target_audience: str = dspy.InputField()
    outline: list[str] = dspy.OutputField(desc="List of section headings")

class WriteSection(dspy.Signature):
    """Write content for a specific section."""
    topic: str = dspy.InputField()
    section_heading: str = dspy.InputField()
    previous_sections: str = dspy.InputField()
    content: str = dspy.OutputField(desc="2-3 paragraphs")

class EditContent(dspy.Signature):
    """Edit and improve the draft content."""
    draft: str = dspy.InputField()
    focus: Literal["clarity", "engagement", "seo"] = dspy.InputField()
    edited: str = dspy.OutputField()

# The Pipeline Module
class BlogWriter(dspy.Module):
    def __init__(self):
        super().__init__()
        self.outliner = dspy.ChainOfThought(GenerateOutline)
        self.writer = dspy.Predict(WriteSection)
        self.editor = dspy.Predict(EditContent)
    
    def forward(self, topic: str, audience: str = "general"):
        # Step 1: Generate outline
        outline_result = self.outliner(
            topic=topic,
            target_audience=audience
        )
        sections = outline_result.outline
        
        # Step 2: Write each section
        all_content = []
        previous = ""
        
        for section in sections:
            section_result = self.writer(
                topic=topic,
                section_heading=section,
                previous_sections=previous
            )
            all_content.append(f"## {section}\n\n{section_result.content}")
            previous = "\n\n".join(all_content)
        
        # Step 3: Combine and edit
        draft = f"# {topic}\n\n" + "\n\n".join(all_content)
        
        final_result = self.editor(
            draft=draft,
            focus="engagement"
        )
        
        return dspy.Prediction(
            outline=sections,
            draft=draft,
            final=final_result.edited
        )

# Usage
writer = BlogWriter()
result = writer(
    topic="Getting Started with Python",
    audience="complete beginners"
)

print("=== Outline ===")
for section in result.outline:
    print(f"  - {section}")

print("\n=== Final Article ===")
print(result.final)</code></pre>
                                </div>
                            </div>

                            <!-- Best Practices -->
                            <div class="content-block">
                                <h2>‚úÖ Best Practices</h2>

                                <div class="chapter-sections-list">
                                    <div class="chapter-section-item">
                                        <span class="section-icon">üì¶</span>
                                        <div class="section-content">
                                            <h4>Keep Modules Focused</h4>
                                            <p>Each module should do one thing well. Create multiple small modules
                                                rather than one giant one.</p>
                                        </div>
                                    </div>
                                    <div class="chapter-section-item">
                                        <span class="section-icon">üè∑Ô∏è</span>
                                        <div class="section-content">
                                            <h4>Use Descriptive Names</h4>
                                            <p>Name your modules and methods clearly:
                                                <code>ContentGenerator</code>, not <code>CG</code>.
                                            </p>
                                        </div>
                                    </div>
                                    <div class="chapter-section-item">
                                        <span class="section-icon">üìù</span>
                                        <div class="section-content">
                                            <h4>Document Parameters</h4>
                                            <p>Add docstrings explaining what the module does and what inputs it
                                                expects.</p>
                                        </div>
                                    </div>
                                    <div class="chapter-section-item">
                                        <span class="section-icon">üß™</span>
                                        <div class="section-content">
                                            <h4>Test Each Step</h4>
                                            <p>Verify each sub-module works independently before composing them.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Key Takeaways -->
                            <div class="content-block summary-block">
                                <h2>üìù Key Takeaways</h2>

                                <div class="chapter-sections-list no-icons">
                                    <div class="chapter-section-item">
                                        <div class="section-content">
                                            <p><strong>Inherit from dspy.Module</strong> and call
                                                <code>super().__init__()</code>
                                            </p>
                                        </div>
                                    </div>
                                    <div class="chapter-section-item">
                                        <div class="section-content">
                                            <p><strong>Define sub-modules in __init__</strong> as instance
                                                attributes</p>
                                        </div>
                                    </div>
                                    <div class="chapter-section-item">
                                        <div class="section-content">
                                            <p><strong>Implement logic in forward</strong> ‚Äî called when module is
                                                invoked</p>
                                        </div>
                                    </div>
                                    <div class="chapter-section-item">
                                        <div class="section-content">
                                            <p><strong>Return dspy.Prediction</strong> for structured outputs</p>
                                        </div>
                                    </div>
                                    <div class="chapter-section-item">
                                        <div class="section-content">
                                            <p><strong>Use any Python logic</strong> ‚Äî conditionals, loops, error
                                                handling</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Continue -->
                            <div class="content-block">
                                <div class="continue-btn-container">
                                    <a href="module-composition.html" class="continue-btn">
                                        <span>Continue to Module Composition</span>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M5 12h14M12 5l7 7-7 7" />
                                        </svg>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </section>
                </article>
            </div>
        </main>
    </div>

    <footer>
        <p>&copy; 2025 DSPy Ebook. All rights reserved.</p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="../../assets/js/main.js?v=1"></script>
    <script src="../../assets/js/chapter_v2.js" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (window.initChapter) {
                window.initChapter({});
            }
            setTimeout(() => {
                if (window.Prism) window.Prism.highlightAll();
            }, 100);
        });
    </script>
</body>

</html>