<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module Composition | Chapter 3 | DSPy: The Comprehensive Guide</title>
    <meta name="description"
        content="Learn to compose DSPy modules into powerful multi-step pipelines and complex workflows.">
    <link rel="stylesheet" href="../../assets/css/style.css?v=2">
    <link rel="stylesheet" href="../../assets/css/chapter.css?v=8">
    <link rel="stylesheet" href="../../assets/css/content.css?v=2">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
</head>

<body class="chapter-page">
    <!-- Skip Link for Accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <header>
        <div class="logo">
            <a href="../../index.html">
                <img src="../../src/assets/logos/logo.png" alt="DSPy Ebook Logo">
                <span>DSPy Ebook</span>
            </a>
        </div>
        <nav>
            <ul>
                <li><a href="../../index.html">Home</a></li>
                <li><a href="../../index.html#chapters">Chapters</a></li>
                <li><a href="https://github.com/dustinober1/Ebook_DSPy" target="_blank">GitHub</a></li>
            </ul>
        </nav>
    </header>

    <div class="chapter-layout">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Chapter 3</h2>
                <span class="sidebar-subtitle">Modules</span>
            </div>
            <nav class="sidebar-nav">
                <ul class="section-list" id="section-list">
                    <li class="section-item viewed" data-section="intro">
                        <a href="index.html">
                            <span class="section-number">1</span>
                            <span class="section-title">Chapter Overview</span>
                        </a>
                    </li>
                    <li class="section-item viewed" data-section="what-are-modules">
                        <a href="what-are-modules.html">
                            <span class="section-number">2</span>
                            <span class="section-title">What Are Modules?</span>
                        </a>
                    </li>
                    <li class="section-item viewed" data-section="built-in-modules">
                        <a href="built-in-modules.html">
                            <span class="section-number">3</span>
                            <span class="section-title">Built-in Modules</span>
                        </a>
                    </li>
                    <li class="section-item viewed" data-section="custom-modules">
                        <a href="custom-modules.html">
                            <span class="section-number">4</span>
                            <span class="section-title">Creating Custom Modules</span>
                        </a>
                    </li>
                    <li class="section-item active" data-section="module-composition">
                        <a href="module-composition.html">
                            <span class="section-number">5</span>
                            <span class="section-title">Module Composition</span>
                        </a>
                    </li>
                    <li class="section-item" data-section="exercises">
                        <a href="exercises.html">
                            <span class="section-number">6</span>
                            <span class="section-title">Exercises</span>
                        </a>
                    </li>
                    <li class="section-item" data-section="solutions">
                        <a href="solutions.html">
                            <span class="section-number">7</span>
                            <span class="section-title">Solutions</span>
                        </a>
                    </li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <a href="../chapter-04/index.html" class="next-chapter-btn">
                    Next: Chapter 04 ‚Üí
                </a>
            </div>
        </aside>

        <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle Sidebar">
            <span></span>
            <span></span>
            <span></span>
        </button>

        <main class="chapter-content" id="main-content">
            <div class="reading-progress" id="reading-progress">
                <div class="progress-bar"></div>
            </div>

            <section class="chapter-hero">
                <div class="chapter-hero-content is-visible fade-in-up">
                    <span class="chapter-label">Chapter 3 ¬∑ Section 5</span>
                    <h1 class="chapter-title">Module Composition</h1>
                    <p class="chapter-description">Combine modules into sophisticated pipelines that handle complex,
                        multi-step workflows.</p>
                    <div class="chapter-meta">
                        <span class="meta-item">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            ~15 min read
                        </span>
                    </div>
                </div>
            </section>

            <div class="content-wrapper">
                <article class="content-article" id="content-article">
                    <section class="content-section is-visible" id="module-composition"
                        data-section="module-composition">
                        <div class="markdown-content" id="module-composition-content">

                            <!-- Introduction -->
                            <div class="content-block">
                                <h2>üîó The Power of Composition</h2>

                                <p>Module composition is where DSPy really shines. By nesting modules inside custom
                                    modules, you can build complex systems that are:</p>

                                <div class="chapter-sections-list">
                                    <div class="chapter-section-item">
                                        <span class="section-icon">üì¶</span>
                                        <div class="section-content">
                                            <h4>Modular</h4>
                                            <p>Each component can be developed, tested, and optimized independently.</p>
                                        </div>
                                    </div>
                                    <div class="chapter-section-item">
                                        <span class="section-icon">üîß</span>
                                        <div class="section-content">
                                            <h4>Maintainable</h4>
                                            <p>Changes to one module don't break others if interfaces are maintained.
                                            </p>
                                        </div>
                                    </div>
                                    <div class="chapter-section-item">
                                        <span class="section-icon">‚ö°</span>
                                        <div class="section-content">
                                            <h4>Optimizable</h4>
                                            <p>DSPy optimizers can tune all sub-modules together automatically.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Nesting Modules -->
                            <div class="content-block">
                                <h2>üèóÔ∏è Nesting Custom Modules</h2>

                                <p>Custom modules can contain other custom modules, creating a hierarchy:</p>

                                <div class="command-box">
                                    <pre><code class="language-python">import dspy

# Level 1: Basic modules with signatures
class Summarize(dspy.Signature):
    """Create a summary."""
    text: str = dspy.InputField()
    summary: str = dspy.OutputField()

class ExtractTopics(dspy.Signature):
    """Extract main topics."""
    text: str = dspy.InputField()
    topics: list[str] = dspy.OutputField()

# Level 2: Combine into a custom module
class ContentAnalyzer(dspy.Module):
    def __init__(self):
        super().__init__()
        self.summarizer = dspy.Predict(Summarize)
        self.topic_extractor = dspy.Predict(ExtractTopics)
    
    def forward(self, document: str):
        summary = self.summarizer(text=document)
        topics = self.topic_extractor(text=document)
        
        return dspy.Prediction(
            summary=summary.summary,
            topics=topics.topics
        )

# Level 3: Use ContentAnalyzer in another module
class DocumentProcessor(dspy.Module):
    def __init__(self):
        super().__init__()
        self.analyzer = ContentAnalyzer()  # Nested custom module!
        self.classifier = dspy.ChainOfThought(ClassifyDocument)
    
    def forward(self, document: str):
        # Use the nested module
        analysis = self.analyzer(document=document)
        
        # Use its outputs
        classification = self.classifier(
            summary=analysis.summary,
            topics=str(analysis.topics)
        )
        
        return dspy.Prediction(
            summary=analysis.summary,
            topics=analysis.topics,
            category=classification.category
        )</code></pre>
                                </div>
                            </div>

                            <!-- Pipeline Patterns -->
                            <div class="content-block">
                                <h2>üìä Common Pipeline Patterns</h2>

                                <h3>Sequential Pipeline</h3>
                                <p>Each step's output feeds into the next:</p>

                                <div class="command-box">
                                    <pre><code class="language-python">class SequentialPipeline(dspy.Module):
    def __init__(self):
        super().__init__()
        self.step1 = dspy.Predict(Step1Sig)
        self.step2 = dspy.Predict(Step2Sig)
        self.step3 = dspy.Predict(Step3Sig)
    
    def forward(self, input_data: str):
        # A ‚Üí B ‚Üí C
        result1 = self.step1(data=input_data)
        result2 = self.step2(data=result1.output)
        result3 = self.step3(data=result2.output)
        
        return result3</code></pre>
                                </div>

                                <h3>Parallel Pipeline</h3>
                                <p>Run multiple analyses on the same input, then combine:</p>

                                <div class="command-box">
                                    <pre><code class="language-python">class ParallelPipeline(dspy.Module):
    def __init__(self):
        super().__init__()
        self.sentiment = dspy.Predict(SentimentSig)
        self.topics = dspy.Predict(TopicsSig)
        self.entities = dspy.Predict(EntitiesSig)
        self.combiner = dspy.ChainOfThought(CombineSig)
    
    def forward(self, text: str):
        # Run in parallel (conceptually)
        sent_result = self.sentiment(text=text)
        topic_result = self.topics(text=text)
        entity_result = self.entities(text=text)
        
        # Combine results
        combined = self.combiner(
            sentiment=sent_result.sentiment,
            topics=str(topic_result.topics),
            entities=str(entity_result.entities)
        )
        
        return dspy.Prediction(
            sentiment=sent_result.sentiment,
            topics=topic_result.topics,
            entities=entity_result.entities,
            synthesis=combined.synthesis
        )</code></pre>
                                </div>

                                <h3>Branching Pipeline</h3>
                                <p>Choose different paths based on conditions:</p>

                                <div class="command-box">
                                    <pre><code class="language-python">class BranchingPipeline(dspy.Module):
    def __init__(self):
        super().__init__()
        self.classifier = dspy.Predict(ClassifySig)
        self.tech_handler = dspy.ChainOfThought(TechSig)
        self.general_handler = dspy.Predict(GeneralSig)
    
    def forward(self, query: str):
        # Classify first
        classification = self.classifier(query=query)
        
        # Branch based on result
        if classification.category == "technical":
            result = self.tech_handler(query=query)
            return dspy.Prediction(
                answer=result.answer,
                reasoning=result.rationale,
                path="technical"
            )
        else:
            result = self.general_handler(query=query)
            return dspy.Prediction(
                answer=result.answer,
                path="general"
            )</code></pre>
                                </div>
                            </div>

                            <!-- Data Flow -->
                            <div class="content-block">
                                <h2>üîÑ Managing Data Flow</h2>

                                <p>Careful data flow design is crucial for complex pipelines:</p>

                                <div class="command-box">
                                    <pre><code class="language-python">class DocumentQA(dspy.Module):
    """Answer questions about a document using organized data flow."""
    
    def __init__(self):
        super().__init__()
        # Preprocessing
        self.chunker = dspy.Predict(ChunkDocument)
        self.summarize_chunk = dspy.Predict(SummarizeChunk)
        
        # Core QA
        self.find_relevant = dspy.ChainOfThought(FindRelevant)
        self.answer = dspy.ChainOfThought(AnswerFromContext)
    
    def forward(self, document: str, question: str):
        # Step 1: Break into chunks
        chunks_result = self.chunker(document=document)
        chunks = chunks_result.chunks
        
        # Step 2: Summarize each chunk (for context)
        chunk_summaries = []
        for chunk in chunks:
            summary = self.summarize_chunk(chunk=chunk)
            chunk_summaries.append({
                "text": chunk,
                "summary": summary.summary
            })
        
        # Step 3: Find relevant chunks
        summaries_text = "\n".join([c["summary"] for c in chunk_summaries])
        relevant = self.find_relevant(
            question=question,
            chunk_summaries=summaries_text
        )
        
        # Step 4: Get relevant chunk texts
        relevant_indices = relevant.relevant_indices
        context = "\n\n".join([
            chunk_summaries[i]["text"] 
            for i in relevant_indices
        ])
        
        # Step 5: Answer with context
        answer = self.answer(
            context=context,
            question=question
        )
        
        return dspy.Prediction(
            answer=answer.answer,
            reasoning=answer.rationale,
            sources=relevant_indices
        )</code></pre>
                                </div>
                            </div>

                            <!-- Shared Components -->
                            <div class="content-block">
                                <h2>‚ôªÔ∏è Sharing Components</h2>

                                <p>You can pass shared modules to child modules for reuse:</p>

                                <div class="command-box">
                                    <pre><code class="language-python">class SharedEmbedder(dspy.Module):
    """A shared component for text processing."""
    def __init__(self):
        super().__init__()
        self.process = dspy.Predict(ProcessText)
    
    def forward(self, text: str):
        return self.process(text=text)

class ModuleA(dspy.Module):
    def __init__(self, embedder: SharedEmbedder):
        super().__init__()
        self.embedder = embedder  # Shared component
        self.analyze = dspy.Predict(AnalyzeSig)
    
    def forward(self, text: str):
        processed = self.embedder(text=text)
        return self.analyze(processed=processed.output)

class ModuleB(dspy.Module):
    def __init__(self, embedder: SharedEmbedder):
        super().__init__()
        self.embedder = embedder  # Same shared component!
        self.classify = dspy.Predict(ClassifySig)
    
    def forward(self, text: str):
        processed = self.embedder(text=text)
        return self.classify(processed=processed.output)

# Usage: share a single embedder
shared_embedder = SharedEmbedder()
module_a = ModuleA(embedder=shared_embedder)
module_b = ModuleB(embedder=shared_embedder)</code></pre>
                                </div>
                            </div>

                            <!-- Real-World Example -->
                            <div class="content-block">
                                <h2>üîß Real-World Example: Customer Support Bot</h2>

                                <div class="command-box">
                                    <pre><code class="language-python">import dspy
from typing import Literal

# Signatures
class IntentClassification(dspy.Signature):
    """Classify the customer's intent."""
    message: str = dspy.InputField()
    intent: Literal["question", "complaint", "feedback", "request"] = dspy.OutputField()
    urgency: Literal["low", "medium", "high"] = dspy.OutputField()

class GenerateResponse(dspy.Signature):
    """Generate a helpful customer support response."""
    message: str = dspy.InputField()
    intent: str = dspy.InputField()
    context: str = dspy.InputField()
    response: str = dspy.OutputField()

class ExtractActionItems(dspy.Signature):
    """Extract any actions needed from the conversation."""
    message: str = dspy.InputField()
    response: str = dspy.InputField()
    action_items: list[str] = dspy.OutputField()

# The Complete Support Bot
class CustomerSupportBot(dspy.Module):
    def __init__(self, knowledge_base: str = ""):
        super().__init__()
        self.knowledge_base = knowledge_base
        
        # Sub-modules
        self.intent_classifier = dspy.Predict(IntentClassification)
        self.response_generator = dspy.ChainOfThought(GenerateResponse)
        self.action_extractor = dspy.Predict(ExtractActionItems)
    
    def forward(self, customer_message: str):
        # Step 1: Understand intent
        intent_result = self.intent_classifier(message=customer_message)
        
        # Step 2: Generate response with context
        response_result = self.response_generator(
            message=customer_message,
            intent=intent_result.intent,
            context=self.knowledge_base
        )
        
        # Step 3: Extract any follow-up actions
        actions = self.action_extractor(
            message=customer_message,
            response=response_result.response
        )
        
        return dspy.Prediction(
            intent=intent_result.intent,
            urgency=intent_result.urgency,
            response=response_result.response,
            reasoning=response_result.rationale,
            action_items=actions.action_items
        )

# Usage
bot = CustomerSupportBot(
    knowledge_base="Our return policy is 30 days. Shipping takes 3-5 days..."
)

result = bot(customer_message="I haven't received my order yet and it's been 2 weeks!")

print(f"Intent: {result.intent}")         # complaint
print(f"Urgency: {result.urgency}")       # high
print(f"Response: {result.response}")
print(f"Actions: {result.action_items}")  # ['Check shipping status', ...]</code></pre>
                                </div>
                            </div>

                            <!-- Key Takeaways -->
                            <div class="content-block summary-block">
                                <h2>üìù Key Takeaways</h2>

                                <div class="chapter-sections-list no-icons">
                                    <div class="chapter-section-item">
                                        <div class="section-content">
                                            <p><strong>Nest custom modules</strong> inside other custom modules for
                                                complex hierarchies</p>
                                        </div>
                                    </div>
                                    <div class="chapter-section-item">
                                        <div class="section-content">
                                            <p><strong>Sequential, parallel, branching</strong> ‚Äî choose the right
                                                pattern</p>
                                        </div>
                                    </div>
                                    <div class="chapter-section-item">
                                        <div class="section-content">
                                            <p><strong>Manage data flow carefully</strong> between pipeline steps</p>
                                        </div>
                                    </div>
                                    <div class="chapter-section-item">
                                        <div class="section-content">
                                            <p><strong>Share components</strong> across modules when appropriate</p>
                                        </div>
                                    </div>
                                    <div class="chapter-section-item">
                                        <div class="section-content">
                                            <p><strong>DSPy tracks all sub-modules</strong> for unified optimization
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Continue -->
                            <div class="content-block">
                                <div class="continue-btn-container">
                                    <a href="exercises.html" class="continue-btn">
                                        <span>Continue to Exercises</span>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M5 12h14M12 5l7 7-7 7" />
                                        </svg>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </section>
                </article>
            </div>
        </main>
    </div>

    <footer>
        <p>&copy; 2025 DSPy Ebook. All rights reserved.</p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="../../assets/js/main.js?v=1"></script>
    <script src="../../assets/js/chapter_v2.js" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (window.initChapter) {
                window.initChapter({});
            }
            setTimeout(() => {
                if (window.Prism) window.Prism.highlightAll();
            }, 100);
        });
    </script>
</body>

</html>