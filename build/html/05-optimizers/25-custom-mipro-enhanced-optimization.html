<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>CustomMIPROv2: Enhanced Multi-Stage Prompt Optimization - DSPy: A Practical Guide</title>


        <!-- Custom HTML head -->

        <meta name="description" content="The most comprehensive DSPy guide with complete coverage of 9 research papers, advanced optimization techniques, and production-ready applications">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon-de23e50b.svg">
        <link rel="shortcut icon" href="../favicon-8114d1fc.png">
        <link rel="stylesheet" href="../css/variables-8adf115d.css">
        <link rel="stylesheet" href="../css/general-2459343d.css">
        <link rel="stylesheet" href="../css/chrome-ae938929.css">
        <link rel="stylesheet" href="../css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="../highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="../tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="../ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../assets/custom-5fe0be54.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex-8a4736e7.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc-90eb277b.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">DSPy: A Practical Guide</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>
                        <a href="https://github.com/dustinober1/Ebook_DSPy" title="Git repository" aria-label="Git repository">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span>
                        </a>
                        <a href="https://github.com/dustinober1/Ebook_DSPy/edit/main/src/05-optimizers/25-custom-mipro-enhanced-optimization.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <span class=fa-svg id="git-edit-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M421.7 220.3l-11.3 11.3-22.6 22.6-205 205c-6.6 6.6-14.8 11.5-23.8 14.1L30.8 511c-8.4 2.5-17.5 .2-23.7-6.1S-1.5 489.7 1 481.2L38.7 353.1c2.6-9 7.5-17.2 14.1-23.8l205-205 22.6-22.6 11.3-11.3 33.9 33.9 62.1 62.1 33.9 33.9zM96 353.9l-9.3 9.3c-.9 .9-1.6 2.1-2 3.4l-25.3 86 86-25.3c1.3-.4 2.5-1.1 3.4-2l9.3-9.3H112c-8.8 0-16-7.2-16-16V353.9zM453.3 19.3l39.4 39.4c25 25 25 65.5 0 90.5l-14.5 14.5-22.6 22.6-11.3 11.3-33.9-33.9-62.1-62.1L314.3 67.7l11.3-11.3 22.6-22.6 14.5-14.5c25-25 65.5-25 90.5 0z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="custommiprov2-enhanced-multi-stage-prompt-optimization"><a class="header" href="#custommiprov2-enhanced-multi-stage-prompt-optimization">CustomMIPROv2: Enhanced Multi-Stage Prompt Optimization</a></h1>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p><strong>CustomMIPROv2</strong> is an enhanced version of the MIPROv2 optimizer that addresses real-world production needs through a two-stage optimization process and explicit constraint handling. This optimizer was developed through extensive multi-use case studies and demonstrates significant improvements in complex tasks like routing agents, prompt evaluation, and code generation.</p>
<h2 id="key-enhancements"><a class="header" href="#key-enhancements">Key Enhancements</a></h2>
<ol>
<li><strong>Two-Stage Instruction Generation</strong>: Separates constraint extraction from instruction generation for better focus</li>
<li><strong>Explicit Constraint Handling</strong>: Users can provide domain-specific constraints and optimization tips</li>
<li><strong>Mini-Batch Evaluation</strong>: Efficient evaluation using representative subsets</li>
<li><strong>Context-Aware Optimization</strong>: Better handling of long conversations and complex contexts</li>
<li><strong>Production-Ready Extraction</strong>: Optimized prompts designed for extraction from DSPy framework</li>
</ol>
<h2 id="architecture"><a class="header" href="#architecture">Architecture</a></h2>
<h3 id="1-two-stage-optimization-process"><a class="header" href="#1-two-stage-optimization-process">1. Two-Stage Optimization Process</a></h3>
<pre><code class="language-python">import dspy
from typing import List, Dict, Optional, Tuple
import random
from dataclasses import dataclass

@dataclass
class OptimizationConstraint:
    """Represents a constraint for prompt optimization."""
    name: str
    description: str
    priority: str  # HIGH, MEDIUM, LOW
    examples: List[str] = None

class CustomMIPROv2:
    """Enhanced MIPROv2 optimizer with two-stage optimization."""

    def __init__(self,
                 teacher_model: str = "gpt-4",
                 student_model: str = "gpt-4o-mini",
                 num_trials: int = 15,
                 mini_batch_size: int = 15,
                 temperature: float = 0.5):
        self.teacher_model = teacher_model
        self.student_model = student_model
        self.num_trials = num_trials
        self.mini_batch_size = mini_batch_size
        self.temperature = temperature

        # Optimization stages
        self.constraint_extractor = dspy.Predict(
            """Analyze the provided task demonstrations and extract key constraints
            and edge cases that the optimized instruction should handle.

            Task Demonstrations:
            {demonstrations}

            Program Context:
            {program_context}

            Extract:
            1. Critical constraints (must-follow rules)
            2. Edge cases to consider
            3. Common failure patterns
            4. Important contextual factors

            Constraints and Edge Cases:"""
        )

        self.instruction_generator = dspy.ChainOfThought(
            """Generate an optimized instruction based on constraints and examples.

            Task Description: {task_description}
            Constraints: {constraints}
            Edge Cases: {edge_cases}
            Tips/Guidance: {tips}

            Requirements:
            - Address all high-priority constraints
            - Handle identified edge cases
            - Follow provided tips when applicable
            - Keep instruction clear and concise
            - Maintain consistency with examples

            Optimized Instruction:"""
        )

    def compile(self,
                program: dspy.Module,
                trainset: List[dspy.Example],
                valset: List[dspy.Example],
                metric: callable,
                tips: Optional[List[str]] = None,
                constraints: Optional[List[OptimizationConstraint]] = None) -&gt; dspy.Module:
        """Compile the program with enhanced optimization."""

        # Store references
        self.program = program
        self.trainset = trainset
        self.valset = valset
        self.metric = metric
        self.tips = tips or []
        self.constraints = constraints or []

        # Stage 1: Extract constraints from demonstrations
        print("Stage 1: Extracting constraints and edge cases...")
        extracted_constraints = self._extract_constraints_from_demos()

        # Combine user constraints with extracted ones
        all_constraints = self._combine_constraints(extracted_constraints, constraints)

        # Stage 2: Generate and evaluate optimized instructions
        print("Stage 2: Generating optimized instructions...")
        best_instruction = self._optimize_instructions(all_constraints, tips)

        # Create and return optimized program
        optimized_program = self._create_optimized_program(best_instruction)

        return optimized_program

    def _extract_constraints_from_demos(self) -&gt; Dict:
        """Extract constraints from training demonstrations."""

        # Sample demonstrations for analysis
        demo_samples = random.sample(self.trainset, min(10, len(self.trainset)))

        # Extract program context
        program_context = self._analyze_program_structure()

        # Format demonstrations for analysis
        demo_text = "\n".join([
            f"Input: {demo.inputs()}\nOutput: {demo.outputs()}"
            for demo in demo_samples
        ])

        # Extract constraints
        extraction_result = self.constraint_extractor(
            demonstrations=demo_text,
            program_context=program_context
        )

        # Parse and structure the extraction
        constraints = self._parse_constraint_extraction(extraction_result)

        return constraints

    def _optimize_instructions(self,
                             constraints: Dict,
                             tips: List[str]) -&gt; str:
        """Generate and evaluate multiple instruction candidates."""

        # Create mini-batches for evaluation
        mini_batches = self._create_mini_batches(self.valset, self.mini_batch_size)

        best_instruction = None
        best_score = 0.0

        for trial in range(self.num_trials):
            print(f"Trial {trial + 1}/{self.num_trials}")

            # Generate instruction candidate
            instruction_candidate = self._generate_instruction_candidate(
                constraints, tips, trial
            )

            # Evaluate on mini-batches
            avg_score = 0.0
            for batch_idx, batch in enumerate(mini_batches):
                # Create temporary program with new instruction
                temp_program = self._create_temp_program(instruction_candidate)

                # Evaluate on this batch
                batch_score = self._evaluate_on_batch(temp_program, batch)
                avg_score += batch_score

            avg_score /= len(mini_batches)

            print(f"  Score: {avg_score:.3f}")

            # Update best if improved
            if avg_score &gt; best_score:
                best_score = avg_score
                best_instruction = instruction_candidate
                print(f"  New best instruction found!")

        print(f"\nOptimization complete. Best score: {best_score:.3f}")
        return best_instruction

    def _generate_instruction_candidate(self,
                                      constraints: Dict,
                                      tips: List[str],
                                      trial: int) -&gt; str:
        """Generate a single instruction candidate."""

        # Select random tips for variety
        selected_tips = random.sample(
            tips + ["Focus on clarity and conciseness"],
            min(2, len(tips) + 1)
        )

        # Get random demonstration for reference
        demo = random.choice(self.trainset[:5])

        # Generate instruction
        result = self.instruction_generator(
            task_description=self._get_task_description(),
            constraints=self._format_constraints(constraints),
            edge_cases=constraints.get('edge_cases', []),
            tips="\n".join([f"- {tip}" for tip in selected_tips])
        )

        return result.optimized_instruction

    def _evaluate_on_batch(self, program: dspy.Module, batch: List[dspy.Example]) -&gt; float:
        """Evaluate program on a mini-batch."""

        total_score = 0.0
        valid_examples = 0

        for example in batch:
            try:
                # Get prediction
                prediction = program(**example.inputs())

                # Evaluate
                score = self.metric(example, prediction, trace=None)
                total_score += score
                valid_examples += 1

            except Exception as e:
                print(f"    Error evaluating example: {e}")
                continue

        return total_score / valid_examples if valid_examples &gt; 0 else 0.0

    def _create_optimized_program(self, best_instruction: str) -&gt; dspy.Module:
        """Create the final optimized program."""

        # Clone the original program
        optimized_program = self._clone_program(self.program)

        # Update all Predict modules with optimized instruction
        for name, module in optimized_program.named_modules():
            if isinstance(module, dspy.Predict):
                module.update(instruction=best_instruction)

        return optimized_program
</code></pre>
<h3 id="2-routing-agent-optimization-example"><a class="header" href="#2-routing-agent-optimization-example">2. Routing Agent Optimization Example</a></h3>
<pre><code class="language-python">class RoutingAgentOptimizer:
    """Example: Optimizing a routing agent using CustomMIPROv2."""

    def __init__(self):
        # Define the routing signature
        class RouterSignature(dspy.Signature):
            """Read the conversation and select the next role from roles_list
            to play. Only return the role."""
            conversation = dspy.InputField(desc="Current conversation history")
            roles_list = dspy.InputField(desc="List of available roles")
            roles = dspy.InputField(desc="Role descriptions")
            selected_role = dspy.OutputField(
                desc="Selected role from the list"
            )

        self.signature = RouterSignature

        # Base program
        self.base_program = dspy.Predict(self.signature)

        # Training data (conversations with correct role selections)
        self.trainset = self._load_routing_examples("routing_train.json")
        self.valset = self._load_routing_examples("routing_val.json")

    def optimize_routing_agent(self) -&gt; dspy.Module:
        """Optimize the routing agent for better performance."""

        # Define domain-specific constraints
        routing_constraints = [
            OptimizationConstraint(
                name="task_completion",
                description="If the last role didn't complete their task, they must be selected again",
                priority="HIGH"
            ),
            OptimizationConstraint(
                name="conversation_flow",
                description="Consider the flow and tone when selecting roles",
                priority="MEDIUM"
            ),
            OptimizationConstraint(
                name="role_availability",
                description="Only select from the provided roles list",
                priority="HIGH"
            )
        ]

        # Define optimization tips
        optimization_tips = [
            "The model should be aware of conversation context and tone",
            "Consider the current state of task completion",
            "Match role selection to conversation needs",
            "Maintain conversation coherence and flow"
        ]

        # Define evaluation metric
        def routing_metric(example, prediction, trace=None):
            """Evaluate routing accuracy."""
            expected_role = example.outputs()['selected_role']
            predicted_role = prediction.get('selected_role', '')

            return 1.0 if predicted_role == expected_role else 0.0

        # Initialize CustomMIPROv2
        optimizer = CustomMIPROv2(
            teacher_model="gpt-4",
            student_model="gpt-4o-mini",
            num_trials=12,
            mini_batch_size=15,
            temperature=0.5
        )

        # Compile optimized program
        optimized_program = optimizer.compile(
            program=self.base_program,
            trainset=self.trainset,
            valset=self.valset,
            metric=routing_metric,
            tips=optimization_tips,
            constraints=routing_constraints
        )

        return optimized_program

    def _load_routing_examples(self, file_path: str) -&gt; List[dspy.Example]:
        """Load routing examples from file."""
        # Implementation depends on data format
        examples = []

        # Sample data structure
        sample_data = {
            "conversation": "User: I need help with the report\nAdmin: I'll help you with that",
            "roles": ["Human_Administrator", "Project_Manager", "Software_Engineer"],
            "selected_role": "Human_Administrator"
        }

        # Convert to DSPy examples
        for item in load_json(file_path):
            example = dspy.Example(
                conversation=item["conversation"],
                roles_list=", ".join(item["roles"]),
                roles=item["roles"]
            ).with_outputs(selected_role=item["selected_role"])
            examples.append(example)

        return examples
</code></pre>
<h3 id="3-prompt-evaluator-optimization"><a class="header" href="#3-prompt-evaluator-optimization">3. Prompt Evaluator Optimization</a></h3>
<pre><code class="language-python">class PromptEvaluatorOptimizer:
    """Example: Optimizing a prompt evaluator for contradiction detection."""

    def __init__(self):
        # Define evaluation signature
        class ContradictionSignature(dspy.Signature):
            """Evaluate the prompt on a scale from 0.0 (high contradiction)
            to 1.0 (no contradiction) based on internal consistency."""
            prompt = dspy.InputField(desc="The prompt to evaluate")
            score = dspy.OutputField(desc="Score between 0.0 and 1.0")
            explanation = dspy.OutputField(desc="Explanation of the score")

        self.signature = ContradictionSignature

        # Load contradiction detection dataset
        self.trainset = self._load_contradiction_examples("contradictions_train.json")
        self.valset = self._load_contradiction_examples("contradictions_val.json")

    def optimize_contradiction_detector(self) -&gt; dspy.Module:
        """Optimize contradiction detection with specific constraints."""

        # Define contradiction-specific constraints
        contradiction_constraints = [
            OptimizationConstraint(
                name="format_contradiction",
                description="Check if output format conflicts with instructions",
                priority="HIGH",
                examples=["Instructions say 'no examples' but examples are provided"]
            ),
            OptimizationConstraint(
                name="instruction_contradiction",
                description="Check for conflicting instructions",
                priority="HIGH",
                examples=["Do X AND Don't do X"]
            ),
            OptimizationConstraint(
                name="example_contradiction",
                description="Check if examples don't follow instructions",
                priority="MEDIUM",
                examples=["Example shows different format than instructed"]
            )
        ]

        # Custom tip for contradiction detection
        contradiction_tips = [
            "Carefully examine all instruction pairs for conflicts",
            "Verify that examples strictly follow the instructions",
            "Check for ambiguous or conflicting requirements",
            "Score 0.0 if ANY contradiction is found"
        ]

        # Evaluation metric
        def contradiction_metric(example, prediction, trace=None):
            """Evaluate contradiction detection accuracy."""
            predicted_score = float(prediction.get('score', 0.5))
            expected_label = example.outputs()['has_contradiction']
            predicted_label = predicted_score &lt; 0.6

            return 1.0 if predicted_label == expected_label else 0.0

        # Initialize optimizer
        optimizer = CustomMIPROv2(
            num_trials=10,
            mini_batch_size=10,
            temperature=0.5
        )

        # Optimize
        optimized_detector = optimizer.compile(
            program=dspy.Predict(self.signature),
            trainset=self.trainset,
            valset=self.valset,
            metric=contradiction_metric,
            tips=contradiction_tips,
            constraints=contradiction_constraints
        )

        return optimized_detector
</code></pre>
<h3 id="4-code-generation-optimization"><a class="header" href="#4-code-generation-optimization">4. Code Generation Optimization</a></h3>
<pre><code class="language-python">class CodeGenerationOptimizer:
    """Example: Optimizing code generation with CustomMIPROv2."""

    def __init__(self):
        # Code generation signature
        class CodeGenSignature(dspy.Signature):
            """Generate pandas code to answer the user's question."""
            question = dspy.InputField(desc="User's data analysis question")
            columns = dspy.InputField(desc="Available columns and sample values")
            code = dspy.OutputField(desc="Generated pandas code")

        self.signature = CodeGenSignature

        # Load code generation dataset
        self.trainset = self._load_code_examples("code_train.json")
        self.valset = self._load_code_examples("code_val.json")

    def optimize_code_generator(self) -&gt; dspy.Module:
        """Optimize code generation with quality constraints."""

        # Code quality constraints
        code_constraints = [
            OptimizationConstraint(
                name="executable_code",
                description="Generated code must be syntactically correct and executable",
                priority="HIGH"
            ),
            OptimizationConstraint(
                name="efficiency",
                description="Code should be efficient and not overly complex",
                priority="MEDIUM"
            ),
            OptimizationConstraint(
                name="relevance",
                description="Code must directly address the user's question",
                priority="HIGH"
            ),
            OptimizationConstraint(
                name="readability",
                description="Include appropriate comments and clear structure",
                priority="LOW"
            )
        ]

        # Code generation tips
        code_tips = [
            "Use pandas built-in methods when possible",
            "Handle potential errors or edge cases",
            "Keep code concise but complete",
            "Add minimal but helpful comments"
        ]

        # LLM-as-a-Judge for code evaluation
        def code_quality_metric(example, prediction, trace=None):
            """Evaluate generated code quality using LLM judge."""

            code = prediction.get('code', '')
            question = example.inputs()['question']

            # Create judge prompt
            judge = dspy.ChainOfThought(
                """Evaluate the generated code for the given question.

                Question: {question}
                Generated Code: {code}

                Evaluate on:
                1. Correctness (0-1): Does it solve the problem correctly?
                2. Efficiency (0-1): Is it reasonably efficient?
                3. Readability (0-1): Is it well-structured?

                Overall Score (0-1):"""
            )

            result = judge(question=question, code=code)
            score = float(result.overall_score) if hasattr(result, 'overall_score') else 0.5

            return score

        # Initialize optimizer
        optimizer = CustomMIPROv2(
            num_trials=15,
            mini_batch_size=20,
            temperature=0.3
        )

        # Optimize
        optimized_generator = optimizer.compile(
            program=dspy.Predict(self.signature),
            trainset=self.trainset,
            valset=self.valset,
            metric=code_quality_metric,
            tips=code_tips,
            constraints=code_constraints
        )

        return optimized_generator
</code></pre>
<h2 id="implementation-guide"><a class="header" href="#implementation-guide">Implementation Guide</a></h2>
<h3 id="1-basic-usage"><a class="header" href="#1-basic-usage">1. Basic Usage</a></h3>
<pre><code class="language-python"># Define your DSPy program
class MyProgram(dspy.Module):
    def __init__(self):
        super().__init__()
        self.predict = dspy.Predict("question -&gt; answer")

    def forward(self, question):
        return self.predict(question=question)

# Create training and validation sets
trainset = [...]
valset = [...]

# Define evaluation metric
def my_metric(example, prediction, trace=None):
    # Your metric logic
    return 1.0 if prediction.answer == example.answer else 0.0

# Initialize CustomMIPROv2
optimizer = CustomMIPROv2(
    teacher_model="gpt-4",
    student_model="gpt-4o-mini",
    num_trials=20,
    mini_batch_size=15
)

# Optimize
optimized_program = optimizer.compile(
    program=MyProgram(),
    trainset=trainset,
    valset=valset,
    metric=my_metric
)
</code></pre>
<h3 id="2-using-constraints-and-tips"><a class="header" href="#2-using-constraints-and-tips">2. Using Constraints and Tips</a></h3>
<pre><code class="language-python"># Define constraints
constraints = [
    OptimizationConstraint(
        name="safety",
        description="Never provide harmful or unsafe content",
        priority="HIGH"
    ),
    OptimizationConstraint(
        name="clarity",
        description="Use clear and unambiguous language",
        priority="MEDIUM"
    )
]

# Define tips
tips = [
    "Consider safety implications before answering",
    "Provide structured responses when possible",
    "Acknowledge uncertainty when appropriate"
]

# Compile with constraints and tips
optimized = optimizer.compile(
    program=MyProgram(),
    trainset=trainset,
    valset=valset,
    metric=my_metric,
    tips=tips,
    constraints=constraints
)
</code></pre>
<h3 id="3-extracting-and-using-optimized-prompts"><a class="header" href="#3-extracting-and-using-optimized-prompts">3. Extracting and Using Optimized Prompts</a></h3>
<pre><code class="language-python"># Get the optimized instruction
optimized_instruction = optimized_program.predict.instruction

# Use outside DSPy (with caution)
def use_optimized_prompt_elsewhere():
    import openai

    response = openai.chat.completions.create(
        model="gpt-4o-mini",
        messages=[
            {"role": "system", "content": optimized_instruction},
            {"role": "user", "content": "Your input here"}
        ]
    )

    return response.choices[0].message.content

# Note: Performance may vary outside DSPy context
</code></pre>
<h2 id="key-results-from-paper"><a class="header" href="#key-results-from-paper">Key Results from Paper</a></h2>
<ol>
<li><strong>Routing Agent</strong>: Improved from 85.71% to 90.47% accuracy (5% absolute improvement)</li>
<li><strong>Prompt Evaluator</strong>: Improved from 46.2% to 76.9% accuracy (30% absolute improvement)</li>
<li><strong>Code Generation</strong>: Achieved 90% accuracy with optimized prompts</li>
<li><strong>Jailbreak Detection</strong>: Maintained perfect recall while improving precision</li>
<li><strong>Hallucination Detection</strong>: Up to 82% accuracy with optimized examples</li>
</ol>
<h2 id="best-practices"><a class="header" href="#best-practices">Best Practices</a></h2>
<ol>
<li><strong>Clear Constraints</strong>: Define specific, actionable constraints with examples</li>
<li><strong>Domain-Specific Tips</strong>: Provide tips that are relevant to your task domain</li>
<li><strong>Appropriate Mini-Batch Size</strong>: Balance evaluation cost with accuracy</li>
<li><strong>Sufficient Trials</strong>: Use enough trials to explore the instruction space</li>
<li><strong>Metric Design</strong>: Ensure metrics capture important aspects of performance</li>
</ol>
<h2 id="advanced-features"><a class="header" href="#advanced-features">Advanced Features</a></h2>
<h3 id="1-constraint-prioritization"><a class="header" href="#1-constraint-prioritization">1. Constraint Prioritization</a></h3>
<pre><code class="language-python">class PrioritizedCustomMIPROv2(CustomMIPROv2):
    """Enhanced version with constraint prioritization."""

    def _format_constraints(self, constraints: Dict) -&gt; str:
        """Format constraints with priority information."""

        formatted = []
        for constraint in constraints.get('high_priority', []):
            formatted.append(f"MUST: {constraint}")

        for constraint in constraints.get('medium_priority', []):
            formatted.append(f"SHOULD: {constraint}")

        for constraint in constraints.get('low_priority', []):
            formatted.append(f"COULD: {constraint}")

        return "\n".join(formatted)
</code></pre>
<h3 id="2-adaptive-trial-management"><a class="header" href="#2-adaptive-trial-management">2. Adaptive Trial Management</a></h3>
<pre><code class="language-python">class AdaptiveCustomMIPROv2(CustomMIPROv2):
    """Version with adaptive trial management."""

    def optimize_instructions(self, constraints, tips):
        """Optimize with early stopping based on improvement."""

        best_score = 0.0
        no_improvement_count = 0
        max_no_improvement = 5

        for trial in range(self.num_trials):
            # Generate and evaluate candidate
            candidate = self._generate_instruction_candidate(constraints, tips, trial)
            score = self._evaluate_candidate(candidate)

            # Check for improvement
            if score &gt; best_score:
                best_score = score
                best_instruction = candidate
                no_improvement_count = 0
            else:
                no_improvement_count += 1

            # Early stopping
            if no_improvement_count &gt;= max_no_improvement:
                print(f"Early stopping at trial {trial + 1}")
                break

        return best_instruction
</code></pre>
<h2 id="limitations-and-considerations"><a class="header" href="#limitations-and-considerations">Limitations and Considerations</a></h2>
<ol>
<li><strong>Extraction Overhead</strong>: Two-stage process increases optimization time</li>
<li><strong>Constraint Quality</strong>: Poorly defined constraints can hurt performance</li>
<li><strong>Mini-Batch Representativeness</strong>: Small batches may not represent full validation set</li>
<li><strong>Context Transfer</strong>: Optimized prompts may perform differently outside DSPy</li>
<li><strong>Compute Cost</strong>: Multiple trials increase API costs</li>
</ol>
<h2 id="conclusion"><a class="header" href="#conclusion">Conclusion</a></h2>
<p>CustomMIPROv2 addresses practical challenges in prompt optimization for production systems. By separating constraint extraction from instruction generation and providing explicit control through constraints and tips, it enables more targeted and effective optimization. The framework demonstrates that systematic optimization can significantly improve performance across diverse tasks, from routing agents to code generation, making it a valuable tool for real-world DSPy applications.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../05-optimizers/24-inpars-plus-synthetic-data-ir.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="../05-optimizers/26-automatic-prompt-optimization-research.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../05-optimizers/24-inpars-plus-synthetic-data-ir.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="../05-optimizers/26-automatic-prompt-optimization-research.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>


        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace-2a3cd908.js"></script>
        <script src="../mode-rust-2c9d5c9a.js"></script>
        <script src="../editor-16ca416c.js"></script>
        <script src="../theme-dawn-4493f9c8.js"></script>
        <script src="../theme-tomorrow_night-9dbe62a9.js"></script>

        <script src="../elasticlunr-ef4e11c1.min.js"></script>
        <script src="../mark-09e88c2c.min.js"></script>
        <script src="../searcher-c2a407aa.js"></script>

        <script src="../clipboard-1626706a.min.js"></script>
        <script src="../highlight-abc7f01d.js"></script>
        <script src="../book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
