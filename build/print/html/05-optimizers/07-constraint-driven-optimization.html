<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Constraint-Driven Optimization - DSPy: A Practical Guide</title>


        <!-- Custom HTML head -->

        <meta name="description" content="The most comprehensive DSPy guide with complete coverage of 9 research papers, advanced optimization techniques, and production-ready applications">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon-de23e50b.svg">
        <link rel="shortcut icon" href="../favicon-8114d1fc.png">
        <link rel="stylesheet" href="../css/variables-8adf115d.css">
        <link rel="stylesheet" href="../css/general-2459343d.css">
        <link rel="stylesheet" href="../css/chrome-ae938929.css">
        <link rel="stylesheet" href="../css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="../highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="../tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="../ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../assets/print-only-ef201963.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc-4ea68664.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                    </div>

                    <h1 class="menu-title">DSPy: A Practical Guide</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>

                    </div>
                </div>


                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="constraint-driven-optimization"><a class="header" href="#constraint-driven-optimization">Constraint-Driven Optimization</a></h1>
<h2 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h2>
<ul>
<li><strong>Previous Section</strong>: <a href="./06-choosing-optimizers.html">Choosing Optimizers</a> - Understanding optimizer selection</li>
<li><strong>Chapter 3</strong>: Assertions Module - Familiarity with assertion concepts</li>
<li><strong>Required Knowledge</strong>: Optimization theory, constraint satisfaction</li>
<li><strong>Difficulty Level</strong>: Advanced</li>
<li><strong>Estimated Reading Time</strong>: 50 minutes</li>
</ul>
<h2 id="learning-objectives"><a class="header" href="#learning-objectives">Learning Objectives</a></h2>
<p>By the end of this section, you will:</p>
<ul>
<li>Understand how to optimize DSPy programs with constraints</li>
<li>Master the integration of assertions with optimization algorithms</li>
<li>Learn to design constraint-aware optimization objectives</li>
<li>Build robust systems that maintain quality during optimization</li>
<li>Apply advanced techniques for constraint handling in large-scale systems</li>
</ul>
<h2 id="introduction-to-constraint-driven-optimization"><a class="header" href="#introduction-to-constraint-driven-optimization">Introduction to Constraint-Driven Optimization</a></h2>
<p>Constraint-driven optimization extends DSPy’s optimization framework to incorporate runtime constraints and validation directly into the optimization process. This ensures that optimized programs not only perform better on metrics but also satisfy critical requirements for correctness, format, and quality.</p>
<h3 id="traditional-vs-constraint-driven-optimization"><a class="header" href="#traditional-vs-constraint-driven-optimization">Traditional vs Constraint-Driven Optimization</a></h3>
<p><strong>Traditional Optimization:</strong></p>
<pre><code class="language-python"># Only optimizes for metric performance
optimizer = dspy.BootstrapFewShot(metric=answer_f1_score)
optimized_program = optimizer.compile(
    student_program,
    trainset=trainset
)
# May sacrifice quality for metric gains
</code></pre>
<p><strong>Constraint-Driven Optimization:</strong></p>
<pre><code class="language-python"># Optimizes while maintaining constraints
def constrained_metric(example, pred, trace):
    # First check constraints
    if not validate_format(pred):
        return 0.0  # Penalize constraint violations

    # Then calculate metric
    return answer_f1_score(example, pred)

optimizer = dspy.BootstrapFewShot(
    metric=constrained_metric,
    max_labeled_demos=3,
    max_bootstrapped_demos=3
)
optimized_program = optimizer.compile(
    program_with_assertions,
    trainset=trainset
)
# Optimizes within constraint boundaries
</code></pre>
<h2 id="core-concepts"><a class="header" href="#core-concepts">Core Concepts</a></h2>
<h3 id="1-constraint-aware-metrics"><a class="header" href="#1-constraint-aware-metrics">1. Constraint-Aware Metrics</a></h3>
<p>Design metrics that incorporate constraint satisfaction:</p>
<pre><code class="language-python">def constraint_aware_metric(gold, pred, trace=None):
    """Metric that balances performance with constraint satisfaction."""

    # Base performance score
    base_score = accuracy(gold, pred)

    # Constraint satisfaction weights
    format_weight = 0.3
    quality_weight = 0.2
    accuracy_weight = 0.5

    # Check constraints
    format_score = 1.0 if validate_format(pred) else 0.0
    quality_score = calculate_quality_score(pred)

    # Weighted combination
    total_score = (
        accuracy_weight * base_score +
        format_weight * format_score +
        quality_weight * quality_score
    )

    return total_score

def calculate_quality_score(pred):
    """Calculate overall quality score."""
    score = 1.0

    # Length requirements
    if hasattr(pred, 'output'):
        if len(pred.output) &lt; 50:
            score -= 0.2
        elif len(pred.output) &gt; 500:
            score -= 0.1

    # Structure requirements
    if hasattr(pred, 'sections'):
        if len(pred.sections) &lt; 3:
            score -= 0.2

    return max(0.0, score)
</code></pre>
<h3 id="2-hard-vs-soft-constraints"><a class="header" href="#2-hard-vs-soft-constraints">2. Hard vs Soft Constraints</a></h3>
<p>Differentiate between critical requirements and preferences:</p>
<pre><code class="language-python">class OptimizationConstraints:
    """Define constraint types and their handling."""

    def __init__(self):
        self.hard_constraints = [
            self.validate_syntax,
            self.validate_required_fields,
            self.validate_output_type
        ]

        self.soft_constraints = [
            self.validate_length,
            self.validate_style,
            self.validate_completeness
        ]

    def validate_hard_constraints(self, pred):
        """Check critical constraints that must pass."""
        for constraint in self.hard_constraints:
            try:
                if not constraint(pred):
                    return False, f"Failed: {constraint.__name__}"
            except Exception as e:
                return False, f"Error in {constraint.__name__}: {e}"
        return True, None

    def validate_soft_constraints(self, pred):
        """Check preference constraints."""
        score = 1.0
        for constraint in self.soft_constraints:
            try:
                result = constraint(pred)
                score *= result if isinstance(result, float) else 1.0
            except:
                score *= 0.9  # Small penalty for errors
        return score
</code></pre>
<h3 id="3-progressive-constraint-enforcement"><a class="header" href="#3-progressive-constraint-enforcement">3. Progressive Constraint Enforcement</a></h3>
<p>Gradually enforce stricter constraints during optimization:</p>
<pre><code class="language-python">class ProgressiveOptimizer:
    """Optimizer with progressively stricter constraints."""

    def __init__(self, base_optimizer):
        self.optimizer = base_optimizer
        self.constraint_levels = [
            [],  # Level 0: No constraints
            [validate_format],  # Level 1: Basic format
            [validate_format, validate_length],  # Level 2: Format + length
            [validate_format, validate_length, validate_quality]  # Level 3: All
        ]

    def compile_with_progression(self, program, trainset):
        """Compile with progressively stricter constraints."""

        best_program = program
        best_score = 0.0

        for level, constraints in enumerate(self.constraint_levels):
            print(f"Optimization level {level}: {len(constraints)} constraints")

            # Create level-specific metric
            def level_metric(gold, pred, trace):
                # Check current level constraints
                for constraint in constraints:
                    if not constraint(pred):
                        return 0.0

                # Evaluate on validation set
                return evaluate_with_constraints(best_program, valset)

            # Compile at this level
            current_program = self.optimizer.compile(
                best_program,
                trainset=trainset,
                metric=level_metric
            )

            # Evaluate
            score = evaluate_with_constraints(current_program, valset)

            if score &gt; best_score:
                best_program = current_program
                best_score = score
                print(f"  Improvement: {score:.3f}")
            else:
                print(f"  No improvement, keeping previous best")

        return best_program
</code></pre>
<h2 id="optimization-strategies"><a class="header" href="#optimization-strategies">Optimization Strategies</a></h2>
<h3 id="1-constraint-guided-example-selection"><a class="header" href="#1-constraint-guided-example-selection">1. Constraint-Guided Example Selection</a></h3>
<p>Select training examples based on constraint satisfaction:</p>
<pre><code class="language-python">class ConstraintGuidedOptimizer(dspy.BootstrapFewShot):
    """Optimizer that selects examples based on constraints."""

    def __init__(self, constraint_validator, **kwargs):
        super().__init__(**kwargs)
        self.constraint_validator = constraint_validator

    def generate_bootstrapped_demos(self, program, trainset):
        """Generate examples that satisfy constraints."""
        valid_examples = []

        # Filter training examples
        for example in trainset:
            # Generate prediction
            pred = program(**example.inputs())

            # Check constraints
            if self.constraint_validator(example, pred):
                valid_examples.append((example, pred))

        # Select diverse valid examples
        selected = self.select_diverse_examples(valid_examples)

        return selected

    def select_diverse_examples(self, examples, max_examples=5):
        """Select diverse examples from valid ones."""
        if len(examples) &lt;= max_examples:
            return examples

        # Simple diversity: use different output lengths
        examples.sort(key=lambda x: len(x[1].output))

        # Select evenly spaced examples
        step = len(examples) // max_examples
        selected = [examples[i * step] for i in range(max_examples)]

        return selected
</code></pre>
<h3 id="2-multi-objective-optimization"><a class="header" href="#2-multi-objective-optimization">2. Multi-Objective Optimization</a></h3>
<p>Optimize for multiple objectives simultaneously:</p>
<pre><code class="language-python">class MultiObjectiveOptimizer:
    """Optimize for multiple objectives with constraints."""

    def __init__(self, objectives):
        self.objectives = objectives  # List of (name, weight, metric_func)

    def evaluate_program(self, program, testset):
        """Evaluate program on all objectives."""
        scores = {}

        for name, weight, metric_func in self.objectives:
            score = 0.0
            for example in testset:
                pred = program(**example.inputs())
                score += metric_func(example, pred)
            scores[name] = score / len(testset)

        # Calculate weighted sum
        total_score = sum(
            weight * scores[name]
            for name, weight, _ in self.objectives
        )

        return total_score, scores

    def optimize(self, program, trainset, valset, iterations=10):
        """Multi-objective optimization loop."""
        best_program = program
        best_score, best_scores = self.evaluate_program(program, valset)

        for i in range(iterations):
            # Create variation
            candidate = self.create_variation(best_program, trainset)

            # Evaluate
            score, scores = self.evaluate_program(candidate, valset)

            # Track best
            if score &gt; best_score:
                best_program = candidate
                best_score = score
                best_scores = scores

                print(f"Iteration {i}: New best score {score:.3f}")
                for name, s in scores.items():
                    print(f"  {name}: {s:.3f}")

        return best_program
</code></pre>
<h3 id="3-constraint-weighted-loss"><a class="header" href="#3-constraint-weighted-loss">3. Constraint-Weighted Loss</a></h3>
<p>Incorporate constraints directly into optimization loss:</p>
<pre><code class="language-python">def constraint_weighted_loss(gold, pred, trace=None):
    """Loss function that includes constraint penalties."""

    # Base task loss
    task_loss = task_specific_loss(gold, pred)

    # Constraint penalties
    constraint_penalties = []

    # Format constraint
    if not validate_format(pred):
        constraint_penalties.append(1.0)
    else:
        constraint_penalties.append(0.0)

    # Quality constraint
    quality_score = calculate_quality(pred)
    constraint_penalties.append(1.0 - quality_score)

    # Length constraint
    length_violation = abs(pred.length - target_length) / target_length
    constraint_penalties.append(min(length_violation, 1.0))

    # Weighted combination
    constraint_loss = sum(constraint_penalties) / len(constraint_penalties)

    # Total loss with constraint weight
    total_loss = task_loss + 0.5 * constraint_loss

    return total_loss
</code></pre>
<h2 id="advanced-techniques"><a class="header" href="#advanced-techniques">Advanced Techniques</a></h2>
<h3 id="1-constraint-aware-prompt-optimization"><a class="header" href="#1-constraint-aware-prompt-optimization">1. Constraint-Aware Prompt Optimization</a></h3>
<p>Optimize prompts while maintaining constraints:</p>
<pre><code class="language-python">class ConstraintAwarePromptOptimizer:
    """Optimize prompts with constraint awareness."""

    def __init__(self, base_optimizer, constraints):
        self.base_optimizer = base_optimizer
        self.constraints = constraints

    def optimize_prompt(self, signature, trainset, initial_prompt=None):
        """Find optimal prompt under constraints."""

        if initial_prompt is None:
            initial_prompt = signature.instructions

        best_prompt = initial_prompt
        best_score = self.evaluate_prompt(initial_prompt, signature, trainset)

        # Generate prompt variations
        variations = self.generate_prompt_variations(initial_prompt)

        for variation in variations:
            # Check if variation satisfies constraints
            if self.prompt_satisfies_constraints(variation):
                # Evaluate
                score = self.evaluate_prompt(variation, signature, trainset)

                if score &gt; best_score:
                    best_prompt = variation
                    best_score = score

        return best_prompt

    def prompt_satisfies_constraints(self, prompt):
        """Check if prompt meets constraints."""
        # Length constraint
        if len(prompt) &gt; 500:
            return False

        # Must include constraint instructions
        required_phrases = ['format', 'ensure', 'must', 'required']
        if not any(phrase in prompt.lower() for phrase in required_phrases):
            return False

        return True

    def generate_prompt_variations(self, base_prompt):
        """Generate prompt variations while preserving constraints."""
        variations = []

        # Add constraint emphasis
        variation1 = base_prompt + "\n\nConstraints: Ensure all outputs are valid JSON."
        variations.append(variation1)

        # Add example format
        variation2 = base_prompt + "\n\nExample output format:\n{\n  \"field\": \"value\"\n}"
        variations.append(variation2)

        # Add validation reminder
        variation3 = base_prompt + "\n\nRemember to double-check your output for correctness."
        variations.append(variation3)

        return variations
</code></pre>
<h3 id="2-dynamic-constraint-adjustment"><a class="header" href="#2-dynamic-constraint-adjustment">2. Dynamic Constraint Adjustment</a></h3>
<p>Adjust constraints based on optimization progress:</p>
<pre><code class="language-python">class DynamicConstraintOptimizer:
    """Optimizer that adjusts constraints during training."""

    def __init__(self, initial_constraints):
        self.constraints = initial_constraints
        self.constraint_history = []

    def adjust_constraints(self, optimization_metrics):
        """Adjust constraints based on optimization performance."""

        # If constraint violations are high, relax constraints
        if optimization_metrics['violation_rate'] &gt; 0.3:
            self.relax_constraints()

        # If performance is good, tighten constraints
        elif optimization_metrics['accuracy'] &gt; 0.9:
            self.tighten_constraints()

        # Record adjustment
        self.constraint_history.append(self.constraints.copy())

    def relax_constraints(self):
        """Make constraints less strict."""
        # Increase length limits
        for constraint in self.constraints:
            if 'min_length' in constraint:
                constraint['min_length'] *= 0.8
            if 'max_length' in constraint:
                constraint['max_length'] *= 1.2

    def tighten_constraints(self):
        """Make constraints more strict."""
        # Decrease tolerance
        for constraint in self.constraints:
            if 'tolerance' in constraint:
                constraint['tolerance'] *= 0.9
</code></pre>
<h3 id="3-constraint-transfer-learning"><a class="header" href="#3-constraint-transfer-learning">3. Constraint Transfer Learning</a></h3>
<p>Transfer constraints between related tasks:</p>
<pre><code class="language-python">class ConstraintTransfer:
    """Transfer constraints between similar tasks."""

    def __init__(self):
        self.constraint_patterns = {}

    def learn_constraints(self, task_name, examples):
        """Learn common constraint patterns from examples."""
        patterns = {
            'format_patterns': self.extract_format_patterns(examples),
            'length_patterns': self.extract_length_patterns(examples),
            'structure_patterns': self.extract_structure_patterns(examples)
        }
        self.constraint_patterns[task_name] = patterns

    def transfer_constraints(self, source_task, target_task, examples):
        """Transfer constraints from source to target task."""
        if source_task not in self.constraint_patterns:
            return []

        source_patterns = self.constraint_patterns[source_task]
        transferred_constraints = []

        # Adapt format constraints
        for pattern in source_patterns['format_patterns']:
            if self.is_applicable(pattern, examples):
                adapted = self.adapt_constraint(pattern, target_task)
                transferred_constraints.append(adapted)

        return transferred_constraints

    def is_applicable(self, pattern, examples):
        """Check if constraint pattern applies to new task."""
        # Simple heuristic: check if pattern appears in some examples
        matches = sum(1 for ex in examples if pattern in str(ex))
        return matches / len(examples) &gt; 0.1
</code></pre>
<h2 id="practical-applications"><a class="header" href="#practical-applications">Practical Applications</a></h2>
<h3 id="1-rag-system-optimization"><a class="header" href="#1-rag-system-optimization">1. RAG System Optimization</a></h3>
<p>Optimize retrieval-augmented generation with constraints:</p>
<pre><code class="language-python">class ConstrainedRAGOptimizer:
    """Optimize RAG systems with quality constraints."""

    def __init__(self, rag_program):
        self.rag_program = rag_program

    def optimize_with_constraints(self, trainset, valset):
        """Optimize RAG while maintaining answer quality."""

        # Define constraints
        constraints = {
            'min_evidence': 2,  # Must cite at least 2 sources
            'max_hallucination': 0.1,  # &lt;10% hallucinated content
            'min_confidence': 0.7,  # Confidence threshold
            'max_length': 500  # Answer length limit
        }

        # Constraint-aware metric
        def rag_metric(gold, pred, trace=None):
            # Base accuracy
            accuracy = calculate_f1(gold.answer, pred.answer)

            # Constraint satisfaction
            constraint_score = 0.0

            # Check citations
            if hasattr(pred, 'citations') and len(pred.citations) &gt;= constraints['min_evidence']:
                constraint_score += 0.25

            # Check confidence
            if hasattr(pred, 'confidence') and pred.confidence &gt;= constraints['min_confidence']:
                constraint_score += 0.25

            # Check length
            if len(pred.answer) &lt;= constraints['max_length']:
                constraint_score += 0.25

            # Check hallucination (using external model)
            hallucination_score = check_hallucination(pred.answer, pred.context)
            if hallucination_score &gt;= (1 - constraints['max_hallucination']):
                constraint_score += 0.25

            # Combine scores
            return 0.6 * accuracy + 0.4 * constraint_score

        # Optimize
        optimizer = dspy.BootstrapFewShot(
            metric=rag_metric,
            max_labeled_demos=3,
            max_bootstrapped_demos=5
        )

        optimized_program = optimizer.compile(
            self.rag_program,
            trainset=trainset
        )

        return optimized_program
</code></pre>
<h3 id="2-code-generation-with-constraints"><a class="header" href="#2-code-generation-with-constraints">2. Code Generation with Constraints</a></h3>
<p>Optimize code generation while maintaining correctness:</p>
<pre><code class="language-python">class CodeConstraintOptimizer:
    """Optimize code generation with correctness constraints."""

    def __init__(self, code_generator):
        self.generator = code_generator

    def optimize_with_tests(self, trainset, test_cases):
        """Optimize while ensuring code passes tests."""

        def code_metric(gold, pred, trace=None):
            # Check if code is syntactically valid
            try:
                compile(pred.code, '&lt;string&gt;', 'exec')
                syntax_score = 1.0
            except:
                return 0.0  # Zero score for syntax errors

            # Run test cases
            test_score = 0.0
            passed = 0
            total = len(test_cases.get(gold.problem, []))

            for test in test_cases.get(gold.problem, []):
                try:
                    exec_globals = {}
                    exec(pred.code, exec_globals)

                    # Check if solution function exists
                    if 'solution' in exec_globals:
                        result = exec_globals['solution'](*test['input'])
                        if result == test['expected']:
                            passed += 1
                except:
                    pass  # Test failed

            test_score = passed / total if total &gt; 0 else 0.0

            # Combine with style score
            style_score = self.check_code_style(pred.code)

            # Weighted combination
            return 0.4 * test_score + 0.3 * syntax_score + 0.3 * style_score

        # Optimize
        optimizer = dspy.MIPROv2(
            metric=code_metric,
            num_candidates=5,
            init_temperature=1.0
        )

        optimized = optimizer.compile(
            self.generator,
            trainset=trainset
        )

        return optimized
</code></pre>
<h2 id="monitoring-and-analysis"><a class="header" href="#monitoring-and-analysis">Monitoring and Analysis</a></h2>
<h3 id="1-constraint-violation-analysis"><a class="header" href="#1-constraint-violation-analysis">1. Constraint Violation Analysis</a></h3>
<p>Track and analyze constraint violations during optimization:</p>
<pre><code class="language-python">import datetime

class ConstraintAnalyzer:
    """Analyze constraint violations in optimization."""

    def __init__(self):
        self.violations = []
        self.metrics = {
            'violation_rates': {},
            'common_violations': {},
            'optimization_progress': []
        }

    def record_violation(self, constraint_name, details):
        """Record a constraint violation."""
        self.violations.append({
            'constraint': constraint_name,
            'details': details,
            'timestamp': datetime.now()
        })

    def analyze_violations(self):
        """Analyze patterns in violations."""
        from collections import Counter

        # Count violations by constraint
        violation_counts = Counter(
            v['constraint'] for v in self.violations
        )

        # Calculate rates
        total = len(self.violations)
        for constraint, count in violation_counts.items():
            self.metrics['violation_rates'][constraint] = count / total

        # Most common violations
        self.metrics['common_violations'] = violation_counts.most_common(5)

        return self.metrics

    def generate_report(self):
        """Generate violation analysis report."""
        report = "Constraint Violation Analysis\n"
        report += "=" * 40 + "\n\n"

        # Violation rates
        report += "Violation Rates:\n"
        for constraint, rate in self.metrics['violation_rates'].items():
            report += f"  {constraint}: {rate:.1%}\n"

        # Common violations
        report += "\nMost Common Violations:\n"
        for constraint, count in self.metrics['common_violations']:
            report += f"  {constraint}: {count} occurrences\n"

        # Recommendations
        report += "\nRecommendations:\n"
        top_violation = self.metrics['common_violations'][0][0]
        if self.metrics['violation_rates'][top_violation] &gt; 0.3:
            report += f"  - Consider relaxing {top_violation} constraint\n"
            report += f"  - Improve training examples for {top_violation}\n"

        return report
</code></pre>
<h3 id="2-optimization-progress-tracking"><a class="header" href="#2-optimization-progress-tracking">2. Optimization Progress Tracking</a></h3>
<p>Track optimization progress with constraint awareness:</p>
<pre><code class="language-python">class OptimizationTracker:
    """Track optimization progress with metrics."""

    def __init__(self):
        self.epochs = []
        self.current_epoch = 0

    def start_epoch(self):
        """Start a new optimization epoch."""
        self.current_epoch += 1
        self.epochs.append({
            'epoch': self.current_epoch,
            'metrics': {},
            'constraints': {},
            'improvements': []
        })

    def record_metrics(self, metrics):
        """Record optimization metrics."""
        self.epochs[-1]['metrics'].update(metrics)

    def record_constraints(self, constraint_stats):
        """Record constraint statistics."""
        self.epochs[-1]['constraints'].update(constraint_stats)

    def record_improvement(self, improvement_type, details):
        """Record an improvement."""
        self.epochs[-1]['improvements'].append({
            'type': improvement_type,
            'details': details
        })

    def plot_progress(self):
        """Plot optimization progress."""
        import matplotlib.pyplot as plt

        epochs = [e['epoch'] for e in self.epochs]
        scores = [e['metrics'].get('score', 0) for e in self.epochs]
        violations = [e['constraints'].get('violation_rate', 0)
                      for e in self.epochs]

        fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(10, 8))

        # Score progression
        ax1.plot(epochs, scores, 'b-', label='Optimization Score')
        ax1.set_ylabel('Score')
        ax1.set_title('Optimization Progress')
        ax1.legend()
        ax1.grid(True)

        # Violation rate
        ax2.plot(epochs, violations, 'r-', label='Constraint Violation Rate')
        ax2.set_xlabel('Epoch')
        ax2.set_ylabel('Violation Rate')
        ax2.set_title('Constraint Satisfaction')
        ax2.legend()
        ax2.grid(True)

        plt.tight_layout()
        plt.show()
</code></pre>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<p>Constraint-driven optimization provides:</p>
<ul>
<li><strong>Balanced optimization</strong> that considers both metrics and constraints</li>
<li><strong>Flexible constraint handling</strong> with hard and soft requirements</li>
<li><strong>Progressive optimization</strong> with gradually stricter requirements</li>
<li><strong>Multi-objective support</strong> for complex optimization scenarios</li>
<li><strong>Monitoring and analysis</strong> tools for understanding optimization behavior</li>
</ul>
<h3 id="key-takeaways"><a class="header" href="#key-takeaways">Key Takeaways</a></h3>
<ol>
<li><strong>Design constraint-aware metrics</strong> that balance performance and requirements</li>
<li><strong>Use progressive enforcement</strong> to guide optimization effectively</li>
<li><strong>Monitor violations</strong> to understand and address optimization challenges</li>
<li><strong>Transfer constraints</strong> between related tasks to speed up optimization</li>
<li><strong>Analyze results</strong> comprehensively with both metric and constraint perspectives</li>
</ol>
<h2 id="next-steps"><a class="header" href="#next-steps">Next Steps</a></h2>
<ul>
<li><a href="../07-advanced-topics/07-self-refining-pipelines.html">Self-Refining Pipelines</a> - Advanced constraint patterns</li>
<li><a href="../08-case-studies/06-assertion-driven-applications.html">Assertion-Driven Applications</a> - Real implementations</li>
<li><a href="../../examples/chapter05/">Practical Examples</a> - See optimization in action</li>
<li><a href="./07-exercises.html">Exercises</a> - Practice constraint techniques</li>
</ul>
<h2 id="further-reading"><a class="header" href="#further-reading">Further Reading</a></h2>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Multi-objective_optimization">Multi-Objective Optimization</a> - Theoretical foundation</li>
<li><a href="https://en.wikipedia.org/wiki/Constraint_satisfaction">Constraint Satisfaction</a> - Problem-solving paradigm</li>
<li><a href="https://arxiv.org/abs/1206.2944">Bayesian Optimization</a> - Advanced optimization techniques</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../05-optimizers/05-finetuning.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="../05-optimizers/08-reflective-prompt-evolution.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../05-optimizers/05-finetuning.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="../05-optimizers/08-reflective-prompt-evolution.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>






        <script src="../clipboard-1626706a.min.js"></script>
        <script src="../highlight-abc7f01d.js"></script>
        <script src="../book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
